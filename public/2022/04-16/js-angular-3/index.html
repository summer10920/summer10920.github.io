<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/config/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/config/favicon-16x16.png">
  <link rel="mask-icon" href="/assets/config/logo-loki.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,700,700italic%7CNoto+Sans+TC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"summer10920.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":20,"offset":20},"hljswrap":true,"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Service 用於明確定義用途的類別，通常用來將共用的程式邏輯或資料存取邏輯抽象出來，且可以在多個元件之間共用，以避免程式邏輯的重複編寫或將元件與底層實作解耦，讓元件類別更加精簡、高效。Routing 可以幫助我們實現多頁面應用程式或單頁面應用程式 (SPA)。當使用者在應用程式中導航時，路由會根據使用者的操作選擇適當的畫面，並將該畫面呈現給使用者。">
<meta property="og:type" content="article">
<meta property="og:title" content="[前端框架] Angular - 服務與路由">
<meta property="og:url" content="http://summer10920.github.io/2022/04-16/js-angular-3/">
<meta property="og:site_name" content="洛奇的邪惡組織手札">
<meta property="og:description" content="Service 用於明確定義用途的類別，通常用來將共用的程式邏輯或資料存取邏輯抽象出來，且可以在多個元件之間共用，以避免程式邏輯的重複編寫或將元件與底層實作解耦，讓元件類別更加精簡、高效。Routing 可以幫助我們實現多頁面應用程式或單頁面應用程式 (SPA)。當使用者在應用程式中導航時，路由會根據使用者的操作選擇適當的畫面，並將該畫面呈現給使用者。">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="http://summer10920.github.io/assets/images/WC5iApN.png">
<meta property="article:published_time" content="2022-04-16T14:57:44.000Z">
<meta property="article:modified_time" content="2024-08-27T02:26:22.744Z">
<meta property="article:author" content="Loki Jiang">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="Angular">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://summer10920.github.io/assets/images/WC5iApN.png">


<link rel="canonical" href="http://summer10920.github.io/2022/04-16/js-angular-3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-TW","comments":true,"permalink":"http://summer10920.github.io/2022/04-16/js-angular-3/","path":"2022/04-16/js-angular-3/","title":"[前端框架] Angular - 服務與路由"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>[前端框架] Angular - 服務與路由 | 洛奇的邪惡組織手札</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146423952-3"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-146423952-3","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>







<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&family=Roboto&display=swap" rel="stylesheet">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <canvas id="lokiBanner" width="1920" height="200"></canvas>
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">洛奇的邪惡組織手札</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">I am WebDeveloper!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜尋" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤<span class="badge">20</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類<span class="badge">17</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>文章<span class="badge">68</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜尋..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Service-%E6%9C%8D%E5%8B%99"><span class="nav-number">1.</span> <span class="nav-text">Service 服務</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BA%E7%AF%84%E8%88%87%E5%89%8D%E7%BD%AE%E6%BA%96%E5%82%99"><span class="nav-number">1.1.</span> <span class="nav-text">示範與前置準備</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-logging-%E7%94%A8%E7%9A%84%E6%9C%8D%E5%8B%99-dddddd"><span class="nav-number">1.2.</span> <span class="nav-text">建立 logging 用的服務 dddddd</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E5%8B%95%E5%B0%87%E6%9C%8D%E5%8B%99%E5%AF%A6%E9%AB%94%E5%8C%96-%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%96%A6%EF%BC%89"><span class="nav-number">1.2.1.</span> <span class="nav-text">手動將服務實體化 （不推薦）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hierarchical-Injector-%E6%B3%A8%E5%85%A5%E4%BE%9D%E8%B3%B4"><span class="nav-number">1.2.2.</span> <span class="nav-text">Hierarchical Injector 注入依賴</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%84%B2%E5%AD%98%E8%B3%87%E6%96%99%E7%9A%84%E6%9C%8D%E5%8B%99"><span class="nav-number">1.3.</span> <span class="nav-text">建立儲存資料的服務</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%9E%E7%9B%B8%E5%90%8C%E5%AF%A6%E9%AB%94%E5%8C%96%E7%9A%84%E6%9C%8D%E5%8B%99%E8%A7%A3%E6%B1%BA"><span class="nav-number">1.3.1.</span> <span class="nav-text">非相同實體化的服務解決</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%87%E6%9C%8D%E5%8B%99%E6%B3%A8%E5%85%A5%E5%88%B0%E5%8F%A6%E4%B8%80%E5%80%8B%E6%9C%8D%E5%8B%99"><span class="nav-number">1.4.</span> <span class="nav-text">將服務注入到另一個服務</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%9C%8D%E5%8B%99%E9%80%B2%E8%A1%8C%E8%B7%A8%E5%85%83%E4%BB%B6%E9%80%9A%E4%BF%A1"><span class="nav-number">1.5.</span> <span class="nav-text">利用服務進行跨元件通信</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Routing-%E8%B7%AF%E7%94%B1"><span class="nav-number">2.</span> <span class="nav-text">Routing 路由</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BA%E7%AF%84%E8%88%87%E5%89%8D%E7%BD%AE%E6%BA%96%E5%82%99-1"><span class="nav-number">2.1.</span> <span class="nav-text">示範與前置準備</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A3%E5%91%8A%E8%B7%AF%E7%94%B1"><span class="nav-number">2.1.1.</span> <span class="nav-text">宣告路由</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%B8%E7%99%BC%E8%B7%AF%E7%94%B1%E5%8B%95%E4%BD%9C"><span class="nav-number">2.2.</span> <span class="nav-text">觸發路由動作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%9E-Template"><span class="nav-number">2.2.1.</span> <span class="nav-text">從 Template</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%9E-TypeScript"><span class="nav-number">2.2.2.</span> <span class="nav-text">從 TypeScript</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#navigate-%E8%B7%AF%E5%BE%91%E8%A7%80%E5%BF%B5"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">navigate 路徑觀念</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%91%E8%B7%AF%E7%94%B1%E5%82%B3%E9%81%9E%E5%8F%83%E6%95%B8"><span class="nav-number">2.3.</span> <span class="nav-text">向路由傳遞參數</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%9E-Template-%E8%A7%B8%E7%99%BC%E8%B7%AF%E7%94%B1%E5%8F%83%E6%95%B8"><span class="nav-number">2.3.1.</span> <span class="nav-text">從 Template 觸發路由參數</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%96%E6%B6%88%E8%A8%82%E9%96%B1%E6%96%BC%E9%8A%B7%E6%AF%80%E9%9A%8E%E6%AE%B5"><span class="nav-number">2.3.2.</span> <span class="nav-text">取消訂閱於銷毀階段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%80%E5%AF%AB-Query-%E5%8F%83%E6%95%B8%E8%88%87%E7%89%87%E6%AE%B5"><span class="nav-number">2.3.3.</span> <span class="nav-text">讀寫 Query 參數與片段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%9E-Template-%E6%8C%87%E5%AE%9A"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">從 Template 指定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%9E-TypeScript-%E6%8C%87%E5%AE%9A"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">從 TypeScript 指定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%9E-TypeScript-%E8%AE%80%E5%8F%96"><span class="nav-number">2.3.3.3.</span> <span class="nav-text">從 TypeScript 讀取</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%A4%BA%E7%AF%84%E8%88%87%E9%99%B7%E9%98%B1%E6%B3%A8%E6%84%8F"><span class="nav-number">2.3.4.</span> <span class="nav-text">操作示範與陷阱注意</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B5%8C%E5%A5%97%E8%B7%AF%E7%94%B1-Nesting-Routes"><span class="nav-number">2.3.5.</span> <span class="nav-text">嵌套路由 Nesting Routes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B7%B4%E7%BF%92%E4%BD%BF%E7%94%A8-Query-%E5%8F%83%E6%95%B8"><span class="nav-number">2.3.6.</span> <span class="nav-text">練習使用 Query 參數</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E9%87%8D%E6%96%B0%E5%B0%8E%E5%90%91"><span class="nav-number">2.4.</span> <span class="nav-text">路由重新導向</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE%E7%9A%84%E6%AA%94%E6%A1%88-app-routing-module-ts"><span class="nav-number">2.5.</span> <span class="nav-text">路由配置的檔案 app-routing.module.ts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Guards-%E8%B7%AF%E7%94%B1%E5%AE%88%E8%A1%9B"><span class="nav-number">2.6.</span> <span class="nav-text">Guards 路由守衛</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CanActivate-%E8%A8%B1%E5%8F%AF%E8%B7%AF%E7%94%B1%E9%80%B2%E5%85%A5"><span class="nav-number">2.6.1.</span> <span class="nav-text">CanActivate 許可路由進入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CanActivateChild-%E8%A8%B1%E5%8F%AF%E5%AD%90%E8%B7%AF%E7%94%B1%E9%80%B2%E5%85%A5"><span class="nav-number">2.6.2.</span> <span class="nav-text">CanActivateChild 許可子路由進入</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%93%AC%E5%B7%B2%E7%99%BB%E5%85%A5%E6%95%88%E6%9E%9C"><span class="nav-number">2.6.2.1.</span> <span class="nav-text">模擬已登入效果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#canDeactivate-%E8%A8%B1%E5%8F%AF%E8%B7%AF%E7%94%B1%E9%9B%A2%E9%96%8B"><span class="nav-number">2.6.3.</span> <span class="nav-text">canDeactivate 許可路由離開</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A8%AD%E8%A8%88%E6%8F%90%E7%A4%BA%E9%9B%A2%E9%96%8B%E6%95%88%E6%9E%9C"><span class="nav-number">2.6.3.1.</span> <span class="nav-text">設計提示離開效果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E5%BA%95%E4%B8%8B%E7%9A%84-data-%E5%B1%AC%E6%80%A7%E8%B3%87%E6%96%99%E5%82%B3%E9%81%9E"><span class="nav-number">2.6.4.</span> <span class="nav-text">路由底下的 data 屬性資料傳遞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%9C%E6%85%8B%E6%95%B8%E6%93%9A%E7%A4%BA%E7%AF%84"><span class="nav-number">2.6.4.1.</span> <span class="nav-text">靜態數據示範</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8B%95%E6%85%8B%E6%95%B8%E6%93%9A%E9%80%8F%E9%81%8E-Resolve-%E5%AE%88%E8%A1%9B"><span class="nav-number">2.6.4.2.</span> <span class="nav-text">動態數據透過 Resolve 守衛</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B6%B2%E5%9D%80%E7%AD%96%E7%95%A5"><span class="nav-number">2.7.</span> <span class="nav-text">網址策略</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%83%E8%80%83%E6%96%87%E7%8D%BB"><span class="nav-number">3.</span> <span class="nav-text">參考文獻</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Loki Jiang"
      src="/assets/config/author_loki.jpg">
  <p class="site-author-name" itemprop="name">Loki Jiang</p>
  <div class="site-description" itemprop="description">Time waits for no oneヽ(｀Д´)ﾉ</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/summer10920" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;summer10920" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:summer10920@gmail.com" title="E-Mail → mailto:summer10920@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://codepen.io/summer10920/pens/public?grid_type=list" title="CodePen → https:&#x2F;&#x2F;codepen.io&#x2F;summer10920&#x2F;pens&#x2F;public?grid_type&#x3D;list" rel="noopener me" target="_blank"><i class="fab fa-codepen fa-fw"></i>CodePen</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.youtube.com/c/LokiJiang/playlists" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;c&#x2F;LokiJiang&#x2F;playlists" rel="noopener me" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="回到頂端">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="http://demob17300.lokiwebs.com/" title="http:&#x2F;&#x2F;demob17300.lokiwebs.com&#x2F;" rel="noopener" target="_blank">DemoSite - 網頁設計乙術科</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://blog.lokiwebs.com/" title="http:&#x2F;&#x2F;blog.lokiwebs.com&#x2F;" rel="noopener" target="_blank">舊址(停更) - 札記 Blog</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="http://summer10920.github.io/2022/04-16/js-angular-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/config/author_loki.jpg">
      <meta itemprop="name" content="Loki Jiang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="洛奇的邪惡組織手札">
      <meta itemprop="description" content="Time waits for no oneヽ(｀Д´)ﾉ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="[前端框架] Angular - 服務與路由 | 洛奇的邪惡組織手札">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [前端框架] Angular - 服務與路由<a href="https://github.com/summer10920/summer10920.github.io/edit/master/source/_posts/20220416-js-angular-3.md" class="post-edit-link" title="編輯" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2022-04-16 22:57:44" itemprop="dateCreated datePublished" datetime="2022-04-16T22:57:44+08:00">2022-04-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-08-27 10:26:22" itemprop="dateModified" datetime="2024-08-27T10:26:22+08:00">2024-08-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Zero-Road/" itemprop="url" rel="index"><span itemprop="name">Zero Road</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Zero-Road/Angular/" itemprop="url" rel="index"><span itemprop="name">Angular</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>16,938</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>00:30:48</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><img src="/assets/images/WC5iApN.png"></p>
<p>Service 用於明確定義用途的類別，通常用來將共用的程式邏輯或資料存取邏輯抽象出來，且可以在多個元件之間共用，以避免程式邏輯的重複編寫或將元件與底層實作解耦，讓元件類別更加精簡、高效。<br>Routing 可以幫助我們實現多頁面應用程式或單頁面應用程式 (SPA)。當使用者在應用程式中導航時，路由會根據使用者的操作選擇適當的畫面，並將該畫面呈現給使用者。</p>
<span id="more"></span>

<h1 id="Service-服務"><a href="#Service-服務" class="headerlink" title="Service 服務"></a>Service 服務</h1><p>Service 可藉由 Dependency Injection 的方式被注入到元件中。舉例來說，如果一個應用程式需要與後端 API 進行資料交換，我們可以使用 Service 將資料的存取邏輯抽象出來，而不是將此邏輯直接放在元件中。這樣可以讓元件專注於畫面呈現的邏輯，而不用擔心資料交換的實作細節。同時，使用 Service 也可以讓應用程式更容易測試和維護，因為相關邏輯都被封裝在 Service 中。</p>
<p>在 Angular 中，Service 是一個可注入的類別，它通常會使用 <code>@Injectable</code> 裝飾器來進行標記，以便 Angular 的 DI 機制可以找到它。透過這種方式，我們可以輕鬆地在需要的元件中使用 Service，並且可以方便地進行單元測試和模擬。</p>
<p>討論服務的作用，假設一個應用程式擁有以下組織並提供一些方法：</p>
<ul>
<li>AppComponent<ul>
<li>AboutComponent (Method:log data to console)</li>
<li>UserComponent (Method:store user data)<ul>
<li>UserDetailComponent (Method:log data to console)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>有兩個 (Method: 能將 data 輸出到 console.log) 的用途很相近幾乎相同，然後另一個 (Method: 儲存用戶資訊）在 User 原件上雖然只有單獨，也許之後這個單獨 Method 之後可能也會出現在其他元件內重複使用。</p>
<p>服務就是將這些 Method 獨立起來成為應用程式的另一部分，使用服務可以將你重複使用的代碼集中起來並可添加到任何元件類別底下做成注入依賴。因此我們可以產生一個 log 用的服務以及儲存用戶資料的服務。</p>
<h2 id="示範與前置準備"><a href="#示範與前置準備" class="headerlink" title="示範與前置準備"></a>示範與前置準備</h2><p>本篇的起始素材放置於 GitHub 底下提供使用，使用資料目錄 lokiService 作為初始環境。下載請記得 npm install 初始化環境。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/summer10920/angularTraining">Github download</a> at lokiService-start Folder</p>
</blockquote>
<p>素材內可看到</p>
<ul>
<li>有三個元件，app 根元件、新增用戶元件、用戶紀錄元件。</li>
<li>且用戶紀錄元件能按鈕控制切換狀態輸出到 console.log 並被儲存起來（字串插植），也許這可以做為服務做為代碼集中。</li>
<li>app 元件將整個東西整合在一起。對 new-account 元件進行<code>@Output</code>自訂事件綁定，對 account 元件進行<code>@input/@Output</code>屬性與自訂事件綁定。</li>
<li>由 app 元件提供 account[] 陣列資料，提供迴圈重複 account 元件使用</li>
<li>account 透過按鈕觸發更改狀態並透過自訂事件通知 app 元件做資料更改。</li>
<li>new-account 透過按鈕觸發除了 console.log 資訊也透過自訂事件通知 app 元件做資料新增。</li>
</ul>
<h2 id="建立-logging-用的服務-dddddd"><a href="#建立-logging-用的服務-dddddd" class="headerlink" title="建立 logging 用的服務 dddddd"></a>建立 logging 用的服務 dddddd</h2><p>我們要建立出一個服務做為 ts 檔案，可手動到 app 目錄下新增一個<code>logging.serve.ts</code>並編寫以下內容：</p>
<figure class="highlight ts"><figcaption><span>logging.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoggingService</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>或者透過 CLI 指令 <code>ng g service logging</code> 或 <code>ng g s logging</code>來自動生成。</p>
</blockquote>
<p>如果你選擇手動新增此檔案，你可能以為我們創建了元件，以為下一步是對本 ts 檔案宣告<code>@Component</code>資訊，以及還要到 add.module.ts 填寫 declarations。事實上不用做這些事，因為 service 不是元件他只是一個 typescript 腳本代碼，目前這些就已經叫做 service。</p>
<p>我們在該 service 內新增一個 Method 能幫助我們進行 console.log。console.log 格式可參考 new-account 的 ts。</p>
<figure class="highlight ts"><figcaption><span>logging.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoggingService</span> &#123;</span><br><span class="line">  <span class="comment">// constructor() &#123; &#125; //用不到</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">logState</span>(<span class="params"><span class="attr">status</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;A server status changed, new status: &#x27;</span> + status);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下來我們要將服務放入到有需要的元件內使用，這裡會示範手動方式（不推薦）與 Angular 提供的注入依賴（推薦）來實施。</p>
<h3 id="手動將服務實體化-（不推薦）"><a href="#手動將服務實體化-（不推薦）" class="headerlink" title="手動將服務實體化 （不推薦）"></a>手動將服務實體化 （不推薦）</h3><p>接下來我們要剛做好的服務，放回到素材內可以服務來取代的相同代碼。透過 new 實體化來載入服務（記得宣告來源）。</p>
<figure class="highlight ts"><figcaption><span>new.account.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">EventEmitter</span>, <span class="title class_">Output</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggingService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../logging.service&#x27;</span>; <span class="comment">//※重點，我們要宣告服務來源</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-new-account&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./new-account.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./new-account.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">NewAccountComponent</span> &#123;</span><br><span class="line">  <span class="meta">@Output</span>() accountAdded = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>&lt;&#123; <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">status</span>: <span class="built_in">string</span> &#125;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreateAccount</span>(<span class="params"><span class="attr">accountName</span>: <span class="built_in">string</span>, <span class="attr">accountStatus</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accountAdded</span>.<span class="title function_">emit</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: accountName,</span><br><span class="line">      <span class="attr">status</span>: accountStatus</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> service = <span class="keyword">new</span> <span class="title class_">LoggingService</span>(); <span class="comment">//透過 new 得到剛剛的服務 object 並實體化</span></span><br><span class="line">    service.<span class="title function_">logState</span>(accountStatus); <span class="comment">//使用這個服務底下的函式方法</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// console.log(&#x27;A server status changed, new status: &#x27; + accountStatus);</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Hierarchical-Injector-注入依賴"><a href="#Hierarchical-Injector-注入依賴" class="headerlink" title="Hierarchical Injector 注入依賴"></a>Hierarchical Injector 注入依賴</h3><p>是指這個元件類別所需要依賴的東西為何，例如目前我們的 new-account 將依賴我們的 loggingService。透過注入依賴把 loggingService 注入到 new-account。由 angular 來幫我們處理在 new-account 內引用 loggingService 做實體化。作法如下：</p>
<ul>
<li>首先我們需要在 angular 對這個元件實體化時，在建構函式內提供該私有參數使得元件內能使用到這個方法（注意強型別來自於 LoggingService)。</li>
<li>接著要告知這個元件所依賴的提供者為何，在<code>@Component</code>內宣告 providers 並使用陣列。</li>
<li>現在你能在元件類別內去直接使用這個方法，因為 Angular 已經幫你實體化到這個元件內。</li>
<li>最後測試一下是否與前一節的動作獲得相同的 console.log 預期結果。</li>
</ul>
<blockquote>
<p>providers 可以被定義在模塊、元件、指令或管道中，是用來注入依賴的一種機制。在 Angular 中，我們通常會將服務定義為一個提供者，然後將該提供者注入到元件或其他服務中。通過注入服務，我們可以實現元件之間的數據共享和通信，也可以將服務抽象出來，方便進行代碼重用和維護。</p>
</blockquote>
<figure class="highlight ts"><figcaption><span>new-account.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">EventEmitter</span>, <span class="title class_">Output</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggingService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../logging.service&#x27;</span>; <span class="comment">//※重點，我們要宣告服務來源</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-new-account&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./new-account.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./new-account.component.css&#x27;</span>],</span><br><span class="line">  <span class="attr">providers</span>:[<span class="title class_">LoggingService</span>] <span class="comment">//※重點：配置所依賴的提供者為何</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">NewAccountComponent</span> &#123;</span><br><span class="line">  <span class="meta">@Output</span>() accountAdded = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>&lt;&#123; <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">status</span>: <span class="built_in">string</span> &#125;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">theLoggingService</span>: <span class="title class_">LoggingService</span></span>) &#123; &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  ※重點：</span></span><br><span class="line"><span class="comment">  在建構函式內定義此物件做為參數，是讓 Angular 當對元件進行實體化時，在建構階段上能夠加載到這個參數</span></span><br><span class="line"><span class="comment">  才能提供我們類別內的後續進行使用</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreateAccount</span>(<span class="params"><span class="attr">accountName</span>: <span class="built_in">string</span>, <span class="attr">accountStatus</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accountAdded</span>.<span class="title function_">emit</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: accountName,</span><br><span class="line">      <span class="attr">status</span>: accountStatus</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// console.log(&#x27;A server status changed, new status: &#x27; + accountStatus);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">theLoggingService</span>.<span class="title function_">logState</span>(accountStatus); <span class="comment">//※重點：透過注入依賴所獲得方法來執行</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>將同樣的方法應用在另一個相同需要相同的服務，並透過注入依賴的方式放入到 account 元件內。</p>
<figure class="highlight ts"><figcaption><span>account.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">EventEmitter</span>, <span class="title class_">Input</span>, <span class="title class_">Output</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggingService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../logging.service&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-account&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./account.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./account.component.css&#x27;</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">LoggingService</span>] <span class="comment">//※重點</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AccountComponent</span> &#123;</span><br><span class="line">  <span class="meta">@Input</span>() account!: &#123; <span class="attr">name</span>: <span class="built_in">string</span>; <span class="attr">status</span>: <span class="built_in">string</span>; &#125;;</span><br><span class="line">  <span class="meta">@Input</span>() id!: <span class="built_in">number</span>;</span><br><span class="line">  <span class="meta">@Output</span>() statusChanged = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>&lt;&#123; <span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">newStatus</span>: <span class="built_in">string</span> &#125;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">theLoggingState</span>: <span class="title class_">LoggingService</span></span>) &#123; &#125; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSetTo</span>(<span class="params"><span class="attr">status</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">statusChanged</span>.<span class="title function_">emit</span>(&#123; <span class="attr">id</span>: <span class="variable language_">this</span>.<span class="property">id</span>, <span class="attr">newStatus</span>: status &#125;);</span><br><span class="line">    <span class="comment">// console.log(&#x27;A server status changed, new status: &#x27; + status);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">theLoggingState</span>.<span class="title function_">logState</span>(status); <span class="comment">//※重點</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前為止，我們將相同的 log 輸出代碼集中成一個服務做成外包，另外利用注入依賴的方式提供給所需要的元件們，且是由 Angular 來幫助我們在元件內實體化這些方法（服務內的方法）。簡化大量重複的代碼。</p>
<h2 id="建立儲存資料的服務"><a href="#建立儲存資料的服務" class="headerlink" title="建立儲存資料的服務"></a>建立儲存資料的服務</h2><p>這一節我們將原本在 app 元件負責進行資料新增修改的代碼，也打包給服務。</p>
<ul>
<li>先建立 accounts 服務，這裡會存放我們用戶資料以及新增修改方法 （參考 app 元件做外包）。</li>
<li>然而 app 本身負責要將用戶資料集中站，會需要提供自己的陣列給 account 元件跑迴圈，所以我們要透過注入依賴，先初始空陣列之後在生命週期的 OnInit 階段從服務那裡取得用戶資料覆蓋此本地的用戶陣列資料。</li>
</ul>
<figure class="highlight ts"><figcaption><span>accounts.services.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AccountsService</span> &#123;</span><br><span class="line">  accounts = [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Master Account&#x27;</span>,</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;active&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Test Account&#x27;</span>,</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;inactive&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Hidden Account&#x27;</span>,</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;unknown&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="title class_">AccountAdd</span>(<span class="attr">newAccount</span>: &#123; <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">status</span>: <span class="built_in">string</span> &#125;) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">push</span>(newAccount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//原本 App 那裏的參數是物件資料，這裡簡化成兩個參數做提供，其實觀念都一樣</span></span><br><span class="line">  <span class="title class_">StatusChange</span>(<span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">newStatus</span>: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span>[id].<span class="property">status</span> = newStatus;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AccountsService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./accounts.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-root&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./app.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./app.component.css&#x27;</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AccountsService</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="attr">accounts</span>: &#123; <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">status</span>: <span class="built_in">string</span> &#125;[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">accountsService</span>: <span class="title class_">AccountsService</span></span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span> = <span class="variable language_">this</span>.<span class="property">accountsService</span>.<span class="property">accounts</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此時畫面報錯，找不到 App 元件內的 onAccountAdded() 與 onStatusChanged()，因為我們把這些也都外包給服務了。因此換個角度來說這些子元件現在應該是向服務直接做資料新增修改，不用再<code>@Output</code>給 App 元件了。</p>
<ul>
<li>將 app 元件與 new-account 元件的<code>@Output</code>與自訂事件綁定給取消，讓 new-account 自己跟服務做新增。</li>
<li>對 new-account 進行注入依賴、注意 import、providers、constructor private</li>
<li>取消原本 new account 的自訂事件，直接對服務的方法進行新增</li>
</ul>
<figure class="highlight html"><figcaption><span>app.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;app-new-account (accountAdded)=&quot;AccountAdd($event)&quot;&gt;&lt;/app-new-account&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">app-new-account</span>&gt;</span><span class="tag">&lt;/<span class="name">app-new-account</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>new-account.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggingService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../logging.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AccountsService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../accounts.service&#x27;</span>; <span class="comment">//※重點，我們要宣告服務 AccountsService 來源</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">EventEmitter</span>, <span class="title class_">Output</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-new-account&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./new-account.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./new-account.component.css&#x27;</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">LoggingService</span>, <span class="title class_">AccountsService</span>] <span class="comment">//※重點：配置所依賴的提供者 AccountsService</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">NewAccountComponent</span> &#123;</span><br><span class="line">  <span class="comment">//※重點 - 原本配自訂事件是為了@Output 給 App，現在透過服務所以就不需要了</span></span><br><span class="line">  <span class="comment">// @Output() accountAdded = new EventEmitter&lt;&#123; name: string, status: string &#125;&gt;();</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">theLoggingService</span>: <span class="title class_">LoggingService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">accountsService</span>: <span class="title class_">AccountsService</span> <span class="comment">// ※重點</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreateAccount</span>(<span class="params"><span class="attr">accountName</span>: <span class="built_in">string</span>, <span class="attr">accountStatus</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//※重點 - 原本配自訂事件是為了@Output 給 App，現在透過服務所以就不需要了</span></span><br><span class="line">    <span class="comment">// this.accountAdded.emit(&#123;</span></span><br><span class="line">    <span class="comment">//   name: accountName,</span></span><br><span class="line">    <span class="comment">//   status: accountStatus</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//※重點 - 直接將資料提供給服務內的方法做新增作業</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accountsService</span>.<span class="title class_">AccountAdd</span>(&#123; <span class="attr">name</span>: accountName, <span class="attr">status</span>: accountStatus &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// console.log(&#x27;A server status changed, new status: &#x27; + accountStatus);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">theLoggingService</span>.<span class="title function_">logState</span>(accountStatus);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在剩下 app 元件與 account 元件的通信也要取消。都由服務來直接操作。</p>
<ul>
<li>將 app 元件與 account 元件的<code>@Output</code>與自訂事件綁定給取消，讓 account 自己跟服務做修改。</li>
<li>對 account 進行注入依賴、注意 import、providers、constructor private</li>
<li>取消原本 account 的自訂事件，直接對服務的方法進行修改</li>
</ul>
<figure class="highlight html"><figcaption><span>app.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;app-account</span></span><br><span class="line"><span class="comment">  *ngFor=&quot;let acc of accounts; let i = index&quot;</span></span><br><span class="line"><span class="comment">  [account]=&quot;acc&quot;</span></span><br><span class="line"><span class="comment">  [id]=&quot;i&quot;</span></span><br><span class="line"><span class="comment">  (statusChanged)=&quot;onStatusChanged($event)&quot;</span></span><br><span class="line"><span class="comment">&gt;&lt;/app-account&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">app-account</span></span></span><br><span class="line"><span class="tag">  *<span class="attr">ngFor</span>=<span class="string">&quot;let acc of accounts; let i = index&quot;</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">account</span>]=<span class="string">&quot;acc&quot;</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">id</span>]=<span class="string">&quot;i&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">app-account</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>account.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggingService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../logging.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AccountsService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../accounts.service&#x27;</span>;  <span class="comment">//※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">EventEmitter</span>, <span class="title class_">Input</span>, <span class="title class_">Output</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-account&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./account.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./account.component.css&#x27;</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">LoggingService</span>, <span class="title class_">AccountsService</span>] <span class="comment">//※重點</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AccountComponent</span> &#123;</span><br><span class="line">  <span class="meta">@Input</span>() account!: &#123; <span class="attr">name</span>: <span class="built_in">string</span>; <span class="attr">status</span>: <span class="built_in">string</span>; &#125;;</span><br><span class="line">  <span class="meta">@Input</span>() id!: <span class="built_in">number</span>;</span><br><span class="line">  <span class="comment">// @Output() statusChanged = new EventEmitter&lt;&#123; id: number, newStatus: string &#125;&gt;();</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">theLoggingState</span>: <span class="title class_">LoggingService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">accountsService</span>: <span class="title class_">AccountsService</span> <span class="comment">//※重點</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSetTo</span>(<span class="params"><span class="attr">status</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="comment">// this.statusChanged.emit(&#123; id: this.id, newStatus: status &#125;);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accountsService</span>.<span class="title class_">StatusChange</span>(<span class="variable language_">this</span>.<span class="property">id</span>, status);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// console.log(&#x27;A server status changed, new status: &#x27; + status);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">theLoggingState</span>.<span class="title function_">logState</span>(status); <span class="comment">//※重點</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前沒有報錯了且 console 部分看似很正常，只剩下 View 的部分沒有準確更新似乎有問題。這是因為在服務的使用邏輯上出了些問題。</p>
<h3 id="非相同實體化的服務解決"><a href="#非相同實體化的服務解決" class="headerlink" title="非相同實體化的服務解決"></a>非相同實體化的服務解決</h3><p>注入依賴是一種具備分層級的用途，各自層級進行建立允許有單獨的注入依賴。如果沒有特別宣告提供者則會根據樹狀層級單向往下應用。</p>
<p>目前來說我們對三個元件（一個上層兩個下層）都進行一樣的注入依賴，都是要求提供者為何才進行建立。因此每當 Angular 針對我們的需求會從 service 那裏獲得實體化物件，目前來說這三個元件的服務都是獨立的實體化彼此不是相同記憶體所在處的值。自然而然都是各自的資料獨立存取。（而前一節 log 服務來說沒有發現因為只是 console.log)</p>
<p>因此如果需要透過服務來對資料存取，勢必需要讓 Angular 由上層 app 元件來告知一組提供者，而下層元件就依賴上層元件的實體化物件即可，使得三者元件都是修改自同一個記憶體位置。</p>
<p>作法很簡單，只需要取消下層元件的提供者資料即可，這樣會去爬上層的提供者對象。</p>
<figure class="highlight ts"><figcaption><span>account.component.ts & new-account.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// providers: [LoggingService, AccountsService]</span></span><br><span class="line"><span class="attr">providers</span>: [<span class="title class_">LoggingService</span>] <span class="comment">//※重點：下層不要寫，這會吃到上層的提供者</span></span><br></pre></td></tr></table></figure>

<h2 id="將服務注入到另一個服務"><a href="#將服務注入到另一個服務" class="headerlink" title="將服務注入到另一個服務"></a>將服務注入到另一個服務</h2><p>回頭想一下整個 app 的服務邏輯，new-account 會去執行 accounts 服務做新增，也會去執行 logging 服務做 console。account 也是一樣做修改與 console 共兩個服務。如果這兩個小元件只需要對 account 服務就好，由 account 服務去帶動 logging 服務工作更好。</p>
<p>我們可以把 logging 服務注入到 account 服務內，使得所有的元件只需要吃到 account 服務，除了能使用 account 本身的服務，也能使用 logging 服務。</p>
<p>在這之前還有一招可介紹，我們能將服務的樹狀影響層級拉到最高，最高不是 app 元件而是整個應用程式。可發現 app.module 內也有提供者可以填寫。</p>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AccountsService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./accounts.service&#x27;</span>; <span class="comment">//※重要</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/platform-browser&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FormsModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AccountComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./account/account.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NewAccountComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./new-account/new-account.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [</span><br><span class="line">    <span class="title class_">AppComponent</span>,</span><br><span class="line">    <span class="title class_">AccountComponent</span>,</span><br><span class="line">    <span class="title class_">NewAccountComponent</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">BrowserModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AccountsService</span>], <span class="comment">//※重要</span></span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AccountsService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./accounts.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-root&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./app.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./app.component.css&#x27;</span>]</span><br><span class="line">  <span class="comment">// providers: [AccountsService] </span></span><br><span class="line">  <span class="comment">//我們只是取消提供者而已，改由上層的應用程式來負責</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="attr">accounts</span>: &#123; <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">status</span>: <span class="built_in">string</span> &#125;[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">accountsService</span>: <span class="title class_">AccountsService</span></span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span> = <span class="variable language_">this</span>.<span class="property">accountsService</span>.<span class="property">accounts</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如此一來注入依賴會將同一個服務往下延伸到所有元件給予實體化使用相同服務。現在整份文件都有 account 服務，接著就能將 logging 服務放到 account 服務內，因此勢必的 app 模組也是需要提供者將 logging 寫入（我們不會再對元件填寫提供者 logging 服務）。之後回到 account 與 new-account 元件，將原本的提供者取消。</p>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggingService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./logging.service&#x27;</span>;<span class="comment">//※重要</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AccountsService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./accounts.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [</span><br><span class="line">    <span class="title class_">AppComponent</span>,</span><br><span class="line">    <span class="title class_">AccountComponent</span>,</span><br><span class="line">    <span class="title class_">NewAccountComponent</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">BrowserModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AccountsService</span>, <span class="title class_">LoggingService</span>], <span class="comment">//※重要</span></span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>new-account.component.ts & account.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// providers: [LoggingService]</span></span><br></pre></td></tr></table></figure>

<p>接著，我們不會透過 account 與 new-account 元件來執行 logging 服務了，而是用 account 服務來執行 logging 服務。因此取消這兩個原本對服務的動作。</p>
<figure class="highlight ts"><figcaption><span>new-account.component.ts & account.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// this.theLoggingService.logState(accountStatus);   //※重點 取消該元件要對服務做的事，到時候由 account 服務來做</span></span><br></pre></td></tr></table></figure>

<p>現在需要由 account 服務來執行 logging 服務內的方法，因為是 Class 寫法我們也是需要利用 constructor 的參數來實體化 logging。接著整合到原本 addAccount() 與 updateStatus() 內去做 log 工作。 </p>
<figure class="highlight ts"><figcaption><span>accounts.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggingService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./logging.service&#x27;</span>; <span class="comment">//※重要</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AccountsService</span> &#123;</span><br><span class="line">  accounts = [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Master Account&#x27;</span>,</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;active&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Test Account&#x27;</span>,</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;inactive&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Hidden Account&#x27;</span>,</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;unknown&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">loggingService</span>: <span class="title class_">LoggingService</span></span>) &#123; &#125; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line">  <span class="title class_">AccountAdd</span>(<span class="attr">newAccount</span>: &#123; <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">status</span>: <span class="built_in">string</span> &#125;) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">push</span>(newAccount);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loggingService</span>.<span class="title function_">logState</span>(newAccount.<span class="property">status</span>); <span class="comment">//※重點</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">StatusChange</span>(<span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">newStatus</span>: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span>[id].<span class="property">status</span> = newStatus;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loggingService</span>.<span class="title function_">logState</span>(newStatus); <span class="comment">//※重點</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此時又獲得一個錯誤資訊。</p>
<blockquote>
<p>The class ‘AccountsService’ cannot be created via dependency injection, as it does not have an Angular decorator. This will result in an error at runtime.<br>Either add the @Injectable() decorator to ‘AccountsService’, or configure a different provider (such as a provider with ‘useFactory’).<br>(-992005)</p>
</blockquote>
<blockquote>
<p>“AccountsService” 不能通過注入依賴創建，因為它沒有 Angular 裝飾器。這將導致運行時出錯。<br>將 @Injectable() 裝飾器添加到“AccountsService”，或配置不同的提供者（例如具有“useFactory”的提供者）。</p>
</blockquote>
<p>原因是我們的 accounts 服務內沒有<code>@Component&#123;&#125;</code>這樣的<mark>元資料 (MetaData)</mark>，因此 Angular 無法像元件那樣知道如何處理、實體化和使用。但這又不是元件不應該這樣寫。因此我們需要透過<code>@Injectable()</code>寫在類別之前，告知 Angular 關於這個類別是可注入的。</p>
<p>換言之，如果你需要在某服務內注入一些東西，就需要在該類別添加前綴符號<code>@Injectable</code>。</p>
<figure class="highlight ts"><figcaption><span>accounts.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;<span class="comment">//※重要</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggingService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./logging.service&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>() <span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AccountsService</span> &#123;  <span class="comment">//※重點</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>過去看到的<code>@Component()</code>其實是 export class 的前墜符號。</p>
</blockquote>
<h2 id="利用服務進行跨元件通信"><a href="#利用服務進行跨元件通信" class="headerlink" title="利用服務進行跨元件通信"></a>利用服務進行跨元件通信</h2><p>目前知道，透過服務我們不再需要依賴<code>@Input/@Output</code>來依賴父元件通信，而是各自元件透過服務來進行資料處理。換言之兩個兄弟元件可透過服務來通信。簡單舉例如下：</p>
<ul>
<li>對 accounts 服務增加一個自訂事件之屬性，而整份 app 都能同樣吃到這個自訂事件<figure class="highlight ts"><figcaption><span>accounts.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line">mport &#123; <span class="title class_">Injectable</span>, <span class="title class_">EventEmitter</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;<span class="comment">//※重要</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggingService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./logging.service&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>() <span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AccountsService</span> &#123;</span><br><span class="line">  accounts = [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Master Account&#x27;</span>,</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;active&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Test Account&#x27;</span>,</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;inactive&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Hidden Account&#x27;</span>,</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;unknown&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ];</span><br><span class="line">  statusAlert=<span class="keyword">new</span> <span class="title class_">EventEmitter</span>&lt;<span class="built_in">string</span>&gt;(); <span class="comment">//※重點：添加一個自訂事件的屬性</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">loggingService</span>: <span class="title class_">LoggingService</span></span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">AccountAdd</span>(<span class="attr">newAccount</span>: &#123; <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">status</span>: <span class="built_in">string</span> &#125;) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">push</span>(newAccount);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loggingService</span>.<span class="title function_">logState</span>(newAccount.<span class="property">status</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">StatusChange</span>(<span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">newStatus</span>: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span>[id].<span class="property">status</span> = newStatus;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loggingService</span>.<span class="title function_">logState</span>(newStatus);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>來到 new-account 元件，我們利用建構函式執行當下，去對服務內的自訂事件 subscribe 註冊此實例發出事件的處理器。<figure class="highlight ts"><figcaption><span>new-account.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">NewAccountComponent</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">theLoggingService</span>: <span class="title class_">LoggingService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">accountsService</span>: <span class="title class_">AccountsService</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    accountsService.<span class="property">statusAlert</span>.<span class="title function_">subscribe</span>( <span class="comment">// ※重點 - 這裡會在建構實體化時會執行一次</span></span><br><span class="line">      <span class="function">(<span class="params"><span class="attr">status</span>: <span class="built_in">string</span></span>) =&gt;</span> <span class="title function_">alert</span>(<span class="string">&#x27;the status is &#x27;</span> + status)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreateAccount</span>(<span class="params"><span class="attr">accountName</span>: <span class="built_in">string</span>, <span class="attr">accountStatus</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accountsService</span>.<span class="title class_">AccountAdd</span>(&#123; <span class="attr">name</span>: accountName, <span class="attr">status</span>: accountStatus &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>來到 account 元件，我們利用建構函式執行當下，去對服務內的自訂事件 emit 發出包含給定值的事件。</li>
</ul>
<figure class="highlight ts"><figcaption><span>account.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">onSetTo</span>(<span class="params"><span class="attr">status</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">accountsService</span>.<span class="title class_">StatusChange</span>(<span class="variable language_">this</span>.<span class="property">id</span>, status);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">accountsService</span>.<span class="property">statusAlert</span>.<span class="title function_">emit</span>(status); <span class="comment">//※重點 發射執行之結果</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這樣的範例中，我們沒有使用到屬性綁定或事件綁定，單純透過相同服務搭配 Emit 進行通信。</p>
<blockquote>
<p>自訂事件 EventEmitter <a target="_blank" rel="noopener" href="https://angular.tw/api/core/EventEmitter">詳閱 Angular.tw</a></p>
</blockquote>
<h1 id="Routing-路由"><a href="#Routing-路由" class="headerlink" title="Routing 路由"></a>Routing 路由</h1><p>Routing 是一個非常重要的功能，用於實現單頁應用程序（SPA:Single Page Application）的路由功能。Routing 讓我們可以通過定義路由器來管理應用程序中的路由。每當用戶進行瀏覽器操作，例如單擊超鏈接或刷新頁面時，路由器會解析 URL 並確定要顯示的 Component。通過 Routing，我們可以實現不同的路由和導航功能，例如：</p>
<ul>
<li>當用戶單擊超鏈接時，顯示特定的 Component</li>
<li>動態生成 URL 並將其顯示給用戶</li>
<li>將用戶導航到應用程序中的不同部分</li>
<li>當用戶進行某些操作時，導航到不同的頁面</li>
</ul>
<p>Routing 通常是在 app.module.ts 中配置。我們可以通過在 RouterModule.forRoot 方法中定義路由配置來設置應用程序的路由。</p>
<p>簡單來說，路由設計可以在同一頁面下不會重新請求伺服器網頁載入，直接替換 DOM 模擬出新的大版面內容以及更換 URL，你感覺好像有重新連結網頁但事實上你的連線沒有重新加載。</p>
<h2 id="示範與前置準備-1"><a href="#示範與前置準備-1" class="headerlink" title="示範與前置準備"></a>示範與前置準備</h2><p>本篇的起始素材放置於 GitHub 底下提供使用，使用資料目錄 lokiRouting 作為初始環境。下載請記得 npm install 初始化環境。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/summer10920/angularTraining">Github download</a> at lokiRouting-start Folder</p>
</blockquote>
<p>素材內可看到：</p>
<ul>
<li>一開始的 app 內有主要元件為 users, servers, home，且各自有自己的子元件先不討論這部份。</li>
<li>目前希望從上面的 nav-bar 透過點選連結來動態加載這三個，一次只顯示一個元件而不是像這樣看到三個。</li>
</ul>
<h3 id="宣告路由"><a href="#宣告路由" class="headerlink" title="宣告路由"></a>宣告路由</h3><p>首先我們需要將這些超連結的位置被記錄起來，來到最外面的 app.module.ts </p>
<ul>
<li>進行設定一變數並指定型別為 Routes（來自 Angular&#x2F;router 導入），因為是型別為複數之陣列所以路由指向可以很多項目。位置最好提早於 NgModule 設定前。</li>
<li>在自訂變數內設定你的 URL 路徑之字串，哪個 path（不用添加<code>/</code>前綴路徑） 指向到哪個對應的元件名稱，若空字串為代表一開始首頁。</li>
<li>接著來到 imports 這裡要求載入 RouterModule（來自 Angular&#x2F;router 導入），在利用 forRoot() 告知 Angular 我們的路徑設定檔</li>
</ul>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RouterModule</span>, <span class="title class_">Routes</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [ <span class="comment">//※重點</span></span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServersComponent</span> &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [</span><br><span class="line">    <span class="title class_">AppComponent</span>,</span><br><span class="line">    <span class="title class_">HomeComponent</span>,</span><br><span class="line">    <span class="title class_">UsersComponent</span>,</span><br><span class="line">    <span class="title class_">ServersComponent</span>,</span><br><span class="line">    <span class="title class_">UserComponent</span>,</span><br><span class="line">    <span class="title class_">EditServerComponent</span>,</span><br><span class="line">    <span class="title class_">ServerComponent</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">BrowserModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">    <span class="title class_">RouterModule</span>.<span class="title function_">forRoot</span>(lokiRoutes)  <span class="comment">//※重點</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">ServersService</span>],</span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>目前 Angular 已經知道我們路由要求變化，但需要告知路由的動態載入要規劃至範本的何處以及提供有效連結給 nav-bar。</p>
<ul>
<li>來到 app 元件的 html 調整原本的元件模板取消，使用 router-outlet 來插入。</li>
<li>在接著來到 nav-bar 的範本這裡，試著將以下超連結對應綁到三個 a:link。</li>
</ul>
<figure class="highlight html"><figcaption><span>app.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;nav nav-tabs&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link active&quot;</span> <span class="attr">aria-current</span>=<span class="string">&quot;page&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/servers&quot;</span>&gt;</span>Servers<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/users&quot;</span>&gt;</span>Users<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-outlet</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;div class=&quot;col&quot;&gt;</span></span><br><span class="line"><span class="comment">      &lt;app-home&gt;&lt;/app-home&gt;</span></span><br><span class="line"><span class="comment">    &lt;/div&gt;</span></span><br><span class="line"><span class="comment">  &lt;/div&gt;</span></span><br><span class="line"><span class="comment">  &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;div class=&quot;col&quot;&gt;</span></span><br><span class="line"><span class="comment">      &lt;app-users&gt;&lt;/app-users&gt;</span></span><br><span class="line"><span class="comment">    &lt;/div&gt;</span></span><br><span class="line"><span class="comment">  &lt;/div&gt;</span></span><br><span class="line"><span class="comment">  &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;div class=&quot;col&quot;&gt;</span></span><br><span class="line"><span class="comment">      &lt;app-servers&gt;&lt;/app-servers&gt;</span></span><br><span class="line"><span class="comment">    &lt;/div&gt;</span></span><br><span class="line"><span class="comment">  &lt;/div&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>嘗試輸入以下完整網址觀察<code>&lt;router-outlet&gt;&lt;/router-outlet&gt;</code>的 View 變化。</p>
<ul>
<li>http:localhost:4200&#x2F;</li>
<li>http:localhost:4200&#x2F;users</li>
<li>http:localhost:4200&#x2F;severs</li>
</ul>
<p>目前處理程度上，已可透過手動指定網址要求<code>&lt;router-outlet&gt;&lt;/router-outlet&gt;</code>對應載入哪一份元件。然而實際操作下，你並不是真正的透過路由進行動態 DOM 抽換，而是還是每次透過連結請求網址來進行加載。</p>
<h2 id="觸發路由動作"><a href="#觸發路由動作" class="headerlink" title="觸發路由動作"></a>觸發路由動作</h2><p>觸發的方式可以從範本上的屬性綁定呼叫 Route 指令來執行。或者從 TypeScript 內去執行 Route 指令。</p>
<h3 id="從-Template"><a href="#從-Template" class="headerlink" title="從 Template"></a>從 Template</h3><p>你不應該直接對 href 直接綁定為相對路徑，這會觸發網頁重新加載失去了 SPA 的應用優勢。因此需要改一下前面的範本的連結設定讓 Angular 知道這是要內部路由模擬處理。將原本的 href 屬性抽換成 routerLink 屬性。</p>
<figure class="highlight html"><figcaption><span>app.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;nav nav-tabs&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link active&quot;</span> <span class="attr">routerLink</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">routerLink</span>=<span class="string">&quot;/servers&quot;</span>&gt;</span>Servers<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/users&#x27;]&quot;</span>&gt;</span>Users<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>現在網址不會加載，檢查 F12 可發現 DOM 自行做切頁的效果。</p>
<ul>
<li>touterLink 本身是一個屬性綁定，<code>routerLink=&quot;/users&quot;</code>等價於<code>[routerLink]=&quot;[&#39;/users&#39;]&quot;</code>。比較特別這裡的指定值是陣列。</li>
<li>routerLink 所填寫的值為相對路徑且觀念一致，寫法根據文件所在地以及 index 頁面有關。</li>
<li>可利用 routerLinkActive 屬性幫我們針對運作中的元件添加指定樣式 class，我們使用 Bootstrap 規則的 active 來做美化。</li>
</ul>
<figure class="highlight html"><figcaption><span>app.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;nav nav-tabs&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">routerLinkActive</span>=<span class="string">&quot;active&quot;</span> <span class="attr">routerLink</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">routerLinkActive</span>=<span class="string">&quot;active&quot;</span> <span class="attr">routerLink</span>=<span class="string">&quot;/servers&quot;</span>&gt;</span>Servers<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">routerLinkActive</span>=<span class="string">&quot;active&quot;</span> <span class="attr">routerLink</span>=<span class="string">&quot;/users&quot;</span>&gt;</span>Users<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Home 的 active 經操作檢查下持續保持 active，這是因為默認預設 Home Root 的關係。路由位置在<code>/server</code>與<code>/users</code>的同本 root 路徑。如果你希望這個 home 這個唯獨不要這樣效果，可以透過選項的屬性<code>[routerLinkActiveOptions]=&quot;&#123;exact:true&#125;&quot;</code>綁定把活動項目對象為固定。</p>
<figure class="highlight html"><figcaption><span>app.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">  <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">routerLinkActive</span>=<span class="string">&quot;active&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">routerLink</span>=<span class="string">&quot;/&quot;</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">routerLinkActiveOptions</span>]=<span class="string">&quot;&#123;exact:true&#125;&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>現在 home 只會在自己的網址上反應，不會對其他對象有作用。</p>
<h3 id="從-TypeScript"><a href="#從-TypeScript" class="headerlink" title="從 TypeScript"></a>從 TypeScript</h3><p>我們也可以從 TypeScript 對路由下指令，先弄素材放置到 Home 元件，透過 button click 事件綁定要求 TypeScript 來執行路由指令。</p>
<figure class="highlight html"><figcaption><span>home.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;loadServers()&quot;</span>&gt;</span>load Servers<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>來到 typeScript 部份，作業如下：</p>
<ul>
<li>規劃私有 Router 屬性，來自於 Router 這個模組。</li>
<li>方法執行當下透過 navigate() 能幫助我們對路由下達指令切頁，你可以在那之前做一些代碼工作才切頁。</li>
</ul>
<figure class="highlight ts"><figcaption><span>home.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;<span class="comment">//※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-home&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./home.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./home.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HomeComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">lokiRouter</span>: <span class="title class_">Router</span> <span class="comment">//※重點</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">loadServers</span>(<span class="params"></span>) &#123;  <span class="comment">//※重點</span></span><br><span class="line">    <span class="comment">//run sql content then go page to servers</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lokiRouter</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/servers&#x27;</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="navigate-路徑觀念"><a href="#navigate-路徑觀念" class="headerlink" title="navigate 路徑觀念"></a>navigate 路徑觀念</h4><p><code>navigate()</code>的路徑觀念跟範本上使用<code>routerLink=&#39;&#39;</code>是不同的。首先討論範本上的 routerLink 部份會根據你是否添加<code>/</code>而有不同的相對路徑影響。但 TypeScript 上的 navigate 的相對路徑是非絕對的，因為 TypeScript 是腳本代碼，因此不會知道當前頁會是在哪裡，因此 Angular 只能根據整個網站的路徑開始指向。</p>
<p>如果你需要明確地給<code>navigate()</code>有明確的相對位置參考，使得它能依據相對路徑來獲得疊加的 URL 位置。對第二參數增加指定物件名，並提供目前作用的 activeRoute。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span>, <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServersService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./servers.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-servers&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./servers.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./servers.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ServersComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="attr">servers</span>: &#123; <span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">status</span>: <span class="built_in">string</span> &#125;[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">serversService</span>: <span class="title class_">ServersService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">router</span>: <span class="title class_">Router</span>, <span class="comment">//※重點</span></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">nowAt</span>: <span class="title class_">ActivatedRoute</span> <span class="comment">//※重點</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">servers</span> = <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">getServers</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">reloadServer</span>(<span class="params"></span>) &#123; <span class="comment">//※重點</span></span><br><span class="line">    <span class="comment">//at: localhost/servers</span></span><br><span class="line">    <span class="comment">// this.router.navigate([&#x27;/servers&#x27;], &#123; relativeTo: this.nowAt &#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//at: localhost/servers/servers</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;servers&#x27;</span>], &#123; <span class="attr">relativeTo</span>: <span class="variable language_">this</span>.<span class="property">nowAt</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果路由的位置，跟目前所在的切頁位置相同且資料不變，Angular 會自動忽略此路由要求。</p>
</blockquote>
<h2 id="向路由傳遞參數"><a href="#向路由傳遞參數" class="headerlink" title="向路由傳遞參數"></a>向路由傳遞參數</h2><p>假設我們有個頁面需要顯示特定用戶的資料，而路由的網址參數可以做為我們的動態變數使用。舉例來說你可以訪問<code>http://localhost/user/3</code>代表 id 為 3 的單筆資料。首先需要從 app.modules.ts 那裏先設定路由位置。其中<code>:id</code>代表 id 是我們的動態變數。可以多個</p>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;users/:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;, <span class="comment">//※重點</span></span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServersComponent</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>接著來到該 user 子元件這裡，透過 TypeScript 來獲得目前路由上的動態變數，該變數放置於路由快照下的 params 陣列內，根據你的變數名稱取得。</p>
<ul>
<li>規劃私有自訂名稱 lokiRoute 屬性賦予 ActivatedRoute 型別，使得 class 內可讀取該模組變數。</li>
<li>當網頁初始化時，向該變數 lokiRoute 的深層位置 params 參數並找到該動態變數，指定回我們的初始變數 user。</li>
</ul>
<figure class="highlight ts"><figcaption><span>user.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-user&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./user.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./user.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  user!: &#123; <span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">name</span>: <span class="built_in">string</span> &#125;;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">lokiRoute</span>: <span class="title class_">ActivatedRoute</span></span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">user</span> = &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="variable language_">this</span>.<span class="property">lokiRoute</span>.<span class="property">snapshot</span>.<span class="property">params</span>[<span class="string">&#x27;id&#x27;</span>], <span class="comment">//※重點</span></span><br><span class="line">      <span class="attr">name</span>: <span class="variable language_">this</span>.<span class="property">lokiRoute</span>.<span class="property">snapshot</span>.<span class="property">params</span>[<span class="string">&#x27;name&#x27;</span>] <span class="comment">//※重點</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">user</span>); <span class="comment">//try http://localhost:4200/users/3/loki</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在我們有了元件屬性綁定，回到範本就能透過字串差值顯示在畫面上。</p>
<figure class="highlight html"><figcaption><span>user.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>User with ID &#123;&#123;user.id&#125;&#125; loaded.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>User name is &#123;&#123;user.name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>snapshot 快照是指當下動作成功時的備份處，他用於有發生路由轉換時列入。但某條件不會列入快照。如下節說明。</p>
<h3 id="從-Template-觸發路由參數"><a href="#從-Template-觸發路由參數" class="headerlink" title="從 Template 觸發路由參數"></a>從 Template 觸發路由參數</h3><p>此時我們添加一個超連結按鈕，利用<code>[routerLink]=&quot;[&#39;/users&#39;]&quot;</code>來完成，而陣列內的其餘參數能代表路徑上的動態變數值。</p>
<figure class="highlight html"><figcaption><span>user.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>User with ID &#123;&#123;user.id&#125;&#125; loaded.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>User name is &#123;&#123;user.name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/users&#x27;,10,&#x27;max&#x27;]&quot;</span>&gt;</span>User Max(sn:10)<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果你是從<code>http://localhost:4200/users</code>的按鈕跳躍到<code>http://localhost:4200/users/10/max</code>這沒問題快照有捕捉到參數。但是如果從某用戶跳躍例如<code>http://localhost:4200/users/3/loki</code>的按鈕想跳躍<code>http://localhost:4200/users/10/max</code>，會發現快照沒有更新停留在 loki 的資料上。這是因為 Angular 收到 link 的變化但元件沒有重新加載的需求，因此不會觸發 OnInit 初始化，自然不會有快照。如果要克服我們需要使用到訂閱功能。</p>
<p>講訂閱之前，需要先提到 Angular 在處理一些非同步任務（某代碼之後才會在某時間下才執行），這是 Angular 利用 RxJS 第三方函式庫的 Observable 可觀察對象所達到的，之後會在介紹。只需要透過訂閱就能向 Observable 要求當時機達到時做甚麼事情。而 Angular 很多模組參數（屬於 Observable) 並提供訂閱讓你做到時候該做的事。</p>
<p>因此我們在本元件初始化時，除了要求初始一開始先獲得快照下的參數。同時也從這個路由的參數觀察來訂閱他，當這個地方發生非同步作業（也就是之後才有變化），就幫我們取得參數寫回我們的屬性值。而不是靠下次重新加載本元件才能獲得。</p>
<figure class="highlight ts"><figcaption><span>user.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span>, <span class="title class_">Params</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-user&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./user.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./user.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  user!: &#123; <span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">name</span>: <span class="built_in">string</span> &#125;;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">lokiRoute</span>: <span class="title class_">ActivatedRoute</span></span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">user</span> = &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="variable language_">this</span>.<span class="property">lokiRoute</span>.<span class="property">snapshot</span>.<span class="property">params</span>[<span class="string">&#x27;id&#x27;</span>],</span><br><span class="line">      <span class="attr">name</span>: <span class="variable language_">this</span>.<span class="property">lokiRoute</span>.<span class="property">snapshot</span>.<span class="property">params</span>[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lokiRoute</span>.<span class="property">params</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">obsParams</span>: <span class="title class_">Params</span></span>) =&gt;</span> &#123; <span class="comment">//※重點</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">user</span> = &#123;</span><br><span class="line">        <span class="attr">id</span>: obsParams.<span class="property">id</span>,</span><br><span class="line">        <span class="attr">name</span>: obsParams.<span class="property">name</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">user</span>); <span class="comment">//try http://localhost:4200/users/3/loki</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在不管元件有沒有重新加載初始化，只要我們的路由位置有獲得動態變數也就是 params 參數時，就幫我們指定給 user 物件並更新值。</p>
<blockquote>
<p>subscribe 訂閱用途，在可用的場合下，提前跟 Angular 說到時候這裡會需要做些什麼事情。</p>
</blockquote>
<h3 id="取消訂閱於銷毀階段"><a href="#取消訂閱於銷毀階段" class="headerlink" title="取消訂閱於銷毀階段"></a>取消訂閱於銷毀階段</h3><p>在 Angular 觀念當中，需要知道每一次的訂閱動作本身會占用記憶體空間。隨著你離開畫面時 Angular 自動銷毀元件釋放空間但訂閱不會。之後再重新加載這頁面你又進行新訂閱隨著重複動作將使記憶體空間不足。因此你需要透過生命週期 OnDestroy 階段主動取消訂閱，使得訂閱會隨著元件銷毀時一起結束。</p>
<p>像 setInterval 一樣我們需要一個 key 記住當下訂閱的編號，之後在 OnDestroy 階段透過這個 key 來取消訂閱。</p>
<ul>
<li>規劃一個 Subscription 區域變數為 key，型別注意。</li>
<li>在訂閱當下儲存給此變數，在銷毀階段上對此變數執行</li>
</ul>
<figure class="highlight ts"><figcaption><span>user.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span>, <span class="title class_">Params</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnDestroy</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Subscription</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-user&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./user.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./user.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span>, <span class="title class_">OnDestroy</span> &#123;</span><br><span class="line">  user!: &#123; <span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">name</span>: <span class="built_in">string</span> &#125;;</span><br><span class="line">  subscriptionKey!: <span class="title class_">Subscription</span>; <span class="comment">//※重點</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">lokiRoute</span>: <span class="title class_">ActivatedRoute</span></span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">user</span> = &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="variable language_">this</span>.<span class="property">lokiRoute</span>.<span class="property">snapshot</span>.<span class="property">params</span>[<span class="string">&#x27;id&#x27;</span>],</span><br><span class="line">      <span class="attr">name</span>: <span class="variable language_">this</span>.<span class="property">lokiRoute</span>.<span class="property">snapshot</span>.<span class="property">params</span>[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subscriptionKey</span> = <span class="variable language_">this</span>.<span class="property">lokiRoute</span>.<span class="property">params</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">obsParams</span>: <span class="title class_">Params</span></span>) =&gt;</span> &#123; <span class="comment">//※重點，使用自訂變數儲存</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">user</span> = &#123;</span><br><span class="line">        <span class="attr">id</span>: obsParams.<span class="property">id</span>,</span><br><span class="line">        <span class="attr">name</span>: obsParams.<span class="property">name</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">ngOnDestroy</span>(): <span class="built_in">void</span> &#123; <span class="comment">//※重點，透過自訂變數取消訂閱</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subscriptionKey</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="讀寫-Query-參數與片段"><a href="#讀寫-Query-參數與片段" class="headerlink" title="讀寫 Query 參數與片段"></a>讀寫 Query 參數與片段</h3><p>假設熟悉 GET 的資料應用，這裡主要談如何規劃網址上的資料，包含了如何生成如<code>?category=37&amp;article=33</code>或錨點連結<code>#go</code>（錨點跳躍不會自動觸發，你需要自己添加向下滾動行為）。以及後半段的如何讀取這些 Query 資料。</p>
<h4 id="從-Template-指定"><a href="#從-Template-指定" class="headerlink" title="從 Template 指定"></a>從 Template 指定</h4><ul>
<li>來到 app.module 這裡先添加一個路由，一個允許我們編輯某項 Server 的頁面指定給 edit-server 元件。</li>
<li>來到 servers 元件的範本左半部 list-group，先將 href 更改為 routerLink 屬性綁定使得能連結到指定路由位置為指定位置，例如<code>http://localhost:4200/servers/1/edit</code></li>
<li>而 query 參數是<code>?</code>透過 queryParams 屬性綁定並指定物件資料。</li>
<li>錨點參數<code>#</code>則是 fragment 屬性綁定並指定字串，所以可簡化<code>[]</code>直接指定關鍵字</li>
</ul>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;users/:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServersComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;servers/:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span> &#125;  <span class="comment">//※重點</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>servers.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-sm-4&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list-group&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 重點 : queryParams 為 get 參數 --&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 重點 : fragment 為 錨點參數 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">        [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/servers&#x27;,server.id,&#x27;edit&#x27;]&quot;</span></span></span><br><span class="line"><span class="tag">        [<span class="attr">queryParams</span>]=<span class="string">&quot;&#123;allowEdit:1&#125;&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">fragment</span>=<span class="string">&quot;loading&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;list-group-item&quot;</span></span></span><br><span class="line"><span class="tag">        *<span class="attr">ngFor</span>=<span class="string">&quot;let server of servers&quot;</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        &#123;&#123; server.name &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-sm-4&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">&quot;reloadServer()&quot;</span>&gt;</span>Reload Server<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app-edit-server</span>&gt;</span><span class="tag">&lt;/<span class="name">app-edit-server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app-server</span>&gt;</span><span class="tag">&lt;/<span class="name">app-server</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>測試並點選畫面上的 side menu 你會獲得類似這樣的路由位置</p>
<figure class="highlight txt"><figcaption><span>sample</span></figcaption><table><tr><td class="code"><pre><span class="line">http://localhost:4200/servers/2/edit?allowEdit=1#loading</span><br></pre></td></tr></table></figure>

<h4 id="從-TypeScript-指定"><a href="#從-TypeScript-指定" class="headerlink" title="從 TypeScript 指定"></a>從 TypeScript 指定</h4><p>我們來到 home 元件做示範，假設需要一個按鈕能載入 server 1 號。</p>
<figure class="highlight html"><figcaption><span>home.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;loadServers(1)&quot;</span>&gt;</span>load Servers 1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>現在回到 home 元件的 ts 部份，對 query 與 fragment 的寫入方式位於 Router.navigate 之第二參數，以物件資料指定。</p>
<figure class="highlight ts"><figcaption><span>home.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">loadServers</span>(<span class="params"><span class="attr">id</span>: <span class="built_in">number</span></span>) &#123;  <span class="comment">//※重點</span></span><br><span class="line">  <span class="comment">// this.lokiRouter.navigate([&#x27;/servers&#x27;]);</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lokiRouter</span>.<span class="title function_">navigate</span>(</span><br><span class="line">    [<span class="string">&#x27;/servers&#x27;</span>, id, <span class="string">&#x27;edit&#x27;</span>],  <span class="comment">//這裡取消靜態 5 改抓函式參數</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">queryParams</span>: &#123;</span><br><span class="line">        <span class="attr">allowEdit</span>: <span class="number">1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">fragment</span>: <span class="string">&quot;loading&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>測試並點選 Home 畫面上的按鈕你會獲得類似這樣的路由位置</p>
<figure class="highlight txt"><figcaption><span>sample</span></figcaption><table><tr><td class="code"><pre><span class="line">http://localhost:4200/servers/1/edit?allowEdit=1#loading</span><br></pre></td></tr></table></figure>

<h4 id="從-TypeScript-讀取"><a href="#從-TypeScript-讀取" class="headerlink" title="從 TypeScript 讀取"></a>從 TypeScript 讀取</h4><p>來到 edit-server 元件，這裡已經出現很多現成代碼，大致說明會透過 ServersService 這支服務，進行獲得全部 server 資資料、獲得指定 id 資料、更新指定 id 資料。</p>
<p>可透過 ActivatedRoute 的快照來獲得非即時反應性資料，但如同前面所說自加載本元件之後當前頁面進行變動參數時無法即時更新當前修改（因為沒有重新加載元件）。</p>
<figure class="highlight ts"><figcaption><span>edit-server.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServersService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../servers.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-edit-server&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./edit-server.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./edit-server.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">EditServerComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">// server: &#123; id: number, name: string, status: string &#125;;</span></span><br><span class="line">  <span class="attr">server</span>: <span class="built_in">any</span>;</span><br><span class="line">  serverName = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  serverStatus = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">serversService</span>: <span class="title class_">ServersService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">route</span>: <span class="title class_">ActivatedRoute</span> <span class="comment">//※重點</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">snapshot</span>.<span class="property">fragment</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">snapshot</span>.<span class="property">queryParams</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if (this.serversService.getServer(1) !== null) </span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">server</span> = <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">getServer</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serverName</span> = <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">name</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serverStatus</span> = <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">status</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onUpdateServer</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">updateServer</span>(<span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">id</span>, &#123; <span class="attr">name</span>: <span class="variable language_">this</span>.<span class="property">serverName</span>, <span class="attr">status</span>: <span class="variable language_">this</span>.<span class="property">serverStatus</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另一種直接從 queryParams 的可觀察對象進行訂閱，一旦這處發生變化仍可以獲得目前值。</p>
<figure class="highlight ts"><figcaption><span>edit-server.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">fragment</span>.<span class="title function_">subscribe</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(e));</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">queryParams</span>.<span class="title function_">subscribe</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(e));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Router 模組與 ActivatedRoute 模組各自主要工作為，Router 能幫助我們前往某指定路由位置依賴旗下的 navigate，ActivatedRoute 能幫助我獲得路由上的資訊，像是 snapshot 快照</p>
</blockquote>
<h3 id="操作示範與陷阱注意"><a href="#操作示範與陷阱注意" class="headerlink" title="操作示範與陷阱注意"></a>操作示範與陷阱注意</h3><p>讓我們先回到 users 元件，先修正 side menu 超連結要帶領要去的路由位置。參考 app.module 稍早的定義類似要去<code>/users/id/name</code>，因此到範本這裡使用 routerLink 來帶入動態變數。讓我們可以訪問到單項 user 資訊。</p>
<figure class="highlight html"><figcaption><span>users.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/users&#x27;,user.id,user.name]&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">class</span>=<span class="string">&quot;list-group-item&quot;</span></span></span><br><span class="line"><span class="tag">  *<span class="attr">ngFor</span>=<span class="string">&quot;let user of users&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br></pre></td></tr></table></figure>

<p>同樣之前的 servers 元件之 side menu 僅是為了示範直接跳到 edit 模式，這裡協助修正路由適當的位置，</p>
<ul>
<li>從 servers 元件關於列表部份，取消原單一 server 連結的 edit 路徑，使得變成只有訪問單項 server 資訊。之後再適合的動線上再進入 edit 切頁。</li>
<li>app.module 也要設定路徑增加此項。幫助我們訪問單一時帶到 server 元件去。</li>
</ul>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;users/:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServersComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;servers/:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServerComponent</span> &#125;  <span class="comment">//※重點</span></span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;servers/:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>servers.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 拿掉 ,&#x27;edit&#x27; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/servers&#x27;,server.id]&quot;</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">queryParams</span>]=<span class="string">&quot;&#123;allowEdit:1&#125;&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">fragment</span>=<span class="string">&quot;loading&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">class</span>=<span class="string">&quot;list-group-item&quot;</span></span></span><br><span class="line"><span class="tag">  *<span class="attr">ngFor</span>=<span class="string">&quot;let server of servers&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line">  &#123;&#123; server.name &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>現在我們需要當從 server side menu 點選時拜訪單一 server 切頁，將直接 URL 上面獲得 id，並透過 server.service 來進行資料查詢單筆。</p>
<ul>
<li>來到 server 元件我們需要啟用可訪問路由的 ActivatedRoute。</li>
<li>在 OnInit 階段上，透過 ActivatedRoute 來獲得我們的 params 上的 id（層級名稱），拿來提供 server 服務部份所需要的 getServer 參數刷新網頁</li>
<li>同時需要注意 params 因同頁面下的變化，因此需要以訂閱方式來更新我們的 getServer 參數刷新網頁</li>
</ul>
<figure class="highlight ts"><figcaption><span>server.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span>, <span class="title class_">Params</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServersService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../servers.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-server&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./server.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./server.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ServerComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">// server: &#123;id: number, name: string, status: string&#125;;</span></span><br><span class="line">  <span class="attr">server</span>: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">serversService</span>: <span class="title class_">ServersService</span>, <span class="keyword">private</span> <span class="attr">route</span>: <span class="title class_">ActivatedRoute</span></span>) &#123; &#125; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">snapshot</span>.<span class="property">params</span>.<span class="property">id</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">server</span> = <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">getServer</span>(id); <span class="comment">//※重點</span></span><br><span class="line">    <span class="comment">// this.server = this.serversService.getServer(1);</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">params</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">prm</span>: <span class="title class_">Params</span></span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">server</span> = <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">getServer</span>(prm.<span class="property">id</span>); <span class="comment">//※重點</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在有兩個 Bug 我們需要修復，透過畫面來到 servers 頁面 (<code>http://localhost:4200/servers</code>)。這裡出現了以下資訊：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Cannot read properties of null (reading &#x27;name&#x27;) at ServerComponent_Template, ...</span><br></pre></td></tr></table></figure>

<p>這因為原本總列表這裡我們有塞一個 server 元件並提供靜態 serverID 為 1 的示範素材。現在被我們改成將從路由上抓取 id 作為資料處理的一部份，在目前頁面上抓不到就產生不了 server.name 的字串差值。等於我們路由設計不適合這樣被放在 servers 總表的畫面上，可以先註解先拿掉。</p>
<figure class="highlight html"><figcaption><span>servers.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;app-server&gt;&lt;/app-server&gt; --&gt;</span></span><br></pre></td></tr></table></figure>

<p>servers 總列表的畫面正常後，再來是另一個問題，當點選任何 server 進入細節時發生錯誤。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ERROR TypeError: Cannot read properties of null (reading &#x27;name&#x27;) at ServerComponent_Template, ...</span><br></pre></td></tr></table></figure>

<p>這是因為型別錯誤，原因是從 Params 捕捉回來的資料格式全都是 string，而我們 id 的型別為 number 因此這樣指定出現問題。你可以使用很快的方式強迫將 string 轉為 number。在需要的地方前綴增加<code>+</code>符號使得型態轉為數字，也包含訂閱那裏。</p>
<figure class="highlight ts"><figcaption><span>server.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = +<span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">snapshot</span>.<span class="property">params</span>.<span class="property">id</span>;  <span class="comment">//型別 string to number</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">server</span> = <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">getServer</span>(id);</span><br><span class="line">  <span class="comment">// this.server = this.serversService.getServer(1);</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">params</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">prm</span>: <span class="title class_">Params</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">server</span> = <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">getServer</span>(+prm.<span class="property">id</span>); <span class="comment">//型別 string to number</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="嵌套路由-Nesting-Routes"><a href="#嵌套路由-Nesting-Routes" class="headerlink" title="嵌套路由 Nesting Routes"></a>嵌套路由 Nesting Routes</h3><p>舉例 servers 的 side menu 如果可以像 frame 那樣的技術，讓左側選單的是對應對右側<code>&lt;app-edit-server&gt;</code>做路由切換。以及 app.module 設定在 servers 路徑上有點重複。</p>
<figure class="highlight ts"><figcaption><span>app app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;users/:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServersComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;servers/:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServerComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;servers/:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>可透過第三個屬性 children （注意這裡是設定型別為陣列結構）來代表子路由位置進行分組。列入 serversComponent 內的子路由。</p>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;users/:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServerComponent</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>此時檢查頁面，發現所有在 servers 底下的 side menu 的切頁功能會失效，只有 url 變化有成功。還記得我們在 app.component 上的路由動作是在該 app 元件下進行路由導向輸出到<code>&lt;router-outlet&gt;&lt;/router-outlet&gt;</code>位置。而這些子路由則目前在 servers 元件底下，因此我們缺乏一個 servers 子路由所需要的<code>&lt;router-outlet&gt;&lt;/router-outlet&gt;</code>。現在我們需要能切頁到右側就應該這樣處理：</p>
<figure class="highlight html"><figcaption><span>servers.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-sm-4&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list-group&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">        [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/servers&#x27;,server.id]&quot;</span></span></span><br><span class="line"><span class="tag">        [<span class="attr">queryParams</span>]=<span class="string">&quot;&#123;allowEdit:1&#125;&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">fragment</span>=<span class="string">&quot;loading&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;list-group-item&quot;</span></span></span><br><span class="line"><span class="tag">        *<span class="attr">ngFor</span>=<span class="string">&quot;let server of servers&quot;</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        &#123;&#123; server.name &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-sm-4&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-outlet</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;button (click)=&quot;reloadServer()&quot;&gt;Reload Server&lt;/button&gt;</span></span><br><span class="line"><span class="comment">    &lt;app-edit-server&gt;&lt;/app-edit-server&gt;</span></span><br><span class="line"><span class="comment">    &lt;hr&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;app-server&gt;&lt;/app-server&gt; --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>現在請幫忙優化 users 那裏也改成嵌套路由。</p>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServerComponent</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>servers.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-sm-4&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list-group&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">        [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/users&#x27;,user.id,user.name]&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;list-group-item&quot;</span></span></span><br><span class="line"><span class="tag">        *<span class="attr">ngFor</span>=<span class="string">&quot;let user of users&quot;</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        &#123;&#123; user.name &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-sm-4&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;app-user&gt;&lt;/app-user&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-outlet</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="練習使用-Query-參數"><a href="#練習使用-Query-參數" class="headerlink" title="練習使用 Query 參數"></a>練習使用 Query 參數</h3><p>現在試著讓範例的動線更好，我們將 edit server 的功能放置在各自 server 畫面底下。</p>
<ul>
<li>對 server 元件的範本上規劃按鈕並賦予事件綁定為 onEdit。</li>
<li>對 server 元件的 TS 之此方法進行導覽到指定路由位置為<code>/server/id/edit</code>，這需要透過 navigate 達到指令因此我們需要使用到 Router 模組。</li>
<li>前往位置的方式有兩種，你可以重新再寫一次完整路徑，或根據相對目前路徑做延伸。但這兩種都不會協助將原本目前路徑的 query 參數轉向（之後再解決）。</li>
</ul>
<figure class="highlight html"><figcaption><span>server.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h5</span>&gt;</span>&#123;&#123; server.name &#125;&#125;<span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Server status is &#123;&#123; server.status &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">&quot;onEdit()&quot;</span>&gt;</span>Edit Button<span class="tag">&lt;/<span class="name">button</span>&gt;</span>　<span class="comment">&lt;!-- ※重點 --&gt;</span></span><br><span class="line">```  </span><br><span class="line">```ts server.component.ts</span><br><span class="line">import &#123; ActivatedRoute, Params, Router &#125; from &#x27;@angular/router&#x27;; // ※重點</span><br><span class="line">import &#123; Component, OnInit &#125; from &#x27;@angular/core&#x27;;</span><br><span class="line">import &#123; ServersService &#125; from &#x27;../servers.service&#x27;;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: &#x27;app-server&#x27;,</span><br><span class="line">  templateUrl: &#x27;./server.component.html&#x27;,</span><br><span class="line">  styleUrls: [&#x27;./server.component.css&#x27;]</span><br><span class="line">&#125;)</span><br><span class="line">export class ServerComponent implements OnInit &#123;</span><br><span class="line">  // server: &#123;id: number, name: string, status: string&#125;;</span><br><span class="line">  server: any;</span><br><span class="line"></span><br><span class="line">  constructor(</span><br><span class="line">    private serversService: ServersService,</span><br><span class="line">    private route: ActivatedRoute,</span><br><span class="line">    private router: Router</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">    const id = +this.route.snapshot.params.id;</span><br><span class="line">    this.server = this.serversService.getServer(id);</span><br><span class="line"></span><br><span class="line">    this.route.params.subscribe((prm: Params) =&gt; &#123;</span><br><span class="line">      this.server = this.serversService.getServer(+prm.id);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onEdit() &#123; // ※重點</span><br><span class="line">    //目前位置為 /servers/2 ，並自帶參數為 ?allowEdit=1#loading</span><br><span class="line">    // this.router.navigate([&#x27;/servers&#x27;, this.server.id, &#x27;edit&#x27;]);  // 方法一：再指定相同位置路徑寫入</span><br><span class="line">    this.router.navigate([&#x27;edit&#x27;], &#123; relativeTo: this.route &#125;)  //方法二：透過目前的相對位置路徑添加 edit 位置</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再來是舉例<code>?allowEdit=1</code>的 Query 資料進行應用，設計為在某條件下才允許編輯資訊，假設我們靜態指定當 id 為 3 的 server 才能進行編輯 (1 為 true)。回到 servers 元件這裡的 html 部份，這是 allowEdit 一開始出現的地方，符合上句描述。</p>
<figure class="highlight html"><figcaption><span>servers.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/servers&#x27;,server.id]&quot;</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">queryParams</span>]=<span class="string">&quot;&#123;allowEdit:server.id===3?1:0&#125;&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">fragment</span>=<span class="string">&quot;loading&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">class</span>=<span class="string">&quot;list-group-item&quot;</span></span></span><br><span class="line"><span class="tag">  *<span class="attr">ngFor</span>=<span class="string">&quot;let server of servers&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br></pre></td></tr></table></figure>

<p>現在只有第三個 server 的詳細資訊有夾帶<code>?allowEdit=1</code>。試著去在 edit-component 訪問下底下進行判斷，如果持有<code>?allowEdit=1</code>則提供編輯功能否則提示文字。</p>
<figure class="highlight ts"><figcaption><span>edit-server.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span>, <span class="title class_">Params</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;  <span class="comment">//※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServersService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../servers.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-edit-server&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./edit-server.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./edit-server.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">EditServerComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">// server: &#123; id: number, name: string, status: string &#125;;</span></span><br><span class="line">  <span class="attr">server</span>: <span class="built_in">any</span>;</span><br><span class="line">  serverName = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  serverStatus = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  allowEdit = <span class="literal">false</span>; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">serversService</span>: <span class="title class_">ServersService</span>, <span class="keyword">private</span> <span class="attr">route</span>: <span class="title class_">ActivatedRoute</span></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// console.log(this.router.snapshot.fragment);</span></span><br><span class="line">    <span class="comment">// console.log(this.router.snapshot.queryParams);</span></span><br><span class="line">    <span class="comment">// this.router.fragment.subscribe(e =&gt; console.log(e));</span></span><br><span class="line">    <span class="comment">// this.router.queryParams.subscribe(e =&gt; console.log(e));</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">queryParams</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">params</span>: <span class="title class_">Params</span></span>) =&gt;</span> &#123; <span class="comment">//※重點</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">allowEdit</span> = params.<span class="property">allowEdit</span> === <span class="string">&#x27;1&#x27;</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if (this.serversService.getServer(1) !== null) </span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">server</span> = <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">getServer</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serverName</span> = <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">name</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serverStatus</span> = <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">status</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onUpdateServer</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">updateServer</span>(<span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">id</span>, &#123; <span class="attr">name</span>: <span class="variable language_">this</span>.<span class="property">serverName</span>, <span class="attr">status</span>: <span class="variable language_">this</span>.<span class="property">serverStatus</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後來到 edit-server 元件的範本，透過 ngIf 來評估是否呈現編輯元素或提示字。</p>
<figure class="highlight html"><figcaption><span>edit-server.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h4</span> *<span class="attr">ngIf</span>=<span class="string">&quot;!allowEdit&quot;</span>&gt;</span>You&#x27;re not not allow to edit!<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span> *<span class="attr">ngIf</span>=<span class="string">&quot;allowEdit&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Server Name<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;text&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">id</span>=<span class="string">&quot;name&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">      [(<span class="attr">ngModel</span>)]=<span class="string">&quot;serverName&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;status&quot;</span>&gt;</span>Server Status<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span></span></span><br><span class="line"><span class="tag">      <span class="attr">id</span>=<span class="string">&quot;status&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">      [(<span class="attr">ngModel</span>)]=<span class="string">&quot;serverStatus&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;online&quot;</span>&gt;</span>Online<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;offline&quot;</span>&gt;</span>Offline<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span></span></span><br><span class="line"><span class="tag">    (<span class="attr">click</span>)=<span class="string">&quot;onUpdateServer()&quot;</span></span></span><br><span class="line"><span class="tag">  &gt;</span>Update Server<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>最後來修正如何讓 navigate 可以夾帶目前的 query 參數。來到消失前的關鍵按鈕動作位於 server 元件的 onEdit() 部份。主要為讓 navigate 協助導覽時，在第二參數多一個屬性為 queryParamsHandling 並提供字串保留，你可以要求舊值處理。 選 preserve 則為只用舊值，選 merge 則為與新值合併。</p>
<figure class="highlight ts"><figcaption><span>server.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">onEdit</span>(<span class="params"></span>) &#123; <span class="comment">// ※重點</span></span><br><span class="line">  <span class="comment">//目前位置為 /servers/2 ，並自帶參數為 ?allowEdit=1#loading</span></span><br><span class="line">  <span class="comment">// this.router.navigate([&#x27;/servers&#x27;, this.server.id, &#x27;edit&#x27;]);  // 方法一</span></span><br><span class="line">  <span class="comment">// this.router.navigate([&#x27;edit&#x27;], &#123; relativeTo: this.route &#125;)  //方法二：使用相對目前位置路徑添加 edit 位置</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;edit&#x27;</span>], &#123;</span><br><span class="line">    <span class="attr">relativeTo</span>: <span class="variable language_">this</span>.<span class="property">route</span>,</span><br><span class="line">    <span class="attr">queryParamsHandling</span>: <span class="string">&#x27;preserve&#x27;</span>　<span class="comment">// ※重點　</span></span><br><span class="line">  &#125;)  <span class="comment">//可合併原本的 query params</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note warning"><p><strong>科普知識：preserve 與 merge</strong><br>queryParamsHandling 是一個選項，用於設置在導航時如何處理查詢參數。當我們進行導航時，通常會帶有查詢參數，這些參數可以用於過濾、排序、分頁等操作。而 queryParamsHandling 選項可以控制這些查詢參數在導航時的行為。</p>
<p>queryParamsHandling 選項有三個值：</p>
<ul>
<li>‘merge’：合併新的查詢參數和現有的查詢參數。如果有相同的參數，則新的查詢參數值將覆蓋現有的查詢參數值。</li>
<li>‘preserve’：保留現有的查詢參數，並忽略新的查詢參數。這意味著，如果你將路由導航到具有新的查詢參數的頁面，但使用’preserve’選項，則新的查詢參數將被忽略，頁面將仍然顯示現有的查詢參數。</li>
<li>null：清除現有的查詢參數，並使用新的查詢參數。這意味著，如果你將路由導航到具有新的查詢參數的頁面，但使用 null 選項，則現有的查詢參數將被清除，並使用新的查詢參數。</li>
</ul>
<p>根據這兩者的應用如下，假設你目前位置為<code>/firstUrl?name=bat7</code>要跳到<code>/secondUrl</code>：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/secondUrl&#x27;</span>], &#123; <span class="attr">queryParamsHandling</span>: <span class="string">&#x27;preserve&#x27;</span> &#125;);</span><br><span class="line"><span class="comment">// like this http://localhost:4200/secondUrl?name=bat7</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/secondUrl/newVal&#x27;</span>], &#123; <span class="attr">queryParams</span>: &#123; <span class="attr">age</span>: <span class="string">&#x27;not-known&#x27;</span>&#125;, <span class="attr">queryParamsHandling</span>: <span class="string">&#x27;merge&#x27;</span> &#125;);</span><br><span class="line"><span class="comment">//http://localhost:4200/secondUrl?name=bat7&amp;age=not-known</span></span><br></pre></td></tr></table></figure></div>

<h2 id="路由重新導向"><a href="#路由重新導向" class="headerlink" title="路由重新導向"></a>路由重新導向</h2><p>你可以指定當用戶輸入無效的位置時，進行重新導向到像似 page 404 之類的動作。先手動添加一個新元件命名為 page-not-found 並規劃範本為簡單的文字說明</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ng g c page-not-found</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>page-not-found.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>THIS PAGE WAS NO FOUND<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再來是來到 app.module.ts 來註冊這個預設路由位置。同時再多新增一個測試用的位置，透過 redirectTo 帶往到這個 404 位置。</p>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServerComponent</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;404&#x27;</span>, <span class="attr">component</span>: <span class="title class_">PageNotFoundComponent</span> &#125;,<span class="comment">// ※重點　</span></span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;try&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/404&#x27;</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>測試 404 與 try 最後都是在 404 的畫面，這就是重新導向的做法。如果你需要排除已知以外的路徑都要導向到 404，可使用<code>**</code>通用字符來代表。需注意位置順序，由上優先到下解析。因此必需要放在陣列處最後一組，當都找不到適合的路由會以最後找到的為設定。</p>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServerComponent</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;404&#x27;</span>, <span class="attr">component</span>: <span class="title class_">PageNotFoundComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;**&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/404&#x27;</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<div class="note danger"><p><strong>新手陷阱：pathMatch&#x3D;’prefix’</strong><br>Angular 所有路由的 pathMatch 參數其預設值為 prefix，這代表會參考前綴符號來查找。舉例來說</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;404&#x27;</span>, <span class="attr">component</span>: <span class="title class_">PageNotFoundComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/404&#x27;</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>會發生跳轉到 404 的組合為只要網址如下例有 a 的分類都會跳轉。</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">http://localhost:4200/a</span><br><span class="line">http://localhost:4200/a/b</span><br><span class="line">http://localhost:4200/a/b/c</span><br></pre></td></tr></table></figure>

<p>因此，如果你希望只有<code>/a</code>的位置會跳轉而後綴其他位置不影響，你需要綁定為 full 作為匹配範圍</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;404&#x27;</span>, <span class="attr">component</span>: <span class="title class_">PageNotFoundComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/404&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>而危險的動作是，如果你這樣設計寫法為任何網頁都會是要去 404，但想停留在 404 時連自己也找不到。因為整個都被覆蓋了</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;404&#x27;</span>, <span class="attr">component</span>: <span class="title class_">PageNotFoundComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/404&#x27;</span>&#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure></div>

<h2 id="路由配置的檔案-app-routing-module-ts"><a href="#路由配置的檔案-app-routing-module-ts" class="headerlink" title="路由配置的檔案 app-routing.module.ts"></a>路由配置的檔案 app-routing.module.ts</h2><p>如果你的路由設定非常的多都寫在 app.module.ts 是不健康的，一般作法會將路由相關配置獨立一個檔案在外部。在 CLI 協助建立專案過程中特別詢問你是否要建立 Routing 如果你確定（假設專案名取為 app) 則會多產生一隻 app-routing.module.ts，並幫你添加到 app.module.ts 內。</p>
<p>你可以事後要求產生模組檔案並提供這兩支給你。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ng generate module loki --routing</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">same ng g m loki --routing</span></span><br></pre></td></tr></table></figure>

<p>請手動新增檔案<code>app-routing.module.ts</code>位於相對<code>app.module.ts</code>位置參考這兩隻檔案進行初步整理。或參考以下初始檔案跟著動作：</p>
<figure class="highlight ts"><figcaption><span>app-routing.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppRoutingModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>將 const lokiRoutes 等路由資料，從 app.module.ts 搬移至 app-routing.module.ts 檔內。</li>
<li>利用修復工具快速將所有遺失的元件宣告來源補回來。</li>
<li>找到原本 app.module.ts 內的 imports 部分，試著搬移 RouterModule 的資訊</li>
<li>同時要添加 exports 將這個路由模駔輸出。</li>
<li>回到 app.module.ts 需要將 AppRoutingModule 宣告。</li>
<li>現在路由模組名字換成這裡要 import 模組進來。</li>
<li>最後測試一下有無成功。</li>
</ul>
<figure class="highlight ts"><figcaption><span>app-routing.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RouterModule</span>, <span class="title class_">Routes</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HomeComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./home/home.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PageNotFoundComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./page-not-found/page-not-found.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">EditServerComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./servers/edit-server/edit-server.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServerComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./servers/server/server.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServersComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./servers/servers.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./users/user/user.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UsersComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./users/users.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServerComponent</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;404&#x27;</span>, <span class="attr">component</span>: <span class="title class_">PageNotFoundComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;**&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/404&#x27;</span> &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">RouterModule</span>.<span class="title function_">forRoot</span>(lokiRoutes)</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">RouterModule</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppRoutingModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/platform-browser&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FormsModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HomeComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./home/home.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UsersComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./users/users.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServersComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./servers/servers.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./users/user/user.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">EditServerComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./servers/edit-server/edit-server.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServerComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./servers/server/server.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServersService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./servers/servers.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PageNotFoundComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./page-not-found/page-not-found.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppRoutingModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app-routing.module&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [</span><br><span class="line">    <span class="title class_">AppComponent</span>,</span><br><span class="line">    <span class="title class_">HomeComponent</span>,</span><br><span class="line">    <span class="title class_">UsersComponent</span>,</span><br><span class="line">    <span class="title class_">ServersComponent</span>,</span><br><span class="line">    <span class="title class_">UserComponent</span>,</span><br><span class="line">    <span class="title class_">EditServerComponent</span>,</span><br><span class="line">    <span class="title class_">ServerComponent</span>,</span><br><span class="line">    <span class="title class_">PageNotFoundComponent</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">BrowserModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">    <span class="title class_">AppRoutingModule</span> <span class="comment">//※重點</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">ServersService</span>],</span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Guards-路由守衛"><a href="#Guards-路由守衛" class="headerlink" title="Guards 路由守衛"></a>Guards 路由守衛</h2><p>路由守衛（Guards）是一種機制，用於保護路由的訪問權限。守衛可以檢查用戶是否有權限訪問某個路由，如果用戶沒有權限，則可以阻止路由的訪問或重定向到其他頁面。Angular 提供了幾種不同類型的守衛，這些守衛都是實現了對應接口的類別，它們在路由的定義中可以作為路由守衛：</p>
<ul>
<li>CanActivate：用於防止進入路由。</li>
<li>CanActivateChild：用於防止進入子路由。</li>
<li>CanDeactivate：用於防止離開路由。</li>
<li>Resolve：用於在進入路由前解決必要的數據。</li>
</ul>
<p>因此，當你要進行路由加載之前以及離開路由之前可以進行一系列的動作前置，舉例來說在範例上來到 server 列表之中可以選擇單一 server 進行編輯，在進入這個路由之前進行用戶身分認證的功能。而不是透過元件初始化階段 onInit 階段進行檢查。守衛本身只是一個服務上的系列動作之設計，主要仍回歸使用內建函式 CanActivate 與 CanDeactivate 返還給我們的資料去達到路由進出的控制。</p>
<h3 id="CanActivate-許可路由進入"><a href="#CanActivate-許可路由進入" class="headerlink" title="CanActivate 許可路由進入"></a>CanActivate 許可路由進入</h3><p>要使用守衛方式透過自建服務並透過 CanActivate 來自訂守衛。服務添加的使用方式與其他一般服務添加方式一致。</p>
<ul>
<li>在跟目錄下新增服務檔案或 CLI 指令<code>ng g s auth-guard</code>。獲得<code>auth-guard.service.ts</code></li>
<li>接著我們需要對 CanActivate 這隻模組做宣告載入 implements 介面使用，並使用固定命稱 canActivate 方法且本身會吃兩個參數。</li>
<li>在該函式規劃一參數自訂名為 route 作為路由已啟用之快照，並指定為 ActivatedRouteSnapshot 型別。 </li>
<li>在該函式規劃一參數自訂名為 state 作為路由狀態之快照，並指定為 RouteStateSnapshot 型別。 </li>
<li>整個 CanActivate 函式會回傳一個 Observable 可觀察對象，因此要確保該型別為 Observable，同時這個 Observable 會包含一個 Boolean 值。另外一種可能會回傳一個 Promise，Promise 會包含 Boolean 值，也可能直接回傳一個 Boolean。因此我們有三種回傳的型別可能。</li>
</ul>
<blockquote>
<p>以上規畫皆固定，可參考複製於官方的 <a target="_blank" rel="noopener" href="https://angular.tw/api/router/CanActivate#canActivate">canActivate 結構說明</a>。</p>
</blockquote>
<figure class="highlight ts"><figcaption><span>auth-guard.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRouteSnapshot</span>, <span class="title class_">CanActivate</span>, <span class="title class_">RouterStateSnapshot</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthGuardService</span> <span class="keyword">implements</span> <span class="title class_">CanActivate</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">canActivate</span>(<span class="attr">route</span>: <span class="title class_">ActivatedRouteSnapshot</span>, <span class="attr">state</span>: <span class="title class_">RouterStateSnapshot</span>): <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="built_in">boolean</span>&#123;</span><br><span class="line">    <span class="comment">//something</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們希望做一個能登入登出功能，因此規劃另一個服務作為身分認證使用，命名為 <code>auth.service.ts</code> ，這裡只是測試實際工作上會連線到後端進行登入登出並檢查當前的身分狀態。</p>
<ul>
<li>可透過 CLI 進行<code>ng g s auth</code>，獲得該檔案。</li>
<li>規劃區域屬性 loggedIn 為 false 代表未登入，方法 login() 能改此為 true，方法 logout() 能改此為 false。</li>
<li>規劃 isAuthenticated() 方法，這是為了假裝是跟後端諮詢登入狀態，利用 Promise 並延遲 1 秒後回傳告知登入狀態初始為 false，整個服務範圍都是為了假裝跟後端拿登入的布林值。</li>
</ul>
<figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line">  loggedIn = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">isAuthenticated</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(</span><br><span class="line">      <span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">res</span>(<span class="variable language_">this</span>.<span class="property">loggedIn</span>);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loggedIn</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loggedIn</span> = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在已模擬一個假後端的服務，透過這個服務能一秒後告知我們用戶的登入狀態為何，我們將利用到這個 auth-guard 服務，因此需要設定注入添加到 auth-guard 內。讓 auth 服務能注入到這個守衛服務。現在能在 AuthGround 的建構函式來私有化使用</p>
<ul>
<li>對 auth-ground.service 添加<code>@Injectable()</code></li>
<li>宣告匯入 AuthService 這支服務</li>
<li>同時規劃一 authService 私有屬性到 constructor，並指定 AuthService 型別</li>
<li>來到 canActivate() 方法內，找到 authService 屬性內的 isAuthenticated() 告知我們登入狀態，因為 isAuthenticated() 本身是 promise 所以用 then 來後續處理。</li>
<li>在 then 裡面透過判斷是否登入並回傳布林值到 canActivate()，同時如果未登入 false 利用 router.navigate 導向到首頁去。</li>
<li>最後 canActivate() 本身也要回傳出去，所以將這個 boolean 再回傳出去。</li>
</ul>
<figure class="highlight ts"><figcaption><span>auth-ground.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRouteSnapshot</span>, <span class="title class_">CanActivate</span>, <span class="title class_">Router</span>, <span class="title class_">RouterStateSnapshot</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthGuardService</span> <span class="keyword">implements</span> <span class="title class_">CanActivate</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">authService</span>: <span class="title class_">AuthService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">router</span>: <span class="title class_">Router</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">canActivate</span>(<span class="attr">route</span>: <span class="title class_">ActivatedRouteSnapshot</span>, <span class="attr">state</span>: <span class="title class_">RouterStateSnapshot</span>): <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="comment">//something</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">isAuthenticated</span>().<span class="title function_">then</span>(</span><br><span class="line">      <span class="function">(<span class="params"><span class="attr">value</span>:<span class="built_in">boolean</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">        <span class="keyword">if</span> (value) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/&#x27;</span>]);</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在已設計完守衛的功能，就看是要在哪裡使用守衛服務。來到定義路由的 app.routing.module 這裡試著將守衛服務放入到路由內，使得路由執行前能觸發守衛。</p>
<ul>
<li>對想要守衛服務的路徑設定上，插入屬性為 canActive 值為 Boolean。範例這裡是對 servers 這支作業，其子路由也會吃到這個守衛。</li>
<li>現在透過除非 AuthGuardService 回傳 true，這個 servers 路徑才能被訪問。</li>
<li>以及需要到 app.module 這裡將這個兩隻服務放入到 providers 內。</li>
</ul>
<figure class="highlight ts"><figcaption><span>app-routing.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>, <span class="attr">canActivate</span>: [<span class="title class_">AuthGuardService</span>], <span class="attr">component</span>: <span class="title class_">ServersComponent</span>, <span class="attr">children</span>: [ <span class="comment">//※重點</span></span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServerComponent</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;404&#x27;</span>, <span class="attr">component</span>: <span class="title class_">PageNotFoundComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;**&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/404&#x27;</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthGuardService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth-guard.service&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [</span><br><span class="line">    <span class="title class_">AppComponent</span>,</span><br><span class="line">    <span class="title class_">HomeComponent</span>,</span><br><span class="line">    <span class="title class_">UsersComponent</span>,</span><br><span class="line">    <span class="title class_">ServersComponent</span>,</span><br><span class="line">    <span class="title class_">UserComponent</span>,</span><br><span class="line">    <span class="title class_">EditServerComponent</span>,</span><br><span class="line">    <span class="title class_">ServerComponent</span>,</span><br><span class="line">    <span class="title class_">PageNotFoundComponent</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">BrowserModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">    <span class="title class_">AppRoutingModule</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    <span class="title class_">ServersService</span>,</span><br><span class="line">    <span class="title class_">AuthService</span>,  <span class="comment">//※重點</span></span><br><span class="line">    <span class="title class_">AuthGuardService</span>  <span class="comment">//※重點</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="CanActivateChild-許可子路由進入"><a href="#CanActivateChild-許可子路由進入" class="headerlink" title="CanActivateChild 許可子路由進入"></a>CanActivateChild 許可子路由進入</h3><p>現在服務已被設定給整份 app，在還沒呼喚 login() 之前，因為初始為 false 現在會拒絕我們訪問整個 servers 路由與子路由。現在試著從 users 位置點選 servers 位置是否一秒後轉回首頁。目前設計為適合要阻擋整個 servers 路徑，但如果只想阻擋在內部下層的 path 路徑上，你可以剪貼到下層各自的 path 去，但還有更好的方法為 CanActivateChild，它能設定在父路由上，使得子路由都會吃到這個守衛設定。</p>
<ul>
<li>來到 auth-guard.service 這裡，多一組介面為 CanActivateChild。</li>
<li>同 canActivate() 結構，多做一份固定名稱 canActivateChild() 結構一致。而 return 的項目為依賴 canActive 動作即可。將獲得的兩參數轉給 canActive。</li>
</ul>
<figure class="highlight ts"><figcaption><span>auth-guard.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRouteSnapshot</span>, <span class="title class_">CanActivate</span>, <span class="title class_">CanActivateChild</span>, <span class="title class_">Router</span>, <span class="title class_">RouterStateSnapshot</span>, <span class="title class_">UrlTree</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthGuardService</span> <span class="keyword">implements</span> <span class="title class_">CanActivate</span>, <span class="title class_">CanActivateChild</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">authService</span>: <span class="title class_">AuthService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">router</span>: <span class="title class_">Router</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">canActivate</span>(<span class="attr">route</span>: <span class="title class_">ActivatedRouteSnapshot</span>, <span class="attr">state</span>: <span class="title class_">RouterStateSnapshot</span>): <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="comment">//something</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">isAuthenticated</span>().<span class="title function_">then</span>(</span><br><span class="line">      <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">        <span class="keyword">if</span> (value) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/&#x27;</span>]);</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">canActivateChild</span>(<span class="attr">childRoute</span>: <span class="title class_">ActivatedRouteSnapshot</span>, <span class="attr">state</span>: <span class="title class_">RouterStateSnapshot</span>): <span class="built_in">boolean</span> | <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;  <span class="comment">//※重點</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">canActivate</span>(childRoute, state);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再回到 app-routing.module 這裡，現在不使用 canActivate 而是使用 canActivateChild。</p>
<figure class="highlight ts"><figcaption><span>app-routing.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>,</span><br><span class="line">    <span class="comment">// canActivate: [AuthGuardService],</span></span><br><span class="line">    <span class="attr">canActivateChild</span>: [<span class="title class_">AuthGuardService</span>], <span class="comment">//※重點</span></span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">ServersComponent</span>,</span><br><span class="line">    <span class="attr">children</span>: [ </span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServerComponent</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;404&#x27;</span>, <span class="attr">component</span>: <span class="title class_">PageNotFoundComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;**&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/404&#x27;</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>現在只有這底下的子路由才會受阻擋。現在你學會阻擋整個路由或是侷限在子路由的阻擋。</p>
<h4 id="模擬已登入效果"><a href="#模擬已登入效果" class="headerlink" title="模擬已登入效果"></a>模擬已登入效果</h4><p>現在要模擬登入後的守衛狀態，來到 home 元件這裡的範本規劃兩組按鈕登入登出。再來到 ts 這裡將我們的 AuthService 私有實例介面化才能使用 login 與 logout 改變布林值。</p>
<figure class="highlight html"><figcaption><span>home.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-success&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onLogin()&quot;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-danger&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onLogout()&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>home.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../auth.service&#x27;</span>;<span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-home&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./home.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./home.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HomeComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">lokiRouter</span>: <span class="title class_">Router</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">authService</span>: <span class="title class_">AuthService</span> <span class="comment">//※重點</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">loadServers</span>(<span class="params"><span class="attr">id</span>: <span class="built_in">number</span></span>) &#123;  <span class="comment">//※重點</span></span><br><span class="line">    <span class="comment">// this.lokiRouter.navigate([&#x27;/servers&#x27;]);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lokiRouter</span>.<span class="title function_">navigate</span>(</span><br><span class="line">      [<span class="string">&#x27;/servers&#x27;</span>, id, <span class="string">&#x27;edit&#x27;</span>],</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">queryParams</span>: &#123;</span><br><span class="line">          <span class="attr">allowEdit</span>: <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">fragment</span>: <span class="string">&quot;loading&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onLogin</span>(<span class="params"></span>) &#123; <span class="comment">//※重點</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">login</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onLogout</span>(<span class="params"></span>) &#123; <span class="comment">//※重點</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">logout</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在你擬透過 login 切換布林值來獲得 servers 底下子路由的權限。</p>
<h3 id="canDeactivate-許可路由離開"><a href="#canDeactivate-許可路由離開" class="headerlink" title="canDeactivate 許可路由離開"></a>canDeactivate 許可路由離開</h3><p>現在可以來討論如何控制目前路由是否允許你離開。例如進行表單編輯當下不小心操作到離開頁面，就能提醒住戶表單資料未送出或是否取消等設計。防止住戶進行意料之外的路由導航。</p>
<ul>
<li>規劃新服務為 deactivate-guard，可利用 CLI 指令<code>ng g s deactivate-guard</code>完成，這支檔案我們放置在 edit-server 的目錄下只有這裡會用到。</li>
<li>同樣需要規劃 CanDeactivate 這隻模組做宣告載入 implements 介面使用，並使用固定名稱來調用 canDeactivate 方法且本身會回傳三個可能 (Observable、Promise、Boolean)。</li>
<li>由於之後會使用到這個型別模型 (canDeactivate 使用方法），因此規劃成 interface 型別介面並命名為 ComponentNameComponent。</li>
<li>這支 DeactivateGuardService 服務先合併基礎的 ComponentNameComponent 型別資料 (Observable、Promise、Boolean)</li>
<li>canDeactivate 的四個參數：<ul>
<li>第一個參數為告知目前所在的元件，且需要 ComponentNameComponent 的型別。</li>
<li>第二參數為當前路由為何，可透過 ActivatedRouteSnapshot 獲得型別。</li>
<li>第三參數為當前狀態為何，可透過 RouterStateSnapshot 獲得型別。</li>
<li>第四參數（非必要）為下一路由為何，也可透過 ActivatedRouteSnapshot 獲得型別。</li>
</ul>
</li>
<li>這隻 canDeactivate 為可觀察的，能回傳 Observable 的 boolean 或 Promise 的 boolean 或 boolean。</li>
<li>最後 canDeactivate 會回傳我們當前元件的調用 canDeactivate 結果。</li>
</ul>
<blockquote>
<p>以上規畫皆固定，可參考複製官方對於 <a target="_blank" rel="noopener" href="https://angular.tw/api/router/CanActivate#canActivate">canDeactivate 結構</a> 說明。或使用 VSCode 關鍵字生成做參考。</p>
</blockquote>
<figure class="highlight ts"><figcaption><span>deactivate-guard.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRouteSnapshot</span>, <span class="title class_">CanDeactivate</span>, <span class="title class_">RouterStateSnapshot</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ComponentNameComponent</span> &#123;</span><br><span class="line">  <span class="attr">canDeactivate</span>: <span class="function">() =&gt;</span> <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DeactivateGuardService</span> <span class="keyword">implements</span> <span class="title class_">CanDeactivate</span>&lt;<span class="title class_">ComponentNameComponent</span>&gt; &#123;</span><br><span class="line">  <span class="title function_">canDeactivate</span>(</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">ComponentNameComponent</span>,</span><br><span class="line">    <span class="attr">currentRoute</span>: <span class="title class_">ActivatedRouteSnapshot</span>,</span><br><span class="line">    <span class="attr">currentState</span>: <span class="title class_">RouterStateSnapshot</span>,</span><br><span class="line">    nextStat?:<span class="title class_">RouterStateSnapshot</span></span><br><span class="line">  ): <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> component.<span class="title function_">canDeactivate</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在離開檢查工具服務已設計完成，就剩下你需要在哪個路由 path 上套用這個路由離開守衛，以及如何去接收這個布林值做想做的事情。回到 app-routing 的路由設定模組這。</p>
<ul>
<li>這裡我們假定只有當編譯 server 時未送出前離開需要做守衛阻擋。指定參數為 canDeactivate 而值對應某類別下同名的函式。</li>
</ul>
<figure class="highlight ts"><figcaption><span>app-routing.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DeactivateGuardService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./servers/edit-server/deactivate-guard.service&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>,</span><br><span class="line">    <span class="comment">// canActivate: [AuthGuardService],</span></span><br><span class="line">    <span class="attr">canActivateChild</span>: [<span class="title class_">AuthGuardService</span>],</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">ServersComponent</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServerComponent</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span>, <span class="attr">canDeactivate</span>: [<span class="title class_">DeactivateGuardService</span>] &#125; <span class="comment">//※重點：增加 canDeactivate</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;404&#x27;</span>, <span class="attr">component</span>: <span class="title class_">PageNotFoundComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;**&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/404&#x27;</span> &#125;</span><br><span class="line">];</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p>現在守衛已經在指定的 edit-server 頁面上執行，但可不可以批准的布林值我們還沒設計出來。因此現在對 server 3 進行編輯時無法離開路由且報錯。</p>
<h4 id="設計提示離開效果"><a href="#設計提示離開效果" class="headerlink" title="設計提示離開效果"></a>設計提示離開效果</h4><p>現在我們要來設計當此頁面離開時，經檢查提供用戶是否確定要離開。為了確保元件能讀到 Service 我們到 App.module 底下宣告該 Deactivate 能被所有元件使用到。</p>
<figure class="highlight ts"><figcaption><span>app.moudle.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DeactivateGuardService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./servers/edit-server/deactivate-guard.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [</span><br><span class="line">    <span class="title class_">AppComponent</span>,</span><br><span class="line">    <span class="title class_">HomeComponent</span>,</span><br><span class="line">    <span class="title class_">UsersComponent</span>,</span><br><span class="line">    <span class="title class_">ServersComponent</span>,</span><br><span class="line">    <span class="title class_">UserComponent</span>,</span><br><span class="line">    <span class="title class_">EditServerComponent</span>,</span><br><span class="line">    <span class="title class_">ServerComponent</span>,</span><br><span class="line">    <span class="title class_">PageNotFoundComponent</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">BrowserModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">    <span class="title class_">AppRoutingModule</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    <span class="title class_">ServersService</span>, </span><br><span class="line">    <span class="title class_">AuthService</span>, </span><br><span class="line">    <span class="title class_">AuthGuardService</span>, </span><br><span class="line">    <span class="title class_">DeactivateGuardService</span> <span class="comment">//※重點</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>回到我們需要會調用這個 Deactivate 功能的對象也就是 edit-server 元件，對其進行 implements 工具化整合入內，這樣我們才能在這個元件內使用 canDeactivate 模組。接著對該模組直接操作提供可觀察的結果布林值。這樣 app-routing 那裏會得到對應的布林值允許離開 (true) 或不離開 (false)</p>
<figure class="highlight ts"><figcaption><span>edit-server.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DeactivateGuardService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./deactivate-guard.service&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span>, <span class="title class_">Params</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServersService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../servers.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">EditServerComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span>, <span class="title class_">DeactivateGuardService</span> &#123; <span class="comment">//※重點：套入 DeactivateGuardService</span></span><br><span class="line">  <span class="comment">// server: &#123; id: number, name: string, status: string &#125;;</span></span><br><span class="line">  <span class="attr">server</span>: <span class="built_in">any</span>;</span><br><span class="line">  serverName = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  serverStatus = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  allowEdit = <span class="literal">false</span>;</span><br><span class="line">  changesSave = <span class="literal">false</span>; <span class="comment">//※重點，還沒有設計判斷是否改變，這裡是假靜態</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">serversService</span>: <span class="title class_">ServersService</span>, <span class="keyword">private</span> <span class="attr">route</span>: <span class="title class_">ActivatedRoute</span></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// console.log(this.router.snapshot.fragment);</span></span><br><span class="line">    <span class="comment">// console.log(this.router.snapshot.queryParams);</span></span><br><span class="line">    <span class="comment">// this.router.fragment.subscribe(e =&gt; console.log(e));</span></span><br><span class="line">    <span class="comment">// this.router.queryParams.subscribe(e =&gt; console.log(e));</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">queryParams</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">params</span>: <span class="title class_">Params</span></span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">allowEdit</span> = params.<span class="property">allowEdit</span> === <span class="string">&#x27;1&#x27;</span> ? <span class="literal">true</span> : <span class="literal">false</span>; </span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if (this.serversService.getServer(1) !== null) </span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">server</span> = <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">getServer</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serverName</span> = <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">name</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serverStatus</span> = <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">status</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onUpdateServer</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">updateServer</span>(<span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">id</span>, &#123; <span class="attr">name</span>: <span class="variable language_">this</span>.<span class="property">serverName</span>, <span class="attr">status</span>: <span class="variable language_">this</span>.<span class="property">serverStatus</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">canDeactivate</span>(): <span class="built_in">boolean</span> | <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123; <span class="comment">//※重點：當路由離開時，方法名稱為 DeactivateGuardService 內所寫的名稱 canDeactivate</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">allowEdit</span>) <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">//如果不允許編輯則可離開</span></span><br><span class="line">    <span class="comment">// 如果某欄位有修改且發生變化</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">serverName</span> != <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">name</span> || <span class="variable language_">this</span>.<span class="property">serverStatus</span> != <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">status</span> &amp;&amp; !<span class="variable language_">this</span>.<span class="property">changesSave</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">confirm</span>(<span class="string">&#x27;Do you want leave page?&#x27;</span>);  <span class="comment">//如果住戶回復 yes 會得到 true 而離開 false 則不能離開</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">//沒有改變，可以離開</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最後順手更新原本的靜態 id&#x3D;1 為動態，id 來自於路由 route 的快照內可獲得（網址參數），注意的是之前已提過自串轉數字的作法。</p>
<figure class="highlight ts"><figcaption><span>edit-server.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">queryParams</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">params</span>: <span class="title class_">Params</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">allowEdit</span> = params.<span class="property">allowEdit</span> === <span class="string">&#x27;1&#x27;</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if (this.serversService.getServer(1) !== null)</span></span><br><span class="line">  <span class="keyword">const</span> id = <span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">snapshot</span>.<span class="property">params</span>.<span class="property">id</span>;  <span class="comment">//※重點</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">server</span> = <span class="variable language_">this</span>.<span class="property">serversService</span>.<span class="title function_">getServer</span>(+id); <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">serverName</span> = <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">name</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">serverStatus</span> = <span class="variable language_">this</span>.<span class="property">server</span>.<span class="property">status</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>現在才是正確載入 server 3 原有資料，而 server1 與 2 因沒有開放 allowEdit 仍無法登入。</p>
<h3 id="路由底下的-data-屬性資料傳遞"><a href="#路由底下的-data-屬性資料傳遞" class="headerlink" title="路由底下的 data 屬性資料傳遞"></a>路由底下的 data 屬性資料傳遞</h3><p>在 Angular 路由中，可以使用 data 屬性來傳遞靜態資料。這些資料是定義在路由配置物件中的屬性，可以在路由的任何地方使用，包括路由守衛和元件中。我們可以透過路由來獲得資料，而不透過網址參數來獲得。可用在一些 404 錯誤的頁面上，網址是乾淨的但是 404 元件能從路由那裏獲得一些 data 進行字串插植到畫面上顯示特定文字。</p>
<h4 id="靜態數據示範"><a href="#靜態數據示範" class="headerlink" title="靜態數據示範"></a>靜態數據示範</h4><p>先從簡單開始，試著從路由取得固定的字串到畫面上。</p>
<ul>
<li>來到 page-not-found.ts 代碼規劃新屬性為 errorMessage。</li>
<li>來到 page-not-found.html 範本上做字串差值輸出。</li>
<li>由於靜態資料是固定的，所以可以把資料寫在 app-routing 模組。透過屬性 data 其值格式為物件</li>
</ul>
<figure class="highlight ts"><figcaption><span>page-not-found.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">PageNotFoundComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="attr">errorMessage</span>: <span class="built_in">string</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>page-not-found.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;errorMessage&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>app-routing.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// &#123; path: &#x27;404&#x27;, component: PageNotFoundComponent &#125;,</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;404&#x27;</span>, <span class="attr">component</span>: <span class="title class_">PageNotFoundComponent</span>, <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&quot;you miss the way....&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>回到 page-not-found 元件，現在能從 ActivateRoute 來獲得這 data 屬性資料。一樣這裡有兩種方法，你需要知道兩者執行上的差異在於：</p>
<ul>
<li>如果路由沒有發生變化也就是同頁面露由觸發，快照不會感應到 data 有變化。</li>
<li>對 data 進行可觀察對象，這樣一旦發生變化就會立即更新。可用於同頁面路由。（但對本範例的靜態資料來說 data 不會變所以這兩招都沒差。)</li>
</ul>
<figure class="highlight ts"><figcaption><span>page-not-found.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span>, <span class="title class_">Data</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-page-not-found&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./page-not-found.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./page-not-found.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">PageNotFoundComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="attr">errorMessage</span>: <span class="built_in">string</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">route</span>:<span class="title class_">ActivatedRoute</span></span>)&#123;&#125; <span class="comment">//※重點：引用 router</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// this.errorMessage = this.route.snapshot.data.message;  //方法一</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">data</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">data</span>: <span class="title class_">Data</span></span>) =&gt;</span> &#123;  <span class="comment">// 方法二：建議</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">errorMessage</span> = data.<span class="property">message</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="動態數據透過-Resolve-守衛"><a href="#動態數據透過-Resolve-守衛" class="headerlink" title="動態數據透過 Resolve 守衛"></a>動態數據透過 Resolve 守衛</h4><p>動態數據的用途在於，能否在新路由渲染出來之前就開始獲取。舉例目前範例上對單一 server 查看時，我們事先進行 onInit 階段才跟後端非同步動作進行拿資料而等待 1 秒。如果是在觸發路由當下去獲得資料，確定有資料再從路由提供 server 資訊，最後於 server 元件上進行捕獲。</p>
<p>在 Angular 路由中，resolve 是一個守衛 (guard)，它可以在路由完成之前解析資料。解析資料通常用於從服務器或其他資料源中取得數據，並將其作為路由參數傳遞給目標路由。使用 resolve 守衛可以確保在路由組件被顯示之前，必須要先取得需要的數據，以避免在畫面顯示時還需要等待數據的加載。這樣可以提高應用的性能和用戶體驗。</p>
<p>因此，開頭提到的設計技巧我們需要創立並使用 Resolve 守衛的 service 來幫忙處理這件事。就像我們使用守衛那樣但是本身只是解析後端，並不會對路由觸發進行阻礙進出仍會進行渲染組建，但會進行預先加載畫面並等待後端資料回來更新。</p>
<ul>
<li>目前要做的 service 指對單一 server 元件所用，因此在同層目錄下建立 <code>ng g s server-resolve</code> 之服務。</li>
<li>宣告 Resolve 並實例介面化，這是一個泛型型別，它能包裝你任何的資料進行獲得。同時我們手動定義回傳的型別為 id,name,status，也就是原本 server 要從後端拿到的東西。</li>
<li>因為型別大量用到，可用 interface 介面化定義 ServerType 型別起來。</li>
<li>參考 <a target="_blank" rel="noopener" href="https://angular.tw/api/router/Resolve">官方對於 resolve 定義</a> 規劃結構。這裡我們要拿的是後端資料所以所有的回傳都會是 ServerType 型別，不管是不是非同步或可訂閱對象。</li>
</ul>
<figure class="highlight ts"><figcaption><span>server-resolve.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRouteSnapshot</span>, <span class="title class_">Resolve</span>, <span class="title class_">RouterStateSnapshot</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ServerType</span> &#123; <span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">status</span>: <span class="built_in">string</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ServerResolveService</span> <span class="keyword">implements</span> <span class="title class_">Resolve</span>&lt;<span class="title class_">ServerType</span>&gt; &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="attr">route</span>: <span class="title class_">ActivatedRouteSnapshot</span>, <span class="attr">state</span>: <span class="title class_">RouterStateSnapshot</span>) : <span class="title class_">Observable</span>&lt;<span class="title class_">ServerType</span>&gt; | <span class="title class_">Promise</span>&lt;<span class="title class_">ServerType</span>&gt; | <span class="title class_">ServerType</span>&#123;</span><br><span class="line">    <span class="comment">//something here</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>我們要在 resolve 裡面模擬假裝到後端拿資料，這需要跟 server.service 來提供，因此需要進行 Injectable 以及建構函式上私有實體化。</li>
<li>屆時 app-routing 設定那，一但使用本 ServerResolveService 時，會參數提供 id 給我，就能從 server.service 獲得 server 資訊。</li>
<li>回到 app.module 註冊一下此 service。</li>
</ul>
<figure class="highlight ts"><figcaption><span>server-resolve.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServersService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../servers.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRouteSnapshot</span>, <span class="title class_">Resolve</span>, <span class="title class_">RouterStateSnapshot</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ServerType</span> &#123; <span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">status</span>: <span class="built_in">string</span> &#125;</span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ServerResolveService</span> <span class="keyword">implements</span> <span class="title class_">Resolve</span>&lt;<span class="title class_">ServerType</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">serverService</span>: <span class="title class_">ServersService</span></span>) &#123; &#125;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="attr">route</span>: <span class="title class_">ActivatedRouteSnapshot</span>, <span class="attr">state</span>: <span class="title class_">RouterStateSnapshot</span>): <span class="title class_">Observable</span>&lt;<span class="title class_">ServerType</span>&gt; | <span class="title class_">Promise</span>&lt;<span class="title class_">ServerType</span>&gt; | <span class="title class_">ServerType</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">serverService</span>.<span class="title function_">getServer</span>(+route.<span class="property">params</span>.<span class="property">id</span>)!;</span><br><span class="line">    <span class="comment">//被 TypeScript 認為有 null 可能這裡！強迫它</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">providers</span>: [</span><br><span class="line">  <span class="title class_">ServersService</span>,</span><br><span class="line">  <span class="title class_">AuthService</span>,</span><br><span class="line">  <span class="title class_">AuthGuardService</span>,</span><br><span class="line">  <span class="title class_">DeactivateGuardService</span>,</span><br><span class="line">  <span class="title class_">ServerResolveService</span> <span class="comment">//※重點</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>現在服務做好了也加入 app 模組內了，就剩下是誰要去執行這個服務。我們會在對應到只有 server 單一頁面的路由，需要靠這裡去做撈資料的動作。</p>
<ul>
<li>使用<code>resolve:&#123;...,...&#125;</code>加入到範圍上的路由位置，透過服務我們能獲得物件資料指定給自訂名稱 server 的值。</li>
<li>現在資料會在 route.data.server 內，回到 server 元件，原本的透過後端服務之管道取得的方式取消，改成路由之管道取得方式。</li>
<li>我們去訂閱路由的資料，等他跑回來就能拿到資料，剛好結構位置直接對到 this.server 與 data.server。</li>
</ul>
<figure class="highlight ts"><figcaption><span>app-routing.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">lokiRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomeComponent</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UsersComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/:name&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;servers&#x27;</span>,</span><br><span class="line">    <span class="comment">// canActivate: [AuthGuardService],</span></span><br><span class="line">    <span class="attr">canActivateChild</span>: [<span class="title class_">AuthGuardService</span>],</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">ServersComponent</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ServerComponent</span>, <span class="attr">resolve</span>: &#123; <span class="attr">server</span>: <span class="title class_">ServerResolveService</span> &#125; &#125;, <span class="comment">//※重點</span></span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;:id/edit&#x27;</span>, <span class="attr">component</span>: <span class="title class_">EditServerComponent</span>, <span class="attr">canDeactivate</span>: [<span class="title class_">DeactivateGuardService</span>] &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// &#123; path: &#x27;404&#x27;, component: PageNotFoundComponent &#125;,</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;404&#x27;</span>, <span class="attr">component</span>: <span class="title class_">PageNotFoundComponent</span>, <span class="attr">data</span>: &#123;</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;you miss the way....&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;**&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/404&#x27;</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>server.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span>, <span class="title class_">Params</span>, <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>; <span class="comment">// ※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ServersService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../servers.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-server&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./server.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./server.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ServerComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="attr">server</span>: &#123;<span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">status</span>: <span class="built_in">string</span>&#125;;</span><br><span class="line">  <span class="comment">// server: any;</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">serversService</span>: <span class="title class_">ServersService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">route</span>: <span class="title class_">ActivatedRoute</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">router</span>: <span class="title class_">Router</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">data</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params"><span class="attr">data</span>: <span class="title class_">Data</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">server</span> = data.<span class="property">server</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// const id = +this.route.snapshot.params.id;</span></span><br><span class="line">  <span class="comment">// this.server = this.serversService.getServer(id);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// this.route.params.subscribe((prm: Params) =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//   this.server = this.serversService.getServer(+prm.id);</span></span><br><span class="line">  <span class="comment">// &#125;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="網址策略"><a href="#網址策略" class="headerlink" title="網址策略"></a>網址策略</h2><p>路由器提供了一個選項，可以將路由配置成使用哈希 (#) 碎片來處理路由，這個選項稱為 useHash。當這個選項被設置為 true 時，路由器會使用哈希碎片來處理 URL。這個選項主要是為了解決一些老舊的瀏覽器對 HTML5 歷史記錄 API 的支持不佳問題而設置的。使用哈希碎片可以讓瀏覽器忽略 URL 中的碎片部分，因此即使使用舊版本的瀏覽器，路由器仍然可以正確地處理路由。</p>
<p>使用哈希碎片的路由 URL 看起來像這樣：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http://example.com/#/path/to/route</span><br></pre></td></tr></table></figure>

<p>在這個 URL 中，<code>#/</code>後面的部分就是哈希碎片，代表路由的路徑。這種 URL 形式可以讓瀏覽器正確地解析路由，同時也可以避免一些兼容性問題。不過，這種 URL 形式看起來可能不太美觀，因此在開發中需要仔細考慮是否需要使用 useHash 選項。</p>
<p>因此，當你在本機環境開發很爽的時候上傳到實體網頁伺服器會發現一個問題。在本地開發時由 Angular 去控制每個 URL 目錄是對應到哪個位置，但實體網頁伺服器是自己去尋找每個目錄下的 index.html 作為 URL 路徑規劃，這部分你的 Angular 不會有這些東西，你只有一個 index.html 跟一狗包的 Angular 應用。如果你可能發生了這樣問題，你的 Angular 無法從 client 端去解析位置，試試看這個方法，來到 app-routing 模組啟用此功能。</p>
<figure class="highlight ts"><figcaption><span>app-routing.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="comment">// RouterModule.forRoot(lokiRoutes)</span></span><br><span class="line">    <span class="title class_">RouterModule</span>.<span class="title function_">forRoot</span>(lokiRoutes, &#123; <span class="attr">useHash</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">RouterModule</span>]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>預設值為 false，一旦開啟這個功能，你會發現所有的網站跟目錄都會多一個#，這能確保告知實體伺服器忽略#以後的 URL 解析，因為#本身對瀏覽器來說是標記不是網址目錄的一部分。如此一來就不會讓實體伺服器產生找不到實體 index 檔案的問題。</p>
<h1 id="參考文獻"><a href="#參考文獻" class="headerlink" title="參考文獻"></a>參考文獻</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.udemy.com/course/the-complete-guide-to-angular-2/">Udemy Angular - The Complete Guide (2022 Edition)</a> SESSION 9, 11, 12</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
              <a href="/tags/Angular/" rel="tag"># Angular</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/04-15/js-angular-2/" rel="prev" title="[前端框架] Angular - 元件、數據綁定、指令">
                  <i class="fa fa-chevron-left"></i> [前端框架] Angular - 元件、數據綁定、指令
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/04-25/js-angular-4/" rel="next" title="[前端框架] Angular - 觀察對象、表單、管道">
                  [前端框架] Angular - 觀察對象、表單、管道 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    <span class="with-love">
      <i class="fa fa-star"></i>
    </span>
    <span class="author" itemprop="copyrightHolder" title="找我？！側單左上連結">Loki Jiang</span>
    <span class="post-meta-item-icon with-love">
      <i class="fas fa-copyright"></i>
    </span>
    2020 – 
    <span itemprop="copyrightYear">2024</span> All rights reserved.
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon with-love">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="總字數">519,958</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon with-love">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">15:45:23</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon with-love">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="訪客總數">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon with-love">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="總瀏覽次數">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/summer10920" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  <script src="/js/third-party/fancybox.js"></script>



  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"
    integrity="sha512-lGnVsh3WK0YJ7NX7rQmUu6kqF7vqELuDrUTnxpI2iD86VwI+OlQhi3EAJJZbrBUOfDFOAYAkigxkApHGM2IZTg=="
    crossorigin="anonymous"></script>
<script src="/assets/js/loki.js"></script>
</body>
</html>
