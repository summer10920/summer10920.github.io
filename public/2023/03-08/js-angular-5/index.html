<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/config/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/config/favicon-16x16.png">
  <link rel="mask-icon" href="/assets/config/logo-loki.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,700,700italic%7CNoto+Sans+TC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"summer10920.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":20,"offset":20},"hljswrap":true,"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本篇深入探討一些 REST API 串接相關技術應用觀念，並使用 Firebase 做為後端實作端點。以及相關用戶身分認證的通用作法，包含 token 驗證機制與路由守衛規劃。以及示範如何透過將靜態元件改為一組動態創建的元件根據事件過程產生。">
<meta property="og:type" content="article">
<meta property="og:title" content="[前端框架] Angular - HTTP 請求、身分驗證、動態元件">
<meta property="og:url" content="http://summer10920.github.io/2023/03-08/js-angular-5/">
<meta property="og:site_name" content="洛奇的邪惡組織手札">
<meta property="og:description" content="本篇深入探討一些 REST API 串接相關技術應用觀念，並使用 Firebase 做為後端實作端點。以及相關用戶身分認證的通用作法，包含 token 驗證機制與路由守衛規劃。以及示範如何透過將靜態元件改為一組動態創建的元件根據事件過程產生。">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/WC5iApN.png">
<meta property="og:image" content="https://i.imgur.com/vKtPpvD.png">
<meta property="og:image" content="https://i.imgur.com/4yYA2gj.png">
<meta property="og:image" content="https://i.imgur.com/dGOKVkL.png">
<meta property="og:image" content="https://i.imgur.com/vYheBJQ.png">
<meta property="og:image" content="https://i.imgur.com/H3h6Rjh.png">
<meta property="og:image" content="https://i.imgur.com/KxX6WnR.png">
<meta property="og:image" content="https://i.imgur.com/OGioB9i.png">
<meta property="og:image" content="https://i.imgur.com/IrGMTRa.png">
<meta property="og:image" content="https://i.imgur.com/Rh8VPpi.png">
<meta property="article:published_time" content="2023-03-08T06:37:20.000Z">
<meta property="article:modified_time" content="2024-08-22T02:31:12.220Z">
<meta property="article:author" content="Loki Jiang">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="Angular">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/WC5iApN.png">


<link rel="canonical" href="http://summer10920.github.io/2023/03-08/js-angular-5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-TW","comments":true,"permalink":"http://summer10920.github.io/2023/03-08/js-angular-5/","path":"2023/03-08/js-angular-5/","title":"[前端框架] Angular - HTTP 請求、身分驗證、動態元件"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>[前端框架] Angular - HTTP 請求、身分驗證、動態元件 | 洛奇的邪惡組織手札</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146423952-3"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-146423952-3","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>







<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&family=Roboto&display=swap" rel="stylesheet">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <canvas id="lokiBanner" width="1920" height="200"></canvas>
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">洛奇的邪惡組織手札</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">I am WebDeveloper!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜尋" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤<span class="badge">20</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類<span class="badge">17</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔<span class="badge">68</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜尋..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Http-Request-%E4%BC%BA%E6%9C%8D%E5%99%A8%E8%AB%8B%E6%B1%82"><span class="nav-number">1.</span> <span class="nav-text">Http Request 伺服器請求</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#API-%E5%9F%BA%E6%9C%AC%E8%A7%80%E5%BF%B5"><span class="nav-number">1.1.</span> <span class="nav-text">API 基本觀念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-Request"><span class="nav-number">1.1.1.</span> <span class="nav-text">HTTP Request</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Request-Line"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">Request Line</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Request-Headers"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">Request Headers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Request-Body"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">Request Body</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%92%B0%E5%A2%83%E5%BB%BA%E7%BD%AE%E6%BA%96%E5%82%99"><span class="nav-number">1.2.</span> <span class="nav-text">環境建置準備</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC-POST-GET-DELETE"><span class="nav-number">1.3.</span> <span class="nav-text">基本 POST&#x2F;GET&#x2F;DELETE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#POST-%E8%AB%8B%E6%B1%82"><span class="nav-number">1.3.1.</span> <span class="nav-text">POST 請求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GET-%E8%AB%8B%E6%B1%82"><span class="nav-number">1.3.2.</span> <span class="nav-text">GET 請求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%8F%E9%81%8E-pipe-%E8%BD%89%E6%8F%9B-response-%E6%95%B8%E6%93%9A"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">透過 pipe 轉換 response 數據</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Modal-%E5%9E%8B%E5%88%A5%E8%A6%8F%E5%8A%83"><span class="nav-number">1.3.3.</span> <span class="nav-text">Modal 型別規劃</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GET-%E6%95%B8%E6%93%9A%E9%A1%AF%E7%A4%BA%E7%95%AB%E9%9D%A2%E4%B8%8A%E8%88%87-Loading-%E6%8F%90%E7%A4%BA"><span class="nav-number">1.3.4.</span> <span class="nav-text">GET 數據顯示畫面上與 Loading 提示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Service-%E8%A6%8F%E5%8A%83"><span class="nav-number">1.3.5.</span> <span class="nav-text">Service 規劃</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%AC%E7%A7%BB-POST"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">搬移 POST</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%AC%E7%A7%BB-GET"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">搬移 GET</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DELETE-%E8%AB%8B%E6%B1%82"><span class="nav-number">1.3.6.</span> <span class="nav-text">DELETE 請求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Error-%E4%BA%8B%E4%BB%B6%E8%99%95%E7%BD%AE"><span class="nav-number">1.4.</span> <span class="nav-text">Error 事件處置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A8%82%E9%96%B1-HttpClient-%E7%9A%84-HttpErrorResponse"><span class="nav-number">1.4.1.</span> <span class="nav-text">訂閱 HttpClient 的 HttpErrorResponse</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8-Subject-%E8%A7%80%E5%AF%9F-subscribe"><span class="nav-number">1.4.2.</span> <span class="nav-text">用 Subject 觀察 subscribe</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8-rxjs-%E7%9A%84-catchError-%E8%99%95%E7%90%86"><span class="nav-number">1.4.3.</span> <span class="nav-text">用 rxjs 的 catchError 處理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HttpClient-%E7%9A%84%E7%9B%B8%E9%97%9C%E8%A8%AD%E7%BD%AE"><span class="nav-number">1.5.</span> <span class="nav-text">HttpClient 的相關設置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HttpHeaders-%E8%A8%AD%E5%AE%9A-Header-%E8%B3%87%E8%A8%8A"><span class="nav-number">1.5.1.</span> <span class="nav-text">HttpHeaders 設定 Header 資訊</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HttpParams-%E8%A8%AD%E5%AE%9A-Query-Params"><span class="nav-number">1.5.2.</span> <span class="nav-text">HttpParams 設定 Query Params</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#observe-%E8%A7%80%E5%AF%9F-response"><span class="nav-number">1.5.3.</span> <span class="nav-text">observe 觀察 response</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#responseType-%E6%8C%87%E5%AE%9A%E5%9B%9E%E6%87%89%E5%9E%8B%E5%88%A5"><span class="nav-number">1.5.4.</span> <span class="nav-text">responseType 指定回應型別</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HttpInterceptor-%E6%94%94%E6%88%AA%E8%99%95%E7%90%86"><span class="nav-number">1.6.</span> <span class="nav-text">HttpInterceptor 攔截處理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#intercept-%E5%AF%A6%E4%BD%9C%E6%96%B9%E6%B3%95"><span class="nav-number">1.6.1.</span> <span class="nav-text">intercept 實作方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A8%BB%E5%86%8A-Interceptor-%E6%96%BC-app-modules-ts"><span class="nav-number">1.6.2.</span> <span class="nav-text">註冊 Interceptor 於 app.modules.ts</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A8%BB%E5%86%8A%E5%A4%9A%E5%80%8B-Interceptor"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">註冊多個 Interceptor</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BA%AB%E5%88%86%E9%A9%97%E8%AD%89%E8%88%87%E8%B7%AF%E7%94%B1%E9%98%B2%E8%AD%B7"><span class="nav-number">2.</span> <span class="nav-text">身分驗證與路由防護</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%92%B0%E5%A2%83%E5%BB%BA%E7%BD%AE%E6%BA%96%E5%82%99-1"><span class="nav-number">2.1.</span> <span class="nav-text">環境建置準備</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A8%AD%E8%A8%88-auth-%E5%85%83%E4%BB%B6"><span class="nav-number">2.1.1.</span> <span class="nav-text">設計 auth 元件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Login-SignUp-%E5%88%87%E6%8F%9B"><span class="nav-number">2.2.</span> <span class="nav-text">Login&#x2F;SignUp 切換</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Template-driven-%E8%A1%A8%E5%96%AE%E8%99%95%E7%90%86"><span class="nav-number">2.3.</span> <span class="nav-text">Template-driven 表單處理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fireBase-%E8%A8%BB%E5%86%8A%E7%99%BB%E5%85%A5%E7%9A%84%E8%BA%AB%E5%88%86%E9%A9%97%E8%AD%89"><span class="nav-number">2.4.</span> <span class="nav-text">fireBase 註冊登入的身分驗證</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A8%BB%E5%86%8A-API"><span class="nav-number">2.4.1.</span> <span class="nav-text">註冊 API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A8%AD%E8%A8%88-auth-service-ts-%E8%88%87%E5%85%83%E4%BB%B6"><span class="nav-number">2.4.1.1.</span> <span class="nav-text">設計 auth.service.ts 與元件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A8%AD%E8%A8%88-Loading-%E8%88%87-Error-Alert"><span class="nav-number">2.4.1.2.</span> <span class="nav-text">設計 Loading 與 Error Alert</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%99%BB%E5%85%A5-API"><span class="nav-number">2.4.2.</span> <span class="nav-text">登入 API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B7%A8%E5%AF%AB-auth-service-ts-%E8%88%87%E5%85%83%E4%BB%B6"><span class="nav-number">2.4.2.1.</span> <span class="nav-text">編寫 auth.service.ts 與元件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A8%AD%E8%A8%88-Error-Alert"><span class="nav-number">2.4.2.2.</span> <span class="nav-text">設計 Error Alert</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%84%B2%E5%AD%98%E7%94%A8%E6%88%B6%E8%B3%87%E8%A8%8A"><span class="nav-number">2.5.</span> <span class="nav-text">儲存用戶資訊</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#User-Model-%E8%B3%87%E8%A8%8A"><span class="nav-number">2.5.1.</span> <span class="nav-text">User Model 資訊</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%9C%E6%A5%AD%E8%B7%AF%E7%94%B1%E5%B0%8E%E5%90%91%E8%88%87-UI-%E6%8E%A7%E5%88%B6"><span class="nav-number">2.5.2.</span> <span class="nav-text">作業路由導向與 UI 控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%82%B3%E9%80%81-token"><span class="nav-number">2.5.3.</span> <span class="nav-text">傳送 token</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%9C%E6%96%BC-BehaviorSubject-%E8%88%87%E5%85%B6%E4%BB%96"><span class="nav-number">2.5.3.1.</span> <span class="nav-text">關於 BehaviorSubject 與其他</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%8B%E5%8B%95%E6%B7%BB%E5%8A%A0-token-%E6%96%BC%E6%8C%87%E5%AE%9A-api"><span class="nav-number">2.5.3.2.</span> <span class="nav-text">手動添加 token 於指定 api</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%8F%E9%81%8E-HttpInterceptor-%E8%87%AA%E5%8B%95-token"><span class="nav-number">2.5.3.3.</span> <span class="nav-text">透過 HttpInterceptor 自動 token</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%99%BB%E5%87%BA%E4%BD%9C%E6%A5%AD"><span class="nav-number">2.6.</span> <span class="nav-text">登出作業</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8B%95%E5%84%B2%E5%AD%98-Storage"><span class="nav-number">2.7.</span> <span class="nav-text">自動儲存 Storage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#autoLogin-%E9%87%8D%E6%95%B4%E9%A0%81%E9%9D%A2"><span class="nav-number">2.7.1.</span> <span class="nav-text">autoLogin 重整頁面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BE%E6%99%82%E8%87%AA%E5%8B%95%E7%99%BB%E5%87%BA"><span class="nav-number">2.7.2.</span> <span class="nav-text">逾時自動登出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E5%AE%88%E8%A1%9B%E9%98%BB%E6%AD%A2%E6%9C%AA%E7%99%BB%E5%85%A5%E7%9A%84%E5%8B%95%E4%BD%9C"><span class="nav-number">2.8.</span> <span class="nav-text">路由守衛阻止未登入的動作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%AE%88%E8%A1%9B%E8%A6%8F%E5%89%87-auth-guard-service-ts"><span class="nav-number">2.8.1.</span> <span class="nav-text">建立守衛規則 auth-guard-service.ts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A8%AD%E5%AE%9A%E8%B7%AF%E7%94%B1%E8%A6%8F%E5%89%87-app-routing-module-ts"><span class="nav-number">2.8.2.</span> <span class="nav-text">設定路由規則 app-routing.module.ts</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dynamic-Component-%E5%8B%95%E6%85%8B%E5%85%83%E4%BB%B6"><span class="nav-number">3.</span> <span class="nav-text">Dynamic Component 動態元件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E6%96%B0%E8%A6%8F%E5%8A%83-Alert-Modal-%E6%96%BC%E9%9D%9C%E6%85%8B%E5%85%83%E4%BB%B6"><span class="nav-number">3.1.</span> <span class="nav-text">重新規劃 Alert Modal 於靜態元件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%B9%E4%BB%A5%E5%8B%95%E6%85%8B%E5%85%83%E4%BB%B6%E6%96%B9%E5%BC%8F%E7%94%9F%E6%88%90-alert"><span class="nav-number">3.2.</span> <span class="nav-text">改以動態元件方式生成 alert</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%83%E8%80%83%E6%96%87%E7%8D%BB"><span class="nav-number">4.</span> <span class="nav-text">參考文獻</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Loki Jiang"
      src="/assets/config/author_loki.jpg">
  <p class="site-author-name" itemprop="name">Loki Jiang</p>
  <div class="site-description" itemprop="description">Time waits for no oneヽ(｀Д´)ﾉ</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/summer10920" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;summer10920" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:summer10920@gmail.com" title="E-Mail → mailto:summer10920@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://codepen.io/summer10920/pens/public?grid_type=list" title="CodePen → https:&#x2F;&#x2F;codepen.io&#x2F;summer10920&#x2F;pens&#x2F;public?grid_type&#x3D;list" rel="noopener me" target="_blank"><i class="fab fa-codepen fa-fw"></i>CodePen</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.youtube.com/c/LokiJiang/playlists" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;c&#x2F;LokiJiang&#x2F;playlists" rel="noopener me" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="回到頂端">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="http://demob17300.lokiwebs.com/" title="http:&#x2F;&#x2F;demob17300.lokiwebs.com&#x2F;" rel="noopener" target="_blank">DemoSite - 網頁設計乙術科</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://blog.lokiwebs.com/" title="http:&#x2F;&#x2F;blog.lokiwebs.com&#x2F;" rel="noopener" target="_blank">舊址(停更) - 札記 Blog</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="http://summer10920.github.io/2023/03-08/js-angular-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/config/author_loki.jpg">
      <meta itemprop="name" content="Loki Jiang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="洛奇的邪惡組織手札">
      <meta itemprop="description" content="Time waits for no oneヽ(｀Д´)ﾉ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="[前端框架] Angular - HTTP 請求、身分驗證、動態元件 | 洛奇的邪惡組織手札">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [前端框架] Angular - HTTP 請求、身分驗證、動態元件<a href="https://github.com/summer10920/summer10920.github.io/edit/master/source/_posts/20230308-js-angular-5.md" class="post-edit-link" title="編輯" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2023-03-08 14:37:20" itemprop="dateCreated datePublished" datetime="2023-03-08T14:37:20+08:00">2023-03-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-08-22 10:31:12" itemprop="dateModified" datetime="2024-08-22T10:31:12+08:00">2024-08-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Zero-Road/" itemprop="url" rel="index"><span itemprop="name">Zero Road</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Zero-Road/Angular/" itemprop="url" rel="index"><span itemprop="name">Angular</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>17,525</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>00:31:52</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><img src="https://i.imgur.com/WC5iApN.png"><br>本篇深入探討一些 REST API 串接相關技術應用觀念，並使用 Firebase 做為後端實作端點。以及相關用戶身分認證的通用作法，包含 token 驗證機制與路由守衛規劃。以及示範如何透過將靜態元件改為一組動態創建的元件根據事件過程產生。</p>
<span id="more"></span>

<h1 id="Http-Request-伺服器請求"><a href="#Http-Request-伺服器請求" class="headerlink" title="Http Request 伺服器請求"></a>Http Request 伺服器請求</h1><p>本節將介紹如何跟後端進行連線作業，透過 API 的方式進行串接。而 API 常見的 Server 連線方式有 REST 或 GraphQL 等，我們將以 REST 方式進行教導，以及搭配免費的虛擬後端做測試，減少開發練習的環境複雜性。<br>前端的 API 是指用於在網頁應用程式中通過瀏覽器與伺服器進行溝通的程式接口。API 可以是一個單獨的 JavaScript 函數，也可以是一組由伺服器提供的 RESTful API 端點。</p>
<h2 id="API-基本觀念"><a href="#API-基本觀念" class="headerlink" title="API 基本觀念"></a>API 基本觀念</h2><p>前端的 API 通常是用於從伺服器獲取數據，並將其用於呈現網頁上的內容。例如，當用戶在網頁應用程式中進行搜索時，前端的 API 將向伺服器發送請求，以獲取符合搜索條件的結果。伺服器端會處理這個請求，返回符合條件的數據，然後前端的 API 將這些數據轉換為適當的格式，例如 JSON 或 XML，以便在網頁上顯示。</p>
<p>除了從伺服器獲取數據，前端的 API 還可以用於將數據發送到伺服器，例如在使用者提交表單時。這種情況下，前端的 API 會將表單數據轉換為適當的格式，例如 JSON 或表單編碼，然後將其發送到伺服器上的 API 端點進行處理。伺服器端會處理這個請求，然後返回適當的響應，例如成功或錯誤信息。</p>
<p>總的來說，前端的 API 是一個關鍵的技術，它使得網頁應用程式能夠與伺服器進行通信，以獲取數據和處理用戶操作。API 主要是由前端透過 http request 向後端做資料請求，透過後端回應的 http response 取得資料庫資料，再進行資料處理回饋到 DOM 上呈現。</p>
<h3 id="HTTP-Request"><a href="#HTTP-Request" class="headerlink" title="HTTP Request"></a>HTTP Request</h3><p>HTTP Request 是客戶端向伺服器發送請求的格式，用於請求特定的資源或服務。一個 HTTP Request 包含三部分：</p>
<ul>
<li>Request Line：包含請求方法、URL 和協議版本。常用的請求方法有 GET、POST、PUT、DELETE 等。</li>
<li>Request Headers：包含一系列請求頭部資訊，用於描述請求的內容、格式、身份驗證等資訊，如 User-Agent、Host、Accept、Content-Type 等。</li>
<li>Request Body：可選的請求體，包含發送到伺服器的資料，例如表單資料、JSON 資料等。</li>
</ul>
<h4 id="Request-Line"><a href="#Request-Line" class="headerlink" title="Request Line"></a>Request Line</h4><p>Request Line（請求行）是 HTTP Request 中的第一部分，用於描述客戶端向伺服器發送的請求方法、URL 和協議版本等基本資訊。Request Line 的格式如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># &lt;Method&gt; &lt;URL&gt; &lt;HTTP Version&gt;</span></span><br><span class="line">GET /index.html HTTP/1.1</span><br></pre></td></tr></table></figure>
<ul>
<li>Method 是客戶端使用的請求方法，常見的有 GET、POST、PUT、DELETE 等；</li>
<li>URL 是客戶端要訪問的資源地址，可以是絕對 URL 或相對 URL；</li>
<li>HTTP Version 是 HTTP 協議的版本，通常是 HTTP&#x2F;1.0 或 HTTP&#x2F;1.1。</li>
</ul>
<p>而這個 Request Line 例子，請求方法是 GET，URL 是 &#x2F;index.html，HTTP 協議版本是 HTTP&#x2F;1.1。當客戶端向伺服器發送這個 Request Line 時，伺服器會根據這些資訊來找到對應的資源並返回相應的內容。</p>
<h4 id="Request-Headers"><a href="#Request-Headers" class="headerlink" title="Request Headers"></a>Request Headers</h4><p>Request Headers（請求頭部）是 HTTP Request 中的第二部分，用於描述客戶端向伺服器發送的請求的額外資訊，例如 User-Agent、Accept、Content-Type 等。以下是一個 HTTP Request Headers 的例子：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /index.html HTTP/1.1</span><br><span class="line">Host: www.example.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>

<p>這個 Request Headers 中，包含了 Host、User-Agent、Accept、Accept-Encoding 和 Connection 等頭部資訊。這些頭部資訊可以告訴伺服器一些額外的資訊，例如客戶端使用的瀏覽器類型、網頁編碼格式、支援的資源類型等。</p>
<h4 id="Request-Body"><a href="#Request-Body" class="headerlink" title="Request Body"></a>Request Body</h4><p>Request Body（請求主體）是 HTTP Request 中的第三部分，通常用於在客戶端向伺服器發送資料。Request Body 的格式取決於請求的內容類型，例如在發送 JSON 格式的資料時，可以使用 application&#x2F;json 作為 Content-Type，並在 Request Body 中以 JSON 格式傳遞資料。另外，Request Body 也可以是空的，例如當客戶端向伺服器發送 GET 請求時，通常是不需要 Request Body 的。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">POST /api/data HTTP/1.1</span><br><span class="line">Host: www.example.com</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age&quot;</span>: 30,</span><br><span class="line">  <span class="string">&quot;email&quot;</span>: <span class="string">&quot;johndoe@example.com&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個 HTTP Request 中使用了 POST 方法，Content-Type 是 application&#x2F;json，Request Body 中包含了一個 JSON 物件。當客戶端向伺服器發送這個請求時，伺服器會根據 URL 和 Request Body 中的資訊，來處理請求並返回相應的結果。</p>
<h2 id="環境建置準備"><a href="#環境建置準備" class="headerlink" title="環境建置準備"></a>環境建置準備</h2><p>本篇的起始素材放置於 GitHub 底下提供使用，使用資料目錄 lokiHttp 作為初始環境。下載請記得 npm install 初始化環境。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/summer10920/angularTraining">Github download</a> at lokiHttp-start Folder</p>
</blockquote>
<p>另外，為了練習與後端連線，這裡會借用 Google 提供的 <a target="_blank" rel="noopener" href="https://firebase.google.com/">FireBase</a> 進行後端模擬使用。請先註冊免費會員並根據以下步驟進行準備。</p>
<ul>
<li>登入帳號，並建立專案名稱自訂與完成專案</li>
<li>來到專案頁面選擇 Realtime Database 並建立可即時性的資料庫，選擇新加坡網速會稍快些。</li>
<li>選擇以測試模式啟動，使得全公開可以任意連線（練習用）。此時可見到 URL 請求網址使用。</li>
</ul>
<p><img src="https://i.imgur.com/vKtPpvD.png"><br><img src="https://i.imgur.com/4yYA2gj.png"><br><img src="https://i.imgur.com/dGOKVkL.png"><br><img src="https://i.imgur.com/vYheBJQ.png"></p>
<div class="note info"><p><strong>Firebase</strong><br>可以用作網站的真實後端。Firebase 提供了一個全面的後端解決方案，包括用戶身份驗證、資料庫、雲端存儲、主機、分析和通知等功能，這些功能可以幫助你快速構建高效可靠的網站。</p>
<p>Firebase 的資料庫功能提供了實時數據庫（Realtime Database）和雲端 FireStore 兩個選項，這些都是 NoSQL 資料庫，可以存儲結構化和非結構化數據。Firebase 還提供了用戶身份驗證，可以通過電子郵件、社交媒體等方式進行註冊和登錄，以及用於管理和保護數據的安全規則。Firebase 的主機功能可以部署和管理網站代碼，而分析和通知功能可以幫助你了解用戶行為和互動並進行即時反饋。</p>
<p>總體而言，Firebase 是一個強大而靈活的後端解決方案，可以滿足大多數網站的需求。</p>
</div>

<h2 id="基本-POST-GET-DELETE"><a href="#基本-POST-GET-DELETE" class="headerlink" title="基本 POST&#x2F;GET&#x2F;DELETE"></a>基本 POST&#x2F;GET&#x2F;DELETE</h2><p>此小節透過基本的 post 方式與 get 方式進行 api 測試，以 REST 之協定觀念上，post 主要用於新增資料，而 get 作為請求資料（可以是全部或是一筆）。</p>
<h3 id="POST-請求"><a href="#POST-請求" class="headerlink" title="POST 請求"></a>POST 請求</h3><p>從素材之中，已規劃好 TD 表單並提供 title 與 content 的表單提交，本節將示範如何透過 API 進行 HTTP Request 進行 POST 發送。首先要進行之前，需進行先掛載 HttpClient 模組。</p>
<figure class="highlight typescript"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/platform-browser&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FormsModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClientModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [<span class="title class_">AppComponent</span>],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">BrowserModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">    <span class="title class_">HttpClientModule</span> <span class="comment">//※重點</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: [],</span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>現在就能再 app.component.ts 內進行使用 HttpClient 使用。注意以下要點：</p>
<ul>
<li>於建構子建立本地變數為 http 以及型別為 HttpClient</li>
<li>於 submit 處 onCreatePost 進行發送 post 請求，注意這裡的 URL 因 firebase 的 no-SQL 規則要求填寫為 posts.json。這不是標準 TEST 方法，這要取決真實後端的 URL 規定。</li>
<li>第二參數為 body，傳送 json 表單資料，以目前的設定簡略，Angular 會自動整理判斷所有 Request 所需要的 Header,Body。包含<code>Content-Type: application/json</code>會自動判定。</li>
<li>Angular 內使用 http 必須要進行 subscribe 才能運作，subscribe 能讓我們接受到 response 回來的資料為何。</li>
<li>編寫完嘗試發送出去，觀察 <kbd>F12</kbd> &gt; Network 以及 FireBase 後台資料情況。你應該可觀察到 require 與獲得 response。</li>
</ul>
<figure class="highlight ts"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;<span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-root&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./app.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./app.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  loadedPosts = [];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">http</span>: <span class="title class_">HttpClient</span> <span class="comment">//※重點</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreatePost</span>(<span class="params"><span class="attr">postData</span>: &#123; title: <span class="built_in">string</span>; content: <span class="built_in">string</span> &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// Send Http request</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// console.log(postData);</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">post</span>(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span>,</span><br><span class="line">      postData</span><br><span class="line">    ).<span class="title function_">subscribe</span>(<span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(response));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>後端會回傳一個 name 參數，這是便於之後要找到該資料時所用。</p>
<h3 id="GET-請求"><a href="#GET-請求" class="headerlink" title="GET 請求"></a>GET 請求</h3><p>接著以範例獲取所有資料，透過 GET 方式做請求，此功能規畫於 fetch Button 使用，以及初始化 init 時全部載入。</p>
<ul>
<li>規劃私有函式 fetchPosts，以 get 方式請求所有資料，這裡不需要發送 require 資料。</li>
<li>將 fetchPosts 觸發於 init 與 onFetchPosts 事件上。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-root&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./app.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./app.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  loadedPosts = [];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">http</span>: <span class="title class_">HttpClient</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fetchPosts</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">onFetchPosts</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Send Http request</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fetchPosts</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">fetchPosts</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">get</span>(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span></span><br><span class="line">    ).<span class="title function_">subscribe</span>(<span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(response));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此時載入畫面以及按下 fetch 按鈕都能透過 http get 取得完整資料。</p>
<h4 id="透過-pipe-轉換-response-數據"><a href="#透過-pipe-轉換-response-數據" class="headerlink" title="透過 pipe 轉換 response 數據"></a>透過 pipe 轉換 response 數據</h4><p>由於 API 是非同步的訂閱對象，我們可以使用 rxjs 的 pipe 對資料進行轉換，方便於我們的 response 數據轉成前端所需要的資料格式。</p>
<p>舉例來說，回傳的資料格式為了方便整理成以下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// before</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;-NQ-JEPX3OgPGMQNGBq0&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BB&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AA&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="comment">// after</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BB&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AA&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-NQ-JEPX3OgPGMQNGBq0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>因此，於 pipe 管道內，透過 map 試著轉換為陣列方式呈現。</p>
<figure class="highlight typescript"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">fetchPosts</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">get</span>(</span><br><span class="line">    <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span></span><br><span class="line">  ).<span class="title function_">pipe</span>( <span class="comment">//※重點</span></span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">responseData</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(responseData);</span><br><span class="line">      <span class="keyword">const</span> postAry = [];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> responseData) &#123;</span><br><span class="line">        <span class="keyword">if</span> (responseData.<span class="title function_">hasOwnProperty</span>(key))</span><br><span class="line">          postAry.<span class="title function_">push</span>(&#123; ...responseData[key], <span class="attr">id</span>: key &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> postAry;</span><br><span class="line">    &#125;)</span><br><span class="line">  ).<span class="title function_">subscribe</span>(<span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(response));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同時，並遵循 TypeScript 試著套入型別。</p>
<h3 id="Modal-型別規劃"><a href="#Modal-型別規劃" class="headerlink" title="Modal 型別規劃"></a>Modal 型別規劃</h3><p>目前為止都能正常運行，為了遵循 TypeScript 應該對這些資料的往返進行加強型別。試著在原處 post 與 get 的 api 處理上追加型別。</p>
<ul>
<li>透過 cli 指令<code>ng g i post --type=model</code>或<code>ng g interface post --type=model</code>，也可手動建置 post.model.ts</li>
<li>規劃 response 內所出現的三種字串型別。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>post.model.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">PostModel</span> &#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">content</span>: <span class="built_in">string</span>;</span><br><span class="line">  id?: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>造訪 app.component.ts，找到 onCreatePost，原本這裡的型別已宣告成 model，可以抽換為 PostModel。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PostModel</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./post.model&#x27;</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">// onCreatePost(postData: &#123; title: string; content: string &#125;) &#123;</span></span><br><span class="line">    <span class="title function_">onCreatePost</span>(<span class="params"><span class="attr">postData</span>: <span class="title class_">PostModel</span></span>) &#123; <span class="comment">//※重點</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">post</span>(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span>,</span><br><span class="line">      postData</span><br><span class="line">    ).<span class="title function_">subscribe</span>(<span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(response));</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>同處找到 fetchPosts，map 之後的陣列會是<code>PostModel[]</code>型別。</li>
<li>而 map 之前的 response 型別，可以規劃為<code>&#123; [key: string]: PostModel &#125;</code>，但不是很優。</li>
<li>同上，我們可以使用 TypeScript 的泛型，在 get 處添加<code>&lt;&#123; [key: string]: PostModel &#125;&gt;</code>讓 Angular 知道 get 所回傳的型別為何。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">fetchPosts</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// this.http.get(</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;&#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">PostModel</span> &#125;&gt;( <span class="comment">//※重點：方法二</span></span><br><span class="line">    <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span></span><br><span class="line">  ).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="comment">// map((responseData: &#123; [key: string]: PostModel &#125;) =&gt; &#123;  //※重點：方法一</span></span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">responseData</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(responseData);</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">postAry</span>: <span class="title class_">PostModel</span>[] = []; <span class="comment">//※重點</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> responseData) &#123;</span><br><span class="line">        <span class="keyword">if</span> (responseData.<span class="title function_">hasOwnProperty</span>(key))</span><br><span class="line">          postAry.<span class="title function_">push</span>(&#123; ...responseData[key], <span class="attr">id</span>: key &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> postAry;</span><br><span class="line">    &#125;)</span><br><span class="line">  ).<span class="title function_">subscribe</span>(<span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(response));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GET-數據顯示畫面上與-Loading-提示"><a href="#GET-數據顯示畫面上與-Loading-提示" class="headerlink" title="GET 數據顯示畫面上與 Loading 提示"></a>GET 數據顯示畫面上與 Loading 提示</h3><p>接著將 get 訂閱出來的資料回饋到畫面上，目前已存在一個本地變數為 loadedPosts 試圖回存於此。另外於 html 模板上透過判斷 ngIf 有資料透過迴圈 ngFor 則 list 出來。</p>
<figure class="highlight typescript"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">fetchPosts</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// this.http.get(</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;&#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">PostModel</span> &#125;&gt;(</span><br><span class="line">    <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span></span><br><span class="line">  ).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">responseData</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(responseData);</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">postAry</span>: <span class="title class_">PostModel</span>[] = [];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> responseData) &#123;</span><br><span class="line">        <span class="keyword">if</span> (responseData.<span class="title function_">hasOwnProperty</span>(key))</span><br><span class="line">          postAry.<span class="title function_">push</span>(&#123; ...responseData[key], <span class="attr">id</span>: key &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> postAry;</span><br><span class="line">    &#125;)</span><br><span class="line">  ).<span class="title function_">subscribe</span>(<span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">this</span>.<span class="property">loadedPosts</span> = response); <span class="comment">//※重點</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>app.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-md-6 col-md-offset-3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> *<span class="attr">ngIf</span>=<span class="string">&quot;loadedPosts.length&lt;1&quot;</span>&gt;</span>No posts available!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span></span></span><br><span class="line"><span class="tag">      *<span class="attr">ngIf</span>=<span class="string">&quot;loadedPosts.length&gt;0&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;list-group&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;list-group-item&quot;</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of loadedPosts&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123;item.title&#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;item.content&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>爾後針對 GET 的 API 作業中，增加一個 loading 訊息作為等待提示，只需多宣告一個本地變數 Boolean，在於 require 之前與 response 之後去改變。以及畫面上根據此 Boolean 做對應的顯示即可。</p>
<figure class="highlight typescript"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PostModel</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./post.model&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-root&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./app.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./app.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  loadedPosts = [];</span><br><span class="line">  loading = <span class="literal">false</span>; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">fetchPosts</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loading</span> = <span class="literal">true</span>;<span class="comment">//※重點</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;&#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">PostModel</span> &#125;&gt;(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span></span><br><span class="line">    ).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">map</span>(<span class="function"><span class="params">responseData</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(responseData);</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">postAry</span>: <span class="title class_">PostModel</span>[] = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> responseData) &#123;</span><br><span class="line">          <span class="keyword">if</span> (responseData.<span class="title function_">hasOwnProperty</span>(key))</span><br><span class="line">            postAry.<span class="title function_">push</span>(&#123; ...responseData[key], <span class="attr">id</span>: key &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> postAry;</span><br><span class="line">      &#125;)</span><br><span class="line">    ).<span class="title function_">subscribe</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loading</span> = <span class="literal">false</span>; <span class="comment">//※重點</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedPosts</span> = response;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>app.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-md-6 col-md-offset-3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> *<span class="attr">ngIf</span>=<span class="string">&quot;loading&quot;</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> *<span class="attr">ngIf</span>=<span class="string">&quot;loadedPosts.length&lt;1 &amp;&amp; !loading&quot;</span>&gt;</span>No posts available!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span></span></span><br><span class="line"><span class="tag">      *<span class="attr">ngIf</span>=<span class="string">&quot;loadedPosts.length&gt;0 &amp;&amp; !loading&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;list-group&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;list-group-item&quot;</span></span></span><br><span class="line"><span class="tag">        *<span class="attr">ngFor</span>=<span class="string">&quot;let item of loadedPosts&quot;</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123;item.title&#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;item.content&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Service-規劃"><a href="#Service-規劃" class="headerlink" title="Service 規劃"></a>Service 規劃</h3><p>目前設計來說都依賴於 app 元件上過於複雜，因此可將這些 HTTP 工作搬移至 Service 服務去，如此你的元件就相對精簡乾淨專注於與模板 HTML 相關工作。</p>
<h4 id="搬移-POST"><a href="#搬移-POST" class="headerlink" title="搬移 POST"></a>搬移 POST</h4><ul>
<li>透過 CLI 指令<code>ng g s http --skip-tests=true</code>生成 http service</li>
<li>規劃 addPost 來處理原本 http post 相同代碼搬入</li>
<li>傳遞參數的型別可共用 PostModel，同時我們也需要設定 HttpClient 於建構子內</li>
<li>最後修改 component 這裡，改從 Service 這裡處理 http，注意需要設定 httpService 於建構子內</li>
</ul>
<figure class="highlight typescript"><figcaption><span>http.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PostModel</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./post.model&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">http</span>: <span class="title class_">HttpClient</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addPost</span>(<span class="params"><span class="attr">postData</span>: <span class="title class_">PostModel</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">post</span>(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span>,</span><br><span class="line">      postData</span><br><span class="line">    ).<span class="title function_">subscribe</span>(<span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(response));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./http.service&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PostModel</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./post.model&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-root&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./app.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./app.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  loadedPosts = [];</span><br><span class="line">  loading = <span class="literal">false</span>; </span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">http</span>: <span class="title class_">HttpClient</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">HttpService</span>: <span class="title class_">HttpService</span> <span class="comment">//※重點</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreatePost</span>(<span class="params"><span class="attr">postData</span>: <span class="title class_">PostModel</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">HttpService</span>.<span class="title function_">addPost</span>(postData); <span class="comment">//※重點</span></span><br><span class="line">    <span class="comment">// this.http.post(</span></span><br><span class="line">    <span class="comment">//   &#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;,</span></span><br><span class="line">    <span class="comment">//   postData</span></span><br><span class="line">    <span class="comment">// ).subscribe(response =&gt; console.log(response));</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="搬移-GET"><a href="#搬移-GET" class="headerlink" title="搬移 GET"></a>搬移 GET</h4><p>同樣作業搬移 fetchPost 工作部分，與前作業不同的是 GET 所回應的 response 有資料處理需求，而 POST 不需要考慮回應的資料如何處理。因此在 subscribe 部分應由 app 元件做等待，Service 只需處理到 pipe 即可，將整個非同步動作直接 return 給元件做訂閱。而 loading 提示的動作仍由 app 元件處置。</p>
<figure class="highlight typescript"><figcaption><span>http.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">fetchPost</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;&#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">PostModel</span> &#125;&gt;(</span><br><span class="line">    <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span></span><br><span class="line">  ).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">responseData</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(responseData);</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">postAry</span>: <span class="title class_">PostModel</span>[] = [];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> responseData) &#123;</span><br><span class="line">        <span class="keyword">if</span> (responseData.<span class="title function_">hasOwnProperty</span>(key))</span><br><span class="line">          postAry.<span class="title function_">push</span>(&#123; ...responseData[key], <span class="attr">id</span>: key &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> postAry;</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// ).subscribe(response =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//   this.loading = false; //※重點</span></span><br><span class="line">  <span class="comment">//   this.loadedPosts = response;</span></span><br><span class="line">  <span class="comment">// &#125;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">fetchPosts</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">loading</span> = <span class="literal">true</span>;<span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">HttpService</span>.<span class="title function_">fetchPost</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loading</span> = <span class="literal">false</span>; <span class="comment">//※重點</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadedPosts</span> = response;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// this.http.get&lt;&#123; [key: string]: PostModel &#125;&gt;(</span></span><br><span class="line">  <span class="comment">//   &#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span></span><br><span class="line">  <span class="comment">// ).pipe(</span></span><br><span class="line">  <span class="comment">//   map(responseData =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//     console.log(responseData);</span></span><br><span class="line">  <span class="comment">//     const postAry: PostModel[] = [];</span></span><br><span class="line">  <span class="comment">//     for (const key in responseData) &#123;</span></span><br><span class="line">  <span class="comment">//       if (responseData.hasOwnProperty(key))</span></span><br><span class="line">  <span class="comment">//         postAry.push(&#123; ...responseData[key], id: key &#125;)</span></span><br><span class="line">  <span class="comment">//     &#125;</span></span><br><span class="line">  <span class="comment">//     return postAry;</span></span><br><span class="line">  <span class="comment">//   &#125;)</span></span><br><span class="line">  <span class="comment">// ).subscribe(response =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//   this.loading = false; //※重點</span></span><br><span class="line">  <span class="comment">//   this.loadedPosts = response;</span></span><br><span class="line">  <span class="comment">// &#125;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DELETE-請求"><a href="#DELETE-請求" class="headerlink" title="DELETE 請求"></a>DELETE 請求</h3><p>同樣的對 clear Button 進行 HTTP 請求刪除所有資料，這部分依賴 Service 完成並回傳，使 app 元件透過訂閱完成後續動作（例如清空變數資料）。</p>
<figure class="highlight typescript"><figcaption><span>http.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">deletePostAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">delete</span>(</span><br><span class="line">    <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">onClearPosts</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Send Http request</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">HttpService</span>.<span class="title function_">deletePostAll</span>().<span class="title function_">subscribe</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadedPosts</span> = [];</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>隨著操作解析，第一次刪除按鈕會要求後端刪除資料，回應後前也刪除資料。隨事後更新按鈕按下則後端回傳空陣列使前端呈現無資料。</p>
<h2 id="Error-事件處置"><a href="#Error-事件處置" class="headerlink" title="Error 事件處置"></a>Error 事件處置</h2><p>進行 API 串接時，可能根據一些狀況產生非預期的行為進行回報。HttpClient 在發送 HTTP 請求時，如果收到非 2xx 的狀態碼，就會產生錯誤。錯誤對象包含多個屬性，前端可針對這部分做期望的錯誤考量處置。</p>
<p>首先我們先將 Firebase 的 read 權限進行關閉，使得 API 進行 GET 會發生錯誤的拒絕連線問題。來到 Firebase 網頁後台即時資料庫的規則參數，調整 read 為 false 拒絕寫入。</p>
<p><img src="https://i.imgur.com/H3h6Rjh.png"></p>
<p>現在任何的 GET 操作都能<kbd>F12</kbd> &gt; network 發現 401 連線錯誤。接下來會介紹三種方式處理 Error 作業，介紹順序以逐漸由高而推薦。</p>
<h3 id="訂閱-HttpClient-的-HttpErrorResponse"><a href="#訂閱-HttpClient-的-HttpErrorResponse" class="headerlink" title="訂閱 HttpClient 的 HttpErrorResponse"></a>訂閱 HttpClient 的 HttpErrorResponse</h3><p>使用 HttpClient 當發生錯誤時，不會進入正常 Response 環節（也就是原本的 pipe 管道不會觸發進行）。而是會以第二組參數回傳。因此訂閱此 httpClient 結果，能在第二個回傳參數做 Error 工作。唯一的缺點是如果沒有使用訂閱去處理此 API，我們會不知道發生什麼事。</p>
<p>若要將錯誤資訊顯示於畫面上，可規劃一個本地變數 errorMsg 為 null，當訂閱於發生錯誤時將錯誤資訊存於此。模板根據邏輯判斷是否有內容則顯示畫面上。</p>
<figure class="highlight typescript"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  errorResponse = <span class="literal">null</span>; <span class="comment">//※重點</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">fetchPosts</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loading</span> = <span class="literal">true</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 寫法一：</span></span><br><span class="line">    <span class="comment">// this.HttpService.fetchPost().subscribe(response =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//   this.loading = false;</span></span><br><span class="line">    <span class="comment">//   this.loadedPosts = response;</span></span><br><span class="line">    <span class="comment">// &#125;, err =&gt; &#123; //※重點，於第二組參數做 HttpErrorResponse</span></span><br><span class="line">    <span class="comment">//   this.loading = false; //※重點：發生錯誤也代表 loading 結束才對</span></span><br><span class="line">    <span class="comment">//   console.log(err); // ※重點：可觀察看看 HttpErrorResponse 夾帶那些 Spec. 屬性值被使用</span></span><br><span class="line">    <span class="comment">//   this.errorResponse = err;</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寫法二：</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">HttpService</span>.<span class="title function_">fetchPost</span>().<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">      <span class="attr">next</span>: <span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">loading</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">loadedPosts</span> = response;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">error</span>: <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">loading</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">errorResponse</span> = err;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>app.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-md-6 col-md-offset-3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> *<span class="attr">ngIf</span>=<span class="string">&quot;loading &amp;&amp; !errorResponse&quot;</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">p</span>&gt;</span> <span class="comment">&lt;!--無錯誤時--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-danger&quot;</span> *<span class="attr">ngIf</span>=<span class="string">&quot;errorResponse&quot;</span>&gt;</span> <span class="comment">&lt;!--有錯誤時--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>Opps! - &#123;&#123;errorResponse.error.error&#125;&#125;<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> <span class="comment">&lt;!--根據 API Error Spec. 狀況而使用 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;errorResponse.message&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> <span class="comment">&lt;!--根據 API Error Spec. 狀況而使用 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> *<span class="attr">ngIf</span>=<span class="string">&quot;loadedPosts.length&lt;1 &amp;&amp; !loading&quot;</span>&gt;</span>No posts available!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span></span></span><br><span class="line"><span class="tag">      *<span class="attr">ngIf</span>=<span class="string">&quot;loadedPosts.length&gt;0 &amp;&amp; !loading&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;list-group&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;list-group-item&quot;</span></span></span><br><span class="line"><span class="tag">        *<span class="attr">ngFor</span>=<span class="string">&quot;let item of loadedPosts&quot;</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123;item.title&#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;item.content&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;btn btn-danger&quot;</span></span></span><br><span class="line"><span class="tag">          (<span class="attr">click</span>)=<span class="string">&quot;errorResponse=null&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span>Close<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="comment">&lt;!--可關閉訊息，消除 errorResponse--&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="用-Subject-觀察-subscribe"><a href="#用-Subject-觀察-subscribe" class="headerlink" title="用 Subject 觀察 subscribe"></a>用 Subject 觀察 subscribe</h3><p>如前面提到，當沒有訂閱者去追蹤 API 的後續我們無法探知問題回報。如我們的 addPost 作業，subscribe 是寫在 service 內，而 app 元件不會得知問題出現。針對這問題可以考慮用 subject 來處理看看。</p>
<ul>
<li>於 Service 內建立一個 Subject，並於 post 的 errorResponse 內使該 Subject 受到變化</li>
<li>要求初始化生命階段 ngOnInit 下，對該 service 的 Subject 的訂閱結果做 errMsg 的處理。</li>
<li>為了銷毀這個訂閱之效能，於 component 建立一個型別為 Subscription 的變數，使得 ngOnDestroy 階段能找到此訂閱消除之。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>http.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpService</span> &#123;</span><br><span class="line">  errSubject = <span class="keyword">new</span> <span class="title class_">Subject</span>&lt;<span class="built_in">string</span>&gt;(); <span class="comment">//※重點</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">addPost</span>(<span class="params"><span class="attr">postData</span>: <span class="title class_">PostModel</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">post</span>(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span>,</span><br><span class="line">      postData</span><br><span class="line">    ).<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(response),</span><br><span class="line">      <span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">this</span>.<span class="property">errSubject</span>.<span class="title function_">next</span>(err) <span class="comment">//※重點</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./http.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnDestroy</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PostModel</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./post.model&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Subscription</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;<span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-root&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./app.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./app.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span>, <span class="title class_">OnDestroy</span> &#123;</span><br><span class="line">  loadedPosts = [];</span><br><span class="line">  loading = <span class="literal">false</span>; </span><br><span class="line">  errorResponse = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">errSubject</span>: <span class="title class_">Subscription</span>;<span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">http</span>: <span class="title class_">HttpClient</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">HttpService</span>: <span class="title class_">HttpService</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">errSubject</span> = <span class="variable language_">this</span>.<span class="property">HttpService</span>.<span class="property">errSubject</span>.<span class="title function_">subscribe</span>(<span class="function"><span class="params">errMsg</span> =&gt;</span> &#123;<span class="comment">//※重點</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">errorResponse</span> = errMsg;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(errMsg);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fetchPosts</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnDestroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">errSubject</span>.<span class="title function_">unsubscribe</span>();<span class="comment">//※重點</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到 Firebase 階段，可以把 write 也關閉為 false，使得寫入 POST 失敗。觀察是否新增資料時也呈現於畫面上（回應訊息會跟 Fetch 失敗一樣）。</p>
<h3 id="用-rxjs-的-catchError-處理"><a href="#用-rxjs-的-catchError-處理" class="headerlink" title="用 rxjs 的 catchError 處理"></a>用 rxjs 的 catchError 處理</h3><p>如果希望在 service 階段尚針對 error 做處理，可以利用 rxjs 的 catchError 於 pipe 管道內進行特別處理後。使得訂閱者可以獲得經處理過的 error 資訊。這裡額外多利用 throwError 做錯誤代表的 Observable 再回傳給前面提到的 HttpErrorResponse 或 Subject。</p>
<figure class="highlight typescript"><figcaption><span>http.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; catchError, map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Subject</span>, throwError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpService</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">fetchPost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;&#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">PostModel</span> &#125;&gt;(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span></span><br><span class="line">    ).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">map</span>(<span class="function"><span class="params">responseData</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(responseData);</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">postAry</span>: <span class="title class_">PostModel</span>[] = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> responseData) &#123;</span><br><span class="line">          <span class="keyword">if</span> (responseData.<span class="title function_">hasOwnProperty</span>(key))</span><br><span class="line">            postAry.<span class="title function_">push</span>(&#123; ...responseData[key], <span class="attr">id</span>: key &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> postAry;</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="title function_">catchError</span>(<span class="function"><span class="params">errorRes</span> =&gt;</span> &#123; <span class="comment">//※重點：catchError 可以處理發生錯誤時的處理</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">throwError</span>(errorRes); <span class="comment">//※重點：產生錯誤的 Observable 並回傳給訂閱者</span></span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="HttpClient-的相關設置"><a href="#HttpClient-的相關設置" class="headerlink" title="HttpClient 的相關設置"></a>HttpClient 的相關設置</h2><p>用於指定 Http 請求的配置選項。它可以包括請求的 URL、Http 的 method（GET、POST、PUT、DELETE 等等）、HttpHeaders、URLSearchParams、request body 等等。可以透過在 Angular 中注入 HttpClient，並使用該物件的 get()、post()、put()、delete() 等方法來發出 Http 請求。在這些方法中，可以傳遞一個選項對象。</p>
<h3 id="HttpHeaders-設定-Header-資訊"><a href="#HttpHeaders-設定-Header-資訊" class="headerlink" title="HttpHeaders 設定 Header 資訊"></a>HttpHeaders 設定 Header 資訊</h3><p>在使用 Angular 的 HttpClient 進行 HTTP 請求時，可以透過 HttpHeaders 類別設定 HTTP 請求的 headers，這可以讓我們在發送請求時，提供一些必要的信息，例如認證信息、內容類型等等。HttpHeaders 是不可變對象，需要使用 set 方法來添加或更改單個頭，或使用 append 方法來添加一個或多個頭。可以使用 HttpHeaders 的多種方法來創建或轉換頭。</p>
<ul>
<li>於 get 或 post 的下一個參數提供 httpOptions 相關資訊。其中重點為 headers 的值</li>
<li>使用 <code>new HttpHeaders()</code> 來建立 Headers 所需套入的各屬性</li>
</ul>
<figure class="highlight typescript"><figcaption><span>http.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span>, <span class="title class_">HttpHeaders</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpService</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">fetchPost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;&#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">PostModel</span> &#125;&gt;(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">headers</span>: <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>(&#123; <span class="comment">//※重點</span></span><br><span class="line">          <span class="title class_">CustomHeader</span>: <span class="string">&#x27;Loki Jiang&#x27;</span>,</span><br><span class="line">          <span class="title class_">Authorization</span>: <span class="string">&#x27;my-auth-token&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    ).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">map</span>(<span class="function"><span class="params">responseData</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(responseData);</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">postAry</span>: <span class="title class_">PostModel</span>[] = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> responseData) &#123;</span><br><span class="line">          <span class="keyword">if</span> (responseData.<span class="title function_">hasOwnProperty</span>(key))</span><br><span class="line">            postAry.<span class="title function_">push</span>(&#123; ...responseData[key], <span class="attr">id</span>: key &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> postAry;</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="title function_">catchError</span>(<span class="function"><span class="params">errorRes</span> =&gt;</span> <span class="title function_">throwError</span>(errorRes))</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>觀察經過 Fetch Button 動作的 <kbd>F12</kbd> &gt; network &gt; Headers &gt; Request Headers 內是否多了兩個自訂屬性。</p>
<div class="note info"><p><strong>HttpHeaders 物件是不可變的</strong><br>一但創建了一個 headers 物件就不能再修改了。如果需要在現有的 headers 基礎上添加新的 headers，可以改使用 append() 方式插入，舉例如下：</p>
<figure class="highlight typescript"><figcaption><span>http.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">fetchPost</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">let</span> myHeaders = <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>(); <span class="comment">// 空的</span></span><br><span class="line">   myHeaders = myHeaders.<span class="title function_">append</span>(<span class="string">&#x27;CustomHeader&#x27;</span>, <span class="string">&#x27;Loki Jiang&#x27;</span>); <span class="comment">// 插入</span></span><br><span class="line">   myHeaders = myHeaders.<span class="title function_">append</span>(<span class="string">&#x27;Authorization&#x27;</span>, <span class="string">&#x27;my-auth-token&#x27;</span>); <span class="comment">// 插入</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;&#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">PostModel</span> &#125;&gt;(</span><br><span class="line">     <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span>,</span><br><span class="line">     &#123;</span><br><span class="line">       <span class="attr">headers</span>: myHeaders,</span><br><span class="line">       <span class="comment">// headers: new HttpHeaders(&#123;</span></span><br><span class="line">       <span class="comment">//   CustomHeader: &#x27;Loki Jiang&#x27;,</span></span><br><span class="line">       <span class="comment">//   Authorization: &#x27;my-auth-token&#x27;</span></span><br><span class="line">       <span class="comment">// &#125;),</span></span><br><span class="line">     &#125;</span><br><span class="line">   ).<span class="title function_">pipe</span>(</span><br><span class="line">     <span class="title function_">map</span>(<span class="function"><span class="params">responseData</span> =&gt;</span> &#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(responseData);</span><br><span class="line">       <span class="keyword">const</span> <span class="attr">postAry</span>: <span class="title class_">PostModel</span>[] = [];</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> responseData) &#123;</span><br><span class="line">         <span class="keyword">if</span> (responseData.<span class="title function_">hasOwnProperty</span>(key))</span><br><span class="line">           postAry.<span class="title function_">push</span>(&#123; ...responseData[key], <span class="attr">id</span>: key &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> postAry;</span><br><span class="line">     &#125;),</span><br><span class="line">     <span class="title function_">catchError</span>(<span class="function"><span class="params">errorRes</span> =&gt;</span> <span class="title function_">throwError</span>(errorRes))</span><br><span class="line">   );</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="HttpParams-設定-Query-Params"><a href="#HttpParams-設定-Query-Params" class="headerlink" title="HttpParams 設定 Query Params"></a>HttpParams 設定 Query Params</h3><p>除了可以直接於 URL 上面填寫 Query 參數（例如<code>.../posts.json?print=pretty</code>)，也能在 httpClient 內透過 HttpParams 指定，寫法與前面 HttpHeaders 雷同。</p>
<figure class="highlight typescript"><figcaption><span>http.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span>, <span class="title class_">HttpHeaders</span>, <span class="title class_">HttpParams</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpService</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">fetchPost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> myHeaders = <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    myHeaders = myHeaders.<span class="title function_">append</span>(<span class="string">&#x27;CustomHeader&#x27;</span>, <span class="string">&#x27;Loki Jiang&#x27;</span>);</span><br><span class="line">    myHeaders = myHeaders.<span class="title function_">append</span>(<span class="string">&#x27;Authorization&#x27;</span>, <span class="string">&#x27;my-auth-token&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> myParams = <span class="keyword">new</span> <span class="title class_">HttpParams</span>();</span><br><span class="line">    myParams = myParams.<span class="title function_">append</span>(<span class="string">&#x27;print&#x27;</span>, <span class="string">&#x27;pretty&#x27;</span>);</span><br><span class="line">    myParams = myParams.<span class="title function_">append</span>(<span class="string">&#x27;todo&#x27;</span>, <span class="string">&#x27;add&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;&#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">PostModel</span> &#125;&gt;(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">headers</span>: myHeaders,</span><br><span class="line">        <span class="comment">// headers: new HttpHeaders(&#123;</span></span><br><span class="line">        <span class="comment">//   CustomHeader: &#x27;Loki Jiang&#x27;,</span></span><br><span class="line">        <span class="comment">//   Authorization: &#x27;my-auth-token&#x27;</span></span><br><span class="line">        <span class="comment">// &#125;),</span></span><br><span class="line">        <span class="attr">params</span>: myParams</span><br><span class="line">        <span class="comment">// params: new HttpParams().set(&#x27;article&#x27;, &#x27;3&#x27;)</span></span><br><span class="line">      &#125;</span><br><span class="line">    ).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">map</span>(<span class="function"><span class="params">responseData</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(responseData);</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">postAry</span>: <span class="title class_">PostModel</span>[] = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> responseData) &#123;</span><br><span class="line">          <span class="keyword">if</span> (responseData.<span class="title function_">hasOwnProperty</span>(key))</span><br><span class="line">            postAry.<span class="title function_">push</span>(&#123; ...responseData[key], <span class="attr">id</span>: key &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> postAry;</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="title function_">catchError</span>(<span class="function"><span class="params">errorRes</span> =&gt;</span> <span class="title function_">throwError</span>(errorRes))</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>觀察經過 Fetch Button 動作的 <kbd>F12</kbd> &gt; network &gt; General &gt; Request URL 內是否多了兩個 Query 屬性。</p>
<blockquote>
<p><code>?print=pretty</code>剛始是 Firebase 的 Query 參數功能，可以將 response 格式美化，可以嘗試到 Firebase 後台將 read 功能 true 查看效果。</p>
</blockquote>
<h3 id="observe-觀察-response"><a href="#observe-觀察-response" class="headerlink" title="observe 觀察 response"></a>observe 觀察 response</h3><p>observe 參數是指要觀察的 response 型別，可選值包括 body、response、events。若設為 body，則 HttpClient 會嘗試將 response body 轉換為指定的 response 型別，如 JSON 或文字等。若設為 response，則 HttpClient 會將整個 response 回傳，包含 headers、status code 等資訊。若設為 events，則 HttpClient 會回傳一個事件流（Observable），可用於監聽 request 的進度及狀態。通常預設值是 “body”。</p>
<p>未指定的情況下只會回傳 response 數據，若要檢查 HttpResponse  完整資訊，可這樣做（以 addPost 為示範）:</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">addPost</span>(<span class="params"><span class="attr">postData</span>: <span class="title class_">PostModel</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">post</span>(</span><br><span class="line">    <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span>,</span><br><span class="line">    postData,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">observe</span>: <span class="string">&#x27;response&#x27;</span> <span class="comment">//※重點：觀察完整的 HttpResponse </span></span><br><span class="line">    &#125;</span><br><span class="line">  ).<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(response),</span><br><span class="line">    <span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">this</span>.<span class="property">errSubject</span>.<span class="title function_">next</span>(err)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>觀察經過 Send Button 動作的 <kbd>F12</kbd> &gt; console.log 能呈現所有 HttpResponse 資訊，涵蓋了 body,headers,status… 等等。</p>
<p>若要觀察 API 的 event 事件處理，舉例來說當進行 deletePostAll 時，會有 api 的送出與返回兩個事件。可以透過<code>observe: &#39;events&#39;</code>來觀察並做對應處理。其中 event 底下 type 能代表目前是 Send（數字 0),Response（數字 4)… 等等事件類別。我們可利用 angular 的<code>HttpEventType</code>做判斷。以下根據刪除 API 作判別處理 SEND 與 RESPONSE 的處置。</p>
<figure class="highlight typescript"><figcaption><span>http.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span>, <span class="title class_">HttpEventType</span>, <span class="title class_">HttpHeaders</span>, <span class="title class_">HttpParams</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpService</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">deletePostAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">delete</span>(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">observe</span>: <span class="string">&#x27;events&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">tap</span>(<span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (event.<span class="property">type</span> === <span class="title class_">HttpEventType</span>.) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;刪除提交中&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (event.<span class="property">type</span> === <span class="title class_">HttpEventType</span>.<span class="property">Response</span>) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;刪除已回應&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(event);</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>RxJS 的 tap 操作符用於監視 Observable 的值，並在它們被發出時執行一些操作，而不影響流中的元素。它是一種副作用操作符，因為它不會修改流中的元素，但是可以對 Observable 中的值執行副作用操作，例如打印日誌、修改變數等等。<br>需要注意的是，tap 操作符不會改變流中的元素，而是返回一個與源 Observable 相同的 Observable。因此，在 tap 操作符後面可以接其他操作符，例如 map、filter、reduce 等等。</p>
</blockquote>
<h3 id="responseType-指定回應型別"><a href="#responseType-指定回應型別" class="headerlink" title="responseType 指定回應型別"></a>responseType 指定回應型別</h3><p>預設為 json 型別，我們也能指定回傳的 response 該用怎樣的型別回傳。除非你有需要可以抽換成’text’而不是預設的’json’，此範例不會特別改成其他避免 json 處理失敗。</p>
<figure class="highlight typescript"><figcaption><span>http.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">deletePostAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">delete</span>(</span><br><span class="line">    <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">observe</span>: <span class="string">&#x27;events&#x27;</span>,</span><br><span class="line">      <span class="attr">responseType</span>: <span class="string">&#x27;text&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">type</span> === <span class="title class_">HttpEventType</span>.<span class="property">Sent</span>) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;刪除提交中&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">type</span> === <span class="title class_">HttpEventType</span>.<span class="property">Response</span>) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;刪除已回應&#x27;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(event);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="HttpInterceptor-攔截處理"><a href="#HttpInterceptor-攔截處理" class="headerlink" title="HttpInterceptor 攔截處理"></a>HttpInterceptor 攔截處理</h2><p>HttpInterceptor 是 Angular 中一個重要的功能，可以在發送請求和接收響應的過程中對它們進行攔截和處理。通常情況下，HttpInterceptor 被用來實現以下幾個功能：</p>
<ul>
<li>設置 Http 請求的 headers，如授權信息，token 等等。</li>
<li>在發送 Http 請求前進行簡單的日誌記錄。</li>
<li>在響應返回之前對其進行處理和轉換，例如：添加 response header，篩選和修改返回的數據等等。</li>
</ul>
<p>通過實現 HttpInterceptor，我們可以將這些重複的代碼抽取出來，使代碼更加清晰簡潔，而且還可以很方便地對 Http 請求和響應進行統一處理。</p>
<ul>
<li>透過 cli 指令<code>ng g s auth-interceptor --skip-tests=true</code>建立 service 為 auth-interceptor.service.ts</li>
<li>對 class AuthInterceptorService 進行介面定義取自 HttpInterceptor，這部分可從 angular http 取得 import。</li>
</ul>
<h3 id="intercept-實作方法"><a href="#intercept-實作方法" class="headerlink" title="intercept 實作方法"></a>intercept 實作方法</h3><p>intercept 是 HttpInterceptor 介面中必須實作的方法之一，它用來攔截 HTTP 請求，並且可以對請求進行變更、增加欄位、設定 headers 等等。intercept 方法的輸入參數是 HttpRequest 和 HttpHandler。當 intercept 方法被呼叫時，會把當前的 HttpRequest 對象傳入這個方法，並傳入一個 HttpHandler 對象。HttpHandler 對象可以用來發送 HTTP 請求。</p>
<p>在 intercept 方法中，可以先對 HttpRequest 對象進行變更、增加欄位、設定 headers 等等。然後，再使用 HttpHandler 對象的 handle 方法來發送經過修改後的請求。</p>
<p>最後，handle 方法返回一個 <code>Observable&lt;HttpEvent&lt;any&gt;&gt;</code>。這個 Observable 可以被訂閱，以獲取由後端返回的數據。如果不訂閱這個 Observable，那麼這個請求就不會被發送出去。</p>
<ul>
<li>接著編寫 intercept 於 AuthInterceptorService 內。</li>
<li>下列代碼範例中，我們嘗試攔截 request 並調整為含有 Headers 的新 authReq，以及 response 回應的部分動作。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth-interceptor.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpEvent</span>, <span class="title class_">HttpHandler</span>, <span class="title class_">HttpInterceptor</span>, <span class="title class_">HttpRequest</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="comment">// import &#123; Injectable &#125; from &#x27;@angular/core&#x27;;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不宣告於此，稍晚定義於 app.modules.ts 內</span></span><br><span class="line"><span class="comment">// @Injectable(&#123;</span></span><br><span class="line"><span class="comment">//   providedIn: &#x27;root&#x27;</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthInterceptorService</span> <span class="keyword">implements</span> <span class="title class_">HttpInterceptor</span> &#123;</span><br><span class="line">  <span class="title function_">intercept</span>(<span class="attr">req</span>: <span class="title class_">HttpRequest</span>&lt;<span class="built_in">any</span>&gt;, <span class="attr">next</span>: <span class="title class_">HttpHandler</span>): <span class="title class_">Observable</span>&lt;<span class="title class_">HttpEvent</span>&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;API 攔截處理中&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在請求被發送前執行一些前置處理，例如加入 token 到 headers 中</span></span><br><span class="line">    <span class="keyword">const</span> authReq = req.<span class="title function_">clone</span>(&#123;</span><br><span class="line">      <span class="attr">headers</span>: req.<span class="property">headers</span>.<span class="title function_">set</span>(<span class="string">&#x27;Authorization&#x27;</span>, <span class="string">&#x27;Loki insert by intercept!!&#x27;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//這裡用 set 修改，也可以使用 append 插入新的 headers 其他屬性資訊</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 攔截並繼續執行請求，處理後續的響應</span></span><br><span class="line">    <span class="keyword">return</span> next.<span class="title function_">handle</span>(authReq).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">tap</span>(</span><br><span class="line">        <span class="function"><span class="params">event</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;HttpResponse&#x27;</span>, event),</span><br><span class="line">        <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;HttpErrorResponse&#x27;</span>, error)</span><br><span class="line">      )</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// constructor() &#123; &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="註冊-Interceptor-於-app-modules-ts"><a href="#註冊-Interceptor-於-app-modules-ts" class="headerlink" title="註冊 Interceptor 於 app.modules.ts"></a>註冊 Interceptor 於 app.modules.ts</h3><p>要註冊 Interceptor 於 AppModule 中，需先在 providers 陣列中加入對應的 Interceptor 服務，並使用 { provide, useClass } 的方式告訴 Angular 要提供哪個服務以及使用哪個 Interceptor 類別。透過提供 HTTP_INTERCEPTORS 令牌，將 Interceptor 加入 providers 陣列中。</p>
<p>在下面的範例中，我們提供了 HTTP_INTERCEPTORS 令牌，設定其值為 AuthInterceptorService 此服務，並將 multi 設為 true。multi 的設定代表我們可能會有多個 Interceptor，所以需要設為 true，讓 Angular 知道有多個 Interceptor，可以和其他的 Interceptor 一起運作。</p>
<figure class="highlight typescript"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthInterceptorService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth-interceptor.service&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/platform-browser&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FormsModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClientModule</span>, <span class="variable constant_">HTTP_INTERCEPTORS</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>; <span class="comment">//※重點</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [<span class="title class_">AppComponent</span>],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">BrowserModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">    <span class="title class_">HttpClientModule</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: [&#123; <span class="comment">//※重點</span></span><br><span class="line">    <span class="attr">provide</span>: <span class="variable constant_">HTTP_INTERCEPTORS</span>,</span><br><span class="line">    <span class="attr">useClass</span>: <span class="title class_">AuthInterceptorService</span>,</span><br><span class="line">    <span class="attr">multi</span>: <span class="literal">true</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<h4 id="註冊多個-Interceptor"><a href="#註冊多個-Interceptor" class="headerlink" title="註冊多個 Interceptor"></a>註冊多個 Interceptor</h4><p>這裡多規劃一個新的 Interceptor 服務，試圖註冊兩組 Interceptor 到 app.module.ts</p>
<ul>
<li>透過 cli 指令<code>ng g s login-interceptor --skip-tests=true</code>建立 service 為 login-interceptor.service.ts</li>
<li>調整與前例雷同的代碼環境。包含<code>implements HttpInterceptor</code>與<code>intercept()</code></li>
</ul>
<figure class="highlight typescript"><figcaption><span>login-interceptor.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpInterceptor</span>, <span class="title class_">HttpEventType</span>, <span class="title class_">HttpRequest</span>, <span class="title class_">HttpHandler</span>, <span class="title class_">HttpEvent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptorService</span> <span class="keyword">implements</span> <span class="title class_">HttpInterceptor</span> &#123;</span><br><span class="line">  <span class="title function_">intercept</span>(<span class="attr">req</span>: <span class="title class_">HttpRequest</span>&lt;<span class="built_in">any</span>&gt;, <span class="attr">next</span>: <span class="title class_">HttpHandler</span>): <span class="title class_">Observable</span>&lt;<span class="title class_">HttpEvent</span>&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Login 攔截處理中&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">url</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next.<span class="title function_">handle</span>(req).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">tap</span>(</span><br><span class="line">        <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (event.<span class="property">type</span> === <span class="title class_">HttpEventType</span>.<span class="property">Response</span>) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Login is Response&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      )</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到 app.module.ts，只需要第二組 intercept 添加在 providers 陣列內即可。</p>
<blockquote>
<p>注意陣列順序前後，所有的 api 會先依序套入前一個開始依序做攔截處理。</p>
</blockquote>
<figure class="highlight typescript"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoginInterceptorService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./login-interceptor.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthInterceptorService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth-interceptor.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/platform-browser&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FormsModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClientModule</span>, <span class="variable constant_">HTTP_INTERCEPTORS</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [<span class="title class_">AppComponent</span>],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">BrowserModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">    <span class="title class_">HttpClientModule</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="variable constant_">HTTP_INTERCEPTORS</span>,</span><br><span class="line">      <span class="attr">useClass</span>: <span class="title class_">AuthInterceptorService</span>,</span><br><span class="line">      <span class="attr">multi</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="variable constant_">HTTP_INTERCEPTORS</span>,</span><br><span class="line">      <span class="attr">useClass</span>: <span class="title class_">LoginInterceptorService</span>,</span><br><span class="line">      <span class="attr">multi</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<h1 id="身分驗證與路由防護"><a href="#身分驗證與路由防護" class="headerlink" title="身分驗證與路由防護"></a>身分驗證與路由防護</h1><p>身分驗證是一個非常重要的安全性功能，尤其對於需要保護資料或是資源的應用程式來說更是必要的。以下是一個基本的身分驗證設計：</p>
<ul>
<li><strong>登入流程</strong><br>使用者輸入帳號密碼，系統驗證使用者身分是否正確，如果正確則系統會回傳一組 token，通常是一個經過加密的字串。</li>
<li><strong>token</strong><br>token 是一個代表使用者身分的識別碼，通常儲存在使用者端的 cookie 或是 local storage 中，可以透過這個 token 來辨識使用者的身分。為了增加安全性，通常會將 token 設定一個過期時間，以確保不會長時間存在於使用者端。</li>
<li><strong>身分驗證</strong><br>當使用者需要訪問受保護的資源時，系統會先檢查使用者是否已經登入，如果沒有登入則導向登入頁面；如果已經登入，系統會檢查 token 是否合法，以確保使用者的身分是正確的。</li>
<li><strong>登出流程</strong><br>使用者可以透過系統提供的登出功能來銷毀 token，以結束身分驗證的狀態。</li>
<li><strong>token 更新</strong><br>為了避免 token 過期，系統可以提供一個 token 更新的機制，當 token 快要過期時，系統會自動更新 token，以確保使用者可以繼續使用應用程式而不會因為 token 過期而被迫重新登入。</li>
</ul>
<p>總結來說，身分驗證是一個涉及到安全性的重要功能，必須要設計得周全並且符合實際應用需求，例如使用加密的 token、設定過期時間、提供登出機制等，才能夠確保使用者的資料和資源得到適當的保護。</p>
<p>以傳統網頁設計來說，後端會使用 SESSION 方式作為身分驗證的設計。但由於 Angular 的 SPA 設計理念會使用 RESTful API 作為伺服器的連線處理，因此 SESSION 並不適合被使用，API 類型的 Server 本身並不會對 Client 端進行綁定 SESSION 對應，而用戶端透過 HttpClient 進行通信。API 類型的 Server 會向 Client 端發送一個 JSON 格式的 Web Token 字串，通常是未加密編碼可被解讀出。並被存放於 Client 端的 LocalStorage 之內。</p>
<p>隨著每次 API 連線透過 Headers 傳送，後端會進行該 Token 驗證特定算法與私鑰產稱 Token 對比檢查，確保 token 正確性而鴂定是否禁止拜訪。</p>
<h2 id="環境建置準備-1"><a href="#環境建置準備-1" class="headerlink" title="環境建置準備"></a>環境建置準備</h2><p>本篇的起始素材放置於 GitHub 底下提供使用，使用資料目錄 lokiHttp 作為初始環境。下載請記得 npm install 初始化環境。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/summer10920/angularTraining">Github download</a> at lokiHttp-start Folder</p>
</blockquote>
<p>我們會在此素材上設計一個 auth 頁面提供註冊與登入。而整個 app 根據用戶是否登入來決定部分功能是否顯示使用。</p>
<h3 id="設計-auth-元件"><a href="#設計-auth-元件" class="headerlink" title="設計 auth 元件"></a>設計 auth 元件</h3><p>本素材已提供 AuthComponent 以下步驟可省略。僅作為提示要新增一元件於 App 內遵循以下步驟：</p>
<ul>
<li>手動建立 AuthComponent 或透過 CLI 指令<code>ng g c auth --skip-tests=true</code>完成。</li>
<li>至 app.module.ts 內將 AuthComponent 加入 declarations 的聲明陣列內，確保可被使用。</li>
<li>至 app-routing.module.ts 內將指定路徑（例如<code>&#123; path: &#39;auth&#39;, component: AuthComponent &#125;</code>) 添加於 Routes 指定陣列內，確保路徑下能拜訪此元件。</li>
<li>同上，嘗試網址輸入 <code>localhost:4200/auth</code> 能否頁面存在且成功。</li>
<li>於想要的畫面位置（本素材為 header 元件）上使用 routerLink 呈現該連結導向（例如<code>&lt;a routerLink=&quot;/auth&quot;&gt;Authenticate&lt;/a&gt;</code>)，引導用戶連結拜訪頁面。</li>
</ul>
<h2 id="Login-SignUp-切換"><a href="#Login-SignUp-切換" class="headerlink" title="Login&#x2F;SignUp 切換"></a>Login&#x2F;SignUp 切換</h2><p>為了介面好看，在此設計一個 switch 按鈕能改變表單用途（登入用或註冊用），可利用一個本地變數作為 flag 標記。</p>
<ul>
<li>建立 isLoginMode 本地變數為 boolean</li>
<li>規劃 onSwitchMode 控制 isLoginMode 顛倒布林值</li>
<li>於 html 模板上規劃對應的 click 事件，以及應呈現的文字之三元邏輯。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-auth&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./auth.component.html&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthComponent</span> &#123;</span><br><span class="line">  isLoginMode = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSwitchMode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoginMode</span> = !<span class="variable language_">this</span>.<span class="property">isLoginMode</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>auth.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-md-6 col-md-offset-3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;email&quot;</span>&gt;</span>E-Mail<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">&quot;email&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">id</span>=<span class="string">&quot;email&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;password&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">id</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span>&#123;&#123;isLoginMode?&#x27;Login&#x27;:&#x27;Sign Up&#x27;&#125;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span> | <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span></span></span><br><span class="line"><span class="tag">          (<span class="attr">click</span>)=<span class="string">&quot;onSwitchMode()&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span>Switch to &#123;&#123;!isLoginMode?&#x27;Login&#x27;:&#x27;Sign Up&#x27;&#125;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Template-driven-表單處理"><a href="#Template-driven-表單處理" class="headerlink" title="Template-driven 表單處理"></a>Template-driven 表單處理</h2><p>本素材使用 TD 方式進行處理（亦可使用 Reactive forms 設計），遵循以下設計發想：</p>
<ul>
<li>對 email 欄位增加 TD 需要的 ngModel、名稱 email、必填 required、email 為驗證條件</li>
<li>對 password 欄位增加 TD 需要的 ngModel、名稱 password、必填 required、最少 6 字元為驗證條件</li>
<li>對 form 元素綁定 ngForm 且規劃別名為 authForm。</li>
<li>對 submit 按鈕設定禁用條件為當 authForm 為驗證錯誤時</li>
<li>規劃 ngSubmit 事件成立時執行自訂函式 onSubmit 並將整個 authForm 作為參數處理</li>
<li>onSubmit 會將此 form 的 value 測試輸出</li>
</ul>
<figure class="highlight html"><figcaption><span>auth.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-md-6 col-md-offset-3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span></span></span><br><span class="line"><span class="tag">      #<span class="attr">authForm</span>=<span class="string">&quot;ngForm&quot;</span></span></span><br><span class="line"><span class="tag">      (<span class="attr">ngSubmit</span>)=<span class="string">&quot;onSubmit(authForm)&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;email&quot;</span>&gt;</span>E-Mail<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">&quot;email&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">id</span>=<span class="string">&quot;email&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">ngModel</span></span></span><br><span class="line"><span class="tag">          <span class="attr">name</span>=<span class="string">&quot;email&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">required</span></span></span><br><span class="line"><span class="tag">          <span class="attr">email</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;password&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">id</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">ngModel</span></span></span><br><span class="line"><span class="tag">          <span class="attr">name</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">required</span></span></span><br><span class="line"><span class="tag">          <span class="attr">minlength</span>=<span class="string">&quot;6&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="tag">          [<span class="attr">disabled</span>]=<span class="string">&quot;authForm.invalid&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span>&#123;&#123;isLoginMode?&#x27;Login&#x27;:&#x27;Sign Up&#x27;&#125;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span> | <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span></span></span><br><span class="line"><span class="tag">          (<span class="attr">click</span>)=<span class="string">&quot;onSwitchMode()&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span>Switch to &#123;&#123;!isLoginMode?&#x27;Login&#x27;:&#x27;Sign Up&#x27;&#125;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>auth.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgForm</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-auth&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./auth.component.html&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthComponent</span> &#123;</span><br><span class="line">  isLoginMode = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSwitchMode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoginMode</span> = !<span class="variable language_">this</span>.<span class="property">isLoginMode</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSubmit</span>(<span class="params"><span class="attr">form</span>: <span class="title class_">NgForm</span></span>) &#123;<span class="comment">//※重點</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(form.<span class="property">value</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="fireBase-註冊登入的身分驗證"><a href="#fireBase-註冊登入的身分驗證" class="headerlink" title="fireBase 註冊登入的身分驗證"></a>fireBase 註冊登入的身分驗證</h2><p>本素材仍以 fireBase 作為我們的後端 API 站點，拜訪 <a target="_blank" rel="noopener" href="https://console.firebase.google.com/">fireBase</a> </p>
<ul>
<li>找到即時資料庫之規則編寫讀寫條件當 auth 有內容才允許讀寫。</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;.read&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth!=null&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;.write&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth!=null&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>根據 firebase 文檔教學，點選”建構&gt;Authentication”，新增一組登入方式為”電子郵件&#x2F;密碼”做為我們登入方式</li>
</ul>
<p><img src="https://i.imgur.com/KxX6WnR.png"><br><img src="https://i.imgur.com/OGioB9i.png"></p>
<blockquote>
<p>REST API 文件<br>你可以從 <a target="_blank" rel="noopener" href="https://firebase.google.com/docs/reference/rest/database?hl=zh-tw">Firebase 說明文件</a> 去了解如何進行 REST API 之完整應用規劃。在此我們會用到的 <a target="_blank" rel="noopener" href="https://firebase.google.com/docs/reference/rest/auth?hl=zh-tw">auth 功能文件</a> 當中的<mark><a target="_blank" rel="noopener" href="https://firebase.google.com/docs/reference/rest/auth?hl=zh-tw#section-create-email-password">使用電子郵件&#x2F;密碼註冊</a></mark>與<mark><a target="_blank" rel="noopener" href="https://firebase.google.com/docs/reference/rest/auth?hl=zh-tw#section-sign-in-email-password">使用電子郵件&#x2F;密碼登錄</a></mark>。</p>
</blockquote>
<h3 id="註冊-API"><a href="#註冊-API" class="headerlink" title="註冊 API"></a>註冊 API</h3><p>從 <a target="_blank" rel="noopener" href="https://firebase.google.com/docs/reference/rest/auth?hl=zh-tw#section-create-email-password">使用電子郵件&#x2F;密碼註冊</a> 文件當中，已提供指定的端點 URL, 請求 require 格式，回應 response 格式。</p>
<p><img src="https://i.imgur.com/IrGMTRa.png"></p>
<blockquote>
<p>[API_KEY] 可以從專案總覽&gt;專案設定&gt;一般設定&gt;網路 API 金鑰找到。而文件內因中文翻譯請改用英文確認 Property Name 為屬性名稱。</p>
</blockquote>
<h4 id="設計-auth-service-ts-與元件"><a href="#設計-auth-service-ts-與元件" class="headerlink" title="設計 auth.service.ts 與元件"></a>設計 auth.service.ts 與元件</h4><p>藉此規劃我們所需的 auth.service.ts。</p>
<ul>
<li>手動新增 auth.service.ts 或 CLI 指令<code>ng g s auth --skip-tests=true</code></li>
<li>規劃 signUp 函式，接受來自表單引數 email 與 password，指向 URL 並提供指定的 require 型別。</li>
<li>同上，response 返回的型別透過 interface 規劃，並宣告於該 http.post 的<code>&lt;&gt;</code>泛型函式之上。</li>
<li>記得 return 這個可觀察的 API 結果。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth/auth.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">AuthResponseData</span> &#123;</span><br><span class="line">  <span class="attr">idToken</span>: <span class="built_in">string</span>; <span class="comment">// Firebase 身份驗證 ID 令牌</span></span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>; <span class="comment">// 用戶的電子郵件</span></span><br><span class="line">  <span class="attr">refreshToken</span>: <span class="built_in">string</span>; <span class="comment">// Firebase 身份驗證刷新 token</span></span><br><span class="line">  <span class="attr">expiresIn</span>: <span class="built_in">string</span>; <span class="comment">// token 過期的秒數</span></span><br><span class="line">  <span class="attr">localId</span>: <span class="built_in">string</span>; <span class="comment">// 用戶的 uid</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">http</span>: <span class="title class_">HttpClient</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">singUp</span>(<span class="params"><span class="attr">email</span>: <span class="built_in">string</span>, <span class="attr">password</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="title class_">AuthResponseData</span>&gt;(</span><br><span class="line">      <span class="string">&#x27;https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=AIzaSyBD5oglUIsgkYiQlabvMw1Y8OGsGC_w6JA&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">email</span>: email,</span><br><span class="line">        <span class="attr">password</span>: password,</span><br><span class="line">        <span class="attr">returnSecureToken</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著編寫註冊動作的 API 串接，有以下步驟要點：</p>
<ul>
<li>不論是 Submit 還是 Login，只要表單驗證存在我們就不處理</li>
<li>判斷 isLoginMode 是登入用還是註冊用做對應的行為</li>
<li>透過 AuthService 傳送 form 的 email 與 password，並訂閱結果成功顯示 response，失敗顯示 error 資訊。</li>
<li>最後不論是登入用還是註冊用，都清除表單欄位</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgForm</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-auth&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./auth.component.html&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthComponent</span> &#123;</span><br><span class="line">  isLoginMode = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">AuthService</span>: <span class="title class_">AuthService</span> <span class="comment">//※重要</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSwitchMode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoginMode</span> = !<span class="variable language_">this</span>.<span class="property">isLoginMode</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSubmit</span>(<span class="params"><span class="attr">form</span>: <span class="title class_">NgForm</span></span>) &#123;</span><br><span class="line">    <span class="comment">// console.log(form.value);</span></span><br><span class="line">    <span class="keyword">if</span> (form.<span class="property">invalid</span>) <span class="keyword">return</span>; <span class="comment">//※重要</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isLoginMode</span>) &#123; <span class="comment">//※重要</span></span><br><span class="line">      <span class="comment">// 登入作業</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//※重要：註冊作業</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="title function_">singUp</span>(form.<span class="property">value</span>.<span class="property">email</span>, form.<span class="property">value</span>.<span class="property">password</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">        <span class="function"><span class="params">resData</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(resData),</span><br><span class="line">        <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(error)</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    form.<span class="title function_">reset</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>嘗試畫面操作註冊提交，觀察 console 以及 fireBase 的 Users 資料是否已添加。且 Firebase 預設會對重複註冊相同 email 的帳戶作拒絕。</p>
<h4 id="設計-Loading-與-Error-Alert"><a href="#設計-Loading-與-Error-Alert" class="headerlink" title="設計 Loading 與 Error Alert"></a>設計 Loading 與 Error Alert</h4><p>可新增一個 component 做為 html&#x2F;css 版型，規劃一個 Loading 動畫圖示插入根據 API 處理等待過程做為畫面提示。Loading 動畫可以從免費的 <a target="_blank" rel="noopener" href="https://loading.io/">loading.io</a> 取得喜歡圖示的 html+css 語法。</p>
<ul>
<li>手動或透過 CLI 指令<code>ng g c shared/loading-spinner --skip-tests --inline-template</code>，只生成 ts 與 css 的元件規畫於 Shared 目錄下，注意 app.module.ts 的 declarations 需聲明置入此 component。</li>
<li>將選用 loading icon 的 HTML 部分編寫於 loading-spinner.component.ts 底下 Component 的 template 內</li>
<li>將選用 loading icon 的 CSS 部分編寫於 loading-spinner.component.css</li>
</ul>
<figure class="highlight typescript"><figcaption><span>src\app\shared\loading-spinner\loading-spinner.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-loading-spinner&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;loadingio-spinner-spinner-7262uuxelp&quot;&gt;&lt;div class=&quot;ldio-tozapb7zt8&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./loading-spinner.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoadingSpinnerComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><figcaption><span>src\app\shared\loading-spinner\loading-spinner.component.css</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">@keyframes</span> ldio-tozapb7zt8 &#123;</span><br><span class="line">  <span class="number">0%</span> &#123;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">100%</span> &#123;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">94px</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">48px</span>;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">animation</span>: ldio-tozapb7zt8 linear <span class="number">1s</span> infinite;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">12px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">24px</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">6px</span> / <span class="number">12px</span>;</span><br><span class="line">  <span class="attribute">transform-origin</span>: <span class="number">6px</span> <span class="number">52px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">0deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">0.9166666666666666s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">2</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">30deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">0.8333333333333334s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">3</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">60deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">0.75s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">4</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">90deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">0.6666666666666666s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">5</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">120deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">0.5833333333333334s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">6</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">150deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">0.5s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">7</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">180deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">0.4166666666666667s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">8</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">210deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">0.3333333333333333s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">9</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">240deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">0.25s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">10</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">270deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">0.16666666666666666s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">11</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">300deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">0.08333333333333333s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-child</span>(<span class="number">12</span>) &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">330deg</span>);</span><br><span class="line">  <span class="attribute">animation-delay</span>: <span class="number">0s</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fe718d</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.loadingio-spinner-spinner-7262uuxelp</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#ffffff</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">translateZ</span>(<span class="number">0</span>) <span class="built_in">scale</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="attribute">backface-visibility</span>: hidden;</span><br><span class="line">  <span class="attribute">transform-origin</span>: <span class="number">0</span> <span class="number">0</span>; <span class="comment">/* see note above */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ldio-tozapb7zt8</span> <span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">box-sizing</span>: content-box;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* generated by https://loading.io/ */</span></span><br></pre></td></tr></table></figure>

<ul>
<li>回到 auth.component.html，將剛新增的 component 以 app 版型方式插入位置處。並以 isLoading 變數來控制顯示 form 元素或是 loading 元素。</li>
<li>isLoading 初始為 false，隨 API 的發送與回應階段控制 Boolean 值變換。</li>
<li>同樣巧思規劃錯誤訊息，以 isError 變數來控制顯示 alert 元素是否出現。</li>
</ul>
<figure class="highlight html"><figcaption><span>auth.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-md-6 col-md-offset-3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app-loading-spinner</span> *<span class="attr">ngIf</span>=<span class="string">&quot;isLoading&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">app-loading-spinner</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span></span></span><br><span class="line"><span class="tag">      #<span class="attr">authForm</span>=<span class="string">&quot;ngForm&quot;</span></span></span><br><span class="line"><span class="tag">      (<span class="attr">ngSubmit</span>)=<span class="string">&quot;onSubmit(authForm)&quot;</span></span></span><br><span class="line"><span class="tag">      *<span class="attr">ngIf</span>=<span class="string">&quot;!isLoading&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>auth.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgForm</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-auth&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./auth.component.html&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthComponent</span> &#123;</span><br><span class="line">  isLoginMode = <span class="literal">true</span>;</span><br><span class="line">  isLoading = <span class="literal">false</span>;</span><br><span class="line">  isError = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">AuthService</span>: <span class="title class_">AuthService</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSwitchMode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoginMode</span> = !<span class="variable language_">this</span>.<span class="property">isLoginMode</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSubmit</span>(<span class="params"><span class="attr">form</span>: <span class="title class_">NgForm</span></span>) &#123;</span><br><span class="line">    <span class="comment">// console.log(form.value);</span></span><br><span class="line">    <span class="keyword">if</span> (form.<span class="property">invalid</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isLoginMode</span>) &#123;</span><br><span class="line">      <span class="comment">// 登入作業</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 註冊作業</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="title function_">singUp</span>(form.<span class="property">value</span>.<span class="property">email</span>, form.<span class="property">value</span>.<span class="property">password</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">        <span class="function"><span class="params">resData</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(resData);</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// console.error(error);</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">isError</span> = error.<span class="property">error</span>.<span class="property">error</span>.<span class="property">message</span>;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    form.<span class="title function_">reset</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此時故意重複帳號註冊，會出現 loading icon 也能出現 Alert 指定的錯誤字串。</p>
<p>然而為了更好的 Error 事件處理，我們可以將錯誤處理放置於 Service 內執行，使得 Component 更精簡。此外錯誤訊息的對應文字可以更白話，參考該文件的常見錯誤代碼表示：</p>
<ul>
<li>EMAIL_EXISTS：電子郵件地址已被另一個帳戶使用。</li>
<li>OPERATION_NOT_ALLOWED：此項目禁用密碼登錄。</li>
<li>TOO_MANY_ATTEMPTS_TRY_LATER：由於異常活動，我們已阻止來自此設備的所有請求。稍後再試。</li>
</ul>
<p>因此跟隨以下步驟優化錯誤代碼的處理：</p>
<ul>
<li>改為 auth.service.ts 於 http.post 的回應處理增加 pipe 管道作業，使用 catchError 捕獲問題當下的處置並回傳 throwError 資訊。</li>
<li>auth.component.ts 階段只接受 error 回來的字串即可。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth/auth.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; throwError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; catchError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">singUp</span>(<span class="params"><span class="attr">email</span>: <span class="built_in">string</span>, <span class="attr">password</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="title class_">AuthResponseData</span>&gt;(</span><br><span class="line">      <span class="string">&#x27;https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=AIzaSyBD5oglUIsgkYiQlabvMw1Y8OGsGC_w6JA&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">email</span>: email,</span><br><span class="line">        <span class="attr">password</span>: password,</span><br><span class="line">        <span class="attr">returnSecureToken</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    ).<span class="title function_">pipe</span>( <span class="comment">//※重點</span></span><br><span class="line">      <span class="title function_">catchError</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> errorMsg = <span class="string">&#x27;unknown Error&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!err.<span class="property">error</span> || !err.<span class="property">error</span>.<span class="property">error</span>) <span class="keyword">return</span> <span class="title function_">throwError</span>(errorMsg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (err.<span class="property">error</span>.<span class="property">error</span>.<span class="property">message</span>) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;EMAIL_EXISTS&#x27;</span>:</span><br><span class="line">            errorMsg = <span class="string">&#x27;電子郵件地址已被另一個帳戶使用。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;OPERATION_NOT_ALLOWED&#x27;</span>:</span><br><span class="line">            errorMsg = <span class="string">&#x27;此項目禁用密碼登錄。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;TOO_MANY_ATTEMPTS_TRY_LATER&#x27;</span>:</span><br><span class="line">            errorMsg = <span class="string">&#x27;由於異常活動，我們已阻止來自此設備的所有請求。稍後再試。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">throwError</span>(errorMsg);</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>auth.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">onSubmit</span>(<span class="params"><span class="attr">form</span>: <span class="title class_">NgForm</span></span>) &#123;</span><br><span class="line">  <span class="comment">// console.log(form.value);</span></span><br><span class="line">  <span class="keyword">if</span> (form.<span class="property">invalid</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isLoginMode</span>) &#123;</span><br><span class="line">    <span class="comment">// 登入作業</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 註冊作業</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="title function_">singUp</span>(form.<span class="property">value</span>.<span class="property">email</span>, form.<span class="property">value</span>.<span class="property">password</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">resData</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(resData);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// console.error(error);</span></span><br><span class="line">        <span class="comment">// this.isError = error.error.error.message;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isError</span> = error;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  form.<span class="title function_">reset</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="登入-API"><a href="#登入-API" class="headerlink" title="登入 API"></a>登入 API</h3><p>從 <a target="_blank" rel="noopener" href="https://firebase.google.com/docs/reference/rest/auth?hl=zh-tw#section-sign-in-email-password">使用電子郵件&#x2F;密碼登錄</a> 文件當中，已提供指定的端點 URL, 請求 require 格式，回應 response 格式。</p>
<p><img src="https://i.imgur.com/Rh8VPpi.png"></p>
<h4 id="編寫-auth-service-ts-與元件"><a href="#編寫-auth-service-ts-與元件" class="headerlink" title="編寫 auth.service.ts 與元件"></a>編寫 auth.service.ts 與元件</h4><p>同樣的作業規劃 signIn 方法，特別注意 response 回傳的 type 多一個<code>registered?:boolean</code>。</p>
<ul>
<li>因此 interface 多增加一個非必要的此項目做為共用 AuthResponseData TypeModel。</li>
<li>元件部分為了優化共用變數，我們可以將訂閱這個物件成為 authObservable 一個可觀察的變數（該回傳的變數型別為 AuthResponseData)，將代碼更簡約些</li>
<li>同上，可對 service 內的 AuthResponseData 進行 export，使得元件這裡可以 import 取得此 AuthResponseData。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth/auth.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AuthResponseData</span> &#123; <span class="comment">// ※重點：改 export，讓別處可以拿到這個 Type</span></span><br><span class="line">  <span class="attr">idToken</span>: <span class="built_in">string</span>; <span class="comment">// Firebase 身份驗證 ID 令牌</span></span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>; <span class="comment">// 用戶的電子郵件</span></span><br><span class="line">  <span class="attr">refreshToken</span>: <span class="built_in">string</span>; <span class="comment">// Firebase 身份驗證刷新 token</span></span><br><span class="line">  <span class="attr">expiresIn</span>: <span class="built_in">string</span>; <span class="comment">// token 過期的秒數</span></span><br><span class="line">  <span class="attr">localId</span>: <span class="built_in">string</span>; <span class="comment">// 用戶的 uid</span></span><br><span class="line">  registered?:<span class="built_in">boolean</span>; <span class="comment">// ※重點：signIn response 多這個，電子郵件是否用於現有帳戶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">singIn</span>(<span class="params"><span class="attr">email</span>: <span class="built_in">string</span>, <span class="attr">password</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="title class_">AuthResponseData</span>&gt;(</span><br><span class="line">      <span class="string">&#x27;https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=AIzaSyBD5oglUIsgkYiQlabvMw1Y8OGsGC_w6JA&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">email</span>: email,</span><br><span class="line">        <span class="attr">password</span>: password,</span><br><span class="line">        <span class="attr">returnSecureToken</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>auth.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthResponseData</span>, <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>; <span class="comment">// ※重點：匯入 response 型別</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgForm</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-auth&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./auth.component.html&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthComponent</span> &#123;</span><br><span class="line">  isLoginMode = <span class="literal">true</span>;</span><br><span class="line">  isLoading = <span class="literal">false</span>;</span><br><span class="line">  isError = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">AuthService</span>: <span class="title class_">AuthService</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSwitchMode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoginMode</span> = !<span class="variable language_">this</span>.<span class="property">isLoginMode</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSubmit</span>(<span class="params"><span class="attr">form</span>: <span class="title class_">NgForm</span></span>) &#123;</span><br><span class="line">    <span class="comment">// console.log(form.value);</span></span><br><span class="line">    <span class="keyword">if</span> (form.<span class="property">invalid</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">authObservable</span>: <span class="title class_">Observable</span>&lt;<span class="title class_">AuthResponseData</span>&gt;; <span class="comment">// ※重點：新增一個可觀察變數，該變數最後回傳的會是指定型別</span></span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isLoginMode</span>) </span><br><span class="line">      <span class="comment">// 登入作業</span></span><br><span class="line">      authObservable = <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="title function_">singIn</span>(form.<span class="property">value</span>.<span class="property">email</span>, form.<span class="property">value</span>.<span class="property">password</span>); <span class="comment">// ※重點，該 Service 會給一個可觀察的數據</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="comment">// 註冊作業</span></span><br><span class="line">      authObservable = <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="title function_">singUp</span>(form.<span class="property">value</span>.<span class="property">email</span>, form.<span class="property">value</span>.<span class="property">password</span>); <span class="comment">// ※重點，該 Service 會給一個可觀察的數據</span></span><br><span class="line">      <span class="comment">// this.AuthService.singUp(form.value.email, form.value.password).subscribe(</span></span><br><span class="line">      <span class="comment">//   resData =&gt; &#123;</span></span><br><span class="line">      <span class="comment">//     console.log(resData);</span></span><br><span class="line">      <span class="comment">//     this.isLoading = false;</span></span><br><span class="line">      <span class="comment">//   &#125;,</span></span><br><span class="line">      <span class="comment">//   error =&gt; &#123;</span></span><br><span class="line">      <span class="comment">//     // console.error(error);</span></span><br><span class="line">      <span class="comment">//     // this.isError = error.error.error.message;</span></span><br><span class="line">      <span class="comment">//     this.isError = error;</span></span><br><span class="line">      <span class="comment">//     this.isLoading = false;</span></span><br><span class="line">      <span class="comment">//   &#125;</span></span><br><span class="line">      <span class="comment">// );</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// ※重點，集中於此一起做訂閱後的處理</span></span><br><span class="line">    authObservable.<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">resData</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(resData);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isError</span> = error;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    form.<span class="title function_">reset</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="設計-Error-Alert"><a href="#設計-Error-Alert" class="headerlink" title="設計 Error Alert"></a>設計 Error Alert</h4><p>目前設計的 Error 只有 SignUp 才有在 Service 內做處理，同樣的參考 firebase 文件處理代碼字串。此外由於 signUp 與 signIn 作法相近因此可以將 Error 處理的做法獨立為一個私有函式額外一併處理。</p>
<blockquote>
<p>catchError 引數的型別為 HttpErrorResponse</p>
</blockquote>
<figure class="highlight typescript"><figcaption><span>auth/auth.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span>, <span class="title class_">HttpErrorResponse</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; throwError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; catchError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AuthResponseData</span> &#123;</span><br><span class="line">  <span class="attr">idToken</span>: <span class="built_in">string</span>; <span class="comment">// Firebase 身份驗證 ID 令牌</span></span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>; <span class="comment">// 用戶的電子郵件</span></span><br><span class="line">  <span class="attr">refreshToken</span>: <span class="built_in">string</span>; <span class="comment">// Firebase 身份驗證刷新 token</span></span><br><span class="line">  <span class="attr">expiresIn</span>: <span class="built_in">string</span>; <span class="comment">// token 過期的秒數</span></span><br><span class="line">  <span class="attr">localId</span>: <span class="built_in">string</span>; <span class="comment">// 用戶的 uid</span></span><br><span class="line">  registered?: <span class="built_in">boolean</span>; <span class="comment">// 電子郵件是否用於現有帳戶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">http</span>: <span class="title class_">HttpClient</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">singUp</span>(<span class="params"><span class="attr">email</span>: <span class="built_in">string</span>, <span class="attr">password</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="title class_">AuthResponseData</span>&gt;(</span><br><span class="line">      <span class="string">&#x27;https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=AIzaSyBD5oglUIsgkYiQlabvMw1Y8OGsGC_w6JA&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">email</span>: email,</span><br><span class="line">        <span class="attr">password</span>: password,</span><br><span class="line">        <span class="attr">returnSecureToken</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    ).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">catchError</span>(<span class="variable language_">this</span>.<span class="property">errorHandle</span>) <span class="comment">//※重點</span></span><br><span class="line">      <span class="comment">// catchError(err =&gt; &#123;</span></span><br><span class="line">      <span class="comment">//   let errorMsg = &#x27;unknown Error&#x27;;</span></span><br><span class="line">      <span class="comment">//   if (!err.error || !err.error.error) return throwError(errorMsg);</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//   switch (err.error.error.message) &#123;</span></span><br><span class="line">      <span class="comment">//     case &#x27;EMAIL_EXISTS&#x27;:</span></span><br><span class="line">      <span class="comment">//       errorMsg = &#x27;電子郵件地址已被另一個帳戶使用。&#x27;;</span></span><br><span class="line">      <span class="comment">//       break;</span></span><br><span class="line">      <span class="comment">//     case &#x27;OPERATION_NOT_ALLOWED&#x27;:</span></span><br><span class="line">      <span class="comment">//       errorMsg = &#x27;此項目禁用密碼登錄。&#x27;;</span></span><br><span class="line">      <span class="comment">//       break;</span></span><br><span class="line">      <span class="comment">//     case &#x27;TOO_MANY_ATTEMPTS_TRY_LATER&#x27;:</span></span><br><span class="line">      <span class="comment">//       errorMsg = &#x27;由於異常活動，我們已阻止來自此設備的所有請求。稍後再試。&#x27;;</span></span><br><span class="line">      <span class="comment">//       break;</span></span><br><span class="line">      <span class="comment">//   &#125;</span></span><br><span class="line">      <span class="comment">//   return throwError(errorMsg);</span></span><br><span class="line">      <span class="comment">// &#125;)</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">singIn</span>(<span class="params"><span class="attr">email</span>: <span class="built_in">string</span>, <span class="attr">password</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="title class_">AuthResponseData</span>&gt;(</span><br><span class="line">      <span class="string">&#x27;https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=AIzaSyBD5oglUIsgkYiQlabvMw1Y8OGsGC_w6JA&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">email</span>: email,</span><br><span class="line">        <span class="attr">password</span>: password,</span><br><span class="line">        <span class="attr">returnSecureToken</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    ).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">catchError</span>(<span class="variable language_">this</span>.<span class="property">errorHandle</span>) <span class="comment">//※重點</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">errorHandle</span>(<span class="params"><span class="attr">errorRes</span>: <span class="title class_">HttpErrorResponse</span></span>) &#123;  <span class="comment">//※重點：獨立一個 private function</span></span><br><span class="line">    <span class="keyword">let</span> errorMsg = <span class="string">&#x27;unknown Error&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!errorRes.<span class="property">error</span> || !errorRes.<span class="property">error</span>.<span class="property">error</span>) <span class="keyword">return</span> <span class="title function_">throwError</span>(errorMsg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (errorRes.<span class="property">error</span>.<span class="property">error</span>.<span class="property">message</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;EMAIL_EXISTS&#x27;</span>:</span><br><span class="line">        errorMsg = <span class="string">&#x27;電子郵件地址已被另一個帳戶使用。&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;OPERATION_NOT_ALLOWED&#x27;</span>:</span><br><span class="line">        errorMsg = <span class="string">&#x27;此項目禁用密碼登錄。&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;TOO_MANY_ATTEMPTS_TRY_LATER&#x27;</span>:</span><br><span class="line">        errorMsg = <span class="string">&#x27;由於異常活動，我們已阻止來自此設備的所有請求。稍後再試。&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;EMAIL_NOT_FOUND&#x27;</span>:</span><br><span class="line">        errorMsg = <span class="string">&#x27;沒有與此標識符對應的用戶記錄。該用戶可能已被刪除。&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;INVALID_PASSWORD&#x27;</span>:</span><br><span class="line">        errorMsg = <span class="string">&#x27;密碼無效或用戶沒有密碼。&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;USER_DISABLED&#x27;</span>:</span><br><span class="line">        errorMsg = <span class="string">&#x27;用戶帳戶已被管理員禁用。&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">throwError</span>(errorMsg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="儲存用戶資訊"><a href="#儲存用戶資訊" class="headerlink" title="儲存用戶資訊"></a>儲存用戶資訊</h2><p>隨登入或註冊作業流程，需將用戶登入資訊紀錄儲存起來並引導用戶離開 login 表單來到指定後台頁面。</p>
<h3 id="User-Model-資訊"><a href="#User-Model-資訊" class="headerlink" title="User Model 資訊"></a>User Model 資訊</h3><p>將登入註冊的 firebase 回傳作業的 email,id,token,expireDate 放入到 Subject 紀錄，以 TypeScript 的規矩之下可以規劃一個 model 整理該型別：</p>
<ul>
<li>建立 auth&#x2F;user.model.ts 編寫 export class，由於結構簡單可直接手動新增。</li>
<li>根據 firebase 手冊提到的型別規劃，唯獨 token 的 expire 手冊回傳的是 String，為了方便作業改為 Date</li>
<li>提前寫好取得 token 的條件必須是有效的時間內才能取出。之後會用到</li>
</ul>
<figure class="highlight typescript"><figcaption><span>user.model.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">public</span> <span class="attr">email</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">public</span> <span class="attr">id</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">_token</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">_tokenExpireDate</span>: <span class="title class_">Date</span>,</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">token</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_tokenExpireDate</span> || <span class="keyword">new</span> <span class="title class_">Date</span>() &gt; <span class="variable language_">this</span>.<span class="property">_tokenExpireDate</span>)</span><br><span class="line">      <span class="comment">//如果沒有 token 期效或現在時間大於 token 期效（已過期）</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_token</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note info"><p><strong>class 中的 get 與 set</strong><br>用來取得和設定類別內部私有變數的方法。get 與 set 方法通常都會搭配一個私有變數，私有變數只能在類別內部被存取。透過 get 方法，我們可以取得私有變數的值；透過 set 方法，我們可以設定私有變數的值。</p>
<p>以下是一個使用 get 與 set 的範例：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">name</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_name</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">name</span>(<span class="params"><span class="attr">newName</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_name</span> = newName;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> person = <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">person.<span class="property">name</span> = <span class="string">&#x27;John&#x27;</span>; <span class="comment">// 呼叫 set 方法</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">name</span>); <span class="comment">// 呼叫 get 方法</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>回到 service，新增一個 subject 變數為 userSbj，該結果型別資料會是我們的 User（來自 model)。</li>
<li>同上，新增一個可以管理用戶資訊的 AuthHandel。將指定的 user 建構物件存放到 subject.next() 內。</li>
<li>利用 tap，將 firebase 的 response（登入跟註冊都要）丟給 AuthHandel，使得 userSbj 的 subject 事件進入 next 階段。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth/auth.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span>, <span class="title class_">HttpErrorResponse</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; throwError, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; catchError, tap &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.model&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AuthResponseData</span> &#123;</span><br><span class="line">  <span class="attr">idToken</span>: <span class="built_in">string</span>; <span class="comment">// Firebase 身份驗證 ID 令牌</span></span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>; <span class="comment">// 用戶的電子郵件</span></span><br><span class="line">  <span class="attr">refreshToken</span>: <span class="built_in">string</span>; <span class="comment">// Firebase 身份驗證刷新 token</span></span><br><span class="line">  <span class="attr">expiresIn</span>: <span class="built_in">string</span>; <span class="comment">// token 過期的秒數</span></span><br><span class="line">  <span class="attr">localId</span>: <span class="built_in">string</span>; <span class="comment">// 用戶的 uid</span></span><br><span class="line">  registered?: <span class="built_in">boolean</span>; <span class="comment">// 電子郵件是否用於現有帳戶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line"></span><br><span class="line">  userSbj = <span class="keyword">new</span> <span class="title class_">Subject</span>&lt;<span class="title class_">User</span>&gt;();<span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">http</span>: <span class="title class_">HttpClient</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">singUp</span>(<span class="params"><span class="attr">email</span>: <span class="built_in">string</span>, <span class="attr">password</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="title class_">AuthResponseData</span>&gt;(</span><br><span class="line">      <span class="string">&#x27;https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=AIzaSyBD5oglUIsgkYiQlabvMw1Y8OGsGC_w6JA&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">email</span>: email,</span><br><span class="line">        <span class="attr">password</span>: password,</span><br><span class="line">        <span class="attr">returnSecureToken</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    ).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">catchError</span>(<span class="variable language_">this</span>.<span class="property">errorHandle</span>),</span><br><span class="line">      <span class="title function_">tap</span>(<span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title class_">AuthHandle</span>(<span class="comment">//※重點</span></span><br><span class="line">        response.<span class="property">email</span>,</span><br><span class="line">        response.<span class="property">localId</span>,</span><br><span class="line">        response.<span class="property">idToken</span>,</span><br><span class="line">        +response.<span class="property">expiresIn</span> <span class="comment">//※重點：string to number</span></span><br><span class="line">      ))</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">singIn</span>(<span class="params"><span class="attr">email</span>: <span class="built_in">string</span>, <span class="attr">password</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="title class_">AuthResponseData</span>&gt;(</span><br><span class="line">      <span class="string">&#x27;https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=AIzaSyBD5oglUIsgkYiQlabvMw1Y8OGsGC_w6JA&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">email</span>: email,</span><br><span class="line">        <span class="attr">password</span>: password,</span><br><span class="line">        <span class="attr">returnSecureToken</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    ).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">catchError</span>(<span class="variable language_">this</span>.<span class="property">errorHandle</span>),</span><br><span class="line">      <span class="title function_">tap</span>(<span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title class_">AuthHandle</span>(<span class="comment">//※重點</span></span><br><span class="line">        response.<span class="property">email</span>,</span><br><span class="line">        response.<span class="property">localId</span>,</span><br><span class="line">        response.<span class="property">idToken</span>,</span><br><span class="line">        +response.<span class="property">expiresIn</span> <span class="comment">//※重點：string to number</span></span><br><span class="line">      ))</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title class_">AuthHandle</span>(<span class="attr">email</span>: <span class="built_in">string</span>, <span class="attr">userId</span>: <span class="built_in">string</span>, <span class="attr">token</span>: <span class="built_in">string</span>, <span class="attr">expiresIn</span>: <span class="built_in">number</span>) &#123;<span class="comment">//※重點</span></span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">new</span> <span class="title class_">User</span>(</span><br><span class="line">      email,</span><br><span class="line">      userId,</span><br><span class="line">      token,</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() + expiresIn * <span class="number">1000</span>) <span class="comment">//※重點：時間物件，以現在時間 timestamp + 持續可活之間格數（毫秒）</span></span><br><span class="line">    );</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userSbj</span>.<span class="title function_">next</span>(user);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="作業路由導向與-UI-控制"><a href="#作業路由導向與-UI-控制" class="headerlink" title="作業路由導向與 UI 控制"></a>作業路由導向與 UI 控制</h3><p>目前隨登入註冊流程會產生由 Subject 持有的用戶資訊，透過此用戶資訊能代表用戶已成功完成表單提交與用戶資訊卻有所回傳。我們接著可以做：</p>
<ul>
<li>隨著登入註冊動作成功，引導用戶轉向到後台指定頁面，例如 Recipes 頁面。這部分於 auth 元件的 submit 末段作業找到。需依賴 route 完成 navigate。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthResponseData</span>, <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgForm</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-auth&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./auth.component.html&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthComponent</span> &#123;</span><br><span class="line">  isLoginMode = <span class="literal">true</span>;</span><br><span class="line">  isLoading = <span class="literal">false</span>;</span><br><span class="line">  isError = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">AuthService</span>: <span class="title class_">AuthService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">Router</span>: <span class="title class_">Router</span> <span class="comment">//※重點</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSwitchMode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoginMode</span> = !<span class="variable language_">this</span>.<span class="property">isLoginMode</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSubmit</span>(<span class="params"><span class="attr">form</span>: <span class="title class_">NgForm</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (form.<span class="property">invalid</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">authObservable</span>: <span class="title class_">Observable</span>&lt;<span class="title class_">AuthResponseData</span>&gt;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isLoginMode</span>)</span><br><span class="line">      authObservable = <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="title function_">singIn</span>(form.<span class="property">value</span>.<span class="property">email</span>, form.<span class="property">value</span>.<span class="property">password</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      authObservable = <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="title function_">singUp</span>(form.<span class="property">value</span>.<span class="property">email</span>, form.<span class="property">value</span>.<span class="property">password</span>);</span><br><span class="line"></span><br><span class="line">    authObservable.<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">resData</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// console.log(resData);</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">Router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/recipes&#x27;</span>]);  <span class="comment">//※重點</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isError</span> = error;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    form.<span class="title function_">reset</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>新規劃一個 Logout 按鈕，這動作部分稍晚設計。</li>
<li>接著 header.component.html 模板可規劃那些選單給登入前限定顯示 (ex: 登入、後台），登入後限定顯示 (ex: 登出、管理），可利用一個本地屬性 isLogged 根據對 service 的 userSbj 訂閱結果來判別是否登入成功（注意：考量訂閱的初始銷毀週期）。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>header.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../auth/auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Subscription</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span>, <span class="title class_">OnDestroy</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DataStorageService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../shared/data-storage.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-header&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./header.component.html&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HeaderComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span>, <span class="title class_">OnDestroy</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">userSub</span>: <span class="title class_">Subscription</span>; <span class="comment">//※重點</span></span><br><span class="line">  isLogged = <span class="literal">false</span>; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">dataStorageService</span>: <span class="title class_">DataStorageService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">AuthService</span>: <span class="title class_">AuthService</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123; <span class="comment">//※重點</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userSub</span> = <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="property">userSbj</span>.<span class="title function_">subscribe</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLogged</span> = !!user;  <span class="comment">// user 存在就等價 true</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnDestroy</span>(): <span class="built_in">void</span> &#123; <span class="comment">//※重點</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userSub</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSaveData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dataStorageService</span>.<span class="title function_">storeRecipes</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onFetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dataStorageService</span>.<span class="title function_">fetchRecipes</span>().<span class="title function_">subscribe</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>header\header.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">&quot;navbar navbar-default&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container-fluid&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-header&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">        <span class="attr">routerLink</span>=<span class="string">&quot;/&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;navbar-brand&quot;</span></span></span><br><span class="line"><span class="tag">      &gt;</span>Recipe Book<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;collapse navbar-collapse&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;nav navbar-nav&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 登入顯示 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span></span></span><br><span class="line"><span class="tag">          <span class="attr">routerLinkActive</span>=<span class="string">&quot;active&quot;</span></span></span><br><span class="line"><span class="tag">          *<span class="attr">ngIf</span>=<span class="string">&quot;isLogged&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">&quot;/recipes&quot;</span>&gt;</span>Recipes<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 未登入顯示 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span></span></span><br><span class="line"><span class="tag">          <span class="attr">routerLinkActive</span>=<span class="string">&quot;active&quot;</span></span></span><br><span class="line"><span class="tag">          *<span class="attr">ngIf</span>=<span class="string">&quot;!isLogged&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">&quot;/auth&quot;</span>&gt;</span>Authenticate<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">routerLinkActive</span>=<span class="string">&quot;active&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">&quot;/shopping-list&quot;</span>&gt;</span>Shopping List<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 登入顯示 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;nav navbar-nav navbar-right&quot;</span>  *<span class="attr">ngIf</span>=<span class="string">&quot;isLogged&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 新追加登出 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">&quot;cursor:pointer&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;dropdown&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">appDropdown</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">            <span class="attr">style</span>=<span class="string">&quot;cursor: pointer;&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">class</span>=<span class="string">&quot;dropdown-toggle&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">role</span>=<span class="string">&quot;button&quot;</span></span></span><br><span class="line"><span class="tag">          &gt;</span>Manage <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;caret&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;dropdown-menu&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">                <span class="attr">style</span>=<span class="string">&quot;cursor: pointer;&quot;</span></span></span><br><span class="line"><span class="tag">                (<span class="attr">click</span>)=<span class="string">&quot;onSaveData()&quot;</span></span></span><br><span class="line"><span class="tag">              &gt;</span>Save Data<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">                <span class="attr">style</span>=<span class="string">&quot;cursor: pointer;&quot;</span></span></span><br><span class="line"><span class="tag">                (<span class="attr">click</span>)=<span class="string">&quot;onFetchData()&quot;</span></span></span><br><span class="line"><span class="tag">              &gt;</span>Fetch Data<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="傳送-token"><a href="#傳送-token" class="headerlink" title="傳送 token"></a>傳送 token</h3><p>我們的 token 資訊位於原本的 userSbj 內，欲取得 token 可從 userSbj.token 拿取，由於他是一個 Subject 型別，考量初始訂閱當下的初始值 null 讀取，可調整改用 BehaviorSubject 方式獲取。</p>
<ul>
<li>將 auth.service.ts 內的 Subject 改為 BehaviorSubject 並賦予初始值 null</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth/auth.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// userSbj = new Subject&lt;User&gt;();</span></span><br><span class="line">userSbj = <span class="keyword">new</span> <span class="title class_">BehaviorSubject</span>&lt;<span class="title class_">User</span>&gt;(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<h4 id="關於-BehaviorSubject-與其他"><a href="#關於-BehaviorSubject-與其他" class="headerlink" title="關於 BehaviorSubject 與其他"></a>關於 BehaviorSubject 與其他</h4><p>在 RxJS 中，有許多種不同的 Subject，以下是各種 Subject 的細節說明：</p>
<ul>
<li><strong>Subject</strong><br>一種可觀察的序列和觀察者。它是一種 Multicast（多播） 的型別，可以向多個 Observer（觀察者） 發送訊息。當一個 Observable 被訂閱時，它會建立一個新的 Observable 並將所有發射的元素發送給新的 Observable。Subject 是 Multicast 特性的一個代表，它可以同時訂閱多個觀察者並將事件廣播給這些觀察者。</li>
<li><strong>BehaviorSubject</strong><br>一種特殊的 Subject。它需要一個初始值，每當訂閱者訂閱時都會發出該初始值。之後，它會發出任何新值。在新的訂閱者訂閱該 BehaviourSubject 時，他會立即得到當前值，然後在將來收到每個新值。</li>
<li><strong>ReplaySubject</strong><br>也是一種 Subject，它可以緩存發出的元素，並在新的 Observer 訂閱時重新發射這些緩存的元素。ReplaySubject 可以緩存多個元素，當一個新的 Observer 訂閱時，它可以將這些元素傳送給新的 Observer。</li>
<li><strong>AsyncSubject</strong><br>一種特殊的 Subject。當 Observable 完成時，AsyncSubject 只會發出最後一個元素。如果 Observable 沒有發出任何元素，AsyncSubject 將不會發出任何元素。</li>
<li><strong>PublishSubject</strong><br>常規的 Subject，但它只發射在 Subject 被訂閱之後發生的事件。PublishSubject 不會將元素傳遞給新訂閱的觀察者，只傳遞 Subject 被訂閱之後的元素。</li>
<li><strong>PublishRelay</strong><br>RxJava 中的 Relay 之一。它是 PublishSubject 的簡化版本。它只是 PublishSubject 的一個輕量級版本，可以方便地使用 Observable 所提供的多個操作符。</li>
<li><strong>BehaviorRelay</strong><br>RxJava 中的 Relay 之一。它是 BehaviorSubject 的簡化版本。它包含一個初始值，每次訂閱時都會發出當前值，並發出任何新值。</li>
</ul>
<p>Subject 與 BehaviorSubject 是 RxJS 中的兩個主要類型，它們都是用來實現觀察者模式的。</p>
<p>Subject 是一個可觀察的對象，可以被訂閱，也可以通過 next() 方法將新的值發送給訂閱者。Subject 是一種熱的可觀察對象，這意味著當一個觀察者訂閱了 Subject 時將只接收到訂閱之後發出的新值，而不會收到 Subject 之前發出的值。</p>
<p>BehaviorSubject 是一個特殊的 Subject，它可以儲存最新的一個值，並且當有一個新的觀察者訂閱時立即向該觀察者發送目前值。如果在訂閱之前，BehaviorSubject 還沒有發送過值，那麼訂閱者將收到初始值，通過這個特性，BehaviorSubject 可以被用來實現狀態管理等功能。</p>
<p>在使用上，可以通過以下方式創建一個 Subject 或 BehaviorSubject：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Subject</span>, <span class="title class_">BehaviorSubject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> subject = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"><span class="keyword">const</span> behaviorSubject = <span class="keyword">new</span> <span class="title class_">BehaviorSubject</span>(<span class="string">&#x27;initial value&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>接下來，可以通過 next() 方法向 Subject 或 BehaviorSubject 發送新的值：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">subject.<span class="title function_">next</span>(<span class="string">&#x27;new value&#x27;</span>);</span><br><span class="line">behaviorSubject.<span class="title function_">next</span>(<span class="string">&#x27;new value&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>在訂閱時，可以像訂閱任何其他的可觀察對象一樣進行訂閱：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">subject.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value));</span><br><span class="line">behaviorSubject.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value));</span><br></pre></td></tr></table></figure>
<p>需要注意的是，當一個 Subject 或 BehaviorSubject 完成時，它將不再發送任何新值，並且訂閱者將收到 complete() 通知。在此之後，即使對 Subject 或 BehaviorSubject 進行 next() 操作，訂閱者也不會再接收到這些值。</p>
<h4 id="手動添加-token-於指定-api"><a href="#手動添加-token-於指定-api" class="headerlink" title="手動添加 token 於指定 api"></a>手動添加 token 於指定 api</h4><p>以選單右側的 Manage 功能來示範如何夾帶 Token 至 Firebase，這部分的功能是將 Pecipes 頁面上的 recipeService 資料 PUT 或 GET 至 firebase。因此常是以下步驟作業：</p>
<ul>
<li>修改 data-storage.service.ts 內的兩處 URL 修改為您 firebase 的 URL，尾段添加<code>/recipes.json</code>已另一個資料表做存取。</li>
<li>原本為直接向 http 作業與訂閱，更改為先對 AuthService.userSb 取得，由於我們只需要拿一次不需要去觀察值得變化，因此藉由 pipe 的 take(1) 只拿一次就完成該訂閱。</li>
<li>將這個觀察對象從原本的 AuthService.userSb 獲得結果之後，再 map 轉給另一個 this.http 觀察對象，這透過 exhaustMap 來完成。</li>
<li>然後，根據 firebase 文檔提到 token 需要以 params 方式 (?token&#x3D;abc) 來提交，因此藉由 httpClient 的 option 來處理 HttpParams 追加。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>shared/data-storage.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../auth/auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span>, <span class="title class_">HttpParams</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; exhaustMap, map, take, tap &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Recipe</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../recipes/recipe.model&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RecipeService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../recipes/recipe.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123; <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DataStorageService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">http</span>: <span class="title class_">HttpClient</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">recipeService</span>: <span class="title class_">RecipeService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">AuthService</span>: <span class="title class_">AuthService</span>,</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">storeRecipes</span>(<span class="params"></span>) &#123; <span class="comment">// MENU manage-&gt; Save Date 作業 </span></span><br><span class="line">    <span class="keyword">const</span> recipes = <span class="variable language_">this</span>.<span class="property">recipeService</span>.<span class="title function_">getRecipes</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="property">userSbj</span>.<span class="title function_">pipe</span>( <span class="comment">//※重點</span></span><br><span class="line">      <span class="title function_">take</span>(<span class="number">1</span>),</span><br><span class="line">      <span class="title function_">exhaustMap</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span></span><br><span class="line">          .<span class="title function_">put</span>(</span><br><span class="line">            <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/recipes.json&#x27;</span>,</span><br><span class="line">            recipes,</span><br><span class="line">            &#123; <span class="attr">params</span>: <span class="keyword">new</span> <span class="title class_">HttpParams</span>().<span class="title function_">set</span>(<span class="string">&#x27;auth&#x27;</span>, user.<span class="property">token</span>) &#125;</span><br><span class="line">          )</span><br><span class="line">      &#125;)</span><br><span class="line">    ).<span class="title function_">subscribe</span>(<span class="function"><span class="params">response</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(response));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this.http</span></span><br><span class="line">    <span class="comment">//   .put(</span></span><br><span class="line">    <span class="comment">//     &#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/recipes.json&#x27;,</span></span><br><span class="line">    <span class="comment">//     recipes,</span></span><br><span class="line">    <span class="comment">//   )</span></span><br><span class="line">    <span class="comment">//   .subscribe(response =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//     console.log(response);</span></span><br><span class="line">    <span class="comment">//   &#125;);</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">fetchRecipes</span>(<span class="params"></span>) &#123; <span class="comment">//MENU manage -&gt; Fetch Data 作業</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="property">userSbj</span>.<span class="title function_">pipe</span>(  <span class="comment">//※重點</span></span><br><span class="line">      <span class="title function_">take</span>(<span class="number">1</span>),</span><br><span class="line">      <span class="title function_">exhaustMap</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span></span><br><span class="line">          .<span class="property">get</span>&lt;<span class="title class_">Recipe</span>[]&gt;(</span><br><span class="line">            <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/recipes.json&#x27;</span>,</span><br><span class="line">            &#123; <span class="attr">params</span>: <span class="keyword">new</span> <span class="title class_">HttpParams</span>().<span class="title function_">set</span>(<span class="string">&#x27;auth&#x27;</span>, user.<span class="property">token</span>) &#125;</span><br><span class="line">          )</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="title function_">map</span>(<span class="function"><span class="params">recipes</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> recipes.<span class="title function_">map</span>(<span class="function"><span class="params">recipe</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            ...recipe,</span><br><span class="line">            <span class="attr">ingredients</span>: recipe.<span class="property">ingredients</span> ? recipe.<span class="property">ingredients</span> : []</span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="title function_">tap</span>(<span class="function"><span class="params">recipes</span> =&gt;</span> <span class="variable language_">this</span>.<span class="property">recipeService</span>.<span class="title function_">setRecipes</span>(recipes))</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// return this.http</span></span><br><span class="line">    <span class="comment">//   .get&lt;Recipe[]&gt;(</span></span><br><span class="line">    <span class="comment">//     &#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/recipes.json&#x27;</span></span><br><span class="line">    <span class="comment">//   )</span></span><br><span class="line">    <span class="comment">//   .pipe(</span></span><br><span class="line">    <span class="comment">//     map(recipes =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//       return recipes.map(recipe =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//         return &#123;</span></span><br><span class="line">    <span class="comment">//           ...recipe,</span></span><br><span class="line">    <span class="comment">//           ingredients: recipe.ingredients ? recipe.ingredients : []</span></span><br><span class="line">    <span class="comment">//         &#125;;</span></span><br><span class="line">    <span class="comment">//       &#125;);</span></span><br><span class="line">    <span class="comment">//     &#125;),</span></span><br><span class="line">    <span class="comment">//     tap(recipes =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//       this.recipeService.setRecipes(recipes);</span></span><br><span class="line">    <span class="comment">//     &#125;)</span></span><br><span class="line">    <span class="comment">//   )</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>take(1) 是 RxJS 中的操作符之一，它的作用是取得 Observable 發出的第一個值後就自動完成 (completes)。具體來說，take(1) 會將 Observable 的第一個值傳遞給下游訂閱者 (subscriber)，然後自動完成 Observable，不再傳遞其他值。</p>
</blockquote>
<blockquote>
<p>exhaustMap 是 RxJS 中的操作符（operator），它可以將來自一個 observable 的輸出映射到另一個 observable，但只有在前一個 observable 完全完成（complete）時，才會開始處理下一個 observable。</p>
</blockquote>
<p>最後請嘗試登入完成之下，操作新增 1~2 筆的 New Recipe 進行 Save（圖片可借用 <a target="_blank" rel="noopener" href="https://picsum.photos/seed/picsum/300/200">picsum</a> 免費圖片），再透過 Save Data 作業與 Fetch Data 作業觀察 firebase 的存入與讀取是否成功。</p>
<h4 id="透過-HttpInterceptor-自動-token"><a href="#透過-HttpInterceptor-自動-token" class="headerlink" title="透過 HttpInterceptor 自動 token"></a>透過 HttpInterceptor 自動 token</h4><p>若每次 API 都要自己加 token 是蠻麻煩的，我們可以利用一開始有提到的攔截處理方式，幫我們每次進行 httpClient 都要自動帶入 params 寫入 Token（但排除 Login&#x2F;SignUp)。</p>
<ul>
<li>手動或 CLI 指令<code>ng g s auth/auth-interceptor --skip-tests</code>增加一個為 AuthInterceptorService</li>
<li>要使用 HttpInterceptor 需對 service 的 class 進行 implements 實體化帶入</li>
<li>規劃 intercept 捕獲原本 require 與 next 事件，處理後回傳 return，回傳的動作來自於 AuthService 的處理。</li>
<li>參考手動的做法，一樣需要 take(1) 與 exhaustMap 轉 map 給 next.handle 的觀察對象。</li>
<li>注意只有登入註冊不需要修改 req，可根據 User 內容是否存在做回傳哪種 require。</li>
<li><code>@Injectable()</code>留空白，稍後要去 app.module.ts 規劃 intercept 詳細參數。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth/auth-interceptor.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; take, exhaustMap &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpEvent</span>, <span class="title class_">HttpHandler</span>, <span class="title class_">HttpInterceptor</span>, <span class="title class_">HttpParams</span>, <span class="title class_">HttpRequest</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthInterceptorService</span> <span class="keyword">implements</span> <span class="title class_">HttpInterceptor</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">AuthService</span>: <span class="title class_">AuthService</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">intercept</span>(<span class="attr">req</span>: <span class="title class_">HttpRequest</span>&lt;<span class="built_in">any</span>&gt;, <span class="attr">next</span>: <span class="title class_">HttpHandler</span>): <span class="title class_">Observable</span>&lt;<span class="title class_">HttpEvent</span>&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="property">userSbj</span>.<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">take</span>(<span class="number">1</span>),</span><br><span class="line">      <span class="title function_">exhaustMap</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!user) <span class="keyword">return</span> next.<span class="title function_">handle</span>(req);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> modifyReq = req.<span class="title function_">clone</span>(&#123;</span><br><span class="line">          <span class="attr">params</span>: <span class="keyword">new</span> <span class="title class_">HttpParams</span>().<span class="title function_">set</span>(<span class="string">&#x27;auth&#x27;</span>, user.<span class="property">token</span>)</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> next.<span class="title function_">handle</span>(modifyReq);</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>來到 app.module.ts 的 providers，加入持有特定的物件屬性設定</p>
<figure class="highlight typescript"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthInterceptorService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth/auth-interceptor.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClientModule</span>, <span class="variable constant_">HTTP_INTERCEPTORS</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    <span class="title class_">ShoppingListService</span>,</span><br><span class="line">    <span class="title class_">RecipeService</span>, &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="variable constant_">HTTP_INTERCEPTORS</span>,</span><br><span class="line">      <span class="attr">useClass</span>: <span class="title class_">AuthInterceptorService</span>,</span><br><span class="line">      <span class="attr">multi</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>最後回到 data-storage.service.ts，將原本手動的做法取消返回到一開始的寫法。</p>
<figure class="highlight typescript"><figcaption><span>shared/data-storage.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">storeRecipes</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> recipes = <span class="variable language_">this</span>.<span class="property">recipeService</span>.<span class="title function_">getRecipes</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// this.AuthService.userSbj.pipe(</span></span><br><span class="line">  <span class="comment">//   take(1),</span></span><br><span class="line">  <span class="comment">//   exhaustMap(user =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//     return this.http</span></span><br><span class="line">  <span class="comment">//       .put(</span></span><br><span class="line">  <span class="comment">//         &#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/recipes.json&#x27;,</span></span><br><span class="line">  <span class="comment">//         recipes,</span></span><br><span class="line">  <span class="comment">//         &#123; params: new HttpParams().set(&#x27;auth&#x27;, user.token) &#125;</span></span><br><span class="line">  <span class="comment">//       )</span></span><br><span class="line">  <span class="comment">//   &#125;)</span></span><br><span class="line">  <span class="comment">// ).subscribe(response =&gt; console.log(response));</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">http</span></span><br><span class="line">    .<span class="title function_">put</span>(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/recipes.json&#x27;</span>,</span><br><span class="line">      recipes,</span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_">subscribe</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fetchRecipes</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// return this.AuthService.userSbj.pipe(</span></span><br><span class="line">  <span class="comment">//   take(1),</span></span><br><span class="line">  <span class="comment">//   exhaustMap(user =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//     return this.http</span></span><br><span class="line">  <span class="comment">//       .get&lt;Recipe[]&gt;(</span></span><br><span class="line">  <span class="comment">//         &#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/recipes.json&#x27;,</span></span><br><span class="line">  <span class="comment">//         &#123; params: new HttpParams().set(&#x27;auth&#x27;, user.token) &#125;</span></span><br><span class="line">  <span class="comment">//       )</span></span><br><span class="line">  <span class="comment">//   &#125;),</span></span><br><span class="line">  <span class="comment">//   map(recipes =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//     return recipes.map(recipe =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//       return &#123;</span></span><br><span class="line">  <span class="comment">//         ...recipe,</span></span><br><span class="line">  <span class="comment">//         ingredients: recipe.ingredients ? recipe.ingredients : []</span></span><br><span class="line">  <span class="comment">//       &#125;;</span></span><br><span class="line">  <span class="comment">//     &#125;);</span></span><br><span class="line">  <span class="comment">//   &#125;),</span></span><br><span class="line">  <span class="comment">//   tap(recipes =&gt; this.recipeService.setRecipes(recipes))</span></span><br><span class="line">  <span class="comment">// );</span></span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span></span><br><span class="line">    .<span class="property">get</span>&lt;<span class="title class_">Recipe</span>[]&gt;(</span><br><span class="line">      <span class="string">&#x27;https://loki-angular-training-default-rtdb.asia-southeast1.firebasedatabase.app/recipes.json&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">map</span>(<span class="function"><span class="params">recipes</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> recipes.<span class="title function_">map</span>(<span class="function"><span class="params">recipe</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            ...recipe,</span><br><span class="line">            <span class="attr">ingredients</span>: recipe.<span class="property">ingredients</span> ? recipe.<span class="property">ingredients</span> : []</span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="title function_">tap</span>(<span class="function"><span class="params">recipes</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">recipeService</span>.<span class="title function_">setRecipes</span>(recipes);</span><br><span class="line">      &#125;)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="登出作業"><a href="#登出作業" class="headerlink" title="登出作業"></a>登出作業</h2><p>要將用戶進行登出，需要將 Subject 的用戶資訊透過 next 清除為 null，這部分的作業會在 AuthService 完成並導向到登入頁面 auth，而 header 元件透過 click 事件去執行該 Service。</p>
<figure class="highlight typescript"><figcaption><span>auth/auth.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="keyword">private</span> <span class="attr">http</span>: <span class="title class_">HttpClient</span>,</span></span><br><span class="line"><span class="params">  <span class="keyword">private</span> <span class="title class_">Router</span>: <span class="title class_">Router</span> <span class="comment">//※重點</span></span></span><br><span class="line"><span class="params"></span>) &#123; &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="title function_">signOut</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">userSbj</span>.<span class="title function_">next</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">Router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;auth&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>header\header.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">&quot;cursor:pointer&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onLogout()&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>header\header.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">onLogout</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="title function_">signOut</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自動儲存-Storage"><a href="#自動儲存-Storage" class="headerlink" title="自動儲存 Storage"></a>自動儲存 Storage</h2><p>介紹如何在重整網頁情況下，會記得上次登入的所有用戶資訊。保持 subject 原有的資料。以及如何在 token 期限到達的情況下自動登出用戶與清除資訊。</p>
<h3 id="autoLogin-重整頁面"><a href="#autoLogin-重整頁面" class="headerlink" title="autoLogin 重整頁面"></a>autoLogin 重整頁面</h3><p>我們將登入成功捕獲的資訊存放於 localStorage 內，每次重刷網頁時，如果在 localStorage 內可以找到這些資訊，就能補回原本 Subject 內應有的資料（原本的 Subject 需要登入成功時寫入 next)。</p>
<ul>
<li>在 AuthHandle 的 Subject next 工作，隨後一個存入 Storage ，由於只能存入 string 格式需要轉換 JSON.stringify</li>
<li>規劃一個 autoSign 方法，幫助我們從 localStorage 取回（若已存在資料並需轉回 json)，由於 json 內的資料格式有變所以要重新從 new User 建立起塞回 Subject。</li>
<li>最後回到 app.component.ts，每次初始化 ngOnInit 時就跑一下 autoSign，如果能找回 UserSbj 就能連動所有 UI 權限，形成已登入的 subject 狀態。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth\auth.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">autoSignIn</span>(<span class="params"></span>) &#123; <span class="comment">//※重點</span></span><br><span class="line">  <span class="keyword">const</span> userKeep = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;userData&#x27;</span>));</span><br><span class="line">  <span class="keyword">if</span> (!userKeep) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> reloadUser = <span class="keyword">new</span> <span class="title class_">User</span>( <span class="comment">//※重點：需重新創造 User 物件，因為有效期的型別是 Date Object，JSON.parse 給的是 string</span></span><br><span class="line">    userKeep.<span class="property">email</span>,</span><br><span class="line">    userKeep.<span class="property">id</span>,</span><br><span class="line">    userKeep.<span class="property">_token</span>,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Date</span>(userKeep.<span class="property">_tokenExpireDate</span>)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (reloadUser.<span class="property">token</span>) <span class="variable language_">this</span>.<span class="property">userSbj</span>.<span class="title function_">next</span>(reloadUser);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">private</span> <span class="title class_">AuthHandle</span>(<span class="attr">email</span>: <span class="built_in">string</span>, <span class="attr">userId</span>: <span class="built_in">string</span>, <span class="attr">token</span>: <span class="built_in">string</span>, <span class="attr">expiresIn</span>: <span class="built_in">number</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">new</span> <span class="title class_">User</span>(</span><br><span class="line">    email,</span><br><span class="line">    userId,</span><br><span class="line">    token,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() + expiresIn * <span class="number">1000</span>)</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">userSbj</span>.<span class="title function_">next</span>(user);</span><br><span class="line">  <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;userData&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user));  <span class="comment">//※重點</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth/auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-root&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./app.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./app.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">AuthService</span>: <span class="title class_">AuthService</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123; <span class="comment">//※重點</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="title function_">autoSignIn</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="逾時自動登出"><a href="#逾時自動登出" class="headerlink" title="逾時自動登出"></a>逾時自動登出</h3><p>firebase 預設提供的 token 期限為 1 小時 (3600000 毫秒），因此需要每次登入或刷新時重新綁定 setTimeout 於指定時間下做 signOut 作業，這部分的工作由 autoSignOut 負責處理。並在登入成功與刷新頁面的時機下執行 autoSignOut。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line">  userSbj = <span class="keyword">new</span> <span class="title class_">BehaviorSubject</span>&lt;<span class="title class_">User</span>&gt;(<span class="literal">null</span>);</span><br><span class="line">  <span class="attr">tokenExpireTimer</span>: <span class="title class_">NodeJS</span>.<span class="property">Timer</span>; <span class="comment">//※重點</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">http</span>: <span class="title class_">HttpClient</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">Router</span>: <span class="title class_">Router</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">autoSignIn</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> userKeep = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;userData&#x27;</span>));</span><br><span class="line">    <span class="keyword">if</span> (!userKeep) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> reloadUser = <span class="keyword">new</span> <span class="title class_">User</span>(</span><br><span class="line">      userKeep.<span class="property">email</span>,</span><br><span class="line">      userKeep.<span class="property">id</span>,</span><br><span class="line">      userKeep.<span class="property">_token</span>,</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Date</span>(userKeep.<span class="property">_tokenExpireDate</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reloadUser.<span class="property">token</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userSbj</span>.<span class="title function_">next</span>(reloadUser);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> expirationDuration = <span class="keyword">new</span> <span class="title class_">Date</span>(userKeep.<span class="property">_tokenExpireDate</span>).<span class="title function_">getTime</span>() - <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>(); <span class="comment">//※重點：原預計的時間距離現在還差？毫秒</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">autoSignOut</span>(expirationDuration);<span class="comment">//// ※重點：刷新網頁成功找回 user 資訊時，執行 autoSignOut ，要求指定時間（單位毫秒）內 timeout</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">signOut</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userSbj</span>.<span class="title function_">next</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">Router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;auth&#x27;</span>]);</span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;userData&#x27;</span>); <span class="comment">// ※重點：順便幫忙清除 storage</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">tokenExpireTimer</span>) &#123; <span class="comment">// ※重點：如果自己登出，我們清掉 timeout 預設動作與值</span></span><br><span class="line">      <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">tokenExpireTimer</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tokenExpireTimer</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">autoSignOut</span>(<span class="params"><span class="attr">expireTime</span>: <span class="built_in">number</span></span>) &#123; <span class="comment">// ※重點</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(expireTime); <span class="comment">//firebase 預設為 1H，觀察是不是 3600000</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tokenExpireTimer</span> = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">signOut</span>();</span><br><span class="line">    &#125;, expireTime)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title class_">AuthHandle</span>(<span class="attr">email</span>: <span class="built_in">string</span>, <span class="attr">userId</span>: <span class="built_in">string</span>, <span class="attr">token</span>: <span class="built_in">string</span>, <span class="attr">expiresIn</span>: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">new</span> <span class="title class_">User</span>(</span><br><span class="line">      email,</span><br><span class="line">      userId,</span><br><span class="line">      token,</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() + expiresIn * <span class="number">1000</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userSbj</span>.<span class="title function_">next</span>(user);</span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;userData&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user));</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">autoSignOut</span>(expiresIn * <span class="number">1000</span>); <span class="comment">// ※重點：登入成功，執行 autoSignOut ，要求指定時間內 timeout</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="路由守衛阻止未登入的動作"><a href="#路由守衛阻止未登入的動作" class="headerlink" title="路由守衛阻止未登入的動作"></a>路由守衛阻止未登入的動作</h2><p>目前若未登入直接拜訪網址<code>http://localhost:4200/recipes</code>仍可以正常讀取，我們需要透過路由守衛去檢查 Subject 內的 User 用戶資訊是否存在。如果存在就 canActivate 允許拜訪回傳 True，否則就強制帶到網址 <code>/auth</code> 要求登入。</p>
<h3 id="建立守衛規則-auth-guard-service-ts"><a href="#建立守衛規則-auth-guard-service-ts" class="headerlink" title="建立守衛規則 auth-guard-service.ts"></a>建立守衛規則 auth-guard-service.ts</h3><ul>
<li>手動或 CLI 指令<code>ng g s auth/auth-guard --skip-tests</code>建立 auth&#x2F;auth-guard-service.ts 路由守衛規則</li>
<li>此規則引用了 AuthService 的 userSbj 進行觀察嘗試拿到 Boolean 值，由於只需一次性所以添加<code>take(1)</code></li>
<li>同上，接著判斷該內容（透過 map) 有值，如果沒有值可以強制路由導向到指定的 auth 表單頁面。導向除了 navigate 方式直接當下轉走，canActivate 也可以使用 createUrlTree 方式將 UrlTree 回傳，由路由守衛幫我們轉址。</li>
</ul>
<figure class="highlight typescript"><figcaption><span>auth\auth-guard.service.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; map, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRouteSnapshot</span>, <span class="title class_">CanActivate</span>, <span class="title class_">Router</span>, <span class="title class_">RouterStateSnapshot</span>, <span class="title class_">UrlTree</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123; <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthGuard</span> <span class="keyword">implements</span> <span class="title class_">CanActivate</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">AuthService</span>: <span class="title class_">AuthService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">Router</span>: <span class="title class_">Router</span>,</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">canActivate</span>(</span><br><span class="line">    <span class="attr">route</span>: <span class="title class_">ActivatedRouteSnapshot</span>,</span><br><span class="line">    <span class="attr">state</span>: <span class="title class_">RouterStateSnapshot</span></span><br><span class="line">  ): <span class="built_in">boolean</span> | <span class="title class_">UrlTree</span> | <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span> | <span class="title class_">UrlTree</span>&gt; | <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span> | <span class="title class_">UrlTree</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">AuthService</span>.<span class="property">userSbj</span>.<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">take</span>(<span class="number">1</span>),</span><br><span class="line">      <span class="title function_">map</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> isAuth = !!user;</span><br><span class="line">        <span class="keyword">if</span> (isAuth) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">Router</span>.<span class="title function_">createUrlTree</span>([<span class="string">&#x27;/auth&#x27;</span>]);</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note info"><p><strong>createUrlTree 與 navigate</strong><br>createUrlTree 與 navigate 都是 Angular Router 提供的導航方法。createUrlTree 可以用來創建一個路由樹，並返回一個新的 UrlTree，但不會執行導航。它主要用於在程式邏輯中建立路由鏈接，例如在頁面中點擊一個按鈕後需要導航到另一個頁面。以下是一個示例：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span>, <span class="title class_">UrlTree</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">router</span>: <span class="title class_">Router</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onButtonClick</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">urlTree</span>: <span class="title class_">UrlTree</span> = <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">createUrlTree</span>([<span class="string">&#x27;/products&#x27;</span>, productId]);</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">url</span>: <span class="built_in">string</span> = urlTree.<span class="title function_">toString</span>();</span><br><span class="line">  <span class="comment">// do something with the url</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>當用戶單擊按鈕時，將創建一個包含 &#x2F;products 和產品 ID 的路由樹，但不會執行導航。然後，可以使用 toString 方法將路由樹轉換為字符串形式，並將其用於任何需要的地方，例如用戶點擊後在新窗口中打開。</p>
<p>相反，navigate 方法可用於在應用程序中執行實際導航。以下是一個示例：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">router</span>: <span class="title class_">Router</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onButtonClick</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/products&#x27;</span>, productId]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的例子中，當用戶單擊按鈕時，將立即執行導航到指定的路由。這將導致應用程序在瀏覽器中顯示新頁面。</p>
</div>

<h3 id="設定路由規則-app-routing-module-ts"><a href="#設定路由規則-app-routing-module-ts" class="headerlink" title="設定路由規則 app-routing.module.ts"></a>設定路由規則 app-routing.module.ts</h3><p>現在示範只示範，若拜訪網址<code>http://localhost:4200/recipes</code>需要套用 auth-guard-service.ts 的守衛機制。</p>
<ul>
<li>找到該 Routs.path 為 recipes 的位置，追加 canActivate 屬性並指向 AuthGuard 規則。</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthGuard</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth/auth-guard.service&#x27;</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">appRoutes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/recipes&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;recipes&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">RecipesComponent</span>,</span><br><span class="line">    <span class="attr">canActivate</span>: [<span class="title class_">AuthGuard</span>], <span class="comment">//※重點</span></span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">    <span class="comment">//  ...</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="comment">//  ...</span></span><br><span class="line">];</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<h1 id="Dynamic-Component-動態元件"><a href="#Dynamic-Component-動態元件" class="headerlink" title="Dynamic Component 動態元件"></a>Dynamic Component 動態元件</h1><p>動態元件（Dynamic Component）是指在執行時期建立並插入到應用程式中的元件。相較於在模板中直接使用 <app-component> 這樣的標籤方式，動態元件通常是透過程式碼動態產生並加入到應用程式中的。</p>
<p>在 Angular 中，要建立動態元件可以使用 ComponentFactoryResolver 來取得 ComponentFactory，再透過 ViewContainerRef 的 createComponent() 方法來建立元件。 ComponentFactoryResolver 負責載入元件的定義，而 ViewContainerRef 則負責定位要插入動態元件的容器。</p>
<p>動態元件常見的應用情境包括：</p>
<ul>
<li>需要在執行時期才能決定元件的類型、樣式或配置。</li>
<li>在路由切換時，需要根據路由參數決定要顯示哪一個元件。</li>
<li>需要動態增加或刪除元件，例如使用者點擊按鈕後，產生一個新的元件並插入到應用程式中。</li>
</ul>
<p>使用動態元件可以提升應用程式的彈性，可以更容易地應對變化的需求。</p>
<h2 id="重新規劃-Alert-Modal-於靜態元件"><a href="#重新規劃-Alert-Modal-於靜態元件" class="headerlink" title="重新規劃 Alert Modal 於靜態元件"></a>重新規劃 Alert Modal 於靜態元件</h2><p>在素材內先前已設計一組若 auth 表單提交錯誤，透過 Bootstrap Alert 產生錯誤資訊。</p>
<figure class="highlight html"><figcaption><span>src\app\auth\auth.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-danger&quot;</span> *<span class="attr">ngIf</span>=<span class="string">&quot;isError&quot;</span>&gt;</span></span><br><span class="line">  &#123;&#123;isError&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>這裡重新設計為層疊彈跳 modal 視窗 UI，並使用傳統元件搭配 ngIf 來控制該元件存取的條件。</p>
<ul>
<li>手動或 CLI 指令<code>ng g c shared/alert/alert --skip-tests</code>建立指定目錄下之 alert.component.ts</li>
<li>配合設計指定 html&#x2F;css 樣式，其中 html 提供 error 資訊之外，另有 Close 的 click 事件落於 backdrop 或 button 之上。</li>
<li>alert 元件上面德 error 資訊與 click 動作 (event 發射器），透過 Input 與 Output 方式給 auth 元件輸入輸出。</li>
</ul>
<blockquote>
<p>注意 app.module.ts 要在 declarations 內註冊此新 AlertComponent</p>
</blockquote>
<figure class="highlight typescript"><figcaption><span>src\app\shared\alert\alert\alert.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">EventEmitter</span>, <span class="title class_">Input</span>, <span class="title class_">OnInit</span>, <span class="title class_">Output</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-alert&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./alert.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./alert.component.css&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AlertComponent</span> &#123;</span><br><span class="line">  <span class="meta">@Input</span>() <span class="attr">message</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="meta">@Output</span>() close = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>&lt;<span class="built_in">void</span>&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onClose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">close</span>.<span class="title function_">emit</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>src\app\shared\alert\alert\alert.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;backdrop&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onClose()&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert-box&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert-box-actions&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onClose()&quot;</span>&gt;</span>Close<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight css"><figcaption><span>src\app\shared\alert\alert\alert.component.css</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.backdrop</span>&#123;</span><br><span class="line">  <span class="attribute">position</span>: fixed;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100vw</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#000b</span>;</span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">50</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.alert-box</span>&#123;</span><br><span class="line">  <span class="attribute">position</span>: fixed;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">30vh</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">20vw</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">60vw</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">16px</span>;</span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">100</span>;</span><br><span class="line">  <span class="attribute">background</span>: white;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">8px</span> <span class="number">#0004</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.alert-box-actions</span>&#123;</span><br><span class="line">  <span class="attribute">text-align</span>: right;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>auth 元件部分，對應處理輸入與輸出作業。</li>
<li>從 alert 元件傳過來的互動按鈕要求關閉 Alert，只需要將 error 資訊清除就會根據原設計不會顯示該 alert。</li>
</ul>
<figure class="highlight html"><figcaption><span>src\app\auth\auth.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;div class=&quot;alert alert-danger&quot; *ngIf=&quot;isError&quot;&gt;</span></span><br><span class="line"><span class="comment">  &#123;&#123;isError&#125;&#125;</span></span><br><span class="line"><span class="comment">&lt;/div&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">app-alert</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">message</span>]=<span class="string">&quot;isError&quot;</span></span></span><br><span class="line"><span class="tag">  *<span class="attr">ngIf</span>=<span class="string">&quot;isError&quot;</span></span></span><br><span class="line"><span class="tag">  (<span class="attr">close</span>)=<span class="string">&quot;onErrorHandle()&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">app-alert</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>src\app\auth\auth.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="title function_">onErrorHandle</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">isError</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="改以動態元件方式生成-alert"><a href="#改以動態元件方式生成-alert" class="headerlink" title="改以動態元件方式生成 alert"></a>改以動態元件方式生成 alert</h2><p>傳統靜態元件的方式只需要依賴 ngIf 方式控制是否讀取該已寫好的元件。相較於動態元件是由 angular 在執行過程當下將一個指定元件塞入至 DOM。塞入 DOM 需先預先規劃一個 ViewContainerRef 容器。</p>
<p>在 Angular 中，ViewContainerRef 是一個抽象類別，它代表一個視圖容器，可以用來動態加入或刪除 Angular 元件。當需要動態地創建元件時，可以使用 ViewContainerRef 來訪問視圖容器，並在需要的地方插入元件。舉例來說，當你想在用戶觸發某些事件後，插入一個元件來顯示資訊時，就可以使用 ViewContainerRef 來實現這個功能。</p>
<ul>
<li>移除原本 HTML 模板上的靜態元件插入，我們改使用 ng-template（亦可使用 ng-container) 並指定自訂別名如 dynamicAlertComp</li>
<li>透過 ViewChild 找到這個自訂模板成為本地屬性 theViewContainerRef，並指定 option 參數為 ViewContainerRef，同時這個屬性的型別也是 ViewContainerRef。</li>
<li>接著規劃一個新方法 showErrorAlert(errorMessage)，當發生錯誤時將錯誤丟給該函式處理控制動態元件的生成。</li>
</ul>
<figure class="highlight html"><figcaption><span>src\app\auth\auth.component.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;app-alert</span></span><br><span class="line"><span class="comment">  [message]=&quot;isError&quot;</span></span><br><span class="line"><span class="comment">  *ngIf=&quot;isError&quot;</span></span><br><span class="line"><span class="comment">  (close)=&quot;onErrorHandle()&quot;</span></span><br><span class="line"><span class="comment">&gt;&lt;/app-alert&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ng-template</span> #<span class="attr">dynamicAlertComp</span>&gt;</span><span class="tag">&lt;/<span class="name">ng-template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>src\app\auth\auth.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">ViewChild</span>, <span class="title class_">ViewContainerRef</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthComponent</span> &#123;</span><br><span class="line">  isLoginMode = <span class="literal">true</span>;</span><br><span class="line">  isLoading = <span class="literal">false</span>;</span><br><span class="line">  isError = <span class="literal">null</span>;</span><br><span class="line">  <span class="meta">@ViewChild</span>(<span class="string">&#x27;dynamicAlertComp&#x27;</span>, &#123; <span class="comment">//※重點</span></span><br><span class="line">    <span class="attr">read</span>: <span class="title class_">ViewContainerRef</span>,</span><br><span class="line">    <span class="attr">static</span>: <span class="literal">false</span></span><br><span class="line">  &#125;) <span class="attr">theViewContainerRef</span>: <span class="title class_">ViewContainerRef</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">onSubmit</span>(<span class="params"><span class="attr">form</span>: <span class="title class_">NgForm</span></span>) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    authObservable.<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">resData</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(resData);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">Router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/recipes&#x27;</span>]);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isError</span> = error;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">showErrorAlert</span>(error); <span class="comment">//※重點</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">    form.<span class="title function_">reset</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">showErrorAlert</span>(<span class="params"><span class="attr">errMessage</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="comment">//規劃動態元件工作</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note info"><p><strong>ng-template 和 ng-container</strong><br>為 Angular 中的指令，用於在模板中定義和處理內容。</p>
<ul>
<li>ng-template<br>是用來定義一段 HTML 模板，它並不會在頁面上顯示任何內容，而是當作一個容器或者容器的複本來使用。</li>
<li>ng-container<br>也是一個容器元素，但它的主要作用是作為佔位符使用，它可以幫助我們結構化模板，提高可讀性，同時不影響 DOM 結構。</li>
</ul>
</div>
<div class="note info"><p><strong>ViewChild 參數</strong><br>範例內的第二組 options 參數提供以下說明：</p>
<ul>
<li>read<br>可以使用 read 選項來指定要注入的提供者。如果指定了這個選項，則 ViewChild 會查找該提供者，而不是使用元素本身的類型。這對於需要在組件中訪問服務或其他提供者的情況非常有用。</li>
<li>static ( Angular8+ 必填）<br>設置 static 為 true，可以在 ngAfterViewInit 之前解析 ViewChild。這個選項可以解決 Angular 的讀取順序問題。</li>
<li>emitEvent<br>設置 emitEvent 為 true，可以在變更時發出事件，通常在與 ngModel 或 FormGroup 一起使用時使用。</li>
</ul>
</div>

<p>我們需要透過 ComponentFactoryResolver 來建立一個元件工廠（你需要在建構子宣告），ComponentFactoryResolver 是 Angular 中一個重要的服務，它允許動態創建和載入組件，並且在執行時期動態創建這些組件，可以滿足各種動態組件的需要。</p>
<ul>
<li>使用 ComponentFactoryResolver 的 resolveComponentFactory 將一個靜態元件（我們的 alert 模板 AlertComponent) 加入。</li>
<li>可以先將 ViewContainerRef 清除避免原畫面上的容器有舊東西，透過 clear()</li>
<li>接著要求這個 AlertComponentFactory 製程建立於 ViewContainerRef 上面，使得畫面上得以產生動態元件。</li>
<li>別忘了我們需要 Input&#x2F;Out 去操作此元件，可使用 instance 去寫入屬性與方法</li>
<li>close 本身是一個可訂閱的事件，一旦偵測到可以清除整個容器下的東西（由於每次按下元件都被清除，所以訂閱不會一值存在，可省去銷毀的取消訂閱）</li>
</ul>
<figure class="highlight typescript"><figcaption><span>src\app\auth\auth.component.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AlertComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../shared/alert/alert/alert.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">ComponentFactoryResolver</span>, <span class="title class_">ViewChild</span>, <span class="title class_">ViewContainerRef</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthComponent</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">AuthService</span>: <span class="title class_">AuthService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">Router</span>: <span class="title class_">Router</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="title class_">ComponentFactoryResolver</span>: <span class="title class_">ComponentFactoryResolver</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">showErrorAlert</span>(<span class="params"><span class="attr">errMessage</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 建立 AlertComponent 製程</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">AlertCmpFty</span> = <span class="variable language_">this</span>.<span class="property">ComponentFactoryResolver</span>.<span class="title function_">resolveComponentFactory</span>(<span class="title class_">AlertComponent</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">theViewContainerRef</span>.<span class="title function_">clear</span>();</span><br><span class="line">  </span><br><span class="line">      <span class="comment">// 插入 AlertComponent 到 ng-template 中</span></span><br><span class="line">    <span class="keyword">const</span> compRef = <span class="variable language_">this</span>.<span class="property">theViewContainerRef</span>.<span class="title function_">createComponent</span>(<span class="title class_">AlertCmpFty</span>);</span><br><span class="line">  </span><br><span class="line">    compRef.<span class="property">instance</span>.<span class="property">message</span> = errMessage;</span><br><span class="line">    compRef.<span class="property">instance</span>.<span class="property">close</span>.<span class="title function_">subscribe</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">theViewContainerRef</span>.<span class="title function_">clear</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外在 Angular 中，如果希望動態加載某個 Component，需要在相關的 NgModule 中聲明該 Component，這通常可以在 declarations 中完成，但如果要動態加載，還需要在 entryComponents 中聲明。</p>
<figure class="highlight typescript"><figcaption><span>src\app\app.module.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [</span><br><span class="line">    <span class="comment">//  ...</span></span><br><span class="line">    <span class="title class_">AlertComponent</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">//  ...</span></span><br><span class="line">  <span class="attr">entryComponents</span>:[</span><br><span class="line">    <span class="title class_">AlertComponent</span>,</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="參考文獻"><a href="#參考文獻" class="headerlink" title="參考文獻"></a>參考文獻</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.udemy.com/course/the-complete-guide-to-angular-2/">Udemy Angular - The Complete Guide (2023 Edition)</a> SESSION 18, 20, 21</li>
<li><a target="_blank" rel="noopener" href="https://firebase.google.com/docs/reference/rest/auth?hl=zh-tw">Firebase</a></li>
<li><a target="_blank" rel="noopener" href="https://jwt.io/">JWT.io</a></li>
<li><a target="_blank" rel="noopener" href="https://angular.io/guide/dynamic-component-loader">Angular - Dynamic component loader</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
              <a href="/tags/Angular/" rel="tag"># Angular</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/12-11/php-project-camp/" rel="prev" title="[期末課程] PHP 期末實作：商務網站">
                  <i class="fa fa-chevron-left"></i> [期末課程] PHP 期末實作：商務網站
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/03-14/js-angular-6/" rel="next" title="[前端框架] Angular - 模組、部屬、獨立元件">
                  [前端框架] Angular - 模組、部屬、獨立元件 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    <span class="with-love">
      <i class="fa fa-star"></i>
    </span>
    <span class="author" itemprop="copyrightHolder" title="找我？！側單左上連結">Loki Jiang</span>
    <span class="post-meta-item-icon with-love">
      <i class="fas fa-copyright"></i>
    </span>
    2020 – 
    <span itemprop="copyrightYear">2024</span> All rights reserved.
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon with-love">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="總字數">519,958</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon with-love">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">15:45:23</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon with-love">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="訪客總數">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon with-love">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="總瀏覽次數">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/summer10920" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  <script src="/js/third-party/fancybox.js"></script>



  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"
    integrity="sha512-lGnVsh3WK0YJ7NX7rQmUu6kqF7vqELuDrUTnxpI2iD86VwI+OlQhi3EAJJZbrBUOfDFOAYAkigxkApHGM2IZTg=="
    crossorigin="anonymous"></script>
<script src="/assets/js/loki.js"></script>
</body>
</html>
