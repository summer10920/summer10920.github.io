<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo-loki.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,700,700italic%7CNoto+Sans+TC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"summer10920.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","width":400,"display":"post","padding":20,"offset":20},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本篇將利用 css 與 javascript 之前端課程專案網站作為對應的網頁資料系統，並出分為後台採用混和型開發與前台 api 分離型開發。在此，試著將網站所需資料透過 php 資料處理輸出至 html 網頁。">
<meta property="og:type" content="article">
<meta property="og:title" content="[期末課程] PHP 期末實作：商務網站">
<meta property="og:url" content="http://summer10920.github.io/2022/12-11/php-project-camp/">
<meta property="og:site_name" content="洛奇的邪惡組織手札">
<meta property="og:description" content="本篇將利用 css 與 javascript 之前端課程專案網站作為對應的網頁資料系統，並出分為後台採用混和型開發與前台 api 分離型開發。在此，試著將網站所需資料透過 php 資料處理輸出至 html 網頁。">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/96NYgou.png">
<meta property="article:published_time" content="2022-12-11T13:38:38.000Z">
<meta property="article:modified_time" content="2023-02-17T14:44:41.922Z">
<meta property="article:author" content="Loki Jiang">
<meta property="article:tag" content="PHP 程式設計（假日班）">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/96NYgou.png">


<link rel="canonical" href="http://summer10920.github.io/2022/12-11/php-project-camp/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-TW","comments":true,"permalink":"http://summer10920.github.io/2022/12-11/php-project-camp/","path":"2022/12-11/php-project-camp/","title":"[期末課程] PHP 期末實作：商務網站"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>[期末課程] PHP 期末實作：商務網站 | 洛奇的邪惡組織手札</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146423952-3"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-146423952-3","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>







<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&family=Roboto&display=swap" rel="stylesheet">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <canvas id="lokiBanner" width="1920" height="200"></canvas>
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">洛奇的邪惡組織手札</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">I am WebDeveloper!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜尋" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤<span class="badge">20</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類<span class="badge">17</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>文章<span class="badge">68</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          關於洛奇
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8F%90%E5%89%8D%E6%BA%96%E5%82%99"><span class="nav-number">1.</span> <span class="nav-text">提前準備</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A0%E6%9D%90%E4%B8%8B%E8%BC%89"><span class="nav-number">1.1.</span> <span class="nav-text">素材下載</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%BA%AB%E8%A8%AD%E5%AE%9A"><span class="nav-number">1.2.</span> <span class="nav-text">資料庫設定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%BA%AB-PHP-%E6%B8%AC%E8%A9%A6"><span class="nav-number">1.3.</span> <span class="nav-text">資料庫 PHP 測試</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%8C%E5%8F%B0%E7%89%88%E5%9E%8B%E6%A8%A1%E7%B5%84%E5%8C%96"><span class="nav-number">1.4.</span> <span class="nav-text">後台版型模組化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#main-orderList-%E8%A8%82%E5%96%AE%E5%88%97%E8%A1%A8"><span class="nav-number">2.</span> <span class="nav-text">main-orderList 訂單列表</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%BB%BA%E7%AB%8B"><span class="nav-number">2.1.</span> <span class="nav-text">資料建立</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E8%AE%80%E5%8F%96"><span class="nav-number">2.2.</span> <span class="nav-text">資料讀取</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%8F%E5%8A%83-function-php-%E8%88%87-header-php"><span class="nav-number">2.2.1.</span> <span class="nav-text">規劃 function.php 與 header.php</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-main-orderList-php"><span class="nav-number">2.2.2.</span> <span class="nav-text">修改 main-orderList.php</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%AF%AB%E5%85%A5"><span class="nav-number">2.3.</span> <span class="nav-text">資料寫入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-plugins-lokiCalendar-js"><span class="nav-number">2.3.1.</span> <span class="nav-text">修改 plugins\lokiCalendar.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%8F%E5%8A%83-function-php"><span class="nav-number">2.3.2.</span> <span class="nav-text">規劃 function.php</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%88%AA%E9%99%A4"><span class="nav-number">2.4.</span> <span class="nav-text">資料刪除</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%8F%E5%8A%83-main-orderList-php-%E5%88%AA%E9%99%A4%E6%8C%89%E9%88%95"><span class="nav-number">2.4.1.</span> <span class="nav-text">規劃 main-orderList.php 刪除按鈕</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%8F%E5%8A%83-function-php-%E5%88%AA%E9%99%A4%E5%8B%95%E4%BD%9C"><span class="nav-number">2.4.2.</span> <span class="nav-text">規劃 function.php 刪除動作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#main-pallet-%E7%87%9F%E4%BD%8D%E5%8F%83%E6%95%B8"><span class="nav-number">3.</span> <span class="nav-text">main-pallet 營位參數</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%BB%BA%E7%AB%8B-1"><span class="nav-number">3.1.</span> <span class="nav-text">資料建立</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E8%AE%80%E5%8F%96-1"><span class="nav-number">3.2.</span> <span class="nav-text">資料讀取</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%8F%E5%8A%83-function-php-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">規劃 function.php</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%8F%E5%8A%83-main-pallet-php"><span class="nav-number">3.2.2.</span> <span class="nav-text">規劃 main-pallet.php</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E8%B3%87%E6%96%99"><span class="nav-number">3.3.</span> <span class="nav-text">修改資料</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%8F%E5%8A%83-function-php-2"><span class="nav-number">3.3.1.</span> <span class="nav-text">規劃 function.php</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E5%8F%B0%E8%B3%87%E6%96%99"><span class="nav-number">3.4.</span> <span class="nav-text">前台資料</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E8%A3%BD-db-json-%E7%82%BA-db-json-php"><span class="nav-number">3.4.1.</span> <span class="nav-text">重製 db.json 為 db.json.php</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#main-holiday-%E5%9C%8B%E5%AE%9A%E5%81%87%E6%97%A5"><span class="nav-number">4.</span> <span class="nav-text">main-holiday 國定假日</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%BB%BA%E7%AB%8B-2"><span class="nav-number">4.1.</span> <span class="nav-text">資料建立</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E8%AE%80%E5%8F%96-2"><span class="nav-number">4.2.</span> <span class="nav-text">資料讀取</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#function-php"><span class="nav-number">4.2.1.</span> <span class="nav-text">function.php</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#main-holiday-php"><span class="nav-number">4.2.2.</span> <span class="nav-text">main-holiday.php</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8B%95%E5%BB%BA%E7%AB%8B%E5%B9%B4%E4%BB%BD%E8%B3%87%E6%96%99"><span class="nav-number">4.3.</span> <span class="nav-text">自動建立年份資料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E8%B3%87%E6%96%99-1"><span class="nav-number">4.4.</span> <span class="nav-text">修改資料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E5%8F%B0%E8%B3%87%E6%96%99-1"><span class="nav-number">4.5.</span> <span class="nav-text">前台資料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A8%88%E7%AE%97%E5%83%B9%E6%A0%BC"><span class="nav-number">4.6.</span> <span class="nav-text">計算價格</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E6%96%B0%E8%A8%82%E5%96%AE%E4%B9%8B%E8%99%95%E7%90%86"><span class="nav-number">4.6.1.</span> <span class="nav-text">修改新訂單之處理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AF%8F%E6%97%A5%E6%88%BF%E6%B3%81"><span class="nav-number">5.</span> <span class="nav-text">每日房況</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%BB%BA%E7%AB%8B-3"><span class="nav-number">5.1.</span> <span class="nav-text">資料建立</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E8%AE%80%E5%8F%96-3"><span class="nav-number">5.2.</span> <span class="nav-text">資料讀取</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#function-php-1"><span class="nav-number">5.2.1.</span> <span class="nav-text">function.php</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E8%B3%87%E6%BA%90"><span class="nav-number">5.2.1.1.</span> <span class="nav-text">前置資源</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#getDaily"><span class="nav-number">5.2.1.1.1.</span> <span class="nav-text">getDaily()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#checkHoliday"><span class="nav-number">5.2.1.1.2.</span> <span class="nav-text">checkHoliday()</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E8%B3%87%E6%96%99%E5%90%88%E4%BD%B5%E6%95%B4%E7%90%86"><span class="nav-number">5.2.1.2.</span> <span class="nav-text">完整資料合併整理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#main-daily-php"><span class="nav-number">5.2.2.</span> <span class="nav-text">main-daily.php</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%AF%AB%E5%85%A5-1"><span class="nav-number">5.3.</span> <span class="nav-text">資料寫入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%9B%9E%E6%94%B9"><span class="nav-number">5.4.</span> <span class="nav-text">資料回改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B3%E8%99%9F%E7%99%BB%E5%85%A5"><span class="nav-number">6.</span> <span class="nav-text">帳號登入</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%99%BB%E5%85%A5%E9%A0%81%E9%9D%A2%E5%88%B0%E5%BE%8C%E5%8F%B0"><span class="nav-number">6.1.</span> <span class="nav-text">登入頁面到後台</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%8C%E5%8F%B0%E7%A6%81%E6%AD%A2%E7%84%A1%E7%99%BB%E5%85%A5%E6%88%90%E5%8A%9F%E7%9A%84%E6%8B%9C%E8%A8%AA"><span class="nav-number">6.2.</span> <span class="nav-text">後台禁止無登入成功的拜訪</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%99%BB%E5%87%BA%E6%B8%85%E9%99%A4-session"><span class="nav-number">6.3.</span> <span class="nav-text">登出清除 session</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%90%E5%AE%9A%E5%96%AE%E5%8F%B0%E9%9B%BB%E8%85%A6%E7%99%BB%E5%85%A5"><span class="nav-number">6.4.</span> <span class="nav-text">限定單台電腦登入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%90%E5%AE%9A-login-%E5%8F%AA%E9%9C%80%E4%B8%80%E6%AC%A1"><span class="nav-number">6.4.1.</span> <span class="nav-text">限定 login 只需一次</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%99%BB%E5%85%A5%E6%8F%90%E4%BA%A4%E7%94%A2%E7%94%9F-token"><span class="nav-number">6.4.2.</span> <span class="nav-text">登入提交產生 token</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%8F%E6%AC%A1%E5%BE%8C%E5%8F%B0%E9%83%BD%E9%9C%80%E6%AA%A2%E6%9F%A5-token-%E6%98%AF%E5%90%A6%E5%81%A5%E5%9C%A8%E3%80%82"><span class="nav-number">6.4.3.</span> <span class="nav-text">每次後台都需檢查 token 是否健在。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9A%B1%E8%97%8F-URL-%E9%99%84%E6%AA%94%E5%90%8D"><span class="nav-number">7.</span> <span class="nav-text">隱藏 URL 附檔名</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Loki Jiang"
      src="/images/loki_img.jpg">
  <p class="site-author-name" itemprop="name">Loki Jiang</p>
  <div class="site-description" itemprop="description">Time waits for no oneヽ(｀Д´)ﾉ</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/summer10920" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;summer10920" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blog@lokiwebs.com" title="E-Mail → mailto:blog@lokiwebs.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://codepen.io/summer10920/pens/public?grid_type=list" title="CodePen → https:&#x2F;&#x2F;codepen.io&#x2F;summer10920&#x2F;pens&#x2F;public?grid_type&#x3D;list" rel="noopener me" target="_blank"><i class="fab fa-codepen fa-fw"></i>CodePen</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.youtube.com/c/LokiJiang/playlists" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;c&#x2F;LokiJiang&#x2F;playlists" rel="noopener me" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="回到頂端">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="http://demob17300.lokiwebs.com/" title="http:&#x2F;&#x2F;demob17300.lokiwebs.com&#x2F;" rel="noopener" target="_blank">DemoSite - 網頁設計乙術科</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://blog.lokiwebs.com/" title="http:&#x2F;&#x2F;blog.lokiwebs.com&#x2F;" rel="noopener" target="_blank">舊址(停更) - 札記 Blog</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="http://summer10920.github.io/2022/12-11/php-project-camp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/loki_img.jpg">
      <meta itemprop="name" content="Loki Jiang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="洛奇的邪惡組織手札">
      <meta itemprop="description" content="Time waits for no oneヽ(｀Д´)ﾉ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="[期末課程] PHP 期末實作：商務網站 | 洛奇的邪惡組織手札">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [期末課程] PHP 期末實作：商務網站
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間 ×2022-12-11 21:38:38" itemprop="dateCreated datePublished" datetime="2022-12-11T21:38:38+08:00">2022-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間 ×2023-02-17 22:44:41" itemprop="dateModified" datetime="2023-02-17T22:44:41+08:00">2023-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%81%B7%E8%A8%93%E6%95%99%E6%9D%90/" itemprop="url" rel="index"><span itemprop="name">職訓教材</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%81%B7%E8%A8%93%E6%95%99%E6%9D%90/%E7%AF%84%E4%BE%8B%E5%AF%A6%E4%BD%9C%E7%B6%B2%E7%AB%99/" itemprop="url" rel="index"><span itemprop="name">範例實作網站</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數 ×</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數 ×</span>
      <span>13,183</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>00:23:58</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><img src="https://i.imgur.com/96NYgou.png"></p>
<p>本篇將利用 css 與 javascript 之前端課程專案網站作為對應的網頁資料系統，並出分為後台採用混和型開發與前台 api 分離型開發。在此，試著將網站所需資料透過 php 資料處理輸出至 html 網頁。</p>
<span id="more"></span>

<h1 id="提前準備"><a href="#提前準備" class="headerlink" title="提前準備"></a>提前準備</h1><p>正式開始教學之前，請先獲取本教學所需的初始素材。透過此素材作為商務網站練習之實作起始點。並透過 VSCode 與 Xampp 平台完成環境布署。</p>
<p>在這個素材內，前台採用提供其他班級課程之商務網站版型內容（主題：露營官網）並包含動態 js 設計與 api 對接準備，以及後台採用 <a target="_blank" rel="noopener" href="https://startbootstrap.com/template/sb-admin">SB Admin</a> 免費版型延伸修改。</p>
<h2 id="素材下載"><a href="#素材下載" class="headerlink" title="素材下載"></a>素材下載</h2><p>請前往下載加以使用，確保安裝置環境內容。本教材與前期 JavaScript 網頁設計（假日班）期末實作教材稍些取不同，請從新下載此份：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/summer10920/studies_TeachDemo_PHP">Source Project</a> - 基本 PHP&#x2F;MYSQL 之商務網站素材。</p>
</blockquote>
<p>此時檢查內容，包含了以下目錄：</p>
<ul>
<li><strong>source</strong><br>本教材前端起始素材，內包含前台完整版型資料與訂單表單。</li>
<li><strong>final</strong><br>本教材之完整結果DEMO檔案。</li>
<li><strong>backed_template</strong><br>本教材所需之後台版型素材，提供本教學所需建置之版型檔案。</li>
</ul>
<h2 id="資料庫設定"><a href="#資料庫設定" class="headerlink" title="資料庫設定"></a>資料庫設定</h2><p>接著規劃資料庫與測試資料存取：</p>
<ol>
<li>至 MYSQL 新增 DB 名為 project_Camp 且編碼為 utf8mb4_unicode_ci。</li>
<li>建立資料表 _loki_user 且欄位 id:INT（設定主鍵與自動流水號 A_I),user:TEXT,pwd:TEXT,active:INT。</li>
<li>對該 table 建立預設 admin:1234</li>
</ol>
<figure class="highlight sql"><figcaption><span>command history</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE `project_camp` <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `project_camp`.`_loki_user` ( `id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT , `name` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span> , `password` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span> , `acitve` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> , <span class="keyword">PRIMARY</span> KEY (`id`)) ENGINE <span class="operator">=</span> InnoDB;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `_loki_user` (`id`, `name`, `password`, `acitve`) <span class="keyword">VALUES</span> (<span class="keyword">NULL</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;1234&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="資料庫-PHP-測試"><a href="#資料庫-PHP-測試" class="headerlink" title="資料庫 PHP 測試"></a>資料庫 PHP 測試</h2><p>網站目錄底下先新增 function.php 並規劃 PDO 連線與測試。</p>
<ul>
<li>規劃 lokiSQL 物件，能夠包含 PDO 物件與設定。並規劃 select 功能。</li>
<li>規劃 checkUserSaveSession 函式，提供帳密如果存在於 SQL 則加入 SESSION 紀錄並回傳成功與否。同時如果已經有在 SESSION 內就不再驗證。</li>
<li>試著網頁執行<code>http://127.0.0.1/function.php</code>是否成功。代表 SQL 連線可正常操作。</li>
</ul>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_save_path</span>(<span class="string">&#x27;tmp&#x27;</span>); <span class="comment">//修改 tmp 路徑</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>(); <span class="comment">//open session</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PDO Connect CRUD</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lokiSQL</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span></span><br><span class="line">    <span class="variable">$db</span>,</span><br><span class="line">    <span class="variable">$prefix_name</span> = <span class="string">&#x27;_loki_&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="string">&quot;mysql:host=127.0.0.1;dbname=project_camp;charset=utf8&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$tb</span>, <span class="variable">$wh</span></span>) </span>&#123;  <span class="comment">//提供資料表名稱跟條件，我能操作 SQL-Select 回傳</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;SELECT * FROM &quot;</span> . <span class="variable">$this</span>-&gt;prefix_name . <span class="variable">$tb</span> . <span class="string">&quot; WHERE &quot;</span> . <span class="variable">$wh</span>)-&gt;<span class="title function_ invoke__">fetchAll</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////// custom function</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="keyword">new</span> <span class="title function_ invoke__">lokiSQL</span>();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkUserSaveSession</span>(<span class="params"><span class="variable">$acc</span>, <span class="variable">$pwd</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>])) <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">//如果存在就直接回傳 true，不用再驗證設定 SESSION</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$check</span> = !!<span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;name=&quot;&#x27;</span> . <span class="variable">$acc</span> . <span class="string">&#x27;&quot; AND password=&quot;&#x27;</span> . <span class="variable">$pwd</span> . <span class="string">&#x27;&quot; AND active=1&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$check</span>) <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>] = <span class="variable">$acc</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$check</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">checkUserSaveSession</span>(<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;1234&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="後台版型模組化"><a href="#後台版型模組化" class="headerlink" title="後台版型模組化"></a>後台版型模組化</h2><p>從這裡開始隨著步驟對素材包內多個 template.html 進行逐步替換成為模組化網頁。以<code>file/table.html</code>為例，將內容進行抽取分離。使得可重複利用以及便於維護性，整理成以下 4 筆檔案：</p>
<ul>
<li>header.php:<br>範圍從<code>&lt;!DOCTYPE html&gt;</code> ~ <code>&lt;div id=&quot;layoutSidenav_content&quot;&gt;</code>，使其 head 標籤與 body 起頭包覆。</li>
<li>main-orderList.php:<br>範圍為不含<code>&lt;main&gt;&lt;/main&gt;</code>內部元素。</li>
<li>footer.php:<br>範圍為<code>&lt;footer class=&quot;py-4 bg-light mt-auto&quot;&gt;</code> ~ <code>&lt;/html&gt;</code>。</li>
<li>admin.php:<br>經上述整理抽取，最後透過 include 匯入。理應獲得不變的首頁，但原理已分割化。<figure class="highlight php"><figcaption><span>admin.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/header.php&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">&lt;main&gt;</span><br><span class="line">  <span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/main-orderList.php&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">&lt;/main&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/footer.php&#x27;</span>) <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<div class="note default"><p>這裡僅示範簡易分割為止，如果需要可以思考 header.php 分離為 linkScript 與 navMenu，使模組更細部化。</p>
</div>

<h1 id="main-orderList-訂單列表"><a href="#main-orderList-訂單列表" class="headerlink" title="main-orderList 訂單列表"></a>main-orderList 訂單列表</h1><p>本篇正式教學訂單資料建置與呈現方式。</p>
<h2 id="資料建立"><a href="#資料建立" class="headerlink" title="資料建立"></a>資料建立</h2><p>前往 SQL 管理，建立 N 筆測試用資料。目前來說從前台得知傳過來的資料為</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">userName<span class="punctuation">:</span> name<span class="punctuation">,</span></span><br><span class="line">userPhone<span class="punctuation">:</span> <span class="number">1234</span><span class="punctuation">,</span></span><br><span class="line">userMail<span class="punctuation">:</span> <span class="number">123</span>@<span class="number">123123.123</span><span class="punctuation">,</span></span><br><span class="line">selectDate<span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;2023-02-21&quot;</span><span class="punctuation">,</span><span class="string">&quot;2023-02-22&quot;</span><span class="punctuation">,</span><span class="string">&quot;2023-02-23&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">sellout<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;aArea&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;bArea&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;cArea&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span><span class="attr">&quot;dArea&quot;</span><span class="punctuation">:</span><span class="number">4</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>而後台所需生成的欄位為：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">th</span>&gt;</span>訂購人<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">th</span>&gt;</span>入住日<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">th</span>&gt;</span>購買帳位<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">th</span>&gt;</span>應收金額<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">th</span>&gt;</span>手機信箱<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">th</span>&gt;</span>訂購時間<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">th</span>&gt;</span>刪除操作<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>因此，建立對應的 sql table 名為 <code>_loki_order_list</code>：</p>
<figure class="highlight sql"><figcaption><span>sql command</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `project_camp`.`_loki_order_list` (</span><br><span class="line">  `id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `phone` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `mail` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `selectDate` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `sellout` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `price` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `createDate` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `del` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>並建立假資料 2 筆，其中注意 selectDate 與 sellout 為陣列與 JSON 物件，因此轉型別為 string 存取較為適合。透過 PHP 的<code>serialize()</code>達到，建立轉換用的 obj2str.php 如下</p>
<figure class="highlight php"><figcaption><span>obj2str.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ary</span> = [<span class="string">&quot;2023-02-21&quot;</span>, <span class="string">&quot;2023-02-22&quot;</span>, <span class="string">&quot;2023-02-23&quot;</span>];</span><br><span class="line"><span class="variable">$aryStr</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ary</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$json</span> = <span class="string">&#x27;&#123;&quot;aArea&quot;:1,&quot;bArea&quot;:2,&quot;cArea&quot;:3,&quot;dArea&quot;:4&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$obj</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$json</span>);</span><br><span class="line"><span class="variable">$objStr</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$obj</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;b&gt;array in sql:&lt;/b&gt;&lt;br&gt; &#x27;</span> . <span class="variable">$aryStr</span>; </span><br><span class="line"><span class="comment">//a:3:&#123;i:0;s:10:&quot;2023-02-21&quot;;i:1;s:10:&quot;2023-02-22&quot;;i:2;s:10:&quot;2023-02-23&quot;;&#125;</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;b&gt;object in sql:&lt;/b&gt;&lt;br&gt; &#x27;</span> . <span class="variable">$objStr</span>; </span><br><span class="line"><span class="comment">//O:8:&quot;stdClass&quot;:4:&#123;s:5:&quot;aArea&quot;;i:1;s:5:&quot;bArea&quot;;i:2;s:5:&quot;cArea&quot;;i:3;s:5:&quot;dArea&quot;;i:4;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;hr&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;array in php::&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">unserialize</span>((<span class="variable">$aryStr</span>)));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;json in php::&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">unserialize</span>((<span class="variable">$objStr</span>)));</span><br></pre></td></tr></table></figure>

<p>因此完成指令如下：</p>
<figure class="highlight sql"><figcaption><span>sql command</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `_loki_order_list`</span><br><span class="line"><span class="keyword">VALUES</span> (</span><br><span class="line">    <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="string">&#x27;客戶 A&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0988123123&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;aa@gmail.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;a:3:&#123;i:0;s:10:&quot;2023-02-21&quot;;i:1;s:10:&quot;2023-02-22&quot;;i:2;s:10:&quot;2023-02-23&quot;;&#125;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;O:8:&quot;stdClass&quot;:4:&#123;s:5:&quot;aArea&quot;;i:1;s:5:&quot;bArea&quot;;i:2;s:5:&quot;cArea&quot;;i:3;s:5:&quot;dArea&quot;;i:4;&#125;&#x27;</span>,</span><br><span class="line">    <span class="number">9999</span>,</span><br><span class="line">    NOW(),</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">  );</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `_loki_order_list`</span><br><span class="line"><span class="keyword">VALUES</span> (</span><br><span class="line">    <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="string">&#x27;客戶 B&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0977456456&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;bb@gmail.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;a:3:&#123;i:0;s:10:&quot;2023-02-22&quot;;i:1;s:10:&quot;2023-02-23&quot;;i:2;s:10:&quot;2023-02-24&quot;;&#125;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;O:8:&quot;stdClass&quot;:4:&#123;s:5:&quot;aArea&quot;;i:2;s:5:&quot;bArea&quot;;i:3;s:5:&quot;cArea&quot;;i:4;s:5:&quot;dArea&quot;;i:5;&#125;&#x27;</span>,</span><br><span class="line">    <span class="number">5555</span>,</span><br><span class="line">    NOW(),</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<h2 id="資料讀取"><a href="#資料讀取" class="headerlink" title="資料讀取"></a>資料讀取</h2><p>這裡將對後台規劃資料列表顯示，透過 datatables 套件能快速規劃出具備功能性的表格。而避免過度依賴 HTML 與 JS，採用 php 來生成靜態 HTML 之資料網頁。</p>
<h3 id="規劃-function-php-與-header-php"><a href="#規劃-function-php-與-header-php" class="headerlink" title="規劃 function.php 與 header.php"></a>規劃 function.php 與 header.php</h3><p>暫時性的先將稍早測試用的 checkUserSaveSession() 註解掉。這裡規劃新的 getOrderList() 使幫助我們能獲取來自 orderList 資料表的所有資料，where 條件為無（也就是 1)。</p>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">///////////// custom function</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="keyword">new</span> <span class="title function_ invoke__">lokiSQL</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// function checkUserSaveSession($acc, $pwd) &#123;</span></span><br><span class="line"><span class="comment">//   global $sql;</span></span><br><span class="line"><span class="comment">//   if (isset($_SESSION[&#x27;admin&#x27;])) return true; //如果存在就直接回傳 ture，不用再驗證設定 SESSION</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   $check = !!$sql-&gt;select(&#x27;user&#x27;, &#x27;name=&quot;&#x27; . $acc . &#x27;&quot; AND password=&quot;&#x27; . $pwd . &#x27;&quot; AND active=1&#x27;);</span></span><br><span class="line"><span class="comment">//   if ($check) $_SESSION[&#x27;admin&#x27;] = $acc;</span></span><br><span class="line"><span class="comment">//   return $check;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// var_dump(checkUserSaveSession(&#x27;admin&#x27;, &#x27;1234&#x27;));</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getOrderList</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;order_list&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後我們希望任何網頁都能吃到 function.php 的函式，因此利用 header.php 剛好會是這些網頁的通用檔案，可加入到初始處。並利用 require_once 完成初始引用。</p>
<figure class="highlight php"><figcaption><span>header.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">require_once</span>(<span class="string">&quot;./function.php&quot;</span>); <span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>現在可以隨意使用 function.php 內的任何函式，只要該網頁持有 head.php。</p>
<h3 id="修改-main-orderList-php"><a href="#修改-main-orderList-php" class="headerlink" title="修改 main-orderList.php"></a>修改 main-orderList.php</h3><p>再來回到後台的指定頁面，透過已存在的 HTML，我們希望能整理出<code>$htmlCode</code>規劃如下：</p>
<figure class="highlight php"><figcaption><span>main-orderList.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$htmlCode</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span> <span class="title">px</span>-4&quot;&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">h1</span> <span class="title">class</span>=&quot;<span class="title">mt</span>-4&quot;&gt;訂購資料&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">card</span> <span class="title">mb</span>-4&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">card</span>-<span class="title">body</span>&quot;&gt;</span></span><br><span class="line"><span class="class">      &lt;<span class="title">table</span> <span class="title">id</span>=&quot;<span class="title">orderTable</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;訂購人&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;入住日&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;購買帳位&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;應收金額&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;手機信箱&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;訂購時間&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;刪除操作&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;?= $<span class="title">htmlCode</span> ?&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="class">      &lt;/<span class="title">table</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如此一來，步驟如下：</p>
<ul>
<li>透過 getOrderList() 來獲得所有資料。這是來自 SQL 內的所有 DATA。需要跑 foreach 批次取出成為 tr&gt;td*7</li>
<li>其中 selectDate 是 array 經過打包所以要反轉回 unserialize。如果是 array 可以透過 implode 幫助我們轉指定的 string <code>$selectDateStr</code></li>
<li>其中 sellout 是 json 物件 (stdClass) 經過打包所以要反轉回 unserialize。雖然是 stdClass 也可以當作 array 跑 foreach 取出 key 與 value，再湊成指定的 string <code>selectPalletStr</code>。</li>
<li>同上，透過指定關鍵字 key 產生不同對應的 HTML Code。</li>
<li>最後將這些資料湊回 tr&gt;td*7，包含了<code>$row[&#39;name&#39;]</code>, <code>$selectDateStr</code>, <code>selectPalletStr</code>, <code>$row[&#39;price&#39;]</code>, <code>$row[&#39;phone&#39;].&#39; | &#39;.$row[&#39;mail&#39;]</code>, <code>$row[&#39;createDate&#39;]</code>, <code>$row[&#39;del&#39;]</code></li>
</ul>
<figure class="highlight php"><figcaption><span>main-orderList.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$rows</span> = <span class="title function_ invoke__">getOrderList</span>();</span><br><span class="line"><span class="variable">$htmlCode</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$rows</span> <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">  <span class="variable">$selectDateAry</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$row</span>[<span class="string">&#x27;selectDate&#x27;</span>]);</span><br><span class="line">  <span class="variable">$selectDateStr</span> =</span><br><span class="line">    <span class="string">&#x27;&lt;span class=&quot;badge bg-secondary me-1&quot;&gt;&#x27;</span> .</span><br><span class="line">    <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;&lt;/span&gt;&lt;span class=&quot;badge bg-secondary me-1&quot;&gt;&#x27;</span>, <span class="variable">$selectDateAry</span>) .</span><br><span class="line">    <span class="string">&#x27;&lt;/span&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$selectPalletObj</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$row</span>[<span class="string">&#x27;sellout&#x27;</span>]);</span><br><span class="line">  <span class="variable">$selectPalletStr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$selectPalletObj</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$key</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;aArea&#x27;</span>:</span><br><span class="line">        <span class="variable">$selectPalletStr</span> .= <span class="string">&#x27;&lt;span class=&quot;badge rounded-pill bg-danger me-1&quot;&gt;A 區 x &#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27;&lt;/span&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;bArea&#x27;</span>:</span><br><span class="line">        <span class="variable">$selectPalletStr</span> .= <span class="string">&#x27;&lt;span class=&quot;badge rounded-pill bg-warning me-1&quot;&gt;B 區 x &#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27;&lt;/span&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;cArea&#x27;</span>:</span><br><span class="line">        <span class="variable">$selectPalletStr</span> .= <span class="string">&#x27;&lt;span class=&quot;badge rounded-pill bg-success me-1&quot;&gt;C 區 x &#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27;&lt;/span&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;dArea&#x27;</span>:</span><br><span class="line">        <span class="variable">$selectPalletStr</span> .= <span class="string">&#x27;&lt;span class=&quot;badge rounded-pill bg-info me-1&quot;&gt;D 區 x &#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27;&lt;/span&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$htmlCode</span> .= <span class="string">&#x27;&lt;tr&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$selectDateStr</span> . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$selectPalletStr</span> . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;price&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;phone&#x27;</span>] . <span class="string">&#x27; | &#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;mail&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;createDate&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;del&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;/tr&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span> <span class="title">px</span>-4&quot;&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">h1</span> <span class="title">class</span>=&quot;<span class="title">mt</span>-4&quot;&gt;訂購資料&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">card</span> <span class="title">mb</span>-4&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">card</span>-<span class="title">body</span>&quot;&gt;</span></span><br><span class="line"><span class="class">      &lt;<span class="title">table</span> <span class="title">id</span>=&quot;<span class="title">orderTable</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;訂購人&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;入住日&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;購買帳位&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;應收金額&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;手機信箱&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;訂購時間&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;刪除操作&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;?= $<span class="title">htmlCode</span> ?&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="class">      &lt;/<span class="title">table</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="資料寫入"><a href="#資料寫入" class="headerlink" title="資料寫入"></a>資料寫入</h2><p>此時需要依賴前台的表單建立，也就是透過真實下訂之後轉給後端來執行資料庫寫入，讓後台可以看到單筆訂單追加。前台設計的位置為 index.html，同時透過 API 方式提交訂單給後端。</p>
<h3 id="修改-plugins-lokiCalendar-js"><a href="#修改-plugins-lokiCalendar-js" class="headerlink" title="修改 plugins\lokiCalendar.js"></a>修改 plugins\lokiCalendar.js</h3><p>API 位置原本為一個測試用的 fake 站點，修改調整回後端指定處。這裡合併利用 function.php 來完成（你應該另外建立一個專門與前台對接的 api.php，但由於範例只有一組 api 所以這裡簡約合併使用 function.php)。</p>
<figure class="highlight js"><figcaption><span>plugins\lokiCalendar.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// fetch(&#x27;https://jsonplaceholder.typicode.com/posts&#x27;, &#123;</span></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;/function.php?do=newOrder&#x27;</span>, &#123;</span><br></pre></td></tr></table></figure>

<h3 id="規劃-function-php"><a href="#規劃-function-php" class="headerlink" title="規劃 function.php"></a>規劃 function.php</h3><p>此時預覽一下 function.php，除了價格前端的前台提交不會傳遞過來（這也是保護真正的金額由後端自家伺服器來計算而不是由客戶來告知金額費用）。因此稍晚我們後端還需要透過資料庫去更新正確的金額。我們先完成訂單存入的行為。</p>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// api todo</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;to&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;newOrder&#x27;</span>:</span><br><span class="line">      <span class="title function_ invoke__">print_r</span>(<span class="variable">$_POST</span>);</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Array</span></span><br><span class="line"><span class="comment">      (</span></span><br><span class="line"><span class="comment">          [userName] =&gt; 213</span></span><br><span class="line"><span class="comment">          [userPhone] =&gt; 123123</span></span><br><span class="line"><span class="comment">          [userMail] =&gt; 123123@123</span></span><br><span class="line"><span class="comment">          [selectDate] =&gt; [&quot;2023-02-21&quot;]</span></span><br><span class="line"><span class="comment">          [sellout] =&gt; &#123;&quot;aArea&quot;:2,&quot;bArea&quot;:0,&quot;cArea&quot;:0,&quot;dArea&quot;:0&#125;</span></span><br><span class="line"><span class="comment">      )</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>循序根據以下規劃步驟思考與設計：</p>
<ul>
<li>在原 switch case 領域下，參考 INSERT 指令重新整理 VALUE 所需的字串。其中 selectDate 與 sellout 需要經過壓縮。</li>
<li>selectDate 壓縮方式較為簡單，將原本 string 轉為 array 再進行 serialize 壓縮。</li>
<li>sellout 需先將前端無意義的 0 捨去，因此 string 轉為普通 array （帶 true)，再透過 filter 過濾才進行壓縮。</li>
<li>整理好 value 陣列，另外發給 saveOrder() 或乾脆寫在一起省去下一步驟。這裡要注意 sql 本身字串需要特殊 string 字元，因此需特別補上。</li>
<li>建立 saveOrder() 幫助我們將 sql 指令傳遞到 sql 物件導向。透過<code>$sql-&gt;insert()</code>與指定 table 名稱完成工作。</li>
<li>於 lokiSql 物件內，參考<code>public function select($tb, $wh)</code>設計規劃出<code>public function insert($tb, $sqlCode)</code>。</li>
<li>insert() 會完成 sql 所有指令並透過 pdo 傳遞給 mysql。</li>
<li>最後要在 switch case 補上一個 json 輸出讓前端 JS 可捕獲到有回應成功。</li>
<li>最後測試一下前台提交訂單是否成功於 mysql 追加訂單成功，並來到後台觀看訂單列表變化。</li>
</ul>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lokiSQL</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span></span><br><span class="line">    <span class="variable">$db</span>,</span><br><span class="line">    <span class="variable">$prefix_name</span> = <span class="string">&#x27;_loki_&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="string">&quot;mysql:host=127.0.0.1;dbname=project_camp;charset=utf8&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$tb</span>, <span class="variable">$wh</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;SELECT * FROM &quot;</span> . <span class="variable">$this</span>-&gt;prefix_name . <span class="variable">$tb</span> . <span class="string">&quot; WHERE &quot;</span> . <span class="variable">$wh</span>)-&gt;<span class="title function_ invoke__">fetchAll</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span>(<span class="params"><span class="variable">$tb</span>, <span class="variable">$sqlCode</span></span>) </span>&#123;  <span class="comment">//提供資料表名稱跟 value 陣列，能操作 SQL-INSERT</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;INSERT INTO &#x27;</span> . <span class="variable">$this</span>-&gt;prefix_name . <span class="variable">$tb</span> . <span class="string">&#x27; VALUES (&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$sqlCode</span>) . <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saveOrder</span>(<span class="params"><span class="variable">$sqlCode</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">insert</span>(<span class="string">&#x27;order_list&#x27;</span>, <span class="variable">$sqlCode</span>)-&gt;queryString; <span class="comment">//如果 SQL 指令成功，可以捕獲到這個 String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// api todo</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;to&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;newOrder&#x27;</span>:</span><br><span class="line"></span><br><span class="line">      <span class="comment">// var_dump($_POST[&#x27;sellout&#x27;]);//注意這裡是字串 string(41) &quot;&#123;&quot;aArea&quot;:2,&quot;bArea&quot;:0,&quot;cArea&quot;:0,&quot;dArea&quot;:0&#125;&quot;</span></span><br><span class="line">      <span class="comment">// var_dump($_POST[&#x27;selectDate&#x27;]);//這裡也是字串</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// $selectDateAry = json_decode($_POST[&#x27;selectDate&#x27;]);</span></span><br><span class="line">      <span class="variable">$selectDateZip</span> = <span class="title function_ invoke__">serialize</span>(<span class="title function_ invoke__">json_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;selectDate&#x27;</span>]));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// $selloutAry = json_decode($_POST[&#x27;sellout&#x27;], true);</span></span><br><span class="line">      <span class="comment">// $selloutIsSet = array_filter($selloutAry, function ($v) &#123;</span></span><br><span class="line">      <span class="comment">//   return $v !== 0;</span></span><br><span class="line">      <span class="comment">// &#125;);</span></span><br><span class="line">      <span class="variable">$selloutZip</span> = <span class="title function_ invoke__">serialize</span>(<span class="title function_ invoke__">array_filter</span>(<span class="title function_ invoke__">json_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;sellout&#x27;</span>], <span class="literal">true</span>), function (<span class="variable">$v</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$v</span> !== <span class="number">0</span>;</span><br><span class="line">      &#125;));</span><br><span class="line"></span><br><span class="line">      <span class="variable">$sqlCode</span> = [<span class="string">&#x27;null&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userName&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userPhone&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userMail&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$selectDateZip</span> . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$selloutZip</span> . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="variable">$sum</span>, <span class="string">&#x27;NOW()&#x27;</span>,  <span class="number">0</span>];</span><br><span class="line">      <span class="comment">//最後提交到 sql 時需要 string 符號，因此這裡需要追加並利用跳脫字元。</span></span><br><span class="line">      <span class="comment">// print_r($sqlCode);</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// saveOrder($sqlCode);</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">saveOrder</span>(<span class="variable">$sqlCode</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/json&quot;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&#x27;STATE&#x27;</span> =&gt; <span class="string">&#x27;DONE&#x27;</span>]); <span class="comment">//最後要回應給前端一個 json 被捕獲。</span></span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&#x27;SQL FAIL&#x27;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前為止，除了金額還沒有計算成功。等完成營位參數設計功能後，再回頭處理這部分的正確計算總值。</p>
<h2 id="資料刪除"><a href="#資料刪除" class="headerlink" title="資料刪除"></a>資料刪除</h2><p>後台要能對每筆資料進行刪除，但這裡我們使用軟刪除，也就是不是真的刪除掉而是透過 del 值為 1，避免有任何需要查詢刪除紀錄時還能從資料庫內找到。（如果可以能對 sql 欄位多考慮刪除日期供未來查核，但這裡簡化不做此欄位）。</p>
<h3 id="規劃-main-orderList-php-刪除按鈕"><a href="#規劃-main-orderList-php-刪除按鈕" class="headerlink" title="規劃 main-orderList.php 刪除按鈕"></a>規劃 main-orderList.php 刪除按鈕</h3><p>修改原本 del 欄位，產生一個超連結方式利用 GET 變數去要求刪除的行為。試著組成帶有 id 的刪除要求並導向至 function.php。</p>
<figure class="highlight php"><figcaption><span>main-orderList.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$rows</span> <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$getAry</span> = [</span><br><span class="line">    <span class="string">&#x27;do&#x27;</span> =&gt; <span class="string">&#x27;delOrder&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span> =&gt; <span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">  ];</span><br><span class="line">  <span class="comment">//這裡可以 string 慢慢湊，或者利用 http_build_query 將 array 轉為 get 參數</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$htmlCode</span> .= <span class="string">&#x27;&lt;tr&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$selectDateStr</span> . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$selectPalletStr</span> . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;price&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;phone&#x27;</span>] . <span class="string">&#x27; | &#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;mail&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;createDate&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&lt;a class=&quot;btn btn-danger btn-sm&quot; href=&quot;function.php?&#x27;</span> . <span class="title function_ invoke__">http_build_query</span>(<span class="variable">$getAry</span>) . <span class="string">&#x27;&quot;&gt;刪除&lt;/a&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;/tr&gt;&#x27;</span>;</span><br><span class="line">    <span class="comment">//原本的 &lt;td&gt;&#x27;.$row[&#x27;del&#x27;].&#x27;&lt;/td&gt;換掉</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="規劃-function-php-刪除動作"><a href="#規劃-function-php-刪除動作" class="headerlink" title="規劃 function.php 刪除動作"></a>規劃 function.php 刪除動作</h3><p>到 function.php 規劃前面帶來的參數。這落於 switch case 內。利用 PDO 方式對 del 修改為 1。</p>
<ul>
<li>規劃 switch case 內的 delOrder 動作，觸發執行 delOrder 並提供 id</li>
<li>delOrder 函式對 PDO 的 update 操作，並指定好 table, SET, WHERE 等必要語句。</li>
<li>update 這裡將語句湊出還原。</li>
<li>如果成立需重新導向回回原本的後台網頁位置</li>
<li>最後調整 select all 的條件，添加只限定 del 為 0 的資料。</li>
<li>驗證資料刪除是否成功。</li>
</ul>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_save_path</span>(<span class="string">&#x27;tmp&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lokiSQL</span> </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"><span class="variable">$tb</span>, <span class="variable">$set</span>, <span class="variable">$wh</span></span>) </span>&#123;  <span class="comment">//提供引數，能操作 SQL-UPDATE</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;UPDATE &#x27;</span> . <span class="variable">$this</span>-&gt;prefix_name . <span class="variable">$tb</span> . <span class="string">&#x27; SET &#x27;</span> . <span class="variable">$set</span> . <span class="string">&#x27; WHERE &#x27;</span> . <span class="variable">$wh</span>);</span><br><span class="line">    <span class="comment">// UPDATE _loki_order_list SET del=1 WHERE id=5 參考</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////// custom function</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="keyword">new</span> <span class="title function_ invoke__">lokiSQL</span>();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getOrderList</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;order_list&#x27;</span>, <span class="string">&#x27;del=0&#x27;</span>); <span class="comment">//調整條件，只顯示軟刪除未成立的資料</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delOrder</span>(<span class="params"><span class="variable">$id</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">update</span>(<span class="string">&#x27;order_list&#x27;</span>, <span class="string">&#x27;del=1&#x27;</span>, <span class="string">&#x27;id=&#x27;</span> . <span class="variable">$id</span>)-&gt;queryString;</span><br><span class="line">  <span class="comment">// UPDATE _loki_order_list SET del=1 WHERE id=5  參考</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// api todo</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>]) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;delOrder&#x27;</span>:</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">delOrder</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location:admin.php&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&#x27;SQL FAIL&#x27;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="main-pallet-營位參數"><a href="#main-pallet-營位參數" class="headerlink" title="main-pallet 營位參數"></a>main-pallet 營位參數</h1><p>接下來為規劃可維護 pallet 的參數，從 file 目錄底下找到 main-pallet.html 並試著參考 admin 作法調整以下動作：</p>
<ul>
<li>建立並放置目錄為於<code>template/main-pallet.php</code></li>
<li>複製 admin.php 另建立根目錄底下的 pallet.php，並參考分割版型做法。</li>
<li>調整<code>template/header.php</code>內的選單 link，包含了 admin 與 pallet 的連結。</li>
</ul>
<figure class="highlight html"><figcaption><span>template/header.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;nav&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sb-sidenav-menu-heading&quot;</span>&gt;</span>訂房資訊<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;admin.php&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;sb-nav-link-icon fas fa-tachometer-alt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>訂單資料<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#!&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;sb-nav-link-icon fas fa-tachometer-alt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>每日房況<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#!&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;sb-nav-link-icon fas fa-tachometer-alt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>國定假日<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;pallet.php&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;sb-nav-link-icon fas fa-tachometer-alt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>營位參數設定<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><figcaption><span>pallet.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/header.php&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">&lt;main&gt;</span><br><span class="line">  <span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/main-pallet.php&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">&lt;/main&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/footer.php&#x27;</span>) <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="資料建立-1"><a href="#資料建立-1" class="headerlink" title="資料建立"></a>資料建立</h2><p>前往 SQL 管理，建立 4 筆測試用資料。從前台 db.json 得知以下資訊</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aArea&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;normalPrice&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;holidayPrice&quot;</span><span class="punctuation">:</span> <span class="number">1500</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bArea&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;normalPrice&quot;</span><span class="punctuation">:</span> <span class="number">1100</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;holidayPrice&quot;</span><span class="punctuation">:</span> <span class="number">1600</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;cArea&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;normalPrice&quot;</span><span class="punctuation">:</span> <span class="number">1200</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;holidayPrice&quot;</span><span class="punctuation">:</span> <span class="number">1700</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dArea&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;normalPrice&quot;</span><span class="punctuation">:</span> <span class="number">2000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;holidayPrice&quot;</span><span class="punctuation">:</span> <span class="number">2500</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>對此建立資料表，以及建立資料參閱 db.json</p>
<figure class="highlight sql"><figcaption><span>sql command</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `project_camp`.`_loki_pallet` (</span><br><span class="line">  `id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `total` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `normalPrice` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `holidayPrice` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `_loki_pallet`</span><br><span class="line"><span class="keyword">VALUES</span> (</span><br><span class="line">    <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="string">&#x27;aArea&#x27;</span>,</span><br><span class="line">    <span class="number">10</span>,</span><br><span class="line">    <span class="number">1000</span>,</span><br><span class="line">    <span class="number">1500</span></span><br><span class="line">  );</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `_loki_pallet`</span><br><span class="line"><span class="keyword">VALUES</span> (</span><br><span class="line">    <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="string">&#x27;bArea&#x27;</span>,</span><br><span class="line">    <span class="number">10</span>,</span><br><span class="line">    <span class="number">1000</span>,</span><br><span class="line">    <span class="number">1500</span></span><br><span class="line">  );</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `_loki_pallet`</span><br><span class="line"><span class="keyword">VALUES</span> (</span><br><span class="line">    <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="string">&#x27;cArea&#x27;</span>,</span><br><span class="line">    <span class="number">10</span>,</span><br><span class="line">    <span class="number">1000</span>,</span><br><span class="line">    <span class="number">1500</span></span><br><span class="line">  );</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `_loki_pallet`</span><br><span class="line"><span class="keyword">VALUES</span> (</span><br><span class="line">    <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="string">&#x27;dArea&#x27;</span>,</span><br><span class="line">    <span class="number">10</span>,</span><br><span class="line">    <span class="number">1000</span>,</span><br><span class="line">    <span class="number">1500</span></span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<h2 id="資料讀取-1"><a href="#資料讀取-1" class="headerlink" title="資料讀取"></a>資料讀取</h2><p>讓後台指定頁面可以獲取這些資料存放於 form 表單內的預設 value。可參考 main-orderList.php 做法。</p>
<h3 id="規劃-function-php-1"><a href="#規劃-function-php-1" class="headerlink" title="規劃 function.php"></a>規劃 function.php</h3><p>這裡規劃新的 getPallets() 使幫助我們能獲取來自 pallet 資料表的所有資料，where 條件為無（也就是 1)。</p>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPallet</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;pallet&#x27;</span>,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="規劃-main-pallet-php"><a href="#規劃-main-pallet-php" class="headerlink" title="規劃 main-pallet.php"></a>規劃 main-pallet.php</h3><p>試著將資料庫整理出畫面所需的 HTML。</p>
<ul>
<li>利用 getPallet() 取得所有資料，由於營位名稱跟資料庫不同，可以利用一個自訂陣列做轉換。</li>
<li>透過資料筆數與畫面 card 數量單位相同，迴圈控制了 4 次也對應 sql 共 4 筆。</li>
<li>注意 value 都能找到指定的資料。而 name 這裡用 [] 來存放。</li>
<li>我們還要偷藏一個 id 到表單內</li>
<li>規劃 form 表單採用 POST 並提交至指定 do&#x3D;mdyPallet</li>
</ul>
<figure class="highlight php"><figcaption><span>main-pallet.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$rows</span> = <span class="title function_ invoke__">getPallet</span>();</span><br><span class="line"><span class="variable">$titleAry</span> = [</span><br><span class="line">  <span class="string">&#x27;aArea&#x27;</span> =&gt; <span class="string">&#x27;河畔 × A 區&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;bArea&#x27;</span> =&gt; <span class="string">&#x27;山間 × B 區&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;cArea&#x27;</span> =&gt; <span class="string">&#x27;平原 × C 區&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;dArea&#x27;</span> =&gt; <span class="string">&#x27;車屋 × D 區&#x27;</span>,</span><br><span class="line">];</span><br><span class="line"><span class="variable">$htmlCode</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$rows</span> <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">  <span class="variable">$htmlCode</span> .= <span class="string">&#x27;</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;col&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;card mb-4&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;div class=&quot;card-header&quot;&gt;&#x27;</span> . <span class="variable">$titleAry</span>[<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>]] . <span class="string">&#x27;&lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;input type=&quot;hidden&quot; name=&quot;id[]&quot; value=&quot;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>] . <span class="string">&#x27;&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;div class=&quot;card-body&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;row row-cols-1 row-cols-sm-3 gy-2&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;div class=&quot;col&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;form-floating&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;input class=&quot;form-control&quot; name=&quot;total[]&quot; value=&quot;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;total&#x27;</span>] . <span class="string">&#x27;&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;label&gt;數量&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">          &lt;/div&gt;</span></span><br><span class="line"><span class="string">          &lt;div class=&quot;col&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;form-floating&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;input class=&quot;form-control&quot; name=&quot;normalPrice[]&quot; value=&quot;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;normalPrice&#x27;</span>] . <span class="string">&#x27;&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;label&gt;平日價格&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">          &lt;/div&gt;</span></span><br><span class="line"><span class="string">          &lt;div class=&quot;col&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;form-floating&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;input class=&quot;form-control&quot; name=&quot;holidayPrice[]&quot; value=&quot;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;holidayPrice&#x27;</span>] . <span class="string">&#x27;&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;label&gt;假日價格&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">          &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;form <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span> <span class="title">px</span>-4&quot; <span class="title">method</span>=&quot;<span class="title">post</span>&quot; <span class="title">action</span>=&quot;<span class="title">function</span>.<span class="title">php</span>?<span class="title">do</span>=<span class="title">mdyPallet</span>&quot;&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">h1</span> <span class="title">class</span>=&quot;<span class="title">mt</span>-4&quot;&gt;營位參數設定&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">row</span> <span class="title">row</span>-<span class="title">cols</span>-1 <span class="title">row</span>-<span class="title">cols</span>-<span class="title">sm</span>-2&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;?= $<span class="title">htmlCode</span> ?&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">hr</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">text</span>-<span class="title">center</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">secondary</span>&quot; <span class="title">type</span>=&quot;<span class="title">reset</span>&quot;&gt;復原&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">primary</span>&quot; <span class="title">type</span>=&quot;<span class="title">submit</span>&quot;&gt;修改&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="修改資料"><a href="#修改資料" class="headerlink" title="修改資料"></a>修改資料</h2><p>也就一口氣將前者之大型表單做修改提交，其重點核心如何將二維陣列整理做成 N 筆批次修改 SQL 指令。</p>
<h3 id="規劃-function-php-2"><a href="#規劃-function-php-2" class="headerlink" title="規劃 function.php"></a>規劃 function.php</h3><p>大概重點落於如何我們從迴圈抽分解 sql 指令，多利用 print_r 觀察 source array。最後如何確保指令成功要重新導向回後台頁面。</p>
<ul>
<li>從 case 內部先試著理解 print_r($_POST) 資料，我們只拿 id 二階陣列跑回圈，再利用同 index 特性去跨 array 湊出單筆資料之結構。</li>
<li>參考 SQL 的 UPDATE 指令做重組 string，利用 array 之後轉 string，會比起臭長的 string 串接而輕鬆。</li>
<li>回圈內應該會強迫更新 4 次資料，規劃 updatePallet() 另外處理，同時需要將 id 跟 SET 指令傳遞過去。</li>
<li>updatePallet 保持乾淨，只需向 PDO 做 update 並回傳結果。且 PDO 的 update 之前已設計過，我們可以重複利用</li>
<li>回到 case，既然會跑 4 次要確保沒有錯誤，可以自訂一個 boolean 為 true，只要有任何一次迴圈的 updatePallet 回傳捕獲失敗就改 false。離開迴圈後觀察此變數是否仍保持 true 就能代表 PDO 都順利，可以導向返回後台頁面。</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///////////// custom function</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="keyword">new</span> <span class="title function_ invoke__">lokiSQL</span>();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updatePallet</span>(<span class="params"><span class="variable">$id</span>, <span class="variable">$set</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">update</span>(<span class="string">&#x27;pallet&#x27;</span>, <span class="variable">$set</span>, <span class="string">&#x27;id=&#x27;</span> . <span class="variable">$id</span>)-&gt;queryString;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// api todo</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>]) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;mdyPallet&#x27;</span>:</span><br><span class="line">      <span class="comment">// print_r($_POST);</span></span><br><span class="line">      <span class="variable">$flag</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="comment">// &quot;UPDATE _loki_pallet SET id=[value-1],name=[value-2],total=[value-3],normalPrice=[value-4],holidayPrice=[value-5] WHERE 1&quot;;</span></span><br><span class="line">        <span class="variable">$setAry</span> = [</span><br><span class="line">          <span class="string">&#x27;total=&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;total&#x27;</span>][<span class="variable">$key</span>],</span><br><span class="line">          <span class="string">&#x27;normalPrice=&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;normalPrice&#x27;</span>][<span class="variable">$key</span>],</span><br><span class="line">          <span class="string">&#x27;holidayPrice=&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;holidayPrice&#x27;</span>][<span class="variable">$key</span>]</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$setStr</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$setAry</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">updatePallet</span>(<span class="variable">$value</span>, <span class="variable">$setStr</span>)) <span class="variable">$flag</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable">$flag</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location:pallet.php&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="前台資料"><a href="#前台資料" class="headerlink" title="前台資料"></a>前台資料</h2><p>由於營位參數的資料於前台有使用到，因此我們需要將原本的 db.json 讓 php 來控制並計算出 json 如何提供。使前台的前端資料與我們資料庫對應相符合。雖然 php 可利用 <code>fopen()</code> 與 <code>fwrite()</code> 來編寫 db.json，但本教材為了容易上手直接以 php 讀取內容方式完成。有興趣同學可自行研究完成。</p>
<h3 id="重製-db-json-為-db-json-php"><a href="#重製-db-json-為-db-json-php" class="headerlink" title="重製 db.json 為 db.json.php"></a>重製 db.json 為 db.json.php</h3><p>將原本根目錄下的 db.json 複製為 db.json.php，並修改前台原本的<code>plugins\lokiCalendar.js</code>內之<code>db.json</code>檔案路徑更改為<code>db.json.php</code> 進行該檔案調整：</p>
<ul>
<li>將原本的內容改成 string 方式用 php 的邏輯儲存起來，此時格式叫做 json string</li>
<li>將 json string 轉換解碼為純陣列使用。此時格式叫做 json array，這裡我們稍晚再做陣列整理保留</li>
<li>再者要提供在畫面內容上之前，記得宣告網頁格式 Content-Type 為 json。</li>
<li>此時 json string 透過 json 編碼 echo 出來，看看前端運作有無錯誤訊息。</li>
<li>此外我們也會需要跟 SQL 連線，所需要 function.php 這隻檔案做引用。</li>
</ul>
<figure class="highlight php"><figcaption><span>db.json.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&quot;./function.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$dbJSONStr</span> = <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;success&quot;: true,</span></span><br><span class="line"><span class="string">  &quot;nationalHoliday&quot;: [</span></span><br><span class="line"><span class="string">    &quot;2023-01-02&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-01-20&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-01-23&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-01-24&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-01-25&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-01-26&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-01-27&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-02-27&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-02-28&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-04-03&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-04-04&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-04-05&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-06-22&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-06-23&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-09-29&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-10-09&quot;,</span></span><br><span class="line"><span class="string">    &quot;2023-10-10&quot;,</span></span><br><span class="line"><span class="string">    &quot;2024-01-01&quot;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;pallet&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;count&quot;: 40,</span></span><br><span class="line"><span class="string">    &quot;aArea&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;total&quot;: 10,</span></span><br><span class="line"><span class="string">      &quot;normalPrice&quot;: 1000,</span></span><br><span class="line"><span class="string">      &quot;holidayPrice&quot;: 1500</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;bArea&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;total&quot;: 10,</span></span><br><span class="line"><span class="string">      &quot;normalPrice&quot;: 1100,</span></span><br><span class="line"><span class="string">      &quot;holidayPrice&quot;: 1600</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;cArea&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;total&quot;: 10,</span></span><br><span class="line"><span class="string">      &quot;normalPrice&quot;: 1200,</span></span><br><span class="line"><span class="string">      &quot;holidayPrice&quot;: 1700</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;dArea&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;total&quot;: 10,</span></span><br><span class="line"><span class="string">      &quot;normalPrice&quot;: 2000,</span></span><br><span class="line"><span class="string">      &quot;holidayPrice&quot;: 2500</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;booked&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;date&quot;: &quot;2022-12-12&quot;,</span></span><br><span class="line"><span class="string">      &quot;sellout&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;aArea&quot;: 1,</span></span><br><span class="line"><span class="string">        &quot;bArea&quot;: 1,</span></span><br><span class="line"><span class="string">        &quot;cArea&quot;: 1,</span></span><br><span class="line"><span class="string">        &quot;dArea&quot;: 1</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;date&quot;: &quot;2022-12-13&quot;,</span></span><br><span class="line"><span class="string">      &quot;sellout&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;aArea&quot;: 2,</span></span><br><span class="line"><span class="string">        &quot;bArea&quot;: 2,</span></span><br><span class="line"><span class="string">        &quot;cArea&quot;: 10,</span></span><br><span class="line"><span class="string">        &quot;dArea&quot;: 2</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;date&quot;: &quot;2022-12-14&quot;,</span></span><br><span class="line"><span class="string">      &quot;sellout&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;aArea&quot;: 3,</span></span><br><span class="line"><span class="string">        &quot;bArea&quot;: 3,</span></span><br><span class="line"><span class="string">        &quot;cArea&quot;: 3,</span></span><br><span class="line"><span class="string">        &quot;dArea&quot;: 3</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;date&quot;: &quot;2022-12-25&quot;,</span></span><br><span class="line"><span class="string">      &quot;sellout&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;aArea&quot;: 10,</span></span><br><span class="line"><span class="string">        &quot;bArea&quot;: 10,</span></span><br><span class="line"><span class="string">        &quot;cArea&quot;: 10,</span></span><br><span class="line"><span class="string">        &quot;dArea&quot;: 10</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;date&quot;: &quot;2022-12-16&quot;,</span></span><br><span class="line"><span class="string">      &quot;sellout&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;aArea&quot;: 10,</span></span><br><span class="line"><span class="string">        &quot;bArea&quot;: 10,</span></span><br><span class="line"><span class="string">        &quot;cArea&quot;: 10,</span></span><br><span class="line"><span class="string">        &quot;dArea&quot;: 10</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dbJSONAry</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$dbJSONStr</span>, <span class="literal">true</span>); <span class="comment">//對 php 來說 json 是 string，轉成 array 才能用 php 做資料處理</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/json&quot;</span>); <span class="comment">//將網頁的內容型別切成 json，讓瀏覽器知道這是 json 不是 string</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$dbJSONAry</span>); <span class="comment">//將 php 的經修改的 array 以 json(string) 方式顯示。</span></span><br></pre></td></tr></table></figure>

<p>目前為止若從瀏覽器上的 network 與 console 沒有錯誤且畫面正常運作。代表你已成功將靜態資料從固定檔案變成 php 編譯檔案。接下來要將此固定資料整理成動態資料。</p>
<ul>
<li>初始空陣列為<code>$pallet</code>，利用 foreach 將每筆 row 塞入至指定處。</li>
<li>總計數量除了慢慢加，也可以利用 array_column 與 array_sum 方式算出，再存入<code>$pallet</code>指定處。</li>
<li>最後存入到已轉為 json array，最後更新輸出。</li>
<li>檢查前台是否如期已動態更新。</li>
</ul>
<figure class="highlight php"><figcaption><span>db.json.php</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// pallet start</span></span><br><span class="line"><span class="variable">$rows</span> = <span class="title function_ invoke__">getPallet</span>(); <span class="comment">//取得</span></span><br><span class="line"><span class="variable">$pallet</span> = []; <span class="comment">//初始</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$rows</span> <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">  <span class="variable">$pallet</span> += [<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>] =&gt; [</span><br><span class="line">    <span class="string">&#x27;total&#x27;</span> =&gt; <span class="variable">$row</span>[<span class="string">&#x27;total&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;normalPrice&#x27;</span> =&gt; <span class="variable">$row</span>[<span class="string">&#x27;normalPrice&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;holidayPrice&#x27;</span> =&gt; <span class="variable">$row</span>[<span class="string">&#x27;holidayPrice&#x27;</span>],</span><br><span class="line">  ]];</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$pallet</span> += [<span class="string">&#x27;count&#x27;</span> =&gt; <span class="title function_ invoke__">array_sum</span>(<span class="title function_ invoke__">array_column</span>(<span class="variable">$rows</span>, <span class="string">&#x27;total&#x27;</span>))]; <span class="comment">//計算 count 的 value</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$dbJSONAry</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$dbJSONStr</span>, <span class="literal">true</span>); </span><br><span class="line"><span class="variable">$dbJSONAry</span>[<span class="string">&#x27;pallet&#x27;</span>] = <span class="variable">$pallet</span>; <span class="comment">//更新指定的值</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/json&quot;</span>); <span class="comment">//將網頁的內容型別切成 json，讓瀏覽器知道這是 json 不是 string</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$dbJSONAry</span>); <span class="comment">//將 php 的經修改的 array 以 json(string) 方式顯示。</span></span><br></pre></td></tr></table></figure>

<h1 id="main-holiday-國定假日"><a href="#main-holiday-國定假日" class="headerlink" title="main-holiday 國定假日"></a>main-holiday 國定假日</h1><p>國定假日會影響房價的計算，也是業者需要的功能之一。需要一個新的資料表存放國定假日，為了好操作維護我們以 textarea 考量去設計而不是 N 個 input:date 慢慢點選。雖簡約但好維護。</p>
<p>與前面相同，從 file 目錄底下找到 main-holiday.html 調整以下動作：</p>
<ul>
<li>建立並放置目錄為於 template&#x2F;main-holiday.php</li>
<li>複製 admin.php 另建立根目錄底下的 holiday.php，並參考分割版型做法。</li>
<li>調整 template&#x2F;header.php 內的 holiday 選單 link。</li>
</ul>
<figure class="highlight html"><figcaption><span>template/header.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;holiday.php&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;sb-nav-link-icon fas fa-tachometer-alt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>國定假日<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>holiday.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/header.php&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">&lt;main&gt;</span><br><span class="line">  <span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/main-holiday.php&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">&lt;/main&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/footer.php&#x27;</span>) <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>main-holiday.php</span></figcaption><table><tr><td class="code"><pre><span class="line">&lt;form <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span> <span class="title">px</span>-4&quot;&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">h1</span> <span class="title">class</span>=&quot;<span class="title">mt</span>-4&quot;&gt;國定假日&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">row</span> <span class="title">row</span>-<span class="title">cols</span>-1 <span class="title">row</span>-<span class="title">cols</span>-<span class="title">sm</span>-2&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">col</span>&quot;&gt;</span></span><br><span class="line"><span class="class">      &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">card</span> <span class="title">mb</span>-4&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">card</span>-<span class="title">header</span>&quot;&gt;2023&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">card</span>-<span class="title">body</span>&quot;&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">floating</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">textarea</span> <span class="title">style</span>=&quot;<span class="title">min</span>-<span class="title">height</span>:20<span class="title">rem</span>&quot; <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot;&gt;&lt;/<span class="title">textarea</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">label</span> <span class="title">for</span>=&quot;<span class="title">floatingTextarea</span>&quot;&gt;<span class="title">Comments</span>&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">      &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">hr</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">text</span>-<span class="title">center</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">secondary</span>&quot; <span class="title">type</span>=&quot;<span class="title">reset</span>&quot;&gt;復原&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">primary</span>&quot; <span class="title">type</span>=&quot;<span class="title">submit</span>&quot;&gt;修改&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="資料建立-2"><a href="#資料建立-2" class="headerlink" title="資料建立"></a>資料建立</h2><p>前往 SQL 管理，建立今年 1 筆測試用資料。從前台 db.json 得知以下資訊：</p>
<figure class="highlight json"><figcaption><span>db.json</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="string">&quot;2023-01-02&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-01-20&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-01-23&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-01-24&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-01-25&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-01-26&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-01-27&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-02-27&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-02-28&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-04-03&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-04-04&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-04-05&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-06-22&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-06-23&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-09-29&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-10-09&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2023-10-10&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;2024-01-01&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>到時候會是以 textarea 讓業者編譯此內容，我們需要以普通的字串來存入資料庫。然而 textarea 支援斷行，所以你可以從 phpmyadmin 去一個個斷行，或改以下指令方式新增。對此建立資料表，以及建立資料參閱 db.json：</p>
<figure class="highlight sql"><figcaption><span>command history</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `project_camp`.`_loki_holiday` ( `id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT , `<span class="keyword">year</span>` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span> , `<span class="type">date</span>` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span> , <span class="keyword">PRIMARY</span> KEY (`id`)) ENGINE <span class="operator">=</span> InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `_loki_holiday` <span class="keyword">VALUES</span> (<span class="keyword">NULL</span>, <span class="string">&#x27;2023&#x27;</span>, <span class="string">&#x27;2023-01-02\r\n2023-01-20\r\n2023-01-23\r\n2023-01-24\r\n2023-01-25\r\n2023-01-26\r\n2023-01-27\r\n2023-02-27\r\n2023-02-28\r\n2023-04-03\r\n2023-04-04\r\n2023-04-05\r\n2023-06-22\r\n2023-06-23\r\n2023-09-29\r\n2023-10-09\r\n2023-10-10&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `_loki_holiday` <span class="keyword">VALUES</span> (<span class="keyword">NULL</span>, <span class="string">&#x27;2024&#x27;</span>, <span class="string">&#x27;2024-01-01&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="資料讀取-2"><a href="#資料讀取-2" class="headerlink" title="資料讀取"></a>資料讀取</h2><p>同樣，讓後台指定頁面可以獲取這些資料的需求。可參考 main-orderList.php 做法。</p>
<h3 id="function-php"><a href="#function-php" class="headerlink" title="function.php"></a>function.php</h3><p>這裡規劃新的 getHoliday() 使幫助我們能獲取來自 holiday 資料表的所有資料，where 條件為今年分以上。</p>
<ul>
<li>YEAR() 是 mySQL 函式需指定一時間單位，CURRENT_DATE() 也是 mySQL 函式能提供當前日期的時間單位。合併起來就是今年年後。</li>
<li>同上，我們的條件是今年且而後皆要。應該屆時會跑出 1 年份的資料表。</li>
</ul>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHoliday</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;holiday&#x27;</span>, <span class="string">&#x27;year&gt;=YEAR(CURRENT_DATE()) ORDER BY year&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="main-holiday-php"><a href="#main-holiday-php" class="headerlink" title="main-holiday.php"></a>main-holiday.php</h3><p>試著將資料庫整理出畫面所需的 HTML。調整一下 main-holiday.php 使得資料翻新至畫面上：</p>
<figure class="highlight php"><figcaption><span>main-holiday.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$rows</span> = <span class="title function_ invoke__">getHoliday</span>();</span><br><span class="line"><span class="variable">$htmlCode</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$rows</span> <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">  <span class="variable">$htmlCode</span> .= <span class="string">&#x27;</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;col&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;card mb-4&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;div class=&quot;card-header&quot;&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;year&#x27;</span>] . <span class="string">&#x27;&lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;div class=&quot;card-body&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;form-floating&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;textarea style=&quot;min-height:30rem&quot; class=&quot;form-control&quot;&gt;&#x27;</span>.<span class="variable">$row</span>[<span class="string">&#x27;date&#x27;</span>].<span class="string">&#x27;&lt;/textarea&gt;</span></span><br><span class="line"><span class="string">          &lt;label for=&quot;floatingTextarea&quot;&gt;特殊假日&lt;/label&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span> <span class="title">px</span>-4&quot;&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">h1</span> <span class="title">class</span>=&quot;<span class="title">mt</span>-4&quot;&gt;國定假日&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">row</span> <span class="title">row</span>-<span class="title">cols</span>-1 <span class="title">row</span>-<span class="title">cols</span>-<span class="title">sm</span>-3&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;?= $<span class="title">htmlCode</span> ?&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">hr</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">text</span>-<span class="title">center</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">secondary</span>&quot; <span class="title">type</span>=&quot;<span class="title">reset</span>&quot;&gt;復原&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">primary</span>&quot; <span class="title">type</span>=&quot;<span class="title">submit</span>&quot;&gt;修改&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="自動建立年份資料"><a href="#自動建立年份資料" class="headerlink" title="自動建立年份資料"></a>自動建立年份資料</h2><p>目前只有一年份，後台畫面上不太需要讓業者去做手動新增年分。應該是固定今明後年三年份的資料。所以不如直接透過 sql 指令的進階組合，試著請 sql 端自行判斷若指定年份不存在則需要新增空的年份資料筆。缺點就是業者要偶爾登入這個網頁不然 php 不會生成這樣的 SQL 指令。</p>
<p>利用 INSERT SELECT 複合指令來幫助達成具判斷的新增做法，參考指令如下解說：</p>
<ul>
<li>INSERT INTO 指令，但插入的資料不是 VALUE()，而是 SELECT …</li>
<li>SELECT … 是完整語句，我們想選中 2023+3 這個結果作為前者，而 WHERE 某資料結果不存在時才成功會到這裡的 SELECT </li>
<li>此某資料結果不存在的語句則是 (SELECT * FROM)，這裡是最裡面的語句，是否有資料影響到前兩段。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> _loki_holiday (<span class="keyword">year</span>) </span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">  <span class="keyword">YEAR</span>(<span class="built_in">CURRENT_DATE</span>())<span class="operator">+</span><span class="number">3</span> <span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> _loki_holiday <span class="keyword">WHERE</span> <span class="keyword">year</span><span class="operator">=</span><span class="keyword">YEAR</span>(<span class="built_in">CURRENT_DATE</span>())<span class="operator">+</span><span class="number">3</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<ul>
<li>因為我們要今後 3 年份，所以跑 for 迴圈產生此 3 筆邏輯是最簡快的。</li>
<li>另外注意把$i 替換進去，使年份正常流水號 3 組。</li>
<li>然後這指令太複雜了不適合普通的公式化函式重複利用，因此再多做一個 function 名為 query 針對此特殊需求。</li>
</ul>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lokiSQL</span> </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">query</span>(<span class="params"><span class="variable">$sqlCode</span></span>) </span>&#123;  <span class="comment">//提供資料表完整 SQL 語句語句，能操作 SQL</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sqlCode</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHoliday</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INSERT INTO _loki_holiday (year) SELECT YEAR(CURRENT_DATE())+3 WHERE NOT EXISTS (SELECT * FROM _loki_holiday WHERE year=YEAR(CURRENT_DATE())+3)</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">3</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$checkYear</span> = <span class="string">&#x27;INSERT INTO _loki_holiday (year) SELECT YEAR(CURRENT_DATE())+&#x27;</span> . <span class="variable">$i</span> . <span class="string">&#x27; WHERE NOT EXISTS (SELECT * FROM _loki_holiday WHERE year=YEAR(CURRENT_DATE())+&#x27;</span> . <span class="variable">$i</span> . <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">    <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$checkYear</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;holiday&#x27;</span>, <span class="string">&#x27;year&gt;=YEAR(CURRENT_DATE()) ORDER BY year&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="修改資料-1"><a href="#修改資料-1" class="headerlink" title="修改資料"></a>修改資料</h2><p>目前階段將進行後台的修改提交動作，與前面 pallet 設計大同小異，僅要注意的是前面是數字這裡是字串，因此需要特別增加跳脫字元<code>\</code>來追加<code>&#39;</code>單引符號。而 textarea 本身的斷行會自處理不用管理。</p>
<ul>
<li>form 表單本身提交位置到 function.php?do&#x3D;mdyHoliday</li>
<li>與前面 pallet 做法相同，以陣列方式命名 HTML 元素之 name 屬性。並 hidden id 值提交，後端處理時以 id 陣列跑出 index 再跨 date 陣列。</li>
<li>同樣這裡會跑 3 次 SQL，因此是否成功可以用 flag 機制判斷。最後若都順利將進行重新導向。</li>
</ul>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHoliday</span>(<span class="params"><span class="variable">$id</span>, <span class="variable">$set</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">update</span>(<span class="string">&#x27;holiday&#x27;</span>, <span class="variable">$set</span>, <span class="string">&#x27;id=&#x27;</span> . <span class="variable">$id</span>)-&gt;queryString;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// api todo</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>]) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;mdyHoliday&#x27;</span>:</span><br><span class="line">      <span class="comment">// print_r($_POST);</span></span><br><span class="line">      <span class="variable">$flag</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="variable">$setStr</span> = <span class="string">&#x27;date=\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;date&#x27;</span>][<span class="variable">$key</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">updateHoliday</span>(<span class="variable">$value</span>, <span class="variable">$setStr</span>)) <span class="variable">$flag</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable">$flag</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location:holiday.php&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><figcaption><span>main-holiday.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$rows</span> = <span class="title function_ invoke__">getHoliday</span>();</span><br><span class="line"><span class="variable">$htmlCode</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$rows</span> <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">  <span class="variable">$htmlCode</span> .= <span class="string">&#x27;</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;col&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;card mb-4&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;div class=&quot;card-header&quot;&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;year&#x27;</span>] . <span class="string">&#x27;&lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;div class=&quot;card-body&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;form-floating&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;input type=&quot;hidden&quot; name=&quot;id[]&quot; value=&quot;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>] . <span class="string">&#x27;&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;textarea name=&quot;date[]&quot; style=&quot;min-height:30rem&quot; class=&quot;form-control&quot;&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;date&#x27;</span>] . <span class="string">&#x27;&lt;/textarea&gt;</span></span><br><span class="line"><span class="string">          &lt;label for=&quot;floatingTextarea&quot;&gt;特殊假日&lt;/label&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span> <span class="title">px</span>-4&quot; <span class="title">method</span>=&quot;<span class="title">post</span>&quot; <span class="title">action</span>=&quot;<span class="title">function</span>.<span class="title">php</span>?<span class="title">do</span>=<span class="title">mdyHoliday</span>&quot;&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">h1</span> <span class="title">class</span>=&quot;<span class="title">mt</span>-4&quot;&gt;國定假日&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">row</span> <span class="title">row</span>-<span class="title">cols</span>-1 <span class="title">row</span>-<span class="title">cols</span>-<span class="title">sm</span>-3&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;?= $<span class="title">htmlCode</span> ?&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">hr</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">text</span>-<span class="title">center</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">secondary</span>&quot; <span class="title">type</span>=&quot;<span class="title">reset</span>&quot;&gt;復原&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">primary</span>&quot; <span class="title">type</span>=&quot;<span class="title">submit</span>&quot;&gt;修改&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="前台資料-1"><a href="#前台資料-1" class="headerlink" title="前台資料"></a>前台資料</h2><p>回到 db.json.php 這裡，試圖能產生原本的所需的 holiday 陣列內容。特別要注意的是將 textarea 的文字轉陣列之前，需將特殊字元做判讀。可利用雙引號使 php 理解。並將此三年份的陣列合併顯示。</p>
<figure class="highlight php"><figcaption><span>db.json.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// pallet data</span></span><br><span class="line"><span class="variable">$rows</span> = <span class="title function_ invoke__">getPallet</span>();</span><br><span class="line"><span class="variable">$pallet</span> = [];</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$rows</span> <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">  <span class="variable">$pallet</span> += [<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>] =&gt; [</span><br><span class="line">    <span class="string">&#x27;total&#x27;</span> =&gt; <span class="variable">$row</span>[<span class="string">&#x27;total&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;normalPrice&#x27;</span> =&gt; <span class="variable">$row</span>[<span class="string">&#x27;normalPrice&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;holidayPrice&#x27;</span> =&gt; <span class="variable">$row</span>[<span class="string">&#x27;holidayPrice&#x27;</span>],</span><br><span class="line">  ]];</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$pallet</span> += [<span class="string">&#x27;count&#x27;</span> =&gt; <span class="title function_ invoke__">array_sum</span>(<span class="title function_ invoke__">array_column</span>(<span class="variable">$rows</span>, <span class="string">&#x27;total&#x27;</span>))];</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////// holiday data</span></span><br><span class="line"><span class="variable">$rows</span> = <span class="title function_ invoke__">getHoliday</span>(); <span class="comment">//取得</span></span><br><span class="line"><span class="variable">$nationalHoliday</span> = [];</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$rows</span> <span class="keyword">as</span> <span class="variable">$row</span>) <span class="variable">$nationalHoliday</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$nationalHoliday</span>, <span class="title function_ invoke__">explode</span>(<span class="string">&quot;\r\n&quot;</span>, <span class="variable">$row</span>[<span class="string">&#x27;date&#x27;</span>]));</span><br><span class="line"><span class="comment">/* PHP 中的單引號表示“不解析此字符串”。它們被視為文字（不是換行符和回車符，而是實際的文字“\n\r”）。</span></span><br><span class="line"><span class="comment">* 使用雙引號意味著“解析這個字符串”，因此您的控製字符將被解析。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//overwrite to json</span></span><br><span class="line"><span class="variable">$dbJSONAry</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$dbJSONStr</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//each data overwrite</span></span><br><span class="line"><span class="variable">$dbJSONAry</span>[<span class="string">&#x27;pallet&#x27;</span>] = <span class="variable">$pallet</span>; <span class="comment">//更新指定的值</span></span><br><span class="line"><span class="variable">$dbJSONAry</span>[<span class="string">&#x27;nationalHoliday&#x27;</span>] = <span class="variable">$nationalHoliday</span>; <span class="comment">//更新指定的值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//show on page</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/json&quot;</span>); <span class="comment">//將網頁的內容型別切成 json，讓瀏覽器知道這是 json 不是 string</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$dbJSONAry</span>); <span class="comment">//將 php 的經修改的 array 以 json(string) 方式顯示。</span></span><br></pre></td></tr></table></figure>

<h2 id="計算價格"><a href="#計算價格" class="headerlink" title="計算價格"></a>計算價格</h2><p>資料庫目前已具備了假日參數與營位價格參數，足以修正先前的訂單資料之中的價格統計。這裡需要回頭找到原先在新訂單生成時，針對實際價格進行統計列入資料庫儲存。</p>
<h3 id="修改新訂單之處理"><a href="#修改新訂單之處理" class="headerlink" title="修改新訂單之處理"></a>修改新訂單之處理</h3><p>我們需要回到 function.php 之<code>switch case &#39;newOrder&#39;</code>部分，重新整理於提交 sqlcode 之前的動作：</p>
<ul>
<li>將 selectDate 與 sellout 的陣列準備好為 selectDateAry 與 selloutAry。</li>
<li>selectDateAry 會存放訂單的日期，我們需要批次去檢查這些購買的日期是否為假日。</li>
<li>要判斷是否為假日，除了透過<code>date(&quot;D&quot;)</code>判斷是否為 SAT 或 SUN，也需要從資料庫 holiday 去比對。</li>
<li>holiday 的資料為 string，需要透過 explode 轉換為陣列，而<code>\r\n</code>為斷行符號，利用雙引號使 PHP 理解為需解析含有意義的 string。</li>
<li>selloutAry 是指定營位與數量，確認好假日或平日時，進行數字總和。</li>
<li>營位參數在資料庫內需取回，取回時可以整理成我們好對應找到的特殊陣列 palletAry。</li>
</ul>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;newOrder&#x27;</span>:</span><br><span class="line">  <span class="variable">$selectDateAry</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;selectDate&#x27;</span>]);</span><br><span class="line">  <span class="variable">$selectDateZip</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$selectDateAry</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable">$selloutAry</span> = <span class="title function_ invoke__">array_filter</span>(<span class="title function_ invoke__">json_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;sellout&#x27;</span>], <span class="literal">true</span>), function (<span class="variable">$v</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$v</span> !== <span class="number">0</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable">$selloutZip</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$selloutAry</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//計算價格</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  Array</span></span><br><span class="line"><span class="comment">  (</span></span><br><span class="line"><span class="comment">      [userName] =&gt; 213</span></span><br><span class="line"><span class="comment">      [userPhone] =&gt; 123123</span></span><br><span class="line"><span class="comment">      [userMail] =&gt; 123123@123</span></span><br><span class="line"><span class="comment">      [selectDate] =&gt; [&quot;2023-02-21&quot;]</span></span><br><span class="line"><span class="comment">      [sellout] =&gt; &#123;&quot;aArea&quot;:2,&quot;bArea&quot;:0,&quot;cArea&quot;:0,&quot;dArea&quot;:0&#125;</span></span><br><span class="line"><span class="comment">  )</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$sum</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable">$palletAry</span> = [];</span><br><span class="line">  <span class="comment">// $rows = getPallet();</span></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="title function_ invoke__">getPallet</span>() <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">    <span class="variable">$palletAry</span>[<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>]][<span class="string">&#x27;normalPrice&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;normalPrice&#x27;</span>];</span><br><span class="line">    <span class="variable">$palletAry</span>[<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>]][<span class="string">&#x27;holidayPrice&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;holidayPrice&#x27;</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// $rows = getHoliday();</span></span><br><span class="line">  <span class="variable">$holidayAry</span> = [];</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="title function_ invoke__">getHoliday</span>() <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">    <span class="variable">$holidayAry</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$holidayAry</span>, <span class="title function_ invoke__">explode</span>(<span class="string">&quot;\r\n&quot;</span>, <span class="variable">$row</span>[<span class="string">&#x27;date&#x27;</span>]));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$selectDateAry</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123;</span><br><span class="line">    <span class="variable">$day</span> = <span class="title function_ invoke__">date</span>(<span class="string">&quot;D&quot;</span>, <span class="title function_ invoke__">strtotime</span>(<span class="variable">$value</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if ($day == &#x27;Sat&#x27; || $day == &#x27;Sun&#x27; || in_array($value, $holidayAry)) &#123;</span></span><br><span class="line">    <span class="comment">//   //is holiday!!</span></span><br><span class="line">    <span class="comment">// &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//   //is normal day!!</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$keyword</span> = <span class="variable">$day</span> == <span class="string">&#x27;Sat&#x27;</span> || <span class="variable">$day</span> == <span class="string">&#x27;Sun&#x27;</span> || <span class="title function_ invoke__">in_array</span>(<span class="variable">$value</span>, <span class="variable">$holidayAry</span>) ? <span class="string">&#x27;holidayPrice&#x27;</span> : <span class="string">&#x27;normalPrice&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$selloutAry</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">      <span class="variable">$sum</span> += <span class="variable">$palletAry</span>[<span class="variable">$key</span>][<span class="variable">$keyword</span>] * <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$sqlCode</span> = [<span class="string">&#x27;null&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userName&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userPhone&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userMail&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$selectDateZip</span> . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$selloutZip</span> . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;NOW()&#x27;</span>, <span class="variable">$sum</span>, <span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">saveOrder</span>(<span class="variable">$sqlCode</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/json&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&#x27;STATE&#x27;</span> =&gt; <span class="string">&#x27;DONE&#x27;</span>]); <span class="comment">//最後要回應給前端一個 json 被捕獲。</span></span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&#x27;SQL FAIL&#x27;</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<h1 id="每日房況"><a href="#每日房況" class="headerlink" title="每日房況"></a>每日房況</h1><p>同樣利用 dataTables 快速建立所需的功能表格。主要是顯示今日起始之後的房況資訊。</p>
<p>與前面相同，從 file 目錄底下找到 main-daily.html 調整以下動作：</p>
<ul>
<li>建立並放置目錄為於 template&#x2F;main-daily.php</li>
<li>複製 admin.php 另建立根目錄底下的 daily.php，並參考分割版型做法。</li>
<li>調整 template&#x2F;header.php 內的 holiday 選單 link。</li>
</ul>
<figure class="highlight html"><figcaption><span>template/header.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;daily.php&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;sb-nav-link-icon fas fa-tachometer-alt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>每日房況<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>daily.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/header.php&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">&lt;main&gt;</span><br><span class="line">  <span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/main-daily.php&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">&lt;/main&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include_once</span>(<span class="string">&#x27;template/footer.php&#x27;</span>) <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>main-daily.php</span></figcaption><table><tr><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span> <span class="title">px</span>-4&quot;&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">h1</span> <span class="title">class</span>=&quot;<span class="title">mt</span>-4&quot;&gt;每日房況&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">card</span> <span class="title">mb</span>-4&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">card</span>-<span class="title">body</span>&quot;&gt;</span></span><br><span class="line"><span class="class">      &lt;<span class="title">table</span> <span class="title">id</span>=&quot;<span class="title">orderTable</span>&quot; <span class="title">class</span>=&quot;<span class="title">table</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;日期&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">rounded</span>-<span class="title">pill</span> <span class="title">bg</span>-<span class="title">danger</span> <span class="title">me</span>-1&quot;&gt;<span class="title">A</span> 區 <span class="title">x10</span>&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">rounded</span>-<span class="title">pill</span> <span class="title">bg</span>-<span class="title">warning</span> <span class="title">me</span>-1&quot;&gt;<span class="title">B</span> 區 <span class="title">x10</span>&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">rounded</span>-<span class="title">pill</span> <span class="title">bg</span>-<span class="title">success</span> <span class="title">me</span>-1&quot;&gt;<span class="title">C</span> 區 <span class="title">x10</span>&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">rounded</span>-<span class="title">pill</span> <span class="title">bg</span>-<span class="title">info</span> <span class="title">me</span>-1&quot;&gt;<span class="title">D</span> 區 <span class="title">x10</span>&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;營業額&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">bg</span>-<span class="title">secondary</span> <span class="title">me</span>-1&quot;&gt;2023/02/01&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;1&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;2&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;3&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;4&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;1000&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">bg</span>-<span class="title">secondary</span> <span class="title">me</span>-1&quot;&gt;2023/02/02&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;2&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;3&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;4&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;5&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;2000&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">bg</span>-<span class="title">secondary</span> <span class="title">me</span>-1&quot;&gt;2023/02/03&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;1&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;2&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;9999&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="class">      &lt;/<span class="title">table</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="資料建立-3"><a href="#資料建立-3" class="headerlink" title="資料建立"></a>資料建立</h2><p>前往 SQL 管理，參考訂單狀況試著計算出已存在的未來入住訂單之數量，並根據 db.json 的格式設計出 DB 固定欄位：</p>
<figure class="highlight json"><figcaption><span>db.json</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;booked&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-12-12&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sellout&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;aArea&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;bArea&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cArea&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dArea&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>因此我們必須存 5 筆資訊，這些數字代表已賣出的數量。屆時也得提供前端前台可以正常推算出可訂購數。後台部分則另規劃視覺化表格。SQL 快速指令如下：</p>
<figure class="highlight sql"><figcaption><span>command history</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `project_camp`.`_loki_daily_state` (</span><br><span class="line">  `id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `<span class="type">date</span>` <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `aArea` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `bArea` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `cArea` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `dArea` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `_loki_daily_state` (`id`, `<span class="type">date</span>`, `aArea`, `bArea`, `cArea`, `dArea`)</span><br><span class="line"><span class="keyword">VALUES</span> </span><br><span class="line">  (<span class="keyword">NULL</span>, <span class="string">&#x27;2023-02-21&#x27;</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">  (<span class="keyword">NULL</span>, <span class="string">&#x27;2023-02-22&#x27;</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>),</span><br><span class="line">  (<span class="keyword">NULL</span>, <span class="string">&#x27;2023-02-23&#x27;</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>),</span><br><span class="line">  (<span class="keyword">NULL</span>, <span class="string">&#x27;2023-02-24&#x27;</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<h2 id="資料讀取-3"><a href="#資料讀取-3" class="headerlink" title="資料讀取"></a>資料讀取</h2><p>同樣，讓後台指定頁面可以獲取這些資料的需求。可參考 main-orderList.php 做法。</p>
<h3 id="function-php-1"><a href="#function-php-1" class="headerlink" title="function.php"></a>function.php</h3><p>這裡規劃新的 getDaily_table() 使幫助我們能獲取來自 daily 整體 table 資料表的所有資料，因此所有的資料整理都會在 function.php 內完成，使得後台 php 只需要請求 getDaily_table() 而不用管理運算。參考後台畫面我們需要除了每日的四組已銷售量，還需要判斷日期是否假日，以及計算當日的營業額。</p>
<h4 id="前置資源"><a href="#前置資源" class="headerlink" title="前置資源"></a>前置資源</h4><p>我們需要以下的資源備妥，部分已經存在之外，有些需要為此新增。</p>
<ul>
<li>getDaily : 獲取每日的四組營位的已售量。</li>
<li>getPallet: 已存在，要獲取四組營位數上限，以及價格資訊。</li>
<li>checkHoliday : 規劃小函式，可以判斷該日期是否為假日或國定日。</li>
<li></li>
</ul>
<h5 id="getDaily"><a href="#getDaily" class="headerlink" title="getDaily()"></a>getDaily()</h5><p>從資料獲取銷售數量。可參考先前 getHoliday() 的做法，當時是獲取今年之後的 sql 資料，而我們要拿取的會是今日之後（房況只需顯示未來的日子）。</p>
<ul>
<li>DATE() 是 mySQL 函式需指定一時間單位，CURRENT_DATE() 也是 mySQL 函式能提供當前日期的時間單位。合併起來就是今日之後。</li>
<li>同上，我們的條件是今年且而後皆要。應該屆時會跑出今天之後的資料表。可以先在 SQL 管理上測試指令是否如預期顯現（添加舊日期測試是否過濾）。</li>
</ul>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDaily</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;daily_state&#x27;</span>, <span class="string">&#x27;date&gt;=DATE(CURRENT_DATE()) ORDER BY date&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="checkHoliday"><a href="#checkHoliday" class="headerlink" title="checkHoliday()"></a>checkHoliday()</h5><p>稍早在新增訂單設計那裏已經有類似的計算。我們可以整理出來變成 checkHoliday()，這樣在新增訂單以及每日房況都能共用此函式。</p>
<ul>
<li>複製參考 <code>case &#39;newOrder&#39;:</code> 日期判斷作法，規劃到 function.php 形成 checkHoliday($date) 回傳 boolean 值。</li>
<li>完成後調整該原處的寫法，而改使用 checkHoliday($date) 方式。</li>
</ul>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkHoliday</span>(<span class="params"><span class="variable">$date</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$holidayAry</span> = [];</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="title function_ invoke__">getHoliday</span>() <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">    <span class="variable">$holidayAry</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$holidayAry</span>, <span class="title function_ invoke__">explode</span>(<span class="string">&quot;\r\n&quot;</span>, <span class="variable">$row</span>[<span class="string">&#x27;date&#x27;</span>]));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$day</span> = <span class="title function_ invoke__">date</span>(<span class="string">&quot;D&quot;</span>, <span class="title function_ invoke__">strtotime</span>(<span class="variable">$date</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$day</span> == <span class="string">&#x27;Sat&#x27;</span> || <span class="variable">$day</span> == <span class="string">&#x27;SUN&#x27;</span> || <span class="title function_ invoke__">in_array</span>(<span class="variable">$date</span>, <span class="variable">$holidayAry</span>) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;newOrder&#x27;</span>:</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">foreach</span> (<span class="variable">$selectDateAry</span> <span class="keyword">as</span> <span class="variable">$date</span>) &#123; <span class="comment">//原$value 改$date 避免混淆下層 foreach</span></span><br><span class="line">        <span class="comment">// $day = date(&quot;D&quot;, strtotime($value));</span></span><br><span class="line">        <span class="comment">// $keyword = $day == &#x27;Sat&#x27; || $day == &#x27;Sun&#x27; || in_array($value, $holidayAry) ? &#x27;holidayPrice&#x27; : &#x27;normalPrice&#x27;;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// $keyword = checkHoliday($value) ? &#x27;holidayPrice&#x27; : &#x27;normalPrice&#x27;;</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$selloutAry</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)</span><br><span class="line">          <span class="comment">// $sum += $palletAry[$key][$keyword] * $value;</span></span><br><span class="line">          <span class="variable">$sum</span> += <span class="variable">$palletAry</span>[<span class="variable">$key</span>][<span class="title function_ invoke__">checkHoliday</span>(<span class="variable">$date</span>) ? <span class="string">&#x27;holidayPrice&#x27;</span> : <span class="string">&#x27;normalPrice&#x27;</span>] * <span class="variable">$value</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="完整資料合併整理"><a href="#完整資料合併整理" class="headerlink" title="完整資料合併整理"></a>完整資料合併整理</h4><p>整合前置準備，開始準備所需資料，透過 getDaily_table() 全部完成後，後台畫面只需提取匯入 html 即可。其中所需要的 DB 資料各自用變數存放。</p>
<ul>
<li>由於$palletDB 內的資料需要整理且規劃 index 方便找到，使用$namePrice 將<code>$palletDB[$row][&#39;name&#39;]</code>當 key，而 value 則用小陣列存放兩種價格。</li>
<li>table header 需要營位總數，利用 array_column 快速取出。</li>
<li>table body 部分，透過原本的 dailyDB 進行增添，這裡採用 array_map 方式試圖累加 <code>(holiday=&gt;boolean)</code>與<code>(total=&gt;number)</code>。</li>
<li>同上，由於匿名函式捕獲不到外面的變數，因此利用 use 來加載。</li>
<li>checkHoliday() 提供日期字串會回傳 boolean 值來告知是否為假日。若我們要轉為 int 可以對其結果前增加<code>+</code>符號。</li>
<li>將這些（數量 x 價格）組合出來即可，其中價格利用數字 0 或 1 快速找到<code>$namePrice</code>指定欄位的數字。</li>
<li>最後別忘了將這兩個變數傳出函式。</li>
</ul>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDaily_table</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$dailyDB</span> = <span class="title function_ invoke__">getDaily</span>();</span><br><span class="line">  <span class="variable">$palletDB</span> = <span class="title function_ invoke__">getPallet</span>();</span><br><span class="line">  <span class="variable">$namePrice</span> = [];</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$palletDB</span> <span class="keyword">as</span> <span class="variable">$row</span>)</span><br><span class="line">    <span class="variable">$namePrice</span>[<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>]] = [<span class="variable">$row</span>[<span class="string">&#x27;normalPrice&#x27;</span>], <span class="variable">$row</span>[<span class="string">&#x27;holidayPrice&#x27;</span>]];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// print_r($namePrice);</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$table_head</span> = <span class="title function_ invoke__">array_column</span>(<span class="variable">$palletDB</span>, <span class="string">&#x27;total&#x27;</span>);</span><br><span class="line">  <span class="variable">$table_body</span> = <span class="title function_ invoke__">array_map</span>(function (<span class="variable">$row</span>) <span class="keyword">use</span> ($<span class="title">namePrice</span>) &#123;</span><br><span class="line">    $<span class="title">row</span>[&#x27;<span class="title">holiday</span>&#x27;] = <span class="title">checkHoliday</span>($<span class="title">row</span>[&#x27;<span class="title">date</span>&#x27;]);</span><br><span class="line">    <span class="comment">// $price = +checkHoliday($row[&#x27;date&#x27;]);</span></span><br><span class="line">    <span class="variable">$row</span>[<span class="string">&#x27;total&#x27;</span>] =</span><br><span class="line">      <span class="variable">$row</span>[<span class="string">&#x27;aArea&#x27;</span>] * <span class="variable">$namePrice</span>[<span class="string">&#x27;aArea&#x27;</span>][+<span class="variable">$row</span>[<span class="string">&#x27;holiday&#x27;</span>]] +</span><br><span class="line">      <span class="variable">$row</span>[<span class="string">&#x27;bArea&#x27;</span>] * <span class="variable">$namePrice</span>[<span class="string">&#x27;bArea&#x27;</span>][+<span class="variable">$row</span>[<span class="string">&#x27;holiday&#x27;</span>]] +</span><br><span class="line">      <span class="variable">$row</span>[<span class="string">&#x27;cArea&#x27;</span>] * <span class="variable">$namePrice</span>[<span class="string">&#x27;cArea&#x27;</span>][+<span class="variable">$row</span>[<span class="string">&#x27;holiday&#x27;</span>]] +</span><br><span class="line">      <span class="variable">$row</span>[<span class="string">&#x27;dArea&#x27;</span>] * <span class="variable">$namePrice</span>[<span class="string">&#x27;dArea&#x27;</span>][+<span class="variable">$row</span>[<span class="string">&#x27;holiday&#x27;</span>]];</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$row</span>;</span><br><span class="line">  &#125;, <span class="variable">$dailyDB</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [<span class="variable">$table_head</span>, <span class="variable">$table_body</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="main-daily-php"><a href="#main-daily-php" class="headerlink" title="main-daily.php"></a>main-daily.php</h3><p>經過處理過的資料，在後台呈現上就很好處理，只需要對應好 table header 與 body 的字串轉換即可。唯獨注意的 body 內的 class 所採用的三元判別需優先處理。</p>
<figure class="highlight php"><figcaption><span>main-daily.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">getDaily_table</span>();</span><br><span class="line"><span class="variable">$htmlCode</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$data</span>[<span class="number">1</span>] <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">  <span class="variable">$htmlCode</span> .= <span class="string">&#x27;&lt;tr&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&lt;span class=&quot;badge bg-&#x27;</span> . (<span class="variable">$row</span>[<span class="string">&#x27;holiday&#x27;</span>] ? <span class="string">&#x27;danger&#x27;</span> : <span class="string">&#x27;secondary&#x27;</span>) . <span class="string">&#x27; me-1&quot;&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;date&#x27;</span>] . <span class="string">&#x27;&lt;/span&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;aArea&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;bArea&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;cArea&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;dArea&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;total&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;/tr&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span> <span class="title">px</span>-4&quot;&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">h1</span> <span class="title">class</span>=&quot;<span class="title">mt</span>-4&quot;&gt;每日房況&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">card</span> <span class="title">mb</span>-4&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">card</span>-<span class="title">body</span>&quot;&gt;</span></span><br><span class="line"><span class="class">      &lt;<span class="title">table</span> <span class="title">id</span>=&quot;<span class="title">orderTable</span>&quot; <span class="title">class</span>=&quot;<span class="title">table</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;日期&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">rounded</span>-<span class="title">pill</span> <span class="title">bg</span>-<span class="title">danger</span> <span class="title">me</span>-1&quot;&gt;<span class="title">A</span> 區 <span class="title">x</span> &lt;?= $<span class="title">data</span>[0][0] ?&gt;&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">rounded</span>-<span class="title">pill</span> <span class="title">bg</span>-<span class="title">warning</span> <span class="title">me</span>-1&quot;&gt;<span class="title">B</span> 區 <span class="title">x</span> &lt;?= $<span class="title">data</span>[0][1] ?&gt;&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">rounded</span>-<span class="title">pill</span> <span class="title">bg</span>-<span class="title">success</span> <span class="title">me</span>-1&quot;&gt;<span class="title">C</span> 區 <span class="title">x</span> &lt;?= $<span class="title">data</span>[0][2] ?&gt;&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">rounded</span>-<span class="title">pill</span> <span class="title">bg</span>-<span class="title">info</span> <span class="title">me</span>-1&quot;&gt;<span class="title">D</span> 區 <span class="title">x</span> &lt;?= $<span class="title">data</span>[0][3] ?&gt;&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">th</span>&gt;營業額&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;?= $<span class="title">htmlCode</span> ?&gt;</span></span><br><span class="line"><span class="class">          &lt;!-- &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">bg</span>-<span class="title">danger</span> <span class="title">me</span>-1&quot;&gt;2023/02/01&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;1&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;2&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;3&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;4&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;1000&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">bg</span>-<span class="title">secondary</span> <span class="title">me</span>-1&quot;&gt;2023/02/02&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;2&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;3&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;4&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;5&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;2000&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">badge</span> <span class="title">bg</span>-<span class="title">secondary</span> <span class="title">me</span>-1&quot;&gt;2023/02/03&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;1&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;2&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">td</span>&gt;9999&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;/<span class="title">tr</span>&gt; --&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="class">      &lt;/<span class="title">table</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="資料寫入-1"><a href="#資料寫入-1" class="headerlink" title="資料寫入"></a>資料寫入</h2><p>此時隨著訂單生成時，後台只會成功訂單資料，不會更新到此每日房況。寫入該資料庫_loki_daily_status 的時機為每次新增訂單下，除了原本對_loki_order_list 進行 INSERT 外，也要對_loki_daily_state 變化。</p>
<p>先將原本的 newOrder 做一下順序整理與註解，方便思考修整：</p>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;newOrder&#x27;</span>:</span><br><span class="line">  <span class="comment">// 前端 payload 資料 </span></span><br><span class="line">  <span class="comment">// userName: 假日測試</span></span><br><span class="line">  <span class="comment">// userPhone: 555</span></span><br><span class="line">  <span class="comment">// userMail: 555@55</span></span><br><span class="line">  <span class="comment">// selectDate: [&quot;2023-02-25&quot;,&quot;2023-02-26&quot;,&quot;2023-02-27&quot;]</span></span><br><span class="line">  <span class="comment">// sellout: &#123;&quot;aArea&quot;:0,&quot;bArea&quot;:0,&quot;cArea&quot;:2,&quot;dArea&quot;:0&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$selectDateAry</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;selectDate&#x27;</span>]); <span class="comment">//日期陣列</span></span><br><span class="line">  <span class="variable">$selloutAry</span> = <span class="title function_ invoke__">array_filter</span>(<span class="title function_ invoke__">json_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;sellout&#x27;</span>], <span class="literal">true</span>), function (<span class="variable">$v</span>) &#123; <span class="comment">//購買陣列 </span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$v</span> !== <span class="number">0</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 設計價目表</span></span><br><span class="line">  <span class="variable">$palletAry</span> = [];</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="title function_ invoke__">getPallet</span>() <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">    <span class="variable">$palletAry</span>[<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>]][<span class="string">&#x27;normalPrice&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;normalPrice&#x27;</span>];</span><br><span class="line">    <span class="variable">$palletAry</span>[<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>]][<span class="string">&#x27;holidayPrice&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;holidayPrice&#x27;</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$sum</span> = <span class="number">0</span>;　<span class="comment">//總價計算之前置準備</span></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$selectDateAry</span> <span class="keyword">as</span> <span class="variable">$date</span>) &#123;</span><br><span class="line">    <span class="comment">// 訂單上拆出每個日子之範圍</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$selloutAry</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)</span><br><span class="line">      <span class="comment">// 每日每營位的總價疊加</span></span><br><span class="line">      <span class="variable">$sum</span> += <span class="variable">$palletAry</span>[<span class="variable">$key</span>][<span class="title function_ invoke__">checkHoliday</span>(<span class="variable">$date</span>) ? <span class="string">&#x27;holidayPrice&#x27;</span> : <span class="string">&#x27;normalPrice&#x27;</span>] * <span class="variable">$value</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//訂單資料</span></span><br><span class="line">  <span class="variable">$selectDateZip</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$selectDateAry</span>); <span class="comment">//提交用</span></span><br><span class="line">  <span class="variable">$selloutZip</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$selloutAry</span>); <span class="comment">//提交用</span></span><br><span class="line">  <span class="variable">$sqlCode</span> = [<span class="string">&#x27;null&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userName&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userPhone&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userMail&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$selectDateZip</span> . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$selloutZip</span> . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;NOW()&#x27;</span>, <span class="variable">$sum</span>, <span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//新增訂單至 SQL</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">saveOrder</span>(<span class="variable">$sqlCode</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/json&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&#x27;STATE&#x27;</span> =&gt; <span class="string">&#x27;DONE&#x27;</span>]); <span class="comment">//最後要回應給前端一個 json 被捕獲。</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&#x27;SQL FAIL&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>找到根據訂單拆分為單一日期來規劃檢查指定日子的工作，首先分為步驟完成以下動作：</p>
<ol>
<li>考量前端的不可信問題<ul>
<li>每個日子的工作階段上。若添加之後會超過營位總數上限，代表此訂單有問題要終止動作。真正寫入訂單的位置是所有日子跑完迴圈後才會執行。因此只要其中一天的指定日有爆掉作停止，整份訂單不會成立。</li>
<li>利用 WHERE 條件我們要找出已售出數加購買數是否超過總數。大致語法為<code>SELECT * FROM </code>_loki_daily_state<code> WHERE date=&#39;2023-02-01&#39; AND (aArea + 9 &gt; 10 OR bArea + 9 &gt; 10)</code>，這能查出指定日是否因追加數而超過上限，如果有回傳結果代表會爆。</li>
<li>利用 implode 將陣列轉為字串，特別注意的是要由於對 selloutAry 陣列取出 key（營位名稱） 跟 value（購買數量），implode 讀不出指定陣列的 key 值，因此需要我們將兩個陣列分別代表 value 的 <code>selloutAry</code> 與代表 key 的 <code>array_keys($selloutAry)</code>，兩者一起轉換。</li>
<li>同上，中介字元為<code>OR</code>，這樣才能生出想要的疊加條件。</li>
<li>同上，由於會使用到$palletAry 在匿名函式之外無法使用到，因此使用 use 方式帶入進來。</li>
<li>最後如果爆掉了，就輸出 FAIL 資訊。透過 exit() 結束 PHP 動作。</li>
</ul>
</li>
<li>指定日期可能還不存在<ul>
<li>透過 SQL 指令與前面出現過的語法雷同，INSERT 指令為：當如果不存在之條件下，這個 INSERT 才會成立。</li>
<li>參考語法為<code>INSERT INTO _loki_daily_state (date) SELECT &#39;2023-03-01&#39; WHERE NOT EXISTS (SELECT * FROM _loki_daily_state WHERE date=&#39;2023-03-01&#39;)</code></li>
</ul>
</li>
<li>翻新該指定日的數量<ul>
<li>透過 UPDATE 指令，對指定的營位數做自我增長。好處就是不用先讀出數字再回存，請 SQL 自己加上即可。</li>
<li>參考語法為<code>UPDATE _loki_daily_state SET aArea = aArea + 1, bArea=bArea+2, cArea=cArea+3 WHERE date = &#39;2023-02-01&#39;</code></li>
<li>做法與第一步差不多，利用 implode 生出 SET 與 WHERE 之間的特別字串。同樣需要 selloutAry 陣列下的$key 跟$value 才能湊出適合的字串。</li>
<li>由於指令特別而先前作的物件函式無法使用，因此改用 query 物件下之函式。送交 SQL 使得每日銷售的統計數翻新。</li>
</ul>
</li>
<li>以上工作完成，就回到原本的訂單生成的工作。</li>
</ol>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;newOrder&#x27;</span>:</span><br><span class="line">  <span class="variable">$selectDateAry</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;selectDate&#x27;</span>]); <span class="comment">//日期陣列</span></span><br><span class="line">  <span class="variable">$selloutAry</span> = <span class="title function_ invoke__">array_filter</span>(<span class="title function_ invoke__">json_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;sellout&#x27;</span>], <span class="literal">true</span>), function (<span class="variable">$v</span>) &#123; <span class="comment">//購買陣列</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$v</span> !== <span class="number">0</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 設計價目表</span></span><br><span class="line">  <span class="variable">$palletAry</span> = [];</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="title function_ invoke__">getPallet</span>() <span class="keyword">as</span> <span class="variable">$row</span>) &#123;</span><br><span class="line">    <span class="variable">$palletAry</span>[<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>]][<span class="string">&#x27;normalPrice&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;normalPrice&#x27;</span>];</span><br><span class="line">    <span class="variable">$palletAry</span>[<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>]][<span class="string">&#x27;holidayPrice&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;holidayPrice&#x27;</span>];</span><br><span class="line">    <span class="variable">$palletAry</span>[<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>]][<span class="string">&#x27;total&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;total&#x27;</span>]; <span class="comment">// 1-1. 追加</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="variable">$sum</span> = <span class="number">0</span>; <span class="comment">//總價計算前置準備</span></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$selectDateAry</span> <span class="keyword">as</span> <span class="variable">$date</span>) &#123;</span><br><span class="line">    <span class="comment">///////// start</span></span><br><span class="line">    <span class="comment">//1. 組合出檢查代碼，如果有結果代表爆掉了，就阻擋建立動作並離開 php</span></span><br><span class="line">    <span class="comment">//SELECT * FROM `_loki_daily_state` WHERE date=&#x27;2023-02-01&#x27; AND (aArea + 9 &gt; 10 OR bArea + 9 &gt; 10)</span></span><br><span class="line">    <span class="variable">$areaCheck</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; OR &#x27;</span>, <span class="title function_ invoke__">array_map</span>(</span><br><span class="line">      function (<span class="variable">$value</span>, <span class="variable">$key</span>) <span class="keyword">use</span> (<span class="variable">$palletAry</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$key</span> . <span class="string">&#x27; + &#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27; &gt; &#x27;</span> . <span class="variable">$palletAry</span>[<span class="variable">$key</span>][<span class="string">&#x27;total&#x27;</span>]; <span class="comment">//aArea + 5 &gt; 10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable">$selloutAry</span>,</span><br><span class="line">      <span class="title function_ invoke__">array_keys</span>(<span class="variable">$selloutAry</span>)</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// $resultCheck = $sql-&gt;select(&#x27;daily_state&#x27;, &#x27;date=&quot;&#x27; . $date . &#x27;&quot; AND (&#x27; . $areaCheck . &#x27;)&#x27;);</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;daily_state&#x27;</span>, <span class="string">&#x27;date=&quot;&#x27;</span> . <span class="variable">$date</span> . <span class="string">&#x27;&quot; AND (&#x27;</span> . <span class="variable">$areaCheck</span> . <span class="string">&#x27;)&#x27;</span>)) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;PALLET FULL&#x27;</span>;</span><br><span class="line">      <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 試著將不存在的日期補足</span></span><br><span class="line">    <span class="comment">// INSERT INTO _loki_daily_state (date) SELECT &#x27;2023-03-01&#x27; WHERE NOT EXISTS (SELECT * FROM _loki_daily_state WHERE date=&#x27;2023-03-01&#x27;)</span></span><br><span class="line">    <span class="variable">$checkYear</span> = <span class="string">&#x27;INSERT INTO _loki_daily_state (date) SELECT &quot;&#x27;</span> . <span class="variable">$date</span> . <span class="string">&#x27;&quot; WHERE NOT EXISTS (SELECT * FROM _loki_daily_state WHERE date=&quot;&#x27;</span> . <span class="variable">$date</span> . <span class="string">&#x27;&quot;)&#x27;</span>;</span><br><span class="line">    <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$checkYear</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 翻新 _loki_daily_state 用，組合出 SET 代碼</span></span><br><span class="line">    <span class="comment">// UPDATE _loki_daily_state SET aArea = aArea + 1, bArea=bArea+2, cArea=cArea+3 WHERE date = &#x27;2023-02-01&#x27;</span></span><br><span class="line">    <span class="variable">$areaUpdate</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="title function_ invoke__">array_map</span>(</span><br><span class="line">      function (<span class="variable">$value</span>, <span class="variable">$key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27; = &#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27; + &#x27;</span> . <span class="variable">$value</span>; //aArea = aArea + <span class="number">1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable">$selloutAry</span>,</span><br><span class="line">      <span class="title function_ invoke__">array_keys</span>(<span class="variable">$selloutAry</span>)</span><br><span class="line">    ));</span><br><span class="line">    <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;UPDATE _loki_daily_state SET &#x27;</span> . <span class="variable">$areaUpdate</span> . <span class="string">&#x27; WHERE date = &quot;&#x27;</span> . <span class="variable">$date</span> . <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">    <span class="comment">///////// end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$selloutAry</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">      <span class="comment">// 每日每營位的總價疊加，value = 數量</span></span><br><span class="line">      <span class="variable">$sum</span> += <span class="variable">$palletAry</span>[<span class="variable">$key</span>][<span class="title function_ invoke__">checkHoliday</span>(<span class="variable">$date</span>) ? <span class="string">&#x27;holidayPrice&#x27;</span> : <span class="string">&#x27;normalPrice&#x27;</span>] * <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//訂單資料</span></span><br><span class="line">  <span class="variable">$selectDateZip</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$selectDateAry</span>); <span class="comment">//提交用</span></span><br><span class="line">  <span class="variable">$selloutZip</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$selloutAry</span>); <span class="comment">//提交用</span></span><br><span class="line">  <span class="variable">$sqlCode</span> = [<span class="string">&#x27;null&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userName&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userPhone&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;userMail&#x27;</span>] . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$selectDateZip</span> . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$selloutZip</span> . <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;NOW()&#x27;</span>, <span class="variable">$sum</span>, <span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//新增訂單至 SQL</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">saveOrder</span>(<span class="variable">$sqlCode</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/json&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&#x27;STATE&#x27;</span> =&gt; <span class="string">&#x27;DONE&#x27;</span>]); <span class="comment">//最後要回應給前端一個 json 被捕獲。</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&#x27;SQL FAIL&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>試著在前台操作訂單建立是否如期更新。</p>
<h2 id="資料回改"><a href="#資料回改" class="headerlink" title="資料回改"></a>資料回改</h2><p>在一個特別情況下，如果後台訂單被刪除，原則上我們要釋放回該訂單原本的購買數量，使得可銷售統計做修正。這處理的地點就落於<code>case &#39;delOrder&#39;:</code>內。所以刪除功能應該只限定尚未過期的單子。這部分也一併考量入可刪除的條件。</p>
<ul>
<li>在後台 html 上，原先只提供 id 進行刪除所需的資料，由於我們需要隊指定日期與營位做扣除銷售值。所以需多增加 date 與 pallet 售出資訊。</li>
<li>同上，可以選擇於 function.php 做這些處理較安全，或者貪快在 main-orderList.php 同畫面上已有這些資訊一併採 GET 方式傳給 function.php 省去此麻煩重新 SQL 捕獲。</li>
</ul>
<figure class="highlight php"><figcaption><span>main-orderList.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="variable">$getAry</span> = [</span><br><span class="line">  <span class="string">&#x27;do&#x27;</span> =&gt; <span class="string">&#x27;delOrder&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;id&#x27;</span> =&gt; <span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>],</span><br><span class="line">  <span class="string">&#x27;date&#x27;</span> =&gt; <span class="variable">$selectDateAry</span>, <span class="comment">//增加</span></span><br><span class="line">  <span class="string">&#x27;pallet&#x27;</span> =&gt; <span class="variable">$selectPalletObj</span> <span class="comment">//增加</span></span><br><span class="line">];</span><br><span class="line"><span class="comment">//這裡可以 string 慢慢湊，或者利用 http_build_query 將 array 轉為 get 參數</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$htmlCode</span> .= <span class="string">&#x27;&lt;tr&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$selectDateStr</span> . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$selectPalletStr</span> . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;price&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;phone&#x27;</span>] . <span class="string">&#x27; | &#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;mail&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;createDate&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&lt;a class=&quot;btn btn-danger btn-sm&quot; href=&quot;function.php?&#x27;</span> . <span class="title function_ invoke__">http_build_query</span>(<span class="variable">$getAry</span>) . <span class="string">&#x27;&quot;&gt;刪除&lt;/a&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;/tr&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>來到 function.php 的<code>delOrder($id)</code>部分，試著在 order_list 軟刪除之前對_loki_daily_state 做 sub 動作：</p>
<ul>
<li>這裡稍早 newOrder 已做過類似行為，只是原本的 add 改成 sub。</li>
<li>另外我們需要對 dateAry 做 foreach 拆成一日一單的更新處理。</li>
<li>當完成 _loki_daily_state update 後才做 order_list update。</li>
</ul>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delOrder</span>(<span class="params"><span class="variable">$id</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// print_r($_GET);</span></span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;date&#x27;</span>] <span class="keyword">as</span> <span class="variable">$date</span>) &#123;</span><br><span class="line">    <span class="comment">// UPDATE _loki_daily_state SET aArea = aArea + 1, bArea=bArea+2, cArea=cArea+3 WHERE date = &#x27;2023-02-01&#x27;</span></span><br><span class="line">    <span class="variable">$areaUpdate</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="title function_ invoke__">array_map</span>(</span><br><span class="line">      function (<span class="variable">$value</span>, <span class="variable">$key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27; = &#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27; - &#x27;</span> . <span class="variable">$value</span>; //aArea = aArea + <span class="number">1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable">$_GET</span>[<span class="string">&#x27;pallet&#x27;</span>],</span><br><span class="line">      <span class="title function_ invoke__">array_keys</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pallet&#x27;</span>])</span><br><span class="line">    ));</span><br><span class="line">    <span class="comment">// echo &#x27;UPDATE _loki_daily_state SET &#x27; . $areaUpdate . &#x27; WHERE date = &quot;&#x27; . $date . &#x27;&quot;&#x27;;</span></span><br><span class="line">    <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;UPDATE _loki_daily_state SET &#x27;</span> . <span class="variable">$areaUpdate</span> . <span class="string">&#x27; WHERE date = &quot;&#x27;</span> . <span class="variable">$date</span> . <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">update</span>(<span class="string">&#x27;order_list&#x27;</span>, <span class="string">&#x27;del=1&#x27;</span>, <span class="string">&#x27;id=&#x27;</span> . <span class="variable">$id</span>)-&gt;queryString;</span><br><span class="line">  <span class="comment">// UPDATE _loki_order_list SET del=1 WHERE id=5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前應已成功工作，試著操作剛新增的 order 做刪除判斷是否取消歸還數量成功。再來是優化一下後台，使得過期單子不給予刪除。</p>
<ul>
<li>考量的是入住日最小值，要從 selectDateAry 來判斷。string 型別的 date 不好判斷大小，因此需要做 strtotime 轉換成可靠的時間搓記再做大小比較。</li>
<li>要比較是陣列中最小的時間 timestamp，而當下的 timestamp 做比較，對象比現在小就是稍早的日子。</li>
<li>顯示對應的 HTML 視覺，就不提供超連結於畫面上了。</li>
</ul>
<figure class="highlight php"><figcaption><span>main-orderList.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="variable">$dateNum</span> = <span class="title function_ invoke__">array_map</span>(function (<span class="variable">$date</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_ invoke__">strtotime</span>(<span class="variable">$date</span>);</span><br><span class="line">&#125;, <span class="variable">$selectDateAry</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$lessDay</span> = <span class="title function_ invoke__">min</span>(<span class="variable">$dateNum</span>) &lt; <span class="title function_ invoke__">time</span>() ?</span><br><span class="line">  <span class="string">&#x27;&lt;span class=&quot;btn btn-secondary btn-sm disabled&quot;&gt;過期&lt;/span&gt;&#x27;</span> :</span><br><span class="line">  <span class="string">&#x27;&lt;a class=&quot;btn btn-danger btn-sm&quot; href=&quot;function.php?&#x27;</span> . <span class="title function_ invoke__">http_build_query</span>(<span class="variable">$getAry</span>) . <span class="string">&#x27;&quot;&gt;刪除&lt;/a&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$htmlCode</span> .= <span class="string">&#x27;&lt;tr&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$selectDateStr</span> . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$selectPalletStr</span> . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;price&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;phone&#x27;</span>] . <span class="string">&#x27; | &#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;mail&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;createDate&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;&#x27;</span> . <span class="variable">$lessDay</span> . <span class="string">&#x27;&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;/tr&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h1 id="帳號登入"><a href="#帳號登入" class="headerlink" title="帳號登入"></a>帳號登入</h1><p>最後一節，我們需要設計一個具備權限登入的後台。使得需透過 login 提交帳號密碼確認身分後，產生 SESSION 快取回傳。一開始我們試著測試 SQL 指令且成功，在資料庫內已存在_loki_user，加以使用不需再做資料建立。</p>
<h2 id="登入頁面到後台"><a href="#登入頁面到後台" class="headerlink" title="登入頁面到後台"></a>登入頁面到後台</h2><p>將 file 目錄下的 login.html 搬移到根目錄上，方便拜訪<code>localhost/login.html</code>能操作登入表單。</p>
<ul>
<li>修改 form 的 action 方式，指向到 function.php?do&#x3D;login，帳密使用 post 方式傳送。</li>
<li>將一開始因測試完畢而註解的 checkUserSaveSession() 再釋放回來。該函式用途為，只要提供帳密就能確認是否帳戶存在並自動存入 session。</li>
<li>同上，因此試圖將提交的 post 轉入該函式內，若成功則轉向到 admin.php</li>
</ul>
<figure class="highlight html"><figcaption><span>login.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;function.php?do=login&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-floating mb-3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inputAccount&quot;</span> <span class="attr">name</span>=<span class="string">&quot;inputAccount&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;name@example.com&quot;</span> <span class="attr">required</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;inputAccount&quot;</span>&gt;</span>Account<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-floating mb-3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inputPassword&quot;</span> <span class="attr">name</span>=<span class="string">&quot;inputPassword&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Password&quot;</span> <span class="attr">required</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;inputPassword&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;d-flex align-items-center justify-content-center mt-4 mb-0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Login&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ... --&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">///////////// custom function</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="keyword">new</span> <span class="title function_ invoke__">lokiSQL</span>();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkUserSaveSession</span>(<span class="params"><span class="variable">$acc</span>, <span class="variable">$pwd</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>])) <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">//如果存在就直接回傳 true，不用再驗證設定 SESSION</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$check</span> = !!<span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;name=&quot;&#x27;</span> . <span class="variable">$acc</span> . <span class="string">&#x27;&quot; AND password=&quot;&#x27;</span> . <span class="variable">$pwd</span> . <span class="string">&#x27;&quot; AND active=1&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$check</span>) <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>] = <span class="variable">$acc</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$check</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// api todo</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>]) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;login&#x27;</span>:</span><br><span class="line">      <span class="comment">// var_dump($_GET, $_POST);</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">checkUserSaveSession</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;inputAccount&#x27;</span>], <span class="variable">$_POST</span>[<span class="string">&#x27;inputPassword&#x27;</span>]))</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location:admin.php&#x27;</span>);</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">exit</span>(<span class="string">&#x27;access deny&#x27;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="後台禁止無登入成功的拜訪"><a href="#後台禁止無登入成功的拜訪" class="headerlink" title="後台禁止無登入成功的拜訪"></a>後台禁止無登入成功的拜訪</h2><p>目前直接拜訪後台任何網頁都能成功，應只有當從 login 獲得 session 綁定的狀態才能允許拜訪，因此找到後台共同持有的 header.php 進行判別即可。（不可規劃到 function.php 內，這會導致前台獲取 json.php 以及新增表單時會失敗拒絕 php 處理）</p>
<figure class="highlight php"><figcaption><span>header.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&quot;./function.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>])) <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location:/&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="登出清除-session"><a href="#登出清除-session" class="headerlink" title="登出清除 session"></a>登出清除 session</h2><p>登出方式只要清除 session 導向回首頁即可。</p>
<figure class="highlight php"><figcaption><span>header.php</span></figcaption><table><tr><td class="code"><pre><span class="line">&lt;li&gt;&lt;a <span class="class"><span class="keyword">class</span>=&quot;<span class="title">dropdown</span>-<span class="title">item</span>&quot; <span class="title">href</span>=&quot;<span class="title">function</span>.<span class="title">php</span>?<span class="title">do</span>=<span class="title">logout</span>&quot;&gt;登出&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;logout&#x27;</span>:</span><br><span class="line">  <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>]);</span><br><span class="line">  <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location:/&#x27;</span>);</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<h2 id="限定單台電腦登入"><a href="#限定單台電腦登入" class="headerlink" title="限定單台電腦登入"></a>限定單台電腦登入</h2><p>這裡將介紹如何同時間只允許一台電腦連線登入後台使用。做發生其他地點有任何電腦或瀏覽器登入，會強制踢出原本已登入的用戶。</p>
<h3 id="限定-login-只需一次"><a href="#限定-login-只需一次" class="headerlink" title="限定 login 只需一次"></a>限定 login 只需一次</h3><p>將 login.html 修改為 login.php，使得該拜訪處具備 php 處理能力。追加同 header.php 的起始處 php 處理方式。唯獨不同的轉址作法為當 session 存在就直接去後台。而可以不引用整份 function.php 改只取 session 相關設定。</p>
<figure class="highlight php"><figcaption><span>login.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// require_once(&quot;./function.php&quot;);</span></span><br><span class="line"><span class="title function_ invoke__">session_save_path</span>(<span class="string">&#x27;tmp&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>])) <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location:/admin.php&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="登入提交產生-token"><a href="#登入提交產生-token" class="headerlink" title="登入提交產生 token"></a>登入提交產生 token</h3><p>我們需要再登入階段多考量 token 的儲存，token 能代表後端給予我們的當下唯一代碼。</p>
<ul>
<li>先擴增 SQL 內_loki_user 的兩個欄位，分別存放 token:TEXT 與 expire:DATETIME</li>
<li>處理的時機為，當 check 完成後已確認該 account 存在，則準備生成 token 值。</li>
<li>token 值可隨意字串再轉 MD5，這裡使用帳號加密碼加當下時間。</li>
<li>將 token 值塞回 SQL 內，以及規劃生命期限為當下的五分鐘後（僅示範，可自己規劃時間長度）。</li>
<li>如果我們 token 跟 expire 都成功更新了，也把 session 的固定值改成存放 token。</li>
</ul>
<figure class="highlight sql"><figcaption><span>mysql command</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `_loki_user` <span class="keyword">ADD</span> `token` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span> AFTER `password`, <span class="keyword">ADD</span> `expire` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span> AFTER `token`;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkUserSaveSession</span>(<span class="params"><span class="variable">$acc</span>, <span class="variable">$pwd</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>])) <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">//如果存在就直接回傳 true，不用再驗證設定 SESSION</span></span><br><span class="line">  <span class="variable">$check</span> = !!<span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;name=&quot;&#x27;</span> . <span class="variable">$acc</span> . <span class="string">&#x27;&quot; AND password=&quot;&#x27;</span> . <span class="variable">$pwd</span> . <span class="string">&#x27;&quot; AND active=1&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$check</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">date_default_timezone_set</span>(<span class="string">&#x27;Asia/Taipei&#x27;</span>);</span><br><span class="line">    <span class="variable">$token</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$acc</span> . <span class="variable">$pwd</span> . <span class="title function_ invoke__">strtotime</span>(<span class="string">&#x27;now&#x27;</span>));</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">update</span>(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;token=&quot;&#x27;</span> . <span class="variable">$token</span> . <span class="string">&#x27;&quot;, expire=DATE_ADD(NOW(), INTERVAL 5 MINUTE)&#x27;</span>, <span class="string">&#x27;name=&quot;&#x27;</span> . <span class="variable">$acc</span> . <span class="string">&#x27;&quot;&#x27;</span>)-&gt;queryString;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span>) <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>] = <span class="variable">$token</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">exit</span>(<span class="string">&#x27;sql fail&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$check</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="每次後台都需檢查-token-是否健在。"><a href="#每次後台都需檢查-token-是否健在。" class="headerlink" title="每次後台都需檢查 token 是否健在。"></a>每次後台都需檢查 token 是否健在。</h3><p>我們希望每次操作後台，都要檢查資料庫狀態，如果稍早我們存入的 token 已經被修改時，代表有人登入此帳號而我們因前面設計不可能做登入。以及要判斷是否太久沒有存取後台而掛網需踢出。</p>
<ul>
<li>將檢查的工作規畫為函式放入 header.php 也就所有的後台頁面。</li>
<li>規劃該 checkPermission，首先先檢查 expire 是否小於（過去）目前時間，由於貪快寫死 name 僅示範，否則應試著從 session 或某處記住帳戶 name。</li>
<li>如果存在期效已發生於過去，清除當下 SESSION（使得可以開放 login)，並提示後轉至 login。這裡使用 js 轉址是確保用戶可以收到 alert 資訊。並 exit 停止 php 工作。</li>
<li>反之未過期，程式繼續往下跑，接著檢查 token 是否 SQL 與 SESSION 仍一致。</li>
<li>如果存在一致沒有改變，則請求翻新 SQL 內的 expire 多活當下 5 分鐘。</li>
<li>反之不存在，代表 token 已從指定條件下被修改（其他電腦拜訪 login 而我們拜訪不到 Login 運行到 token update)。</li>
<li>同上，清除手上的 token 使得可拜訪 login 做 token update，並轉到 login 畫面。</li>
</ul>
<figure class="highlight php"><figcaption><span>header.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">require_once</span>(<span class="string">&quot;./function.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>])) <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location:/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">checkPermission</span>();</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>function.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkPermission</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$sql</span>;</span><br><span class="line">  <span class="variable">$life</span> = <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;expire&lt;NOW() and name=&quot;admin&quot;&#x27;</span>); <span class="comment">//是否有時間已過期</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$life</span>)) &#123; <span class="comment">//有找到代表有過期</span></span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>]);</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">      &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;連線逾時，請重新作業。&#x27;);</span></span><br><span class="line"><span class="string">        document.location.href = &#x27;/login.php&#x27;;</span></span><br><span class="line"><span class="string">      &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$tokenIsset</span> = <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;token=&quot;&#x27;</span> . <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>] . <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$tokenIsset</span>))  <span class="comment">//token 不變，延長壽命</span></span><br><span class="line">    <span class="variable">$sql</span>-&gt;<span class="title function_ invoke__">update</span>(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;expire=DATE_ADD(NOW(), INTERVAL 5 MINUTE)&#x27;</span>, <span class="string">&#x27;name=&quot;&#x27;</span> . <span class="variable">$tokenIsset</span>[<span class="number">0</span>][<span class="string">&#x27;name&#x27;</span>] . <span class="string">&#x27;&quot;&#x27;</span>)-&gt;queryString;</span><br><span class="line">  <span class="keyword">else</span> &#123; <span class="comment">//token 已改變，清除 session，顯示重複登入，登出，踢回 login</span></span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>]);</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">      &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;帳號重複登入，請重新作業。&#x27;);</span></span><br><span class="line"><span class="string">        document.location.href = &#x27;/login.php&#x27;;</span></span><br><span class="line"><span class="string">      &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="隱藏-URL-附檔名"><a href="#隱藏-URL-附檔名" class="headerlink" title="隱藏 URL 附檔名"></a>隱藏 URL 附檔名</h1><ul>
<li>確認 apache 的 rewrite 功能有啟用<figure class="highlight plaintext"><figcaption><span>httpd.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">LoadModule rewrite_module modules/mod_rewrite.so</span><br></pre></td></tr></table></figure></li>
<li>新增根目錄檔案底下添加 RewriteRule 規則<figure class="highlight shell"><figcaption><span>.htaccess</span></figcaption><table><tr><td class="code"><pre><span class="line">Options +FollowSymlinks</span><br><span class="line">RewriteEngine on</span><br><span class="line"></span><br><span class="line">RewriteCond %&#123;THE_REQUEST&#125; /([^.]+)\.php [NC]</span><br><span class="line">RewriteRule ^ /%1 [NC,L,R]</span><br><span class="line"></span><br><span class="line">RewriteCond %&#123;REQUEST_FILENAME&#125;.php -f</span><br><span class="line">RewriteRule ^ %&#123;REQUEST_URI&#125;.php [NC,L]</span><br></pre></td></tr></table></figure></li>
<li>調整過去在 HTM 上的相關 URL 寫法<figure class="highlight php"><figcaption><span>login.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">&lt;form action=<span class="string">&quot;function?do=login&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>lokiCalendar</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;/function?do=newOrder&#x27;</span>, &#123;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>header.php</span></figcaption><table><tr><td class="code"><pre><span class="line">&lt;li&gt;&lt;a <span class="class"><span class="keyword">class</span>=&quot;<span class="title">dropdown</span>-<span class="title">item</span>&quot; <span class="title">href</span>=&quot;<span class="title">function</span>?<span class="title">do</span>=<span class="title">logout</span>&quot;&gt;登出&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>main-holiday.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">&lt;form <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span> <span class="title">px</span>-4&quot; <span class="title">method</span>=&quot;<span class="title">post</span>&quot; <span class="title">action</span>=&quot;<span class="title">function</span>?<span class="title">do</span>=<span class="title">mdyHoliday</span>&quot;&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>main-orderList.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="string">&#x27;&lt;a class=&quot;btn btn-danger btn-sm&quot; href=&quot;function?&#x27;</span> . <span class="title function_ invoke__">http_build_query</span>(<span class="variable">$getAry</span>) . <span class="string">&#x27;&quot;&gt;刪除&lt;/a&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><figcaption><span>main-pallet.php</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">&lt;form <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span> <span class="title">px</span>-4&quot; <span class="title">method</span>=&quot;<span class="title">post</span>&quot; <span class="title">action</span>=&quot;<span class="title">function</span>?<span class="title">do</span>=<span class="title">mdyPallet</span>&quot;&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/PHP-%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88%EF%BC%88%E5%81%87%E6%97%A5%E7%8F%AD%EF%BC%89/" rel="tag"># PHP 程式設計（假日班）</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/11-15/js-project-camp/" rel="prev" title="[期末課程] JavaScript 期末實作：商務網站">
                  <i class="fa fa-chevron-left"></i> [期末課程] JavaScript 期末實作：商務網站
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/03-08/js-angular-5/" rel="next" title="[前端框架] Angular - HTTP 請求、身分驗證、動態元件">
                  [前端框架] Angular - HTTP 請求、身分驗證、動態元件 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  
      <span class="post-meta-item">
        <span class="post-meta-item-icon with-love">
          <i class="fa fa-chart-line"></i>
        </span>
        <span title="全站總字數">519,531</span>
      </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon with-love">
          <i class="fa fa-coffee"></i>
        </span>
        <span title="全站總閱讀時間">15:44:36</span>
      </span>
      <span class="post-meta-item" id="busuanzi_container_site_uv">
        <span class="post-meta-item-icon with-love">
          <i class="fa fa-user"></i>
        </span>
        <span class="site-uv" title="訪客總數">
          <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span class="post-meta-item" id="busuanzi_container_site_pv">
        <span class="post-meta-item-icon with-love">
          <i class="fa fa-eye"></i>
        </span>
        <span class="site-pv" title="總瀏覽次數">
          <span id="busuanzi_value_site_pv"></span>
        </span>
      </span>

    <div class="copyright">
      <span class="with-love">
        <i class="fa fa-star"></i>
      </span>
      <span class="author" itemprop="copyrightHolder" title="找我？！側單左上連結">Loki Jiang</span>
      <span class="post-meta-item-icon with-love">
        <i class="fas fa-copyright"></i>
      </span>
      2020 – 
      <span itemprop="copyrightYear">2023</span> All rights reserved.
    </div>
  
    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/summer10920" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.4.3/mermaid.min.js","integrity":"sha256-e0o3JYsdjqKajf9eOe22FhioYSz9WofRY4dLKo3F6do="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  <script src="/js/third-party/fancybox.js"></script>



  
  
  <script>
    var bszCaller,
      bszTag;
    !function () {
      var c,
        d,
        e,
        a = !1,
        b = [];
      ready = function (c) {
        return a || "interactive" === document.readyState || "complete" === document.readyState
          ? c.call(document)
          : b.push(function () {
            return c.call(this)
          }),
        this
      },
      d = function () {
        for (var a = 0, c = b.length; c > a; a++) 
          b[a].apply(document);
        b = []
      },
      e = function () {
        a || (
          a = !0, d.call(window), document.removeEventListener
          ? document.removeEventListener("DOMContentLoaded", e, !1)
          : document.attachEvent && (document.detachEvent("onreadystatechange", e), window == window.top && (clearInterval(c), c = null)))
      },
      document.addEventListener
        ? document.addEventListener("DOMContentLoaded", e, !1)
        : document.attachEvent && (document.attachEvent("onreadystatechange", function () {
          /loaded|complete/.test(document.readyState) && e()
        }), window == window.top && (c = setInterval(function () {
          try {
            a || document
              .documentElement
              .doScroll("left")
          } catch (b) {
            return
          }
          e()
        }, 5)))
    }(),
    bszCaller = {
      fetch: function (a, b) {
        var c = "BusuanziCallback_" + Math.floor(1099511627776 * Math.random());
        window[c] = this.evalCall(b),
        a = a.replace("=BusuanziCallback", "=" + c),
        scriptTag = document.createElement("SCRIPT"),
        scriptTag.type = "text/javascript",
        scriptTag.defer = !0,
        scriptTag.src = a,
        scriptTag.referrerPolicy = "no-referrer-when-downgrade",
        document
          .getElementsByTagName("HEAD")[0]
          .appendChild(scriptTag)
      },
      evalCall: function (a) {
        return function (b) {
          ready(function () {
            try {
              a(b),
              scriptTag
                .parentElement
                .removeChild(scriptTag)
            } catch (c) {
              bszTag.hides()
            }
          })
        }
      }
    },
    bszCaller.fetch("//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback", function (a) {
      bszTag.texts(a),
      bszTag.shows()
    }),
    bszTag = {
      bszs: [
        "site_pv", "page_pv", "site_uv"
      ],
      texts: function (a) {
        this
          .bszs
          .map(function (b) {
            var c = document.getElementById("busuanzi_value_" + b);
            c && (c.innerHTML = a[b].toLocaleString())
          })
      },
      hides: function () {
        this
          .bszs
          .map(function (a) {
            var b = document.getElementById("busuanzi_container_" + a);
            b && (b.style.display = "none")
          })
      },
      shows: function () {
        this
          .bszs
          .map(function (a) {
            var b = document.getElementById("busuanzi_container_" + a);
            b && (b.style.display = "inline")
          })
      }
    };
  </script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"
    integrity="sha512-lGnVsh3WK0YJ7NX7rQmUu6kqF7vqELuDrUTnxpI2iD86VwI+OlQhi3EAJJZbrBUOfDFOAYAkigxkApHGM2IZTg=="
    crossorigin="anonymous"></script>
<script src="/js/loki.js"></script>

</body>
</html>
